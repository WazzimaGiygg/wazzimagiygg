<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar HTML - WZZM</title>
    <!-- Carrega o Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Importa a fonte Inter, amplamente usada em designs modernos */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilo customizado para o spinner de carregamento */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3b82f6; /* Azul moderno do Tailwind */
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Garantindo que o conteúdo HTML interno se ajuste bem */
        .html-content > * {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="container bg-white max-w-4xl w-full p-6 md:p-10 rounded-xl shadow-2xl mt-10 transition-all duration-300">

        <h1 id="page-title" class="text-3xl font-extrabold text-gray-800 mb-8 pb-4 border-b-4 border-blue-500/50">
            Carregando...
        </h1>

        <div id="html-display" class="html-content text-left mt-6 p-4 md:p-8 border border-gray-200 bg-gray-50 rounded-lg min-h-[200px] transition-all duration-300 overflow-auto">
            
            <div class="loading-container flex flex-col items-center justify-center p-8 space-y-4">
                <div class="spinner w-12 h-12"></div>
                <p class="text-center text-gray-500 text-lg font-medium">Carregando conteúdo...</p>
                <p class="text-center text-blue-500 text-sm">A página será aberta automaticamente em uma nova aba.</p>
            </div>
        </div>

        <!-- Container para mostrar status e botão manual (se necessário) -->
        <div id="status-container" class="mt-6 hidden">
            <div class="flex flex-col items-center space-y-4 p-4 border border-gray-200 rounded-lg">
                <div id="auto-open-status" class="flex items-center space-x-2">
                    <div class="spinner w-6 h-6"></div>
                    <span class="text-gray-600">Abrindo em nova aba...</span>
                </div>
                <button id="manual-open-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                    <span>Abrir Manualmente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Inicialização do Firebase
        const firebaseConfig = {
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const htmlDisplay = document.getElementById('html-display');
        const pageTitle = document.getElementById('page-title');
        const statusContainer = document.getElementById('status-container');
        const autoOpenStatus = document.getElementById('auto-open-status');
        const manualOpenBtn = document.getElementById('manual-open-btn');

        // Armazenar dados em cache
        let cachedHtmlData = {
            uid: null,
            content: null,
            title: null,
            js: null,
            timestamp: null,
            lastOpened: null
        };

        // Controle de tentativas de abertura
        let openAttemptCount = 0;
        const MAX_OPEN_ATTEMPTS = 2;

        /**
         * Salva os dados no localStorage do navegador
         */
        function saveToCache(uid, htmlContent, title, jsScript) {
            cachedHtmlData = {
                uid: uid,
                content: htmlContent,
                title: title,
                js: jsScript,
                timestamp: new Date().getTime(),
                lastOpened: new Date().getTime()
            };
            
            try {
                localStorage.setItem('wzzm_cached_html', JSON.stringify(cachedHtmlData));
            } catch (e) {
                console.warn('Não foi possível salvar no localStorage:', e);
            }
        }

        /**
         * Prepara o conteúdo HTML para funcionar em blob/data URL
         */
        function prepareHtmlForBlob(htmlContent, jsScript) {
            // Remove scripts do Firebase Auth que não funcionam em blob/data URLs
            let cleanedHtml = htmlContent;
            
            // Remove importações do Firebase Auth
            cleanedHtml = cleanedHtml.replace(
                /<script[^>]*src=["'][^"']*firebase-auth[^"']*["'][^>]*><\/script>/gi,
                ''
            );
            
            // Remove scripts que inicializam Firebase Auth
            cleanedHtml = cleanedHtml.replace(
                /<script>[\s\S]*?firebase\.auth\(\)[\s\S]*?<\/script>/gi,
                ''
            );
            
            // Remove event listeners de login com Google
            cleanedHtml = cleanedHtml.replace(
                /onclick=["']signInWithGoogle\(\)["']/gi,
                'onclick="handleAuthClick(event)"'
            );
            
            // Adiciona mensagem informativa sobre login
            const authMessage = `
                <div style="position: fixed; top: 10px; right: 10px; background: #ffeb3b; padding: 10px; border-radius: 5px; z-index: 1000; max-width: 300px;">
                    <strong>⚠️ Login Firebase:</strong>
                    <p style="margin: 5px 0; font-size: 12px;">
                        A funcionalidade de login não está disponível nesta visualização.
                        Para usar o login completo, acesse a página original.
                    </p>
                    <button onclick="this.parentElement.style.display='none'" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                        Fechar
                    </button>
                </div>
            `;
            
            return authMessage + cleanedHtml;
        }

        /**
         * Cria um script de substituição para funções de autenticação
         */
        function createAuthReplacementScript() {
            return `
                <script>
                    // Função para substituir o Firebase Auth em blob/data URLs
                    function handleAuthClick(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        const originalUrl = window.location.origin + window.location.pathname + '?uid=${cachedHtmlData.uid}';
                        
                        const message = document.createElement('div');
                        message.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center;';
                        message.innerHTML = \`
                            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center;">
                                <h3 style="color: #f44336; margin-bottom: 15px;">⚠️ Funcionalidade de Login</h3>
                                <p style="margin-bottom: 20px;">
                                    A autenticação com Firebase não está disponível nesta visualização.<br>
                                    Para usar o login completo, você precisa acessar a página original.
                                </p>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button onclick="window.open('\\\${originalUrl}', '_blank')" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        Abrir Página Original
                                    </button>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #9E9E9E; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        \`;
                        
                        document.body.appendChild(message);
                        return false;
                    }
                    
                    // Substitui qualquer referência ao Firebase Auth
                    if (typeof firebase !== 'undefined') {
                        try {
                            // Se firebase.auth() for chamado, mostra mensagem
                            const originalAuth = firebase.auth;
                            firebase.auth = function() {
                                console.warn('Firebase Auth não está disponível nesta visualização.');
                                
                                return {
                                    signInWithPopup: function() {
                                        return Promise.reject(new Error('Firebase Auth não disponível em blob/data URLs'));
                                    },
                                    signInWithEmailAndPassword: function() {
                                        return Promise.reject(new Error('Firebase Auth não disponível em blob/data URLs'));
                                    },
                                    createUserWithEmailAndPassword: function() {
                                        return Promise.reject(new Error('Firebase Auth não disponível em blob/data URLs'));
                                    },
                                    signOut: function() {
                                        return Promise.resolve();
                                    },
                                    onAuthStateChanged: function(callback) {
                                        // Não chama o callback ou chama com null
                                        return function() {};
                                    },
                                    currentUser: null
                                };
                            };
                        } catch (e) {
                            console.warn('Não foi possível substituir firebase.auth:', e);
                        }
                    }
                    
                    // Remove qualquer script problemático após o carregamento
                    document.addEventListener('DOMContentLoaded', function() {
                        // Remove scripts que podem causar erros
                        const scripts = document.querySelectorAll('script');
                        scripts.forEach(script => {
                            const content = script.textContent || script.innerHTML || '';
                            if (content.includes('auth/operation-not-supported-in-this-environment') ||
                                content.includes('location.protocol') ||
                                content.includes('firebase.auth()')) {
                                script.remove();
                            }
                        });
                        
                        // Intercepta links para abrir na mesma janela
                        const links = document.querySelectorAll('a');
                        links.forEach(link => {
                            if (link.target !== '_blank') {
                                link.addEventListener('click', function(e) {
                                    if (this.href && this.href.startsWith('blob:') || this.href.startsWith('data:')) {
                                        e.preventDefault();
                                        return;
                                    }
                                    
                                    if (this.target !== '_blank') {
                                        e.preventDefault();
                                        const href = this.href;
                                        if (href) {
                                            window.location.href = href;
                                        }
                                    }
                                });
                            }
                        });
                    });
                <\/script>
            `;
        }

        /**
         * Cria e abre o conteúdo em uma nova aba
         */
        function openInNewTab() {
            if (!cachedHtmlData.content) {
                console.error('Nenhum conteúdo disponível para abrir.');
                showManualButton();
                return;
            }

            openAttemptCount++;
            
            // Atualiza status
            if (openAttemptCount === 1) {
                autoOpenStatus.innerHTML = `
                    <div class="spinner w-6 h-6"></div>
                    <span class="text-gray-600">Abrindo em nova aba...</span>
                `;
            } else {
                autoOpenStatus.innerHTML = `
                    <div class="spinner w-6 h-6"></div>
                    <span class="text-gray-600">Tentativa ${openAttemptCount} de ${MAX_OPEN_ATTEMPTS}...</span>
                `;
            }

            // Prepara o conteúdo HTML removendo problemas de autenticação
            const preparedHtml = prepareHtmlForBlob(cachedHtmlData.content, cachedHtmlData.js);
            const authReplacementScript = createAuthReplacementScript();

            // Cria um novo HTML completo para a nova aba
            const fullHtml = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${cachedHtmlData.title || 'Página WZZM'}</title>
                    <style>
                        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                        /* Remove qualquer frame-busting */
                        iframe { display: none; }
                        
                        /* Estilo para mensagens de aviso */
                        .auth-warning {
                            position: fixed;
                            top: 10px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: #ff9800;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 5px;
                            z-index: 10000;
                            text-align: center;
                            max-width: 80%;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        }
                    </style>
                </head>
                <body>
                    ${preparedHtml}
                    
                    ${cachedHtmlData.js ? `<script>${cachedHtmlData.js}<\/script>` : ''}
                    
                    ${authReplacementScript}
                </body>
                </html>
            `;

            // Tenta abrir usando diferentes métodos
            let newTab = null;
            
            // Método 1: Blob URL
            try {
                const blob = new Blob([fullHtml], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                
                newTab = window.open(blobUrl, '_blank');
                
                // Limpa a URL do blob após a abertura
                if (newTab) {
                    setTimeout(() => {
                        URL.revokeObjectURL(blobUrl);
                    }, 1000);
                }
            } catch (e) {
                console.warn('Erro com Blob URL:', e);
                
                // Método 2: Data URL (fallback)
                try {
                    const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(fullHtml);
                    newTab = window.open(dataUrl, '_blank');
                } catch (e2) {
                    console.warn('Erro com Data URL:', e2);
                }
            }

            // Verifica se a nova aba foi aberta com sucesso
            if (newTab) {
                // Atualiza status de sucesso
                autoOpenStatus.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="text-green-600">Aberto com sucesso!</span>
                `;
                
                // Foca na nova aba
                newTab.focus();
                
                // Fecha esta janela após 2 segundos (opcional)
                setTimeout(() => {
                    // window.close(); // Descomente se quiser fechar automaticamente
                }, 2000);
            } else {
                console.warn('O navegador pode estar bloqueando pop-ups.');
                
                if (openAttemptCount < MAX_OPEN_ATTEMPTS) {
                    // Tenta novamente após um delay
                    setTimeout(() => {
                        openInNewTab();
                    }, 1000);
                } else {
                    // Mostra botão manual após tentativas falharem
                    showManualButton();
                }
            }
        }

        /**
         * Mostra o botão para abertura manual
         */
        function showManualButton() {
            autoOpenStatus.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span class="text-yellow-600">Abertura automática bloqueada</span>
            `;
            
            manualOpenBtn.style.display = 'flex';
        }

        /**
         * Intercepta cliques em todos os links <a> dentro de um container
         */
        function interceptLinks(container) {
            const links = container.querySelectorAll('a');

            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.target === '_blank') {
                        return; 
                    }
                    
                    e.preventDefault();
                    
                    const href = this.href;
                    if (href) {
                        window.location.href = href;
                    }
                });
            });
        }

        async function buscarEExibirHtml() {
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('uid');

            if (!documentId) {
                htmlDisplay.innerHTML = '<p class="text-center text-red-500 font-bold p-4">ID do documento não fornecido na URL.</p>';
                pageTitle.innerText = "Erro";
                return;
            }

            try {
                const docRef = db.collection('HTML2W').doc(documentId);
                const doc = await docRef.get();

                if (doc.exists) {
                    const htmlData = doc.data();
                    pageTitle.innerText = htmlData.nomePagina || 'Página carregada';
                    const htmlContent = htmlData.html_content || htmlData.codigo;
                    const jsScript = htmlData.js_script;

                    if (htmlContent) {
                        htmlDisplay.innerHTML = htmlContent;
                        interceptLinks(htmlDisplay);
                        
                        // Salva no cache
                        saveToCache(
                            documentId,
                            htmlContent,
                            htmlData.nomePagina || 'Página sem Título',
                            jsScript
                        );
                        
                        // Mostra o status container
                        statusContainer.classList.remove('hidden');
                        
                        // Abre automaticamente em nova aba
                        setTimeout(() => {
                            openInNewTab();
                        }, 500); // Pequeno delay para garantir que o conteúdo foi processado
                    } else {
                        htmlDisplay.innerHTML = '<p class="text-center text-red-500 font-bold p-4">Conteúdo HTML não encontrado no documento.</p>';
                    }

                    if (jsScript) {
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = jsScript;
                        document.body.appendChild(scriptElement);
                    }
                } else {
                    htmlDisplay.innerHTML = '<p class="text-center text-red-500 font-bold p-4">Documento não encontrado no banco de dados.</p>';
                    pageTitle.innerText = "Conteúdo Não Encontrado";
                }
            } catch (error) {
                console.error("Ocorreu um erro ao carregar o conteúdo:", error);
                const errorMessage = '<p class="text-center text-red-500 font-bold p-4">O sistema detectou uma anomalia em seu trafego, a página não pode ser aberta!</p>';
                
                htmlDisplay.innerHTML = errorMessage;
                pageTitle.innerText = "Erro";
            }
        }
        
        // Event Listeners
        window.onload = buscarEExibirHtml;
        manualOpenBtn.addEventListener('click', openInNewTab);

        // Verifica se há cache do localStorage ao carregar
        window.addEventListener('DOMContentLoaded', function() {
            try {
                const cached = localStorage.getItem('wzzm_cached_html');
                if (cached) {
                    const parsed = JSON.parse(cached);
                    // Verifica se o cache é recente (menos de 24 horas)
                    const now = new Date().getTime();
                    if (now - parsed.timestamp < 24 * 60 * 60 * 1000) {
                        cachedHtmlData = parsed;
                    }
                }
            } catch (e) {
                console.warn('Erro ao ler cache:', e);
            }
        });
    </script>
</body>
</html>
