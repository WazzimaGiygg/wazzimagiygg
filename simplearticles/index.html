<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca Avançada - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #202122;
        }
        .header-logged-in {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #343a40;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-container {
            padding: 2em;
        }
        .lista-artigos-pane {
            background-color: #ffffff;
            border: 1px solid #ddd;
            padding: 1em;
            overflow-y: auto;
        }
        .lista-artigos-pane h2 {
            font-size: 1.5em;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 0.5em;
        }
        .artigo-item {
            padding: 1em;
            border-bottom: 1px solid #eaecf0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .artigo-item:hover, .artigo-item.ativo {
            background-color: #eaf3ff;
        }
        .artigo-item h3 {
            margin: 0 0 5px 0;
            color: #0645ad;
            font-size: 1.1em;
        }
        .artigo-item p {
            font-size: 0.9em;
            color: #54595d;
            margin: 0;
        }
        #form-busca-avancada label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #form-busca-avancada input, #form-busca-avancada select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
        }
        #botao-buscar-avancado {
            width: 100%;
            padding: 10px;
            background-color: #2a6f8b;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1em;
            border-radius: 4px;
        }
        #botao-voltar {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #a2a9b1;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1em;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="header-logged-in">
        <h1>Busca Avançada</h1>
        <a href="index.html" style="color: white; text-decoration: none;">Voltar ao Painel</a>
    </div>

    <div class="search-container">
        <div class="lista-artigos-pane">
            <div style="margin-bottom: 1em; border-bottom: 1px solid #ccc; padding-bottom: 1em;">
                <h3 style="margin-top: 0;">Busca Avançada</h3>
                <form id="form-busca-avancada">
                    <label for="busca-uid">Buscar por UID</label>
                    <input type="text" id="busca-uid" placeholder="UID do Artigo">

                    <label for="busca-titulo">Buscar por Título</label>
                    <input type="text" id="busca-titulo" placeholder="Título do Artigo">

                    <label for="busca-idioma">Filtrar por Idioma</label>
                    <select id="busca-idioma">
                        <option value="">Todos os Idiomas</option>
                        <option value="Português">Português</option>
                        <option value="Inglês">Inglês</option>
                        <option value="Espanhol">Espanhol</option>
                    </select>

                    <button type="submit" id="botao-buscar-avancado">Buscar</button>
                </form>
            </div>
            <h2 id="artigos-title">Resultados da Busca</h2>
            <div id="artigos-list">
                <p style="text-align: center; color: #666;">Use os campos acima para iniciar uma busca.</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Elementos da interface
        const artigosList = document.getElementById('artigos-list');
        const formBuscaAvancada = document.getElementById('form-busca-avancada');
        const buscaUidInput = document.getElementById('busca-uid');
        const buscaTituloInput = document.getElementById('busca-titulo');
        const buscaIdiomaSelect = document.getElementById('busca-idioma');
        const artigosTitle = document.getElementById('artigos-title');

        // Lógica de Autenticação (apenas para verificação, caso necessário)
        auth.onAuthStateChanged(user => {
            if (!user) {
                console.log("Usuário não autenticado. A busca ainda funciona, mas o acesso completo requer login.");
            }
        });

        // Lógica da busca avançada
        formBuscaAvancada.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = buscaUidInput.value.trim();
            const titulo = buscaTituloInput.value.trim();
            const idioma = buscaIdiomaSelect.value;

            artigosList.innerHTML = '<p style="text-align: center; color: #666;">Buscando...</p>';
            artigosTitle.textContent = `Resultados da Busca`;

            let query = db.collection('materias').orderBy('createdAt', 'desc');

            if (uid) {
                buscarArtigoPorUid(uid);
                return;
            } else if (titulo) {
                buscarArtigoPorTitulo(titulo, idioma);
                return;
            } else if (idioma) {
                query = query.where('armario', '==', idioma);
            }

            try {
                const querySnapshot = await query.get();
                exibirResultados(querySnapshot);
            } catch (error) {
                console.error("Erro na busca avançada:", error);
                artigosList.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erro: ' + error.message + '</p>';
            }
        });

        async function buscarArtigoPorUid(uid) {
            try {
                const doc = await db.collection('materias').doc(uid).get();
                artigosList.innerHTML = '';
                if (doc.exists) {
                    const materia = doc.data();
                    const artigoItem = document.createElement('div');
                    artigoItem.className = 'artigo-item';
                    artigoItem.setAttribute('data-id', doc.id);
                    artigoItem.innerHTML = `<h3>${materia.titulo}</h3><p>ID: ${doc.id}</p>`;
                    artigosList.appendChild(artigoItem);
                } else {
                    artigosList.innerHTML = `<p style="text-align: center; color: #666;">Nenhum artigo encontrado com este UID.</p>`;
                }
            } catch (error) {
                console.error("Erro ao buscar artigo por UID: ", error);
                artigosList.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erro: ' + error.message + '</p>';
            }
        }

        async function buscarArtigoPorTitulo(titulo, idioma) {
            let query = db.collection('materias');
            if (idioma) {
                query = query.where('armario', '==', idioma);
            }
            try {
                const querySnapshot = await query.get();
                const resultados = [];
                querySnapshot.forEach(doc => {
                    const materia = doc.data();
                    if (materia.titulo && materia.titulo.toLowerCase().includes(titulo.toLowerCase())) {
                        resultados.push({ id: doc.id, ...materia });
                    }
                });
                exibirResultadosDaBuscaPorTitulo(resultados);
            } catch (error) {
                console.error("Erro ao buscar artigo por título: ", error);
                artigosList.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erro: ' + error.message + '</p>';
            }
        }

        function exibirResultados(querySnapshot) {
            artigosList.innerHTML = '';
            if (querySnapshot.empty) {
                artigosList.innerHTML = `<p style="text-align: center; color: #666;">Nenhum artigo encontrado com os critérios de busca.</p>`;
                return;
            }
            querySnapshot.forEach(doc => {
                const materia = doc.data();
                const artigoItem = document.createElement('div');
                artigoItem.className = 'artigo-item';
                artigoItem.setAttribute('data-id', doc.id);
                artigoItem.innerHTML = `<h3>${materia.titulo}</h3><p>ID: ${doc.id}</p>`;
                artigosList.appendChild(artigoItem);
            });
        }

        function exibirResultadosDaBuscaPorTitulo(resultados) {
            artigosList.innerHTML = '';
            if (resultados.length === 0) {
                artigosList.innerHTML = `<p style="text-align: center; color: #666;">Nenhum artigo encontrado com este título.</p>`;
                return;
            }
            resultados.forEach(res => {
                const artigoItem = document.createElement('div');
                artigoItem.className = 'artigo-item';
                artigoItem.setAttribute('data-id', res.id);
                artigoItem.innerHTML = `<h3>${res.titulo}</h3><p>ID: ${res.id}</p>`;
                artigosList.appendChild(artigoItem);
            });
        }
    </script>
</body>
</html>
