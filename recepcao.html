<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Artigos - WZZM Admin</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body {
            font-family: 'Roboto', 'Helvetica', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        h1 {
            color: #3f51b5;
            margin-bottom: 25px;
            text-align: center;
        }
        .search-controls, .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
            align-items: flex-end;
        }
        .mdl-textfield {
            flex-grow: 1;
            min-width: 200px;
        }
        .mdl-selectfield {
            min-width: 180px;
            flex-grow: 1;
        }
        .mdl-button {
            height: 36px;
            line-height: 36px;
            padding: 0 16px;
        }
        .article-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .article-card {
            min-height: 200px; /* Adjusted min-height for better appearance */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .article-card .mdl-card__title {
            padding-bottom: 0;
        }
        .article-card .mdl-card__title-text {
            font-size: 1.2em;
            line-height: 1.3em;
            margin-bottom: 10px;
            color: #3f51b5;
        }
        .article-card .mdl-card__supporting-text {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-top: 0;
            font-size: 0.9em;
            color: #555;
        }
        .article-card .mdl-card__supporting-text p {
            margin: 0 0 5px 0;
        }
        .abnt-summary-container {
            max-height: 100px; /* Limita a altura do resumo */
            overflow-y: auto; /* Adiciona scroll se o resumo for muito longo */
            margin-top: 10px;
            padding-right: 5px; /* Evita que o scrollbar cubra o texto */
        }
        .mdl-card__actions {
            padding: 16px;
            display: flex;
            justify-content: flex-end;
        }
        .no-articles-message {
            text-align: center;
            color: #757575;
            font-size: 1.2em;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Busca de Artigos Científicos</h1>

        <div class="search-controls">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" id="search-input">
                <label class="mdl-textfield__label" for="search-input">Termo de Busca</label>
            </div>

            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-selectfield">
                <select class="mdl-textfield__input" id="search-type">
                    <option value=""></option>
                    <option value="title">Título</option>
                    <option value="summary">Resumo</option>
                    <option value="introduction">Introdução</option>
                    <option value="methodology">Metodologia</option>
                    <option value="discussion">Discussão</option>
                    <option value="conclusion">Conclusão</option>
                    <option value="abstract">Abstract</option>
                    <option value="userId">ID do Usuário</option>
                </select>
                <label class="mdl-textfield__label" for="search-type">Buscar em</label>
            </div>

            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="main-search-button">
                Buscar
            </button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="clear-search-button">
                Limpar Busca
            </button>
        </div>

        <div class="filter-controls">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-selectfield">
                <select class="mdl-textfield__input" id="filter-language">
                    <option value=""></option>
                    <option value="Português">Português</option>
                    <option value="Inglês">Inglês</option>
                    </select>
                <label class="mdl-textfield__label" for="filter-language">Filtrar por Idioma</label>
            </div>

            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label mdl-selectfield">
                <select class="mdl-textfield__input" id="filter-article-type">
                    <option value=""></option>
                    <option value="TCC">TCC</option>
                    <option value="Artigo Científico">Artigo Científico</option>
                    <option value="Monografia">Monografia</option>
                    </select>
                <label class="mdl-textfield__label" for="filter-article-type">Filtrar por Tipo</label>
            </div>
        </div>

        <div id="articles-list" class="article-list">
            <p class="no-articles-message">Use a barra de pesquisa para encontrar artigos ou aguarde o carregamento dos artigos mais recentes.</p>
        </div>
    </div>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Initialize Firebase
        let app;
        try {
            app = firebase.app();
        } catch (e) {
            app = firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();

        // DOM elements
        const searchInput = document.getElementById('search-input');
        const searchTypeSelect = document.getElementById('search-type');
        const mainSearchButton = document.getElementById('main-search-button');
        const clearSearchButton = document.getElementById('clear-search-button');
        const articlesListDiv = document.getElementById('articles-list');
        const filterLanguageSelect = document.getElementById('filter-language');
        const filterArticleTypeSelect = document.getElementById('filter-article-type');

        // Function to escape HTML for security
        function escapeHtml(unsafe) {
            // Ensure unsafe is a string. If it's undefined or null, convert it to an empty string.
            if (typeof unsafe !== 'string' && unsafe !== null && unsafe !== undefined) {
                 unsafe = String(unsafe); // Try to convert to string if it's a number, boolean, etc.
            }
            if (unsafe === null || unsafe === undefined) {
                return ''; // Return an empty string for null or undefined inputs
            }

            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Function to load articles
        async function loadArticles() {
            articlesListDiv.innerHTML = '<p class="no-articles-message">Carregando artigos...</p>';
            let articlesRef = firestore.collection('articlesdoc');

            const searchTerm = searchInput.value;
            const searchField = searchTypeSelect.value;
            const languageFilter = filterLanguageSelect.value;
            const articleTypeFilter = filterArticleTypeSelect.value;

            const trimmedSearchTerm = searchTerm ? searchTerm.trim() : '';

            try {
                // Apply search query
                if (trimmedSearchTerm && searchField) {
                    articlesRef = articlesRef
                        .where(searchField, '>=', trimmedSearchTerm)
                        .where(searchField, '<=', trimmedSearchTerm + '\uf8ff');
                }

                // Apply filters
                if (languageFilter) {
                    articlesRef = articlesRef.where('language', '==', languageFilter);
                }
                if (articleTypeFilter) {
                    articlesRef = articlesRef.where('articleType', '==', articleTypeFilter);
                }

                // Order results
                if (trimmedSearchTerm && searchField) {
                    articlesRef = articlesRef.orderBy(searchField);
                } else {
                    articlesRef = articlesRef.orderBy('timestamp', 'desc');
                }

                const snapshot = await articlesRef.get();

                articlesListDiv.innerHTML = ''; // Clear previous articles

                if (snapshot.empty) {
                    articlesListDiv.innerHTML = '<p class="no-articles-message">Nenhum artigo encontrado com os critérios de busca.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const id = doc.id; // Correctly get the document ID
                    const data = doc.data();

                    // --- CRITICAL FIXES: Provide fallback values for potentially undefined fields ---
                    const title = data.title || 'Título Indisponível';
                    const summary = data.summary || ''; // Empty string is good for display
                    const userId = data.userId || 'Não informado'; // Fallback for userId
                    const language = data.language || 'Não informado'; // Fallback for language
                    const articleType = data.articleType || 'Não informado'; // Fallback for articleType
                    const abstract = data.abstract || '';
                    const introduction = data.introduction || '';
                    const methodology = data.methodology || '';
                    const discussion = data.discussion || '';
                    const conclusion = data.conclusion || '';

                    // Ensure sources is an array, even if undefined or not an array
                    const sources = (data.sources && Array.isArray(data.sources)) ? data.sources : [];

                    // Ensure originalUrl is a string, trim it, and handle missing
                    const externalLink = data.originalUrl ? String(data.originalUrl).trim() : '';
                    // --- END CRITICAL FIXES ---

                    const card = document.createElement('div');
                    card.className = 'article-card mdl-card mdl-shadow--2dp';
                    card.innerHTML = `
                        <div class="mdl-card__title">
                            <h2 class="mdl-card__title-text">${escapeHtml(title)}</h2>
                        </div>
                        <div class="mdl-card__supporting-text">
                            <strong>ID do Artigo:</strong> <p>${escapeHtml(id)}</p>
                            <strong>ID do Usuário:</strong> <p>${escapeHtml(userId)}</p>
                            <strong>Idioma:</strong> <p>${escapeHtml(language)}</p>
                            <strong>Tipo de Artigo:</strong> <p>${escapeHtml(articleType)}</p>
                            <div class="abnt-summary-container">
                                <strong>Resumo:</strong> <p>${escapeHtml(summary)}</p>
                            </div>
                            ${externalLink ? `<p style="display: block; margin-top: 10px;"><strong>Link Externo:</strong> <a href="${encodeURI(externalLink)}" target="_blank" rel="noopener noreferrer">${escapeHtml(externalLink)}</a></p>` : ''}
                            ${abstract ? `<p class="abnt-section-title">Abstract:</p><p>${escapeHtml(abstract)}</p>` : ''}
                            ${introduction ? `<p class="abnt-section-title">1 INTRODUÇÃO</p><p>${escapeHtml(introduction)}</p>` : ''}
                            ${methodology ? `<p class="abnt-section-title">2 METODOLOGIA</p><p>${escapeHtml(methodology)}</p>` : ''}
                            ${discussion ? `<p class="abnt-section-title">3 DISCUSSÃO</p><p>${escapeHtml(discussion)}</p>` : ''}
                            ${conclusion ? `<p class="abnt-section-title">4 CONCLUSÃO</p><p>${escapeHtml(conclusion)}</p>` : ''}
                            ${sources.length > 0 ? `<p class="abnt-section-title">REFERÊNCIAS</p><ul class="abnt-source-list">${sources.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>` : ''}
                        </div>
                        <div class="mdl-card__actions mdl-card--border">
                            <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect view-article-button" data-article-id="${escapeHtml(id)}">Visualizar Artigo</button>
                        </div>
                    `;
                    articlesListDiv.appendChild(card);
                });

                // Re-upgrade MDL components if new elements are added to the DOM
                if (window.componentHandler) {
                    window.componentHandler.upgradeElements(articlesListDiv);
                }

            } catch (error) {
                console.error("Erro ao carregar os artigos:", error);
                articlesListDiv.innerHTML = `<p class="no-articles-message">Erro: Não foi possível carregar os artigos. Erro: ${escapeHtml(error.message)}</p>`;
                console.warn("Possível erro de falta de índice no Firestore. Crie um índice composto se estiver usando múltiplos 'where' clauses ou 'where' com 'orderBy' em campos diferentes.");
            }
        }

        // Event Listeners for search and filters
        mainSearchButton.addEventListener('click', loadArticles);
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                loadArticles();
            }
        });

        // Trigger search when filter changes
        filterLanguageSelect.addEventListener('change', loadArticles);
        filterArticleTypeSelect.addEventListener('change', loadArticles);
        searchTypeSelect.addEventListener('change', loadArticles);

        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            searchTypeSelect.value = '';
            filterLanguageSelect.value = '';
            filterArticleTypeSelect.value = '';

            // Update MDL textfield displays
            const searchInputMdl = searchInput.closest('.mdl-textfield');
            if (searchInputMdl && searchInputMdl.MaterialTextfield) {
                searchInputMdl.MaterialTextfield.change(''); // Clear display
            }

            const searchTypeMdlSelect = searchTypeSelect.closest('.mdl-textfield');
            if (searchTypeMdlSelect && searchTypeMdlSelect.MaterialTextfield) {
                searchTypeMdlSelect.MaterialTextfield.change(''); // Clear display
            }

            const languageMdlSelect = filterLanguageSelect.closest('.mdl-textfield');
            if (languageMdlSelect && languageMdlSelect.MaterialTextfield) {
                languageMdlSelect.MaterialTextfield.change(''); // Clear display
            }
            const articleTypeMdlSelect = filterArticleTypeSelect.closest('.mdl-textfield');
            if (articleTypeMdlSelect && articleTypeMdlSelect.MaterialTextfield) {
                articleTypeMdlSelect.MaterialTextfield.change(''); // Clear display
            }

            loadArticles();
        });


        // Event listener for "Visualizar Artigo" buttons using event delegation
        articlesListDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('view-article-button')) {
                const articleId = event.target.dataset.articleId;
                if (articleId) {
                    const newWindow = window.open(`/visualizar.html?id=${encodeURIComponent(articleId)}`, '_blank');
                    if (!newWindow) {
                        alert('Por favor, permita pop-ups para visualizar o artigo completo.');
                    }
                }
            }
        });


        // Initialize MDL components on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            if (window.componentHandler) {
                window.componentHandler.upgradeDom();
                // For mdl-selectfield, the display input needs to be updated after upgradeDom
                const searchTypeDisplayInput = searchTypeSelect.closest('.mdl-textfield');
                if (searchTypeDisplayInput && searchTypeDisplayInput.MaterialTextfield) {
                    searchTypeDisplayInput.MaterialTextfield.change(searchTypeSelect.options[searchTypeSelect.selectedIndex]?.text || '');
                }
                const languageDisplayInput = filterLanguageSelect.closest('.mdl-textfield');
                if (languageDisplayInput && languageDisplayInput.MaterialTextfield) {
                    languageDisplayInput.MaterialTextfield.change(filterLanguageSelect.options[filterLanguageSelect.selectedIndex]?.text || '');
                }
                const articleTypeDisplayInput = filterArticleTypeSelect.closest('.mdl-textfield');
                if (articleTypeDisplayInput && articleTypeDisplayInput.MaterialTextfield) {
                    articleTypeDisplayInput.MaterialTextfield.change(filterArticleTypeSelect.options[filterArticleTypeSelect.selectedIndex]?.text || '');
                }
            }
            loadArticles(); // Carrega os artigos iniciais (ou a mensagem de "use a barra de pesquisa")
        });

        // Para garantir que os selectfields do MDL funcionem corretamente
        // Se o valor inicial for vazio, o label pode não se comportar corretamente.
        // Adicionar um evento para quando o select é alterado
        document.querySelectorAll('.mdl-selectfield select').forEach(selectElement => {
            selectElement.addEventListener('change', () => {
                const parentTextfield = selectElement.closest('.mdl-textfield');
                if (parentTextfield && parentTextfield.MaterialTextfield) {
                    // Update the MDL component's state to reflect the new value
                    parentTextfield.MaterialTextfield.change(selectElement.options[selectElement.selectedIndex].text);
                }
            });
        });
    </script>
</body>
</html>
