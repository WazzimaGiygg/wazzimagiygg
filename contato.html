<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WZZM Chat</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body {
            display: flex; [cite_start]/* [cite: 1] */
            min-height: 100vh; [cite_start]/* [cite: 2] */
            margin: 0; [cite_start]/* [cite: 2] */
            font-family: 'Roboto', sans-serif; [cite_start]/* [cite: 2] */
            background-color: #f5f5f5; [cite_start]/* [cite: 2] */
        }
        .mdl-layout__content {
            flex-grow: 1; [cite_start]/* [cite: 2] */
            display: flex; [cite_start]/* [cite: 3] */
            padding: 0; [cite_start]/* [cite: 3] */
        }
        #left-panel {
            width: 300px; [cite_start]/* [cite: 3] */
            background-color: #ffffff; [cite_start]/* [cite: 4] */
            border-right: 1px solid #e0e0e0; [cite_start]/* [cite: 4] */
            display: flex; [cite_start]/* [cite: 4] */
            flex-direction: column; [cite_start]/* [cite: 4] */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); [cite_start]/* [cite: 4] */
        [cite_start]} /* [cite: 5] */
        #chat-main-area {
            flex-grow: 1; [cite_start]/* [cite: 5] */
            display: flex; [cite_start]/* [cite: 6] */
            flex-direction: column; [cite_start]/* [cite: 6] */
            background-color: #fbfbfb; [cite_start]/* [cite: 6] */
        }
        #recent-chats-list {
            list-style: none; [cite_start]/* [cite: 6] */
            padding: 0; [cite_start]/* [cite: 7] */
            margin: 0; [cite_start]/* [cite: 7] */
            flex-grow: 1; [cite_start]/* [cite: 7] */
            overflow-y: auto; [cite_start]/* [cite: 7] */
        }
        .chat-list-item {
            display: flex; [cite_start]/* [cite: 7] */
            align-items: center; [cite_start]/* [cite: 8] */
            padding: 15px; [cite_start]/* [cite: 8] */
            border-bottom: 1px solid #eee; [cite_start]/* [cite: 8] */
            cursor: pointer; [cite_start]/* [cite: 8] */
            transition: background-color 0.3s ease; [cite_start]/* [cite: 8] */
        [cite_start]} /* [cite: 9] */
        .chat-list-item:hover {
            background-color: #f0f0f0; [cite_start]/* [cite: 9] */
        [cite_start]} /* [cite: 10] */
        .chat-list-item.active {
            background-color: #e0e0e0; [cite_start]/* [cite: 10] */
        [cite_start]} /* [cite: 11] */
        .chat-list-item img {
            width: 40px; [cite_start]/* [cite: 11] */
            height: 40px; [cite_start]/* [cite: 12] */
            border-radius: 50%; [cite_start]/* [cite: 12] */
            margin-right: 10px; [cite_start]/* [cite: 12] */
            object-fit: cover; [cite_start]/* [cite: 12] */
        }
        .chat-list-item-info strong {
            display: block; [cite_start]/* [cite: 12] */
            font-size: 16px; [cite_start]/* [cite: 13] */
            color: #333; [cite_start]/* [cite: 13] */
        }
        .chat-list-item-info span {
            font-size: 14px; [cite_start]/* [cite: 14] */
            color: #777; [cite_start]/* [cite: 14] */
        }

        #messages-display {
            flex-grow: 1; [cite_start]/* [cite: 14] */
            overflow-y: auto; [cite_start]/* [cite: 15] */
            padding: 20px; [cite_start]/* [cite: 15] */
            display: flex; [cite_start]/* [cite: 15] */
            flex-direction: column; [cite_start]/* Para mensagens mais antigas em cima, mais novas embaixo */ /* [cite: 15] */
        }
        .message-bubble {
            max-width: 70%; [cite_start]/* [cite: 15] */
            padding: 10px 15px; [cite_start]/* [cite: 16] */
            border-radius: 20px; [cite_start]/* [cite: 16] */
            margin-bottom: 10px; [cite_start]/* [cite: 16] */
            line-height: 1.4; [cite_start]/* [cite: 16] */
            word-wrap: break-word; [cite_start]/* [cite: 16] */
        [cite_start]} /* [cite: 17] */
        .message-bubble.sent {
            background-color: #3f51b5; [cite_start]/* [cite: 17] */
            color: white; [cite_start]/* [cite: 18] */
            align-self: flex-end; [cite_start]/* [cite: 18] */
            border-bottom-right-radius: 5px; [cite_start]/* [cite: 18] */
        }
        .message-bubble.received {
            background-color: #e0e0e0; [cite_start]/* [cite: 18] */
            color: #333; [cite_start]/* [cite: 19] */
            align-self: flex-start; [cite_start]/* [cite: 19] */
            border-bottom-left-radius: 5px; [cite_start]/* [cite: 19] */
        }
        .message-meta {
            font-size: 10px; [cite_start]/* [cite: 19] */
            color: #999; [cite_start]/* [cite: 20] */
            margin-top: 5px; [cite_start]/* [cite: 20] */
            text-align: right; [cite_start]/* [cite: 20] */
        }
        .message-bubble.received .message-meta {
            text-align: left; [cite_start]/* [cite: 20] */
        [cite_start]} /* [cite: 21] */
        .message-bubble.system { /* Estilo para mensagens do sistema */
            background-color: #d1ecf1; [cite_start]/* [cite: 21] */
            color: #0c5460; [cite_start]/* [cite: 22] */
            align-self: center; [cite_start]/* [cite: 22] */
            font-size: 0.9em; [cite_start]/* [cite: 22] */
            text-align: center; [cite_start]/* [cite: 22] */
            width: 90%; [cite_start]/* [cite: 22] */
            border-radius: 10px; [cite_start]/* [cite: 22] */
        [cite_start]} /* [cite: 23] */


        #message-input-area {
            padding: 15px; [cite_start]/* [cite: 23] */
            border-top: 1px solid #e0e0e0; [cite_start]/* [cite: 24] */
            display: flex; [cite_start]/* [cite: 24] */
            background-color: #ffffff; [cite_start]/* [cite: 24] */
        }
        #message-input {
            flex-grow: 1; [cite_start]/* [cite: 24] */
            border: 1px solid #ccc; [cite_start]/* [cite: 25] */
            border-radius: 5px; [cite_start]/* [cite: 25] */
            padding: 10px 15px; [cite_start]/* [cite: 25] */
            font-size: 16px; [cite_start]/* [cite: 25] */
            margin-right: 10px; [cite_start]/* [cite: 25] */
            outline: none; [cite_start]/* [cite: 25] */
            resize: none; [cite_start]/* [cite: 25] */
            min-height: 40px; [cite_start]/* [cite: 26] */
            max-height: 100px; [cite_start]/* [cite: 26] */
            overflow-y: auto; [cite_start]/* [cite: 26] */
        }
        #send-button {
            min-width: 60px; [cite_start]/* [cite: 26] */
            height: 40px; [cite_start]/* [cite: 27] */
            padding: 0 15px; [cite_start]/* [cite: 27] */
        }

        /* Estilos para o cabeçalho da conversa */
        #chat-header {
            padding: 15px 20px; [cite_start]/* [cite: 27] */
            border-bottom: 1px solid #e0e0e0; [cite_start]/* [cite: 28] */
            background-color: #ffffff; [cite_start]/* [cite: 28] */
            display: flex; [cite_start]/* [cite: 28] */
            align-items: center; [cite_start]/* [cite: 28] */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); [cite_start]/* [cite: 28] */
        [cite_start]} /* [cite: 29] */
        #chat-header img {
            width: 50px; [cite_start]/* [cite: 29] */
            height: 50px; [cite_start]/* [cite: 30] */
            border-radius: 50%; [cite_start]/* [cite: 30] */
            margin-right: 15px; [cite_start]/* [cite: 30] */
            object-fit: cover; [cite_start]/* [cite: 30] */
        }
        #chat-header h3 {
            margin: 0; [cite_start]/* [cite: 30] */
            color: #333; [cite_start]/* [cite: 31] */
            font-size: 18px; [cite_start]/* [cite: 31] */
        }

        /* Estilos para os Diálogos */
        .mdl-dialog {
            width: 400px; [cite_start]/* [cite: 31] */
            [cite_start]/* Largura padrão para diálogos */ /* [cite: 32] */
        }
        .mdl-dialog__content {
            padding: 20px; [cite_start]/* [cite: 32] */
        [cite_start]} /* [cite: 33] */
        .mdl-dialog__actions {
            padding: 10px 20px; [cite_start]/* [cite: 33] */
        [cite_start]} /* [cite: 34] */

        /* Estilos específicos para o Diálogo de Registro de Matéria */
        #register-material-dialog {
            width: 90%; [cite_start]/* [cite: 34] */
            [cite_start]/* Ajuste a largura conforme necessário */ /* [cite: 35] */
            max-width: 600px; [cite_start]/* [cite: 36] */
        }
        #register-material-dialog .mdl-textfield {
            width: 100%; [cite_start]/* [cite: 36] */
            margin-bottom: 20px; [cite_start]/* [cite: 37] */
        }
        #register-material-dialog .mdl-button {
            margin-top: 20px; [cite_start]/* [cite: 38] */
            width: 100%; [cite_start]/* [cite: 38] */
        }
        .message-box {
            margin-top: 20px; [cite_start]/* [cite: 38] */
            padding: 15px; [cite_start]/* [cite: 39] */
            border-radius: 4px; [cite_start]/* [cite: 39] */
            font-weight: bold; [cite_start]/* [cite: 39] */
            text-align: center; [cite_start]/* [cite: 39] */
            display: none; [cite_start]/* [cite: 39] */
        [cite_start]} /* [cite: 40] */
        .message-box.success {
            background-color: #d4edda; [cite_start]/* [cite: 40] */
            color: #155724; [cite_start]/* [cite: 41] */
            border: 1px solid #c3e6cb; [cite_start]/* [cite: 41] */
        }
        .message-box.error {
            background-color: #f8d7da; [cite_start]/* [cite: 41] */
            color: #721c24; [cite_start]/* [cite: 42] */
            border: 1px solid #f5c6cb; [cite_start]/* [cite: 42] */
        }
        #register-material-dialog textarea {
            resize: vertical; [cite_start]/* [cite: 42] */
            min-height: 100px; [cite_start]/* [cite: 43] */
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <main class="mdl-layout__content">
            <div id="left-panel">
                <div style="padding: 15px; border-bottom: 1px solid #e0e0e0; background-color: #f5f5f5; display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0; color: #555;">Conversas Recentes</h4>
                    <button id="add-contact-button" class="mdl-button mdl-js-button mdl-button--icon">
                        <i class="material-icons">person_add</i>
                    </button>
                </div>
                <div style="padding: 10px 15px; border-bottom: 1px solid #e0e0e0; background-color: #fff;">
                    <button id="contact-support-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" style="width: 100%;">
                        <i class="material-icons">help_outline</i> Contatar Suporte
                    </button>
                </div>
                <ul id="recent-chats-list">
                </ul> </div>

            <div id="chat-main-area">
                <div id="chat-header">
                    <h3>Selecione uma Conversa</h3>
                </div>

                <div id="messages-display">
                </div> <div id="message-input-area">
                    <textarea id="message-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
                    <button id="send-button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
                        <i class="material-icons">send</i>
                    </button>
                </div>
            </div>
        </main>

        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer__left-section">
                <div class="mdl-logo">WZZM © 2025</div> <ul class="mdl-mini-footer__link-list">
                    <li><a href="./Privacidade/">Privacidade</a></li>
                    <li><a href="https://wikizero.wzzm.org/">Doações</a></li>
                </ul>
            </div>
            <div class="mdl-mini-footer__right-section">
                <button id="login-google" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" style="display: none;">
                    <i class="material-icons">account_circle</i> Login com Google
                </button>
                <button id="login-github" class="mdl-button mdl-js-button mdl-button--raised" style="display: none;">
                    <i class="material-icons">code</i> Login com GitHub
                </button> <button id="logout-button" class="mdl-button mdl-js-button mdl-button--accent" style="display: none;">
                    <i class="material-icons">exit_to_app</i> Sair
                </button>
                <button id="admin-panel-button" class="mdl-button mdl-js-button mdl-button--primary" style="display: none;">
                    <i class="material-icons">admin_panel_settings</i> Admin
                </button> </div>
        </footer>

        <dialog class="mdl-dialog" id="add-contact-dialog">
            <h4 class="mdl-dialog__title">Adicionar Novo Contato</h4> <div class="mdl-dialog__content">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width: 100%;">
                    <input class="mdl-textfield__input" type="text" id="contact-uid-input">
                    <label class="mdl-textfield__label" for="contact-uid-input">UID Google do Contato</label>
                </div>
                <p id="contact-search-status" style="color: grey; font-size: 14px; margin-top: 10px;"></p> <div id="found-contact-info" style="display: none; margin-top: 15px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #f9f9f9;"> <img id="found-contact-pic" src="" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; vertical-align: middle;"> <strong id="found-contact-name"></strong>
                </div>
            </div>
            <div class="mdl-dialog__actions">
                <button type="button" class="mdl-button" id="start-chat-button" disabled>Iniciar Chat</button>
                <button type="button" class="mdl-button close-dialog">Cancelar</button> </div>
        </dialog>

        <dialog class="mdl-dialog" id="register-material-dialog">
            <h4 class="mdl-dialog__title">Registrar Nova Matéria</h4>
            <div class="mdl-dialog__content">
                <form id="material-form-modal">
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="text" id="material-title-modal" required>
                        <label class="mdl-textfield__label" for="material-title-modal">Título da Matéria</label>
                    </div>

                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <textarea class="mdl-textfield__input" type="text" rows="5" id="material-description-modal" required></textarea>
                        <label class="mdl-textfield__label" for="material-description-modal">Descrição da Matéria</label>
                    </div>

                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="text" id="material-category-modal" required>
                        <label class="mdl-textfield__label" for="material-category-modal">Categoria (Ex: Notícias, Tutoriais, Eventos)</label>
                    </div>

                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="url" id="material-image-url-modal">
                        <label class="mdl-textfield__label" for="material-image-url-modal">URL da Imagem de Destaque (Opcional)</label>
                    </div>

                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"> <input class="mdl-textfield__input" type="text" id="material-tags-modal">
                        <label class="mdl-textfield__label" for="material-tags-modal">Tags (separadas por vírgula, Ex: tecnologia, jogos, update)</label>
                        <span class="mdl-textfield__help">Separe as tags com vírgula.</span>
                    </div> <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                        <i class="material-icons">save</i> Salvar Matéria
                    </button>
                </form> <div id="material-message-box" class="message-box"></div>
            </div>
            <div class="mdl-dialog__actions">
                <button type="button" class="mdl-button close-dialog-material">Cancelar</button>
            </div>
        </dialog>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <script>
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            [cite_start]messagingSenderId: "249427877153", /* [cite: 67] */
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };
        [cite_start]if (!firebase.apps.length) { /* [cite: 68] */
            firebase.initializeApp(firebaseConfig); [cite_start]/* [cite: 69] */
        }

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore(); [cite_start]/* [cite: 69] */
        const analytics = firebase.analytics(); [cite_start]/* [cite: 70] */

        // --- Elementos da UI ---
        const loginGoogleButton = document.getElementById('login-google'); [cite_start]/* [cite: 70] */
        const loginGitHubButton = document.getElementById('login-github'); [cite_start]/* [cite: 71] */
        const logoutButton = document.getElementById('logout-button'); [cite_start]/* [cite: 71] */
        const adminPanelButton = document.getElementById('admin-panel-button'); [cite_start]/* [cite: 71] */
        // --- Elementos da UI do Chat ---
        const recentChatsList = document.getElementById('recent-chats-list'); [cite_start]/* [cite: 72] */
        const chatHeader = document.getElementById('chat-header'); [cite_start]/* [cite: 73] */
        const messagesDisplay = document.getElementById('messages-display'); [cite_start]/* [cite: 73] */
        const messageInput = document.getElementById('message-input'); [cite_start]/* [cite: 73] */
        const sendButton = document.getElementById('send-button'); [cite_start]/* [cite: 74] */
        // Elementos do Diálogo de Adicionar Contato
        const addContactButton = document.getElementById('add-contact-button'); [cite_start]/* [cite: 74] */
        const addContactDialog = document.getElementById('add-contact-dialog'); [cite_start]/* [cite: 75] */
        const contactUidInput = document.getElementById('contact-uid-input'); [cite_start]/* [cite: 75] */
        const contactSearchStatus = document.getElementById('contact-search-status'); [cite_start]/* [cite: 75] */
        const foundContactInfo = document.getElementById('found-contact-info'); [cite_start]/* [cite: 75] */
        const foundContactPic = document.getElementById('found-contact-pic'); [cite_start]/* [cite: 76] */
        const foundContactName = document.getElementById('found-contact-name'); [cite_start]/* [cite: 76] */
        const startChatButton = document.getElementById('start-chat-button'); [cite_start]/* [cite: 76] */
        const closeDialogButtons = addContactDialog.querySelectorAll('.close-dialog'); [cite_start]/* [cite: 77] */
        // --- NOVO: Elementos da UI do Diálogo de Registro de Matéria ---
        const registerMaterialDialog = document.getElementById('register-material-dialog'); [cite_start]/* [cite: 77] */
        const materialFormModal = registerMaterialDialog.querySelector('#material-form-modal'); [cite_start]/* [cite: 78] */
        const materialTitleModal = registerMaterialDialog.querySelector('#material-title-modal'); [cite_start]/* [cite: 78] */
        const materialDescriptionModal = registerMaterialDialog.querySelector('#material-description-modal'); [cite_start]/* [cite: 78] */
        const materialCategoryModal = registerMaterialDialog.querySelector('#material-category-modal'); [cite_start]/* [cite: 78] */
        const materialImageUrlModal = registerMaterialDialog.querySelector('#material-image-url-modal'); [cite_start]/* [cite: 79] */
        const materialTagsModal = registerMaterialDialog.querySelector('#material-tags-modal'); [cite_start]/* [cite: 79] */
        const materialMessageBox = registerMaterialDialog.querySelector('#material-message-box'); [cite_start]/* [cite: 79] */
        const closeMaterialDialogButtons = registerMaterialDialog.querySelectorAll('.close-dialog-material'); [cite_start]/* [cite: 79] */

        // --- NOVO: Elemento do botão de Contato de Suporte ---
        const contactSupportButton = document.getElementById('contact-support-button');

        const ADMIN_UIDS = ['6aPqWVh8JVYL5NqEb78iDGPD7dH3', 'sZxfMuOBPbXdR8nttVPXIN8QOOl1'];
        const SUPPORT_CHAT_PSEUDO_ID = 'support_chat_thread'; // Um ID especial para sinalizar mensagens de suporte

        let currentUser = null; [cite_start]/* [cite: 80] */
        // O usuário atualmente logado
        let currentChatId = null; [cite_start]/* [cite: 81] */
        // O ID da conversa atualmente selecionada
        let unsubscribeMessages = null; [cite_start]/* [cite: 82] */
        // Variável para a função de desinscrição do listener de mensagens
        let foundContactUid = null; [cite_start]/* [cite: 83] */
        // UID do contato encontrado no diálogo

        // --- Funções de Autenticação ---
        const handleLogout = () => {
            auth.signOut().then(() => {
                console.log("Usuário deslogado.");
                loginGoogleButton.style.display = 'inline-block';
                loginGitHubButton.style.display = 'inline-block';
                [cite_start]logoutButton.style.display = 'none'; /* [cite: 84] */
                adminPanelButton.style.display = 'none'; [cite_start]/* [cite: 84] */

                recentChatsList.innerHTML = ''; [cite_start]/* [cite: 84] */
                messagesDisplay.innerHTML = '<p style="text-align: center; color: #666;">Por favor, faça login para iniciar o chat.</p>'; [cite_start]/* [cite: 84] */
                chatHeader.innerHTML = '<h3>Selecione uma Conversa</h3>'; [cite_start]/* [cite: 85] */
                messageInput.value = ''; [cite_start]/* [cite: 85] */
                messageInput.disabled = true; [cite_start]/* [cite: 85] */
                sendButton.disabled = true; [cite_start]/* [cite: 85] */
                addContactButton.style.display = 'none'; [cite_start]// Esconde o botão adicionar contato /* [cite: 85] */

                if (unsubscribeMessages) {
                    unsubscribeMessages(); [cite_start]/* [cite: 86] */
                [cite_start]} /* [cite: 87] */
            }).catch((error) => {
                [cite_start]console.error("Erro ao fazer logout:", error); /* [cite: 87] */
                alert(`Erro ao fazer logout: ${error.message}`); [cite_start]/* [cite: 87] */
            }); [cite_start]/* [cite: 88] */
        };

        loginGoogleButton.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                [cite_start]console.error("Erro ao fazer login com Google:", error); /* [cite: 89] */
                alert(`Erro ao fazer login com Google: ${error.message}`); [cite_start]/* [cite: 89] */
            }
        }); [cite_start]/* [cite: 90] */
        loginGitHubButton.addEventListener('click', async () => {
            const provider = new firebase.auth.GithubAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                [cite_start]console.error("Erro ao fazer login com GitHub:", error); /* [cite: 91] */
                alert(`Erro ao fazer login com GitHub: ${error.message}`); [cite_start]/* [cite: 91] */
            }
        }); [cite_start]/* [cite: 92] */
        // --- NEW: Função para criar notificações ---
        async function createNotification(recipientUid, notificationData) {
            if (!recipientUid) {
                console.error("UID do usuário receptor é necessário para criar notificação."); [cite_start]/* [cite: 92] */
                return; [cite_start]/* [cite: 93] */
            }
            try {
                await firestore.collection('users').doc(recipientUid).collection('notifications').add(notificationData); [cite_start]/* [cite: 93] */
                console.log("Notificação de chat criada para", recipientUid); [cite_start]/* [cite: 94] */
            } catch (error) {
                console.error("Erro ao criar notificação de chat:", error); [cite_start]/* [cite: 94] */
            [cite_start]} /* [cite: 95] */
        }


        // --- Funções Firebase para o Chat ---

        // 1. Criar um documento de perfil de usuário
        async function createUserProfileDocument(user) {
            if (!user) return; [cite_start]/* [cite: 95] */
            const userRef = firestore.collection('users').doc(user.uid); [cite_start]/* [cite: 96] */
            const docSnapshot = await userRef.get(); [cite_start]/* [cite: 96] */

            if (!docSnapshot.exists) {
                const { displayName, email, photoURL } = user; [cite_start]/* [cite: 96] */
                const createdAt = firebase.firestore.FieldValue.serverTimestamp(); [cite_start]/* [cite: 97] */
                try {
                    await userRef.set({
                        [cite_start]uid: user.uid, /* [cite: 97] */
                        [cite_start]name: displayName, /* [cite: 98] */
                        [cite_start]email: email, /* [cite: 98] */
                        [cite_start]profilePictureUrl: photoURL, /* [cite: 98] */
                        [cite_start]createdAt: createdAt, /* [cite: 98] */
                        [cite_start]lastLoginAt: createdAt, /* [cite: 99] */
                        [cite_start]isBan: false, /* [cite: 99] */
                        [cite_start]isAdmin: false, /* [cite: 99] */
                    });
                    console.log("Novo perfil de usuário criado no Firestore!"); [cite_start]/* [cite: 100] */
                } catch (error) {
                    console.error("Erro ao criar perfil de usuário no Firestore:", error); [cite_start]/* [cite: 100] */
                [cite_start]} /* [cite: 101] */
            } else {
                try {
                    await userRef.update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                    }); [cite_start]/* [cite: 101] */
                    console.log("Perfil de usuário atualizado no Firestore (lastLoginAt)."); [cite_start]/* [cite: 102] */
                } catch (error) {
                    console.error("Erro ao atualizar perfil de usuário no Firestore:", error); [cite_start]/* [cite: 102] */
                [cite_start]} /* [cite: 103] */
            }
        }

        // 2. Função para criar ou obter uma conversa
        async function getOrCreateChat(otherUserId) {
            if (!currentUser) {
                console.error("Nenhum usuário logado para criar/obter chat."); [cite_start]/* [cite: 103] */
                return null; [cite_start]/* [cite: 104] */
            }

            const currentUserId = currentUser.uid; [cite_start]/* [cite: 104] */
            // Impedir que o usuário adicione a si mesmo
            if (currentUserId === otherUserId) {
                alert("Você não pode iniciar um chat consigo mesmo."); [cite_start]/* [cite: 105] */
                return null; [cite_start]/* [cite: 106] */
            }

            const chatRef = firestore.collection('wwebmodmail'); [cite_start]/* [cite: 106] */
            const query1 = await chatRef
                .where('participants', 'array-contains', currentUserId)
                .get(); [cite_start]/* [cite: 107] */
            let existingChatId = null; [cite_start]/* [cite: 108] */

            for (const doc of query1.docs) {
                const participants = doc.data().participants; [cite_start]/* [cite: 108] */
                if (participants && participants.includes(otherUserId)) {
                    existingChatId = doc.id; [cite_start]/* [cite: 109] */
                    break;
                }
            }

            if (existingChatId) {
                console.log("Chat existente encontrado:", existingChatId); [cite_start]/* [cite: 110] */
                return existingChatId; [cite_start]/* [cite: 111] */
            } else {
                console.log("Criando novo chat com", otherUserId); [cite_start]/* [cite: 111] */
                try {
                    // Buscar nomes e fotos dos participantes para o título inicial do chat
                    const currentUserDoc = await firestore.collection('users').doc(currentUserId).get(); [cite_start]/* [cite: 112] */
                    const otherUserDoc = await firestore.collection('users').doc(otherUserId).get(); [cite_start]/* [cite: 113] */

                    const currentUserName = currentUserDoc.exists ? (currentUserDoc.data().name || currentUserDoc.data().email) : 'Você'; [cite_start]/* [cite: 113] */
                    const otherUserName = otherUserDoc.exists ? (otherUserDoc.data().name || otherUserDoc.data().email) : 'Usuário Desconhecido'; [cite_start]/* [cite: 114] */

                    const newChat = await chatRef.add({
                        [cite_start]participants: [currentUserId, otherUserId], /* [cite: 114] */
                        [cite_start]createdAt: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 114] */
                        [cite_start]lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 114] */
                        [cite_start]lastMessageText: '', // Inicialmente sem mensagem /* [cite: 115] */
                        participantNames: {
                            [cite_start][currentUserId]: currentUserName, /* [cite: 115] */
                            [cite_start][otherUserId]: otherUserName /* [cite: 116] */
                        }
                    });
                    console.log("Novo chat criado com ID:", newChat.id); [cite_start]/* [cite: 117] */
                    return newChat.id; [cite_start]/* [cite: 117] */
                } catch (error) {
                    console.error("Erro ao criar novo chat:", error); [cite_start]/* [cite: 118] */
                    return null; [cite_start]/* [cite: 118] */
                }
            }
        }

        // 3. Função para enviar mensagem
        async function sendMessage(chatId, text) {
            if (!currentUser || !text.trim()) {
                console.warn("Não é possível enviar mensagem: usuário não logado ou mensagem vazia.");
                return;
            }

            // 1. Verificar se o usuário é administrador
            const userDocRef = firestore.collection('users').doc(currentUser.uid); [cite_start]/* [cite: 119] */
            const userDoc = await userDocRef.get(); [cite_start]/* [cite: 120] */
            const isAdmin = userDoc.exists && userDoc.data().isAdmin === true; [cite_start]/* [cite: 121] */

            // --- Lógica para o comando de atualização financeira (doações) ---
            if (isAdmin && text.startsWith('@donationupdate')) {
                console.log("Comando de atualização financeira detectado por admin."); [cite_start]/* [cite: 121] */
                const now = new Date(); [cite_start]/* [cite: 122] */
                const currentMonth = now.getMonth() + 1; [cite_start]/* [cite: 122] */
                const currentYear = now.getFullYear(); [cite_start]/* [cite: 122] */
                const monthYearId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`; [cite_start]/* [cite: 123] */
                let updatedData = {}; [cite_start]/* [cite: 123] */
                let success = true; [cite_start]/* [cite: 123] */

                const parseValue = (pattern) => {
                    const match = text.match(pattern); [cite_start]/* [cite: 124] */
                    if (match && match[1]) {
                        // Substitui vírgula por ponto para parsear corretamente como float
                        return parseFloat(match[1].replace(',', '.')); [cite_start]/* [cite: 124] */
                    }
                    return null; [cite_start]/* [cite: 125] */
                }; [cite_start]/* [cite: 126] */

                const totalDonations = parseValue(/Doações recebidas: \|\|Cont:(\d{1,},\d{2})R\$\}/); [cite_start]/* [cite: 126] */
                const firebaseCost = parseValue(/Custo Firebase \(Previsão\): \|\|ContF:(\d{1,},\d{2})R\$\}/); [cite_start]/* [cite: 127] */
                const workspaceCost = parseValue(/Custo Google Workspace \(Previsão\): \|\|ContG:(\d{1,},\d{2})R\$\}/); [cite_start]/* [cite: 127] */

                if (totalDonations !== null) updatedData.totalDonations = totalDonations; [cite_start]/* [cite: 128] */
                if (firebaseCost !== null) updatedData.firebaseCost = firebaseCost; [cite_start]/* [cite: 128] */
                if (workspaceCost !== null) updatedData.workspaceCost = workspaceCost; [cite_start]/* [cite: 128] */
                if (Object.keys(updatedData).length > 0) {
                    try {
                        await firestore.collection('financialData').doc(monthYearId).set(updatedData, { merge: true }); [cite_start]/* [cite: 129] */
                        console.log("Dados financeiros atualizados no Firestore:", updatedData); [cite_start]/* [cite: 130] */
                        await firestore.collection('wwebmodmail').doc(chatId).collection('messages').add({
                            senderId: currentUser.uid, // O próprio admin envia a mensagem de confirmação
                            text: `✅ Dados financeiros atualizados para ${monthYearId}.`,
                            [cite_start]timestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 131] */
                            isSystemMessage: true // Identifica como mensagem de sistema
                        }); [cite_start]/* [cite: 132] */
                    } catch (error) {
                        console.error("Erro ao atualizar dados financeiros:", error); [cite_start]/* [cite: 132] */
                        await firestore.collection('wwebmodmail').doc(chatId).collection('messages').add({
                            [cite_start]senderId: currentUser.uid, /* [cite: 133] */
                            [cite_start]text: `❌ Erro ao atualizar dados financeiros: ${error.message}`, /* [cite: 133] */
                            [cite_start]timestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 134] */
                            isSystemMessage: true
                        }); [cite_start]/* [cite: 135] */
                        success = false; [cite_start]/* [cite: 135] */
                    }
                } else {
                    console.warn("Comando de atualização financeira inválido ou incompleto."); [cite_start]/* [cite: 135] */
                    await firestore.collection('wwebmodmail').doc(chatId).collection('messages').add({
                        [cite_start]senderId: currentUser.uid, /* [cite: 136] */
                        [cite_start]text: "⚠️ Comando de atualização financeira inválido. Formato: @donationupdate Doações recebidas: ||Cont:{{VALOR}} Custo Firebase: ||ContF:{{VALOR}} Custo Google Workspace: ||ContG:{{VALOR}}", /* [cite: 136] */
                        [cite_start]timestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 137] */
                        isSystemMessage: true
                    }); [cite_start]/* [cite: 138] */
                    success = false; [cite_start]/* [cite: 138] */
                }

                if (success) {
                    messageInput.value = ''; [cite_start]/* [cite: 138] */
                    messageInput.style.height = 'auto'; [cite_start]/* [cite: 139] */
                    messagesDisplay.scrollTop = messagesDisplay.scrollHeight; [cite_start]/* [cite: 139] */
                    return; // Termina a função aqui para não enviar como mensagem normal
                }
            }
            // --- FIM Lógica para o comando de atualização financeira ---

            // --- NOVO: Lógica para o comando de registro de notícia ---
            [cite_start]if (isAdmin && text.trim() === '$#registrarnoticia$') { /* [cite: 140] */
                const registerMaterialDialog = document.getElementById('register-material-dialog'); [cite_start]/* [cite: 140] */
                [cite_start]if (!registerMaterialDialog.showModal) { /* [cite: 141] */
                    dialogPolyfill.registerDialog(registerMaterialDialog); [cite_start]/* [cite: 142] */
                }
                registerMaterialDialog.showModal(); [cite_start]/* [cite: 142] */
                messageInput.value = ''; [cite_start]/* [cite: 142] */
                // Limpa o comando do input
                messageInput.style.height = 'auto'; [cite_start]/* [cite: 143] */
                return; // Impede que o comando seja enviado como uma mensagem normal
            }
            // --- FIM NOVO ---

            // --- NOVO: Lógica para enviar mensagem para o suporte ---
            if (currentChatId === SUPPORT_CHAT_PSEUDO_ID) {
                const emailRef = firestore.collection('email');
                try {
                    await emailRef.add({
                        senderId: currentUser.uid,
                        text: text.trim(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        recipientAdmins: ADMIN_UIDS, // Para direcionar a mensagem aos administradores
                        chatThreadId: currentUser.uid // Identificador para agrupar conversas de suporte por usuário
                    });
                    console.log("Mensagem de suporte enviada para a coleção 'email'!");
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                    return; // Termina a função para não processar como chat normal
                } catch (error) {
                    console.error("Erro ao enviar mensagem de suporte:", error);
                    alert("Erro ao enviar mensagem de suporte.");
                    return;
                }
            }
            // --- FIM NOVO ---

            // Se não for um comando de admin ou mensagem de suporte, envia para o chat normal
            const messagesRef = firestore.collection('wwebmodmail').doc(chatId).collection('messages'); [cite_start]/* [cite: 144] */
            try {
                await messagesRef.add({
                    [cite_start]senderId: currentUser.uid, /* [cite: 145] */
                    [cite_start]text: text.trim(), /* [cite: 145] */
                    [cite_start]timestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 145] */
                }); [cite_start]/* [cite: 146] */
                // Opcional: Atualizar o lastMessageTimestamp no documento pai do chat
                await firestore.collection('wwebmodmail').doc(chatId).update({
                    [cite_start]lastMessageTimestamp: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 146] */
                    [cite_start]lastMessageText: text.trim(), // Para exibir na lista de conversas /* [cite: 146] */
                }); [cite_start]/* [cite: 147] */
                console.log("Mensagem enviada!"); [cite_start]/* [cite: 147] */
                messageInput.value = ''; [cite_start]// Limpa a caixa de texto /* [cite: 147] */
                messageInput.style.height = 'auto'; [cite_start]/* [cite: 148] */
                // Reseta a altura do textarea
                messagesDisplay.scrollTop = messagesDisplay.scrollHeight; [cite_start]/* [cite: 149] */
                // Rola para o final das mensagens

                // Lógica para criar notificação para o receptor
                const chatDoc = await firestore.collection('wwebmodmail').doc(chatId).get(); [cite_start]/* [cite: 149] */
                [cite_start]if (chatDoc.exists) { /* [cite: 150] */
                    const chatData = chatDoc.data(); [cite_start]/* [cite: 151] */
                    const participants = chatData.participants || []; [cite_start]/* [cite: 151] */
                    const recipientId = participants.find(uid => uid !== currentUser.uid); [cite_start]/* [cite: 152] */
                    // Encontra o outro participante

                    if (recipientId) {
                        const senderName = currentUser.displayName || currentUser.email; [cite_start]/* [cite: 153] */
                        const notificationData = {
                            [cite_start]type: 'new_chat_message', /* [cite: 153] */
                            [cite_start]title: `Nova Mensagem de ${senderName}`, /* [cite: 153] */
                            [cite_start]message: text.trim().substring(0, 100) + (text.trim().length > 100 ? '...' : ''), /* [cite: 154] */
                            [cite_start]chatId: chatId, /* [cite: 154] */
                            [cite_start]senderUid: currentUser.uid, /* [cite: 154] */
                            [cite_start]read: false, /* [cite: 154] */
                            [cite_start]timestamp: firebase.firestore.FieldValue.serverTimestamp() /* [cite: 155] */
                        };
                        await createNotification(recipientId, notificationData); [cite_start]/* [cite: 156] */
                    }
                }

            } catch (error) {
                console.error("Erro ao enviar mensagem:", error); [cite_start]/* [cite: 157] */
                alert("Erro ao enviar mensagem."); [cite_start]/* [cite: 157] */
            }
        }

        // 4. Carregar mensagens de um chat
        function loadMessages(chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); [cite_start]/* [cite: 157] */
                // Desinscreve-se do listener anterior
            }
            messagesDisplay.innerHTML = ''; [cite_start]/* [cite: 158] */
            // Limpa as mensagens anteriores

            if (!chatId) {
                chatHeader.innerHTML = '<h3>Selecione uma Conversa</h3>'; [cite_start]/* [cite: 159] */
                return;
            }

            // NOVO: Se o chatId for o pseudo-ID do suporte, carrega as mensagens do suporte
            if (chatId === SUPPORT_CHAT_PSEUDO_ID) {
                loadSupportMessages(currentUser.uid);
                return;
            }

            const messagesRef = firestore.collection('wwebmodmail').doc(chatId).collection('messages'); [cite_start]/* [cite: 160] */
            unsubscribeMessages = messagesRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                [cite_start]messagesDisplay.innerHTML = ''; // Limpa para redesenhar /* [cite: 161] */
                snapshot.forEach(doc => {
                    const message = doc.data();
                    [cite_start]const isSent = message.senderId === currentUser.uid; /* [cite: 161] */
                    const isSystem = message.isSystemMessage === true; [cite_start]// Verifica se é mensagem de sistema /* [cite: 162] */

                    const messageBubble = document.createElement('div');
                    messageBubble.classList.add('message-bubble'); [cite_start]/* [cite: 162] */
                    if (isSystem) {
                        messageBubble.classList.add('system'); [cite_start]// Adiciona a classe 'system' /* [cite: 163] */
                    } else {
                        messageBubble.classList.add(isSent ? 'sent' : 'received'); [cite_start]/* [cite: 163] */
                    }

                    const timestampDate = message.timestamp ? message.timestamp.toDate() : new Date(); [cite_start]/* [cite: 164] */
                    const timeString = timestampDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); [cite_start]/* [cite: 164] */
                    if (isSystem) {
                        messageBubble.innerHTML = `${message.text}`; [cite_start]/* [cite: 165] */
                    } else {
                        messageBubble.innerHTML = `${message.text}<br>
                            <div class="message-meta">${isSent ? 'Você' : 'Contato'}, ${timeString}</div>`; [cite_start]/* [cite: 167] */
                    }
                    messagesDisplay.appendChild(messageBubble); [cite_start]/* [cite: 168] */
                });
                messagesDisplay.scrollTop = messagesDisplay.scrollHeight; [cite_start]/* [cite: 168] */
            }, error => {
                console.error("Erro no listener de mensagens:", error); [cite_start]/* [cite: 169] */
                messagesDisplay.innerHTML = `<p style="color: red;">Erro ao carregar mensagens: ${error.message}</p>`; [cite_start]/* [cite: 169] */
            }); [cite_start]/* [cite: 170] */
        }

        // NOVO: Função para carregar mensagens do chat de suporte (coleção 'email')
        function loadSupportMessages(userId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Desinscreve-se do listener anterior
            }
            messagesDisplay.innerHTML = ''; // Limpa as mensagens anteriores

            if (!userId) {
                chatHeader.innerHTML = '<h3>Selecione uma Conversa</h3>';
                return;
            }

            // Ouve mensagens onde o remetente é o usuário atual OU o destinatário é o usuário atual
            // (Assumindo que respostas do admin teriam recipientUser = userId)
            unsubscribeMessages = firestore.collection('email')
                .where('chatThreadId', '==', userId) // Agrupa por um ID de thread, aqui o UID do usuário
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    messagesDisplay.innerHTML = '';
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const isSent = message.senderId === currentUser.uid; // Se a mensagem foi enviada pelo usuário logado

                        const messageBubble = document.createElement('div');
                        messageBubble.classList.add('message-bubble');
                        messageBubble.classList.add(isSent ? 'sent' : 'received'); // Admins replies will be 'received'

                        const timestampDate = message.timestamp ? message.timestamp.toDate() : new Date();
                        const timeString = timestampDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        messageBubble.innerHTML = `${message.text}<br>
                            <div class="message-meta">${isSent ? 'Você' : 'Suporte'}, ${timeString}</div>`;
                        messagesDisplay.appendChild(messageBubble);
                    });
                    messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
                }, error => {
                    console.error("Erro no listener de mensagens de suporte:", error);
                    messagesDisplay.innerHTML = `<p style="color: red;">Erro ao carregar mensagens de suporte: ${error.message}</p>`;
                });
        }


        // 5. Carregar lista de conversas recentes
        function loadRecentChats() {
            if (!currentUser) {
                recentChatsList.innerHTML = ''; [cite_start]/* [cite: 170] */
                return; [cite_start]/* [cite: 171] */
            }

            firestore.collection('wwebmodmail')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTimestamp', 'desc')
                .onSnapshot(async snapshot => {
                    [cite_start]recentChatsList.innerHTML = ''; // Limpa a lista existente /* [cite: 171] */
                    for (const doc of snapshot.docs) {
                        const chat = doc.data(); [cite_start]/* [cite: 172] */
                        const chatId = doc.id; [cite_start]/* [cite: 172] */
                        const otherUserId = chat.participants.find(uid => uid !== currentUser.uid); [cite_start]/* [cite: 173] */

                        let otherUserName = "Usuário Desconhecido"; [cite_start]/* [cite: 173] */
                        let otherUserPic = "https://via.placeholder.com/40"; [cite_start]// Imagem padrão /* [cite: 173] */

                        [cite_start]if (otherUserId) { /* [cite: 174] */
                            try {
                                const otherUserDoc = await firestore.collection('users').doc(otherUserId).get(); [cite_start]/* [cite: 174] */
                                [cite_start]if (otherUserDoc.exists) { /* [cite: 175] */
                                    otherUserName = otherUserDoc.data().name || otherUserDoc.data().email; [cite_start]/* [cite: 176] */
                                    otherUserPic = otherUserDoc.data().profilePictureUrl || otherUserPic; [cite_start]/* [cite: 176] */
                                }
                            } catch (error) {
                                console.warn("Não foi possível obter informações do outro usuário:", otherUserId, error); [cite_start]/* [cite: 177] */
                            }
                        }

                        const listItem = document.createElement('li'); [cite_start]/* [cite: 177] */
                        listItem.classList.add('chat-list-item'); [cite_start]/* [cite: 178] */
                        listItem.dataset.chatId = chatId; [cite_start]/* [cite: 178] */
                        listItem.dataset.otherUserId = otherUserId; [cite_start]/* [cite: 178] */
                        listItem.innerHTML = `
                            <img src="${otherUserPic}" alt="${otherUserName} Avatar">
                            <div class="chat-list-item-info">
                                [cite_start]<strong>${otherUserName}</strong> /* [cite: 179] */
                                <span>${chat.lastMessageText || [cite_start]'Nenhuma mensagem.'}</span> /* [cite: 180] */
                            </div>
                        `;
                        recentChatsList.appendChild(listItem); [cite_start]/* [cite: 181] */

                        listItem.addEventListener('click', () => {
                            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
                            listItem.classList.add('active');

                            [cite_start]currentChatId = chatId; /* [cite: 181] */
                            chatHeader.innerHTML = `
                                <img src="${otherUserPic}" alt="${otherUserName} Avatar">
                                <h3>${otherUserName}</h3>
                            `; [cite_start]/* [cite: 183] */
                            loadMessages(chatId); [cite_start]/* [cite: 183] */
                        }); [cite_start]/* [cite: 184] */
                    }
                }, error => {
                    console.error("Erro ao carregar conversas recentes:", error); [cite_start]/* [cite: 184] */
                }); [cite_start]/* [cite: 185] */
        }

        // --- Event Listeners do Chat ---
        sendButton.addEventListener('click', () => {
            [cite_start]sendMessage(currentChatId, messageInput.value); /* [cite: 185] */
        }); [cite_start]/* [cite: 186] */
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Envia com Enter, nova linha com Shift+Enter
                e.preventDefault(); // Impede nova linha no textarea
                sendMessage(currentChatId, messageInput.value);
            }
        }); [cite_start]/* [cite: 187] */
        messageInput.addEventListener('input', () => {
            // Ajusta a altura do textarea automaticamente
            [cite_start]messageInput.style.height = 'auto'; /* [cite: 187] */
            messageInput.style.height = messageInput.scrollHeight + 'px'; [cite_start]/* [cite: 187] */
        }); [cite_start]/* [cite: 188] */
        // --- Event Listeners para o Diálogo de Adicionar Contato ---
        addContactButton.addEventListener('click', () => {
            [cite_start]addContactDialog.showModal(); /* [cite: 188] */
            contactUidInput.value = ''; [cite_start]/* [cite: 188] */
            contactSearchStatus.textContent = ''; [cite_start]/* [cite: 188] */
            foundContactInfo.style.display = 'none'; [cite_start]/* [cite: 188] */
            startChatButton.disabled = true; [cite_start]/* [cite: 188] */
            foundContactUid = null; [cite_start]/* [cite: 189] */
            if (componentHandler) componentHandler.upgradeElement(contactUidInput.parentElement); // Re-upgrade MDL textfield
        }); [cite_start]/* [cite: 190] */
        closeDialogButtons.forEach(button => {
            button.addEventListener('click', () => {
                [cite_start]addContactDialog.close(); /* [cite: 190] */
            });
        }); [cite_start]/* [cite: 191] */
        contactUidInput.addEventListener('input', async () => {
            [cite_start]const uid = contactUidInput.value.trim(); /* [cite: 191] */
            if (uid.length > 5) { // Espera um UID minimamente razoável
                contactSearchStatus.textContent = 'Buscando usuário...'; [cite_start]/* [cite: 191] */
                foundContactInfo.style.display = 'none'; [cite_start]/* [cite: 192] */
                startChatButton.disabled = true; [cite_start]/* [cite: 192] */
                foundContactUid = null; [cite_start]/* [cite: 192] */

                try {
                    const userDoc = await firestore.collection('users').doc(uid).get(); [cite_start]/* [cite: 192] */
                    if (userDoc.exists) {
                        const userData = userDoc.data(); [cite_start]/* [cite: 193] */
                        foundContactName.textContent = userData.name || userData.email; [cite_start]/* [cite: 193] */
                        foundContactPic.src = userData.profilePictureUrl || "https://via.placeholder.com/50"; [cite_start]/* [cite: 193] */
                        foundContactInfo.style.display = 'flex'; [cite_start]// Usar flex para alinhar img e texto /* [cite: 194] */
                        contactSearchStatus.textContent = 'Usuário encontrado!'; [cite_start]/* [cite: 194] */
                        startChatButton.disabled = false; [cite_start]/* [cite: 195] */
                        foundContactUid = uid; [cite_start]/* [cite: 195] */
                    } else {
                        contactSearchStatus.textContent = 'Usuário não encontrado.'; [cite_start]/* [cite: 196] */
                        foundContactInfo.style.display = 'none'; [cite_start]/* [cite: 196] */
                        startChatButton.disabled = true; [cite_start]/* [cite: 196] */
                        foundContactUid = null; [cite_start]/* [cite: 197] */
                    }
                } catch (error) {
                    console.error("Erro ao buscar usuário:", error); [cite_start]/* [cite: 197] */
                    contactSearchStatus.textContent = `Erro ao buscar: ${error.message}`; [cite_start]/* [cite: 197] */
                    foundContactInfo.style.display = 'none'; [cite_start]/* [cite: 197] */
                    startChatButton.disabled = true; [cite_start]/* [cite: 198] */
                    foundContactUid = null; [cite_start]/* [cite: 198] */
                }
            } else {
                contactSearchStatus.textContent = ''; [cite_start]/* [cite: 198] */
                foundContactInfo.style.display = 'none'; [cite_start]/* [cite: 199] */
                startChatButton.disabled = true; [cite_start]/* [cite: 199] */
                foundContactUid = null; [cite_start]/* [cite: 199] */
            }
        }); [cite_start]/* [cite: 200] */
        startChatButton.addEventListener('click', async () => {
            if (foundContactUid) {
                [cite_start]const newChatId = await getOrCreateChat(foundContactUid); /* [cite: 200] */
                if (newChatId) {
                    addContactDialog.close(); [cite_start]/* [cite: 201] */
                    // Opcional: Ativar o novo chat na UI
                    // Poderíamos simular um clique no item da lista de chats para ativá-lo
                    // Mas para simplificar, apenas fechamos o modal
                }
            }
        }); [cite_start]/* [cite: 202] */

        // NOVO: Event Listener para o botão de Contatar Suporte
        contactSupportButton.addEventListener('click', () => {
            startSupportChat();
        });

        // Função para iniciar um chat de suporte
        function startSupportChat() {
            if (!currentUser) {
                alert("Por favor, faça login para entrar em contato com o suporte.");
                return;
            }

            currentChatId = SUPPORT_CHAT_PSEUDO_ID; // Define o ID especial para o chat de suporte

            chatHeader.innerHTML = `
                <img src="https://via.placeholder.com/50/FF0000/FFFFFF?text=SUP" alt="Suporte Avatar">
                <h3>Suporte e Assistência Wiki Zone Zero Mod</h3>
            `;
            messagesDisplay.innerHTML = '<p style="text-align: center; color: #666;">Você está conversando com o suporte. Suas mensagens serão enviadas aos administradores.</p>';
            messageInput.disabled = false;
            sendButton.disabled = false;

            loadSupportMessages(currentUser.uid); // Carrega as mensagens de suporte para o usuário atual
        }


        // --- NOVO: Lógica para o Formulário de Registro de Matéria no Modal ---
        function showMaterialMessage(msg, type) {
            materialMessageBox.textContent = msg; [cite_start]/* [cite: 202] */
            materialMessageBox.className = 'message-box ' + type; [cite_start]/* [cite: 203] */
            materialMessageBox.style.display = 'block'; [cite_start]/* [cite: 203] */
            setTimeout(() => {
                [cite_start]materialMessageBox.style.display = 'none'; /* [cite: 203] */
            }, 5000); [cite_start]/* [cite: 204] */
        }

        materialFormModal.addEventListener('submit', async (e) => {
            [cite_start]e.preventDefault(); /* [cite: 204] */

            const currentUser = auth.currentUser; [cite_start]/* [cite: 204] */
            if (!currentUser) {
                showMaterialMessage('Você precisa estar logado para registrar uma matéria.', 'error'); [cite_start]/* [cite: 205] */
                return;
            }

            // Opcional: Re-verificação de isAdmin para maior segurança no lado do cliente
            const userDoc = await firestore.collection('users').doc(currentUser.uid).get(); [cite_start]/* [cite: 205] */
            if (!userDoc.exists || userDoc.data().isAdmin !== true) {
                 showMaterialMessage('Você não tem permissão para registrar matérias.', 'error'); [cite_start]/* [cite: 206] */
                return;
            }

            const title = materialTitleModal.value.trim(); [cite_start]/* [cite: 206] */
            const description = materialDescriptionModal.value.trim(); [cite_start]/* [cite: 206] */
            const category = materialCategoryModal.value.trim(); [cite_start]/* [cite: 206] */
            const imageUrl = materialImageUrlModal.value.trim(); [cite_start]/* [cite: 207] */
            const tags = materialTagsModal.value.split(',').map(tag => tag.trim()).filter(tag => tag !== ''); [cite_start]/* [cite: 207] */
            if (!title || !description || !category) {
                showMaterialMessage('Por favor, preencha todos os campos obrigatórios.', 'error'); [cite_start]/* [cite: 208] */
                return;
            }

            try {
                await firestore.collection('news').add({
                    [cite_start]title: title, /* [cite: 208] */
                    [cite_start]description: description, /* [cite: 209] */
                    [cite_start]category: category, /* [cite: 209] */
                    [cite_start]imageUrl: imageUrl, /* [cite: 209] */
                    [cite_start]tags: tags, /* [cite: 209] */
                    [cite_start]authorUid: currentUser.uid, /* [cite: 209] */
                    [cite_start]authorEmail: currentUser.email, /* [cite: 209] */
                    [cite_start]createdAt: firebase.firestore.FieldValue.serverTimestamp(), /* [cite: 210] */
                    [cite_start]updatedAt: firebase.firestore.FieldValue.serverTimestamp() /* [cite: 210] */
                });
                showMaterialMessage('Matéria registrada com sucesso!', 'success'); [cite_start]/* [cite: 211] */
                materialFormModal.reset(); [cite_start]/* [cite: 211] */
                if (componentHandler) {
                    materialTitleModal.parentElement.MaterialTextfield.change(); [cite_start]/* [cite: 211] */
                    materialDescriptionModal.parentElement.MaterialTextfield.change(); [cite_start]/* [cite: 212] */
                    materialCategoryModal.parentElement.MaterialTextfield.change(); [cite_start]/* [cite: 212] */
                    materialImageUrlModal.parentElement.MaterialTextfield.change(); [cite_start]/* [cite: 212] */
                    materialTagsModal.parentElement.MaterialTextfield.change(); [cite_start]/* [cite: 212] */
                }
            } catch (error) {
                console.error("Erro ao registrar matéria:", error); [cite_start]/* [cite: 213] */
                showMaterialMessage(`Erro ao registrar matéria: ${error.message}`, 'error'); [cite_start]/* [cite: 213] */
            }
        }); [cite_start]/* [cite: 214] */
        closeMaterialDialogButtons.forEach(button => {
            button.addEventListener('click', () => {
                [cite_start]registerMaterialDialog.close(); /* [cite: 214] */
            });
        }); [cite_start]/* [cite: 215] */
        // --- FIM NOVO: Lógica para o Formulário de Registro de Matéria ---


        // --- Observador de Autenticação ---
        auth.onAuthStateChanged(async (user) => {
            [cite_start]currentUser = user; /* [cite: 215] */
            if (user) {
                await createUserProfileDocument(user); [cite_start]/* [cite: 215] */
                console.log("Usuário logado:", user.displayName || user.email); [cite_start]/* [cite: 216] */
                loginGoogleButton.style.display = 'none'; [cite_start]/* [cite: 216] */
                loginGitHubButton.style.display = 'none'; [cite_start]/* [cite: 216] */
                logoutButton.style.display = 'inline-block'; [cite_start]/* [cite: 216] */
                addContactButton.style.display = 'inline-block'; [cite_start]// Mostra o botão adicionar contato /* [cite: 216] */
                contactSupportButton.style.display = 'inline-block'; // Mostra o botão de contato de suporte

                // Verificar se o usuário é admin
                const userDoc = await firestore.collection('users').doc(user.uid).get(); [cite_start]/* [cite: 217] */
                if (userDoc.exists && userDoc.data().isAdmin === true) {
                    adminPanelButton.style.display = 'inline-block'; [cite_start]// Mostra botão de admin /* [cite: 217] */
                } else {
                    adminPanelButton.style.display = 'none'; [cite_start]/* [cite: 218] */
                [cite_start]} /* [cite: 219] */

                messageInput.disabled = false; [cite_start]/* [cite: 219] */
                sendButton.disabled = false; [cite_start]/* [cite: 220] */
                messagesDisplay.innerHTML = '<p style="text-align: center; color: #666;">Selecione uma conversa para começar a digitar.</p>'; [cite_start]/* [cite: 220] */
                loadRecentChats(); [cite_start]/* [cite: 221] */
            } else {
                console.log("Nenhum usuário logado."); [cite_start]/* [cite: 221] */
                loginGoogleButton.style.display = 'inline-block'; [cite_start]/* [cite: 222] */
                loginGitHubButton.style.display = 'inline-block'; [cite_start]/* [cite: 222] */
                logoutButton.style.display = 'none'; [cite_start]/* [cite: 222] */
                adminPanelButton.style.display = 'none'; [cite_start]/* [cite: 222] */
                contactSupportButton.style.display = 'none'; // Esconde o botão de contato de suporte

                recentChatsList.innerHTML = ''; [cite_start]/* [cite: 223] */
                messagesDisplay.innerHTML = '<p style="text-align: center; color: #666;">Por favor, faça login para iniciar o chat.</p>'; [cite_start]/* [cite: 223] */
                chatHeader.innerHTML = '<h3>Selecione uma Conversa</h3>'; [cite_start]/* [cite: 224] */
                messageInput.value = ''; [cite_start]/* [cite: 224] */
                messageInput.disabled = true; [cite_start]/* [cite: 224] */
                sendButton.disabled = true; [cite_start]/* [cite: 224] */
                addContactButton.style.display = 'none'; [cite_start]/* [cite: 225] */
                // Esconde o botão adicionar contato

                if (unsubscribeMessages) {
                    unsubscribeMessages(); [cite_start]/* [cite: 225] */
                [cite_start]} /* [cite: 226] */
            }
            // Re-upgrade MDL components on auth state change
            if (componentHandler) {
                componentHandler.upgradeDom(); [cite_start]/* [cite: 227] */
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa todos os componentes MDL após o DOM ser carregado
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
            // Registra os diálogos para o polyfill, se necessário (para browsers que não suportam showModal nativamente)
            [cite_start]if (!addContactDialog.showModal) { /* [cite: 228] */
                dialogPolyfill.registerDialog(addContactDialog); [cite_start]/* [cite: 228] */
            }
            [cite_start]if (!registerMaterialDialog.showModal) { /* [cite: 228] */
                dialogPolyfill.registerDialog(registerMaterialDialog); [cite_start]/* [cite: 228] */
            }
        }); [cite_start]/* [cite: 229] */
    </script>
</body>
</html>
