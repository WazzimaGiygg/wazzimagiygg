<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - WZZM</title>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        .settings-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .mdl-textfield {
            width: 100%;
        }
        .mdl-checkbox {
            margin-bottom: 15px;
        }
        #saveButton, #loadButton {
            margin-right: 10px;
        }
        #message {
            margin-top: 15px;
            color: green;
        }
        #message.error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h4>Configurações do Usuário</h4>

        <div class="mdl-textfield mdl-js-textfield">
            <input class="mdl-textfield__input" type="email" id="email">
            <label class="mdl-textfield__label" for="email">E-mail (necessário para carregar/salvar)</label>
        </div>

        <div class="mdl-textfield mdl-js-textfield">
            <input class="mdl-textfield__input" type="password" id="password">
            <label class="mdl-textfield__label" for="password">Senha (necessário para carregar/salvar)</label>
        </div>

        <p>Preencha E-mail e Senha para carregar ou salvar suas preferências.</p>

        <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="loadButton" onclick="loadPreferences()">
            Carregar Preferências
        </button>
         <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="saveButton" onclick="savePreferences()">
            Salvar Preferências
        </button>

        <hr style="margin: 20px 0;">

        <div class="mdl-textfield mdl-js-textfield">
            <input class="mdl-textfield__input" type="text" id="userName">
            <label class="mdl-textfield__label" for="userName">Nome</label>
        </div>

        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="darkMode">
            <input type="checkbox" id="darkMode" class="mdl-checkbox__input">
            <span class="mdl-checkbox__label">Modo Escuro Ativado</span>
        </label>

        <p>Configurações de exibição de Artigos:</p>
        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="enableFavorites">
            <input type="checkbox" id="enableFavorites" class="mdl-checkbox__input">
            <span class="mdl-checkbox__label">Habilitar "Adicionar aos favoritos" nos artigos</span>
        </label>
        <br>
        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="enableHide">
            <input type="checkbox" id="enableHide" class="mdl-checkbox__input">
            <span class="mdl-checkbox__label">Habilitar "Não exibir novamente" nos artigos</span>
        </label>


        <div id="message"></div>

    </div>

    <script>
        const storageKey = 'wzzm_user_preferences'; // Chave para localStorage

        function getKey(email, password) {
            // Deriva uma chave simples combinando email e senha.
            // Em um cenário real, usaria PBKDF2 com um salt forte.
            // ISTO É UMA SIMPLIFICAÇÃO PARA DEMONSTRAÇÃO.
             if (!email || !password) {
                return null; // Retorna nulo se email ou senha estiverem vazios
            }
            const combined = email + password;
            return CryptoJS.SHA256(combined).toString(); // Usa um hash simples
        }

        function savePreferences() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value; // Não trim na senha
            const messageDiv = document.getElementById('message');

            if (!email || !password) {
                messageDiv.textContent = 'Por favor, preencha o E-mail e a Senha para salvar.';
                messageDiv.className = 'error';
                return;
            }

            const key = getKey(email, password);
             if (!key) {
                 messageDiv.textContent = 'Erro ao gerar a chave de criptografia.';
                 messageDiv.className = 'error';
                 return;
             }


            const preferences = {
                name: document.getElementById('userName').value,
                darkMode: document.getElementById('darkMode').checked,
                enableFavorites: document.getElementById('enableFavorites').checked,
                enableHide: document.getElementById('enableHide').checked,
                // Não salvamos email e senha nas preferências criptografadas,
                // pois eles são usados para a chave.
            };

            try {
                const preferencesString = JSON.stringify(preferences);
                // Criptografa o string JSON
                const encryptedData = CryptoJS.AES.encrypt(preferencesString, key).toString();

                // Salva os dados criptografados no localStorage
                localStorage.setItem(storageKey, encryptedData);

                messageDiv.textContent = 'Preferências salvas com sucesso (localmente no navegador)!';
                messageDiv.className = '';

                 // Opcional: Notificar a página principal para aplicar o dark mode Imediatamente
                 // Isso requer uma comunicação entre iframe e parent, mais complexo.
                 // A forma mais simples é a página principal ler localStorage ao carregar.
                 if (window.parent && window.parent.applyDarkModeFromLocalStorage) {
                      window.parent.applyDarkModeFromLocalStorage();
                 }


            } catch (e) {
                messageDiv.textContent = 'Erro ao salvar preferências: ' + e.message;
                messageDiv.className = 'error';
            }
        }

        function loadPreferences() {
             const email = document.getElementById('email').value.trim();
             const password = document.getElementById('password').value;
             const messageDiv = document.getElementById('message');

            if (!email || !password) {
                messageDiv.textContent = 'Por favor, preencha o E-mail e a Senha para carregar.';
                messageDiv.className = 'error';
                return;
            }

            const key = getKey(email, password);
             if (!key) {
                 messageDiv.textContent = 'Erro ao gerar a chave para descriptografia.';
                 messageDiv.className = 'error';
                 return;
             }


            const encryptedData = localStorage.getItem(storageKey);

            if (!encryptedData) {
                messageDiv.textContent = 'Nenhuma preferência salva encontrada para este usuário.';
                 messageDiv.className = '';
                 // Limpa os campos do formulário se nada for encontrado
                 document.getElementById('userName').value = '';
                 document.getElementById('darkMode').checked = false;
                 document.getElementById('enableFavorites').checked = false;
                 document.getElementById('enableHide').checked = false;
                 // Atualiza os componentes MDL para refletir as mudanças
                 if (window.componentHandler) {
                      window.componentHandler.upgradeDom();
                 }
                return;
            }

            try {
                // Tenta descriptografar
                const bytes  = CryptoJS.AES.decrypt(encryptedData, key);
                const preferencesString = bytes.toString(CryptoJS.enc.Utf8);

                // Verifica se a descriptografia foi bem-sucedida (string não vazia e parece JSON)
                if (!preferencesString || preferencesString.trim() === '' || !preferencesString.startsWith('{')) {
                     throw new Error("Falha na descriptografia. Senha ou E-mail incorretos?");
                }

                const preferences = JSON.parse(preferencesString);

                // Preenche o formulário com os dados descriptografados
                document.getElementById('userName').value = preferences.name || '';
                document.getElementById('darkMode').checked = preferences.darkMode === true; // Garante que é booleano
                 document.getElementById('enableFavorites').checked = preferences.enableFavorites === true;
                 document.getElementById('enableHide').checked = preferences.enableHide === true;


                // Atualiza os componentes MDL (checkboxes, textfields)
                 if (window.componentHandler) {
                      window.componentHandler.upgradeDom();
                 }


                messageDiv.textContent = 'Preferências carregadas com sucesso!';
                 messageDiv.className = '';

                 // Opcional: Notificar a página principal para aplicar o dark mode Imediatamente
                  if (window.parent && window.parent.applyDarkModeFromLocalStorage) {
                       window.parent.applyDarkModeFromLocalStorage();
                  }

            } catch (e) {
                messageDiv.textContent = 'Erro ao carregar preferências. Verifique o E-mail e a Senha.';
                messageDiv.className = 'error';
                console.error("Erro de descriptografia/parsing:", e);
                 // Limpa os campos do formulário em caso de erro de carregamento
                 document.getElementById('userName').value = '';
                 document.getElementById('darkMode').checked = false;
                 document.getElementById('enableFavorites').checked = false;
                 document.getElementById('enableHide').checked = false;
                  if (window.componentHandler) {
                      window.componentHandler.upgradeDom();
                 }
            }
        }

        // Inicializa os componentes MDL após carregar a página do iframe
         window.onload = function() {
             if (window.componentHandler) {
                 window.componentHandler.upgradeDom();
             }
         };

    </script>
</body>
</html>
