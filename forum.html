<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fórum da Wiki Zone Zero Mod</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .forum-post { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .forum-post h3 { margin-top: 0; }
        .forum-post small { color: #888; }
        #post-form { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; background-color: #f9f9f9; }
        #post-form input[type="text"], #post-form textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box; }
        #post-form button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #post-form button:hover { background-color: #218838; }
        .edit-button, .delete-button {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 5px;
        }
        .edit-button:hover, .delete-button:hover {
            color: #0056b3;
        }
        .loading-message { color: gray; }
        .error-message { color: red; }
        #forum-disabled-message {
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: #d33;
            border: 1px solid #f00;
            background-color: #fee;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Fórum da Wiki Zone Zero Mod</h1>

    <div id="forum-disabled-message" style="display: none;">
        O fórum está desativado. Você precisa fazer login com uma conta Google no site principal para poder postar.
    </div>

    <div id="post-form" style="display: none;">
        <h2>Nova Mensagem</h2>
        <input type="hidden" id="postIdToEdit">
        <label for="assunto">Assunto:</label><br>
        <input type="text" id="assunto" placeholder="Digite o assunto" required><br><br>
        <label for="conteudo">Conteúdo:</label><br>
        <textarea id="conteudo" placeholder="Escreva sua mensagem" rows="5" required></textarea><br><br>
        <button onclick="salvarMensagem()">Postar Mensagem</button>
    </div>

    <hr>

    <h2>Mensagens Anteriores</h2>
    <div id="mensagensContainer">
        <p class="loading-message">Carregando mensagens...</p>
    </div>

    <script>
        // *** COLOQUE O ID DO SEU BIN AQUI! ***
        // Exemplo: const BIN_ID = '60f7e9b01c3e387140e70a2a';
        const BIN_ID = 'SEU_ID_DO_BIN_AQUI'; // Substitua pelo ID real do seu bin no jsonbin.io!

        const ACCESS_KEY = '$2a$10$yYkleiX8VSZNdbcsN8o6iuVm56ZSSHYExMh.OZ8DW07Qx5B1OJpj6'; // Sua Chave de Acesso X
        const BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let currentGoogleUID = null; // Armazenará a UID recebida da página principal

        const forumForm = document.getElementById('post-form');
        const forumDisabledMessage = document.getElementById('forum-disabled-message');

        // Função para habilitar/desabilitar o formulário do fórum
        function setForumEnabled(enabled) {
            if (enabled) {
                forumForm.style.display = 'block';
                forumDisabledMessage.style.display = 'none';
            } else {
                forumForm.style.display = 'none';
                forumDisabledMessage.style.display = 'block';
            }
        }

        // Listener para receber mensagens da página pai (index.html)
        window.addEventListener('message', (event) => {
            // É CRUCIAL verificar a origem do evento em um ambiente de produção
            // if (event.origin !== "http://seu-dominio.com") return; 

            if (event.data && event.data.type === 'UID_GOOGLE_LOGIN') {
                currentGoogleUID = event.data.uid;
                console.log("UID do Google recebida no fórum:", currentGoogleUID);
                setForumEnabled(true); // Habilita o formulário
                exibirMensagens(); // Recarrega as mensagens após receber a UID
            }
        });


        // --- Funções de interação com JSONBin.io (iguais às do exemplo anterior) ---

        function generateUniqueId() {
            return 'msg-' + Math.random().toString(36).substr(2, 9) + Date.now();
        }

        async function carregarMensagens() {
            try {
                const response = await fetch(BIN_URL, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': ACCESS_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar mensagens: ${response.statusText}`);
                }

                const data = await response.json();
                return data.record || [];
            } catch (error) {
                console.error("Erro ao carregar mensagens:", error);
                document.getElementById('mensagensContainer').innerHTML = `<p class="error-message">Erro ao carregar mensagens: ${error.message}</p>`;
                return [];
            }
        }

        async function salvarMensagens(mensagens) {
            try {
                const response = await fetch(BIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': ACCESS_KEY,
                        'X-Bin-Meta': 'false'
                    },
                    body: JSON.stringify(mensagens)
                });

                if (!response.ok) {
                    throw new Error(`Erro ao salvar mensagens: ${response.statusText}`);
                }

                console.log("Mensagens salvas com sucesso no JSONBin.io!");
            } catch (error) {
                console.error("Erro ao salvar mensagens:", error);
                document.getElementById('mensagensContainer').innerHTML += `<p class="error-message">Erro ao salvar mensagens: ${error.message}</p>`;
            }
        }

        async function exibirMensagens() {
            document.getElementById('mensagensContainer').innerHTML = '<p class="loading-message">Carregando mensagens...</p>';
            const mensagens = await carregarMensagens();
            const container = document.getElementById('mensagensContainer');
            container.innerHTML = '';

            if (mensagens.length === 0) {
                container.innerHTML = '<p>Nenhuma mensagem ainda. Seja o primeiro a postar!</p>';
                return;
            }

            mensagens.forEach(msg => {
                const postDiv = document.createElement('div');
                postDiv.className = 'forum-post';
                postDiv.setAttribute('data-id', msg.id);

                let buttonsHtml = '';
                // Habilita botões de edição/exclusão APENAS se a UID do post corresponder à UID logada
                // E o currentGoogleUID não for nulo (usuário Google logado)
                if (currentGoogleUID && msg.authorUID === currentGoogleUID) { 
                    buttonsHtml = `
                        <button class="edit-button" onclick="prepararEdicao('${msg.id}')">Editar</button>
                        <button class="delete-button" onclick="deletarMensagem('${msg.id}')">Excluir</button>
                    `;
                }

                postDiv.innerHTML = `
                    <h3>${msg.assunto}</h3>
                    <p>${msg.conteudo}</p>
                    <small>ID: ${msg.id} | Autor: ${msg.authorUID ? msg.authorUID.substring(0, 8) + '...' : 'Anônimo'}</small>
                    ${buttonsHtml}
                `;
                container.appendChild(postDiv);
            });
        }

        async function salvarMensagem() {
            const assuntoInput = document.getElementById('assunto');
            const conteudoInput = document.getElementById('conteudo');
            const postIdToEdit = document.getElementById('postIdToEdit');

            if (!assuntoInput.value || !conteudoInput.value) {
                alert("Assunto e conteúdo não podem ser vazios.");
                return;
            }
            
            // Verifica se o usuário Google está logado antes de salvar
            if (!currentGoogleUID) {
                alert("Você precisa estar logado com uma conta Google para postar.");
                return;
            }

            let mensagens = await carregarMensagens();
            const id = postIdToEdit.value;

            if (id) {
                // Editando mensagem existente
                const index = mensagens.findIndex(msg => msg.id === id);
                if (index !== -1 && mensagens[index].authorUID === currentGoogleUID) { // Adiciona verificação de autoria
                    mensagens[index].assunto = assuntoInput.value;
                    mensagens[index].conteudo = conteudoInput.value;
                } else {
                    alert("Você não tem permissão para editar esta mensagem.");
                    return;
                }
                postIdToEdit.value = '';
            } else {
                // Adicionando nova mensagem
                const novaMensagem = {
                    id: generateUniqueId(),
                    assunto: assuntoInput.value,
                    conteudo: conteudoInput.value,
                    authorUID: currentGoogleUID // Adiciona a UID do autor!
                };
                mensagens.push(novaMensagem);
            }

            await salvarMensagens(mensagens);
            assuntoInput.value = '';
            conteudoInput.value = '';
            exibirMensagens();
        }

        async function prepararEdicao(id) {
            const mensagens = await carregarMensagens();
            const mensagem = mensagens.find(msg => msg.id === id);

            // Verifica a autoria antes de preparar para edição
            if (mensagem && mensagem.authorUID === currentGoogleUID) {
                document.getElementById('assunto').value = mensagem.assunto;
                document.getElementById('conteudo').value = mensagem.conteudo;
                document.getElementById('postIdToEdit').value = mensagem.id;
            } else {
                alert("Você não tem permissão para editar esta mensagem.");
            }
        }

        async function deletarMensagem(id) {
            if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
                let mensagens = await carregarMensagens();
                const indexToDelete = mensagens.findIndex(msg => msg.id === id);

                // Verifica a autoria antes de deletar
                if (indexToDelete !== -1 && mensagens[indexToDelete].authorUID === currentGoogleUID) {
                    mensagens.splice(indexToDelete, 1); // Remove a mensagem
                    await salvarMensagens(mensagens);
                    exibirMensagens();
                } else {
                    alert("Você não tem permissão para excluir esta mensagem.");
                }
            }
        }

        // Inicialmente, desativa o fórum até receber a UID
        document.addEventListener('DOMContentLoaded', () => {
            setForumEnabled(false);
            exibirMensagens(); // Carrega as mensagens existentes (mas o formulário estará desativado)
        });
    </script>
</body>
</html>
