<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Notícias - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body {
            font-family: 'Roboto', 'Helvetica', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px; /* Aumenta um pouco para a visualização */
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        h1 {
            color: #3f51b5;
            margin-bottom: 25px;
            text-align: center;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            justify-content: center;
        }
        .mdl-textfield, .mdl-selectfield {
            flex-grow: 1;
            min-width: 200px; /* Garante tamanho mínimo para os campos */
        }
        .mdl-button {
            margin-right: 10px;
        }
        .news-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Layout responsivo de cards */
            gap: 20px;
            margin-top: 30px;
        }
        .news-card.mdl-card {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 200px; /* Garante uma altura mínima para o card */
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        .news-card > .mdl-card__title {
            color: #fff;
            background-color: #3f51b5;
            padding: 16px;
            height: auto; /* Permite que o título ocupe o espaço necessário */
            word-break: break-word; /* Quebra palavras longas */
        }
        .news-card > .mdl-card__title-text {
            font-size: 20px; /* Aumenta um pouco o tamanho do título */
            line-height: 1.3;
        }
        .news-card > .mdl-card__supporting-text {
            flex-grow: 1; /* Ocupa o espaço restante */
            font-size: 14px;
            line-height: 1.5;
            color: rgba(0,0,0,.6);
            max-height: 80px; /* Limita a altura para a descrição */
            overflow: hidden; /* Esconde o excesso */
            text-overflow: ellipsis; /* Adiciona reticências */
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Mostra até 3 linhas */
            -webkit-box-orient: vertical;
        }
        .news-card > .mdl-card__actions {
            display: flex;
            justify-content: space-between;
            padding: 8px 16px 16px 16px;
            border-top: 1px solid rgba(0,0,0,.1);
        }
        .news-card .news-meta {
            font-size: 12px;
            color: rgba(0,0,0,.54);
        }
        .news-card .news-meta strong {
            color: rgba(0,0,0,.87);
        }

        /* Estilos da Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        .pagination button.mdl-button {
            min-width: 40px;
            height: 40px;
            line-height: 40px;
            padding: 0;
            margin: 0 5px;
            border-radius: 50%; /* Botões de página redondos */
            background-color: transparent;
            color: #3f51b5;
            border: 1px solid #3f51b5;
            transition: all 0.2s ease-in-out;
        }
        .pagination button.mdl-button:hover:not(.mdl-button--colored) {
            background-color: #e8eaf6; /* Um azul claro */
        }
        .pagination button.mdl-button.mdl-button--colored {
            background-color: #3f51b5;
            color: #fff;
        }
        .pagination button.mdl-button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: transparent !important;
            color: #3f51b5 !important;
        }
        .pagination span.dots {
            padding: 0 10px;
            align-self: center;
            font-weight: bold;
            color: rgba(0,0,0,.54);
        }

        .no-results {
            text-align: center;
            color: rgba(0,0,0,.54);
            margin-top: 50px;
            font-size: 1.2em;
        }

        /* Estilos para o campo de seleção de data */
        .mdl-selectfield select {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-bottom: 1px solid rgba(0,0,0,.12);
            background: transparent;
            font-size: 16px;
            color: rgba(0,0,0,.87);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        .mdl-selectfield label {
            color: rgba(0,0,0,.26);
            font-size: 16px;
            left: 0;
            top: 10px;
            position: absolute;
            pointer-events: none;
            transition: 0.2s ease all;
            transform-origin: left top;
        }
        .mdl-selectfield select:focus + label,
        .mdl-selectfield select:not([value=""]) + label {
            color: #3f51b5;
            top: -15px;
            font-size: 12px;
            transform: scale(0.75);
        }
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <div class="container">
        <h1>Notícias do WZZM</h1>

        <div class="filters">
            <div class="mdl-selectfield mdl-js-selectfield mdl-textfield--floating-label">
                <select id="filter-date" class="mdl-textfield__input">
                    <option value="">Todos os Períodos</option>
                    </select>
                <label for="filter-date" class="mdl-textfield__label">Filtrar por Período</label>
            </div>

            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" id="filter-author-uid">
                <label class="mdl-textfield__label" for="filter-author-uid">Filtrar por UID do Autor</label>
            </div>

            <button id="apply-filters-btn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                Aplicar Filtros
            </button>
            <button id="clear-filters-btn" class="mdl-button mdl-js-button mdl-button--raised">
                Limpar Filtros
            </button>
        </div>

        <div id="news-list" class="news-list">
            </div>

        <div id="no-results" class="no-results" style="display: none;">
            Nenhuma notícia encontrada com os filtros aplicados.
        </div>

        <div id="pagination" class="pagination">
            </div>
    </div>

    <script>
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        let app;
        try {
            app = firebase.app();
        } catch (e) {
            app = firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();
        const newsCollectionRef = firestore.collection('wikizero'); // Referência à coleção de notícias

        // --- Elementos do DOM ---
        const newsListDiv = document.getElementById('news-list');
        const noResultsDiv = document.getElementById('no-results');
        const filterDateSelect = document.getElementById('filter-date');
        const filterAuthorUidInput = document.getElementById('filter-author-uid');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const paginationDiv = document.getElementById('pagination');

        // --- Variáveis de Paginação ---
        const NEWS_PER_PAGE = 10;
        let currentPage = 1;
        let totalNewsCount = 0;
        let lastVisible = null; // Usado para paginação de próxima página
        let firstVisible = null; // Usado para paginação de página anterior
        let querySnapshotCache = []; // Cache dos snapshots de cada página
        let currentQuery = null; // A query atual para recarregar com filtros

        // --- Funções de Ajuda ---

        /**
         * Gera opções de Ano/Mês para o filtro de data.
         * Assume que as notícias têm um campo 'timestamp'.
         */
        async function generateDateFilterOptions() {
            try {
                // Buscamos apenas os timestamps para otimizar
                const snapshot = await newsCollectionRef.orderBy('timestamp', 'desc').get();
                const dates = new Set(); // Usamos Set para garantir datas únicas

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        const date = data.timestamp.toDate();
                        const year = date.getFullYear();
                        const month = date.getMonth() + 1; // getMonth() é 0-indexado
                        dates.add(`${year}-${String(month).padStart(2, '0')}`); // Formato YYYY-MM
                    }
                });

                // Converte Set para Array, ordena e adiciona ao select
                const sortedDates = Array.from(dates).sort((a, b) => b.localeCompare(a)); // Ordena do mais novo para o mais antigo

                filterDateSelect.innerHTML = '<option value="">Todos os Períodos</option>'; // Reset
                sortedDates.forEach(dateStr => {
                    const [year, month] = dateStr.split('-');
                    const monthName = new Date(year, parseInt(month) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                    const option = document.createElement('option');
                    option.value = dateStr;
                    option.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${year}`;
                    filterDateSelect.appendChild(option);
                });

                // Reinicia o componente MDL para o select
                if (window.componentHandler) {
                    window.componentHandler.upgradeElement(filterDateSelect.parentNode);
                }

            } catch (error) {
                console.error("Erro ao gerar opções de filtro de data:", error);
            }
        }

        /**
         * Renderiza as notícias na div de listagem.
         * @param {Array} newsDocs - Array de documentos do Firestore.
         */
        function renderNews(newsDocs) {
            newsListDiv.innerHTML = ''; // Limpa a lista existente
            if (newsDocs.length === 0) {
                noResultsDiv.style.display = 'block';
                return;
            }
            noResultsDiv.style.display = 'none';

            newsDocs.forEach(doc => {
                const data = doc.data();
                const newsCard = document.createElement('div');
                newsCard.className = 'news-card mdl-card mdl-shadow--2dp';
                newsCard.innerHTML = `
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">${data.title || 'Sem Título'}</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        ${data.description || 'Sem descrição.'}
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <div class="news-meta">
                            ${data.timestamp ? `<strong>Data:</strong> ${new Date(data.timestamp.toDate()).toLocaleDateString()}<br>` : ''}
                            ${data.authorUid ? `<strong>Autor UID:</strong> ${data.authorUid}` : ''}
                        </div>
                        ${data.externalLink ? `<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" href="${data.externalLink}" target="_blank">
                            Ver Notícia Original
                        </a>` : ''}
                    </div>
                `;
                newsListDiv.appendChild(newsCard);
            });
            // Re-upgrade MDL components if necessary
            if (window.componentHandler) {
                window.componentHandler.upgradeElements(newsListDiv);
            }
        }

        /**
         * Constrói a query do Firestore com base nos filtros e na paginação.
         */
        function buildQuery() {
            let query = newsCollectionRef.orderBy('timestamp', 'desc'); // Ordena por data mais recente

            const selectedDate = filterDateSelect.value;
            if (selectedDate) {
                const [year, month] = selectedDate.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1); // Primeiro dia do mês
                const endDate = new Date(year, month, 0, 23, 59, 59, 999); // Último milissegundo do mês
                query = query
                    .where('timestamp', '>=', startDate)
                    .where('timestamp', '<=', endDate);
            }

            const authorUid = filterAuthorUidInput.value.trim();
            if (authorUid) {
                query = query.where('authorUid', '==', authorUid);
            }
            
            currentQuery = query; // Armazena a query base para contagem e navegação
            return query;
        }

        /**
         * Conta o total de notícias para a paginação.
         */
        async function countTotalNews() {
            const snapshot = await currentQuery.get();
            totalNewsCount = snapshot.size;
        }

        /**
         * Carrega as notícias para a página atual.
         */
        async function loadNews(page = 1) {
            currentPage = page;
            querySnapshotCache = []; // Limpa o cache ao carregar uma nova página

            let query = buildQuery();

            // Ajusta a query para ir para a página correta
            if (currentPage > 1) {
                // Para ir para a página N, precisamos pular N-1 páginas de NEWS_PER_PAGE itens
                // O Firebase não tem um offset direto, então precisamos começar após o último item da página anterior
                // Esta lógica se torna complexa se você permitir pular páginas aleatoriamente
                // Para uma paginação "à la Google", é mais comum navegar sequencialmente (Próximo/Anterior)
                // Ou usar `startAt` ou `startAfter` com o último documento da página anterior.

                // Vamos implementar a navegação sequencial com `startAfter`
                // Ou uma re-query completa para cada página para simplificar a lógica inicial de 'ir para página X'
                // Para o efeito 'Google Search', é mais comum ter um array de documentos de 'lastVisible'

                // Reset do lastVisible e firstVisible para queries de página específica
                lastVisible = null;
                firstVisible = null;

                // Para ir diretamente para uma página X, precisamos re-executar a query até lá.
                // Isso pode ser ineficiente para muitas páginas.
                // Uma alternativa seria buscar TODAS as notícias (com filtros) e paginar no cliente,
                // mas isso é ruim para grandes datasets.
                // A melhor prática para Firestore é baseada em cursores (`startAt`/`endBefore`).
                // Para simular a paginação "número de páginas", teremos que buscar os dados de forma sequencial ou
                // armazenar os cursores.

                // Para este exemplo, vamos simplificar para botões "Próximo" e "Anterior"
                // E uma série de números de página que "podem" recalcular, mas não são totalmente otimizadas para "ir para página 50" direto.
                // No entanto, para fins de demonstração, vamos simular a navegação "direta" para uma página X
                // buscando até o documento de início.
                
                // Opção 1: Buscar do início até o documento de início da página
                // Esta é mais complexa e não é a forma mais performática do Firestore para "ir para página X"
                // sem os cursores.

                // Opção 2: Simplificar o "Google Search" para uma navegação de cursor com limites
                // Se o usuário clica em "3", ele busca 2*10 = 20 documentos e começa no 21º.
                // Isso não é a melhor prática para o Firestore.
                // A melhor prática é:
                // Clicou Próximo: query.startAfter(lastDocument).limit(NEWS_PER_PAGE)
                // Clicou Anterior: query.endBefore(firstDocument).limit(NEWS_PER_PAGE).orderBy(reverseOrder)

                // PARA FINS DE EXEMPLO COM NÚMEROS DE PÁGINA (como o pedido):
                // Vamos buscar o número de docs necessários para chegar à página atual,
                // que pode ser ineficiente se for a página 1000.
                // Uma solução real para muitas páginas exigiria armazenar os 'lastVisible' de cada página
                // ou uma abordagem mais complexa.

                // Para simular a navegação "direta" por número de página:
                const docsToSkip = (currentPage - 1) * NEWS_PER_PAGE;
                let tempQuery = buildQuery();
                const snapshot = await tempQuery.limit(docsToSkip).get();
                if (snapshot.docs.length > 0) {
                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                    query = query.startAfter(lastVisible);
                } else if (docsToSkip > 0) {
                    // Não há documentos suficientes para pular, significa que a página solicitada está vazia ou além do limite
                    renderNews([]);
                    renderPagination();
                    return;
                }
            }
            
            const snapshot = await query.limit(NEWS_PER_PAGE).get();
            
            if (snapshot.docs.length > 0) {
                firstVisible = snapshot.docs[0];
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
            } else {
                firstVisible = null;
                lastVisible = null;
            }

            renderNews(snapshot.docs);
            await countTotalNews(); // Atualiza a contagem total para a paginação
            renderPagination();
        }

        /**
         * Renderiza os botões de paginação.
         */
        function renderPagination() {
            paginationDiv.innerHTML = ''; // Limpa a paginação existente

            const totalPages = Math.ceil(totalNewsCount / NEWS_PER_PAGE);

            if (totalPages <= 1) {
                return; // Não mostra paginação se houver apenas uma página
            }

            const maxPagesToShow = 7; // Quantos números de página mostrar (ex: 1 ... 4 5 6 ... 10)
            let startPage, endPage;

            if (totalPages <= maxPagesToShow) {
                // Menos páginas do que o máximo, mostra todas
                startPage = 1;
                endPage = totalPages;
            } else {
                // Mais páginas do que o máximo
                const middle = Math.ceil(maxPagesToShow / 2);
                if (currentPage <= middle) {
                    startPage = 1;
                    endPage = maxPagesToShow;
                } else if (currentPage + middle > totalPages) {
                    startPage = totalPages - maxPagesToShow + 1;
                    endPage = totalPages;
                } else {
                    startPage = currentPage - middle + 1;
                    endPage = currentPage + middle - 1;
                }
            }

            // Botão "Anterior"
            const prevBtn = document.createElement('button');
            prevBtn.className = 'mdl-button mdl-js-button mdl-button--raised';
            prevBtn.textContent = 'Anterior';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => loadNews(currentPage - 1));
            paginationDiv.appendChild(prevBtn);

            // Botões numéricos
            for (let i = startPage; i <= endPage; i++) {
                if (i === startPage && i > 1) { // Mostrar "..." no início se não for a primeira página
                    const dots = document.createElement('span');
                    dots.className = 'dots';
                    dots.textContent = '...';
                    paginationDiv.appendChild(dots);
                }

                const pageBtn = document.createElement('button');
                pageBtn.className = 'mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab';
                if (i === currentPage) {
                    pageBtn.classList.add('mdl-button--colored');
                }
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => loadNews(i));
                paginationDiv.appendChild(pageBtn);

                if (i === endPage && i < totalPages) { // Mostrar "..." no final se não for a última página
                    const dots = document.createElement('span');
                    dots.className = 'dots';
                    dots.textContent = '...';
                    paginationDiv.appendChild(dots);
                }
            }

            // Botão "Próximo"
            const nextBtn = document.createElement('button');
            nextBtn.className = 'mdl-button mdl-js-button mdl-button--raised';
            nextBtn.textContent = 'Próximo';
            nextBtn.disabled = currentPage === totalPages || totalNewsCount === 0;
            nextBtn.addEventListener('click', () => loadNews(currentPage + 1));
            paginationDiv.appendChild(nextBtn);

            // Re-upgrade MDL components
            if (window.componentHandler) {
                window.componentHandler.upgradeElements(paginationDiv);
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Gera as opções de data e então carrega as notícias iniciais
            generateDateFilterOptions().then(() => {
                buildQuery(); // Inicializa currentQuery
                loadNews(); // Carrega a primeira página de notícias
            });
            
            applyFiltersBtn.addEventListener('click', () => {
                buildQuery(); // Recria a query com os novos filtros
                loadNews(1); // Volta para a primeira página com os novos filtros
            });

            clearFiltersBtn.addEventListener('click', () => {
                filterDateSelect.value = ''; // Limpa o filtro de data
                filterAuthorUidInput.value = ''; // Limpa o filtro de autor

                // Re-upgrade MDL component para o select após limpar o valor
                if (window.componentHandler) {
                    filterDateSelect.parentNode.MaterialTextfield.checkDirty();
                }

                buildQuery(); // Recria a query sem filtros
                loadNews(1); // Recarrega a primeira página
            });

            // Garante que todos os componentes MDL na página sejam inicializados
            if (window.componentHandler) {
                window.componentHandler.upgradeDom();
            }
        });
    </script>
</body>
</html>
