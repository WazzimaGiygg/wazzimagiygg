<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carregando...</title>
<link rel="icon" href="favicom.png" type="image/x-icon">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.min.css">
<style id="custom-app-css">
/* Este ser√° o local onde o CSS dos aplicativos do usu√°rio ser√° injetado */
</style>
<style id="custom-theme-color">
/* A cor do tema ser√° injetada aqui pelo JavaScript */
</style>
<style>
/* Seus estilos CSS existentes aqui */
/* --- ESTILOS DO POPUP DE CHAT (NOVOS) --- */

body {
    /* O body deve ser simples agora, pois o chat √© fixo (fixed) */
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
}

/* Bot√£o Flutuante (Trigger) */
#chat-button {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000; /* Garante que fique acima de outros elementos */
    background-color: var(--color-secondary); /* Usa a cor verde definida */
    color: white;
    transition: transform 0.3s ease;
}

/* Container Principal do Popup (Onde o chat ser√° exibido) */
#chat-popup {
    position: fixed;
    bottom: 100px; /* Posiciona acima do bot√£o */
    right: 24px;
    z-index: 999;
    width: 90vw;
    max-width: 400px;
    height: 70vh;
    max-height: 550px;
    /* Estilos para a anima√ß√£o de abertura */
    transform: scale(1);
    opacity: 1;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    transform-origin: bottom right;
}

/* Classe para esconder o popup */
#chat-popup.hidden {
    transform: scale(0.1);
    opacity: 0;
    pointer-events: none; /* Desabilita intera√ß√µes quando invis√≠vel */
}

/* Garante que a janela de mensagens ocupe o espa√ßo e seja scroll√°vel */
#chat-window {
    height: auto; 
    flex-grow: 1; /* Ocupa o espa√ßo restante */
    /* Mantenha os outros estilos de #chat-window originais */
}

.chat-container {
    height: 100%; /* Ocupa 100% do novo container #chat-popup */
    box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* Sombra mais destacada */
    /* Mantenha os outros estilos de .chat-container originais */
}
.mdl-layout__content {
flex-grow: 1;
display: flex;
position: relative; /* Adicionado para posicionamento absoluto */
padding: 0;
}
.page-content {
flex-grow: 1;
display: flex;
flex-direction: column;
}
.mdl-layout__drawer .mdl-navigation .mdl-navigation__link {
color: #424242;
}
.mdl-layout__drawer .mdl-navigation .mdl-navigation__link[data-requires-auth="true"] {
color: #9e9e9e;
pointer-events: none;
}
/* Estilo para o novo iframe de conte√∫do em tela cheia */
#main-content-frame {
flex-grow: 1;
border: none;
width: 100%;
height: 100%;
position: absolute;
top: 0;
left: 0;
z-index: 0; /* z-index para ficar no fundo */
}
/* Estilo para o cont√™iner das janelas flutuantes */
#window-container {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 1000; /* Garante que as janelas fiquem por cima */
pointer-events: none; /* Permite cliques passarem para o iframe de fundo */
}
#window-container > .floating-window {
pointer-events: auto; /* Reativa os cliques para as janelas */
}
/* Estilo para as janelas flutuantes */
.floating-window {
display: flex;
flex-direction: column;
position: absolute;
min-width: 300px;
min-height: 200px;
background-color: white;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
border-radius: 8px;
overflow: hidden;
resize: both;
transition: transform 0.2s ease-out;
border: 1px solid #ccc;
top: 50px;
left: 50px;
z-index: 1000;
}
.window-header {
cursor: grab;
padding: 8px 12px;
background-color: #f5f5f5;
border-bottom: 1px solid #ddd;
display: flex;
align-items: center;
justify-content: space-between;
}
.window-header:active {
cursor: grabbing;
}
.window-header span {
font-weight: bold;
}
.window-controls button {
border: none;
background: none;
font-size: 24px;
cursor: pointer;
color: #666;
line-height: 1;
padding: 0 8px;
}
.window-controls button:hover {
color: #333;
}
.window-body {
flex-grow: 1;
overflow: hidden;
}
.window-body iframe {
width: 100%;
height: 100%;
border: none;
}
.mdl-layout__header-row {
padding: 0 16px;
}
.mdl-layout__header-row .mdl-navigation {
display: flex;
align-items: center;
}
.mdl-layout__header-row .mdl-navigation .mdl-navigation__link {
padding: 0 12px;
}
/* Estilo para a imagem de perfil */
#user-profile-pic {
width: 32px;
height: 32px;
border-radius: 50%;
margin-left: 8px;
vertical-align: middle;
display: none;
}
/* Estilos para o popup de apps */
#google-apps-button {
display: none;
}
#google-apps-popup {
display: none;
position: absolute;
top: 48px; /* Altura do header */
right: 0;
width: 300px;
background-color: white;
border-radius: 8px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
z-index: 1000;
padding: 10px;
box-sizing: border-box;
}
#google-apps-popup h4 {
margin-top: 0;
margin-bottom: 10px;
color: #3f51b5;
text-align: center;
}
#app-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 10px;
padding: 10px;
}
.app-item {
display: flex;
flex-direction: column;
align-items: center;
text-align: center;
cursor: pointer;
padding: 8px;
border-radius: 4px;
transition: background-color 0.3s;
}
.app-item:hover {
background-color: #f0f0f0;
}
.app-item img {
width: 48px;
height: 48px;
margin-bottom: 5px;
}
.app-item span {
font-size: 0.8em;
color: #555;
}
/* Mensagens de acesso */
#access-denied-message, #banned-message {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background-color: #ffe0b2;
border: 1px solid #ffb74d;
padding: 20px;
border-radius: 8px;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
text-align: center;
color: #e65100;
font-weight: bold;
z-index: 1001;
}
/* --- ESTILOS PARA NOT√çCIAS (Bot√£o e Popup) --- */
#news-button {
margin-right: 8px;
display: none;
}
#news-center-popup {
display: none;
position: absolute;
top: 48px;
right: 0;
width: 400px;
max-height: 80vh;
background-color: white;
border-radius: 8px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
z-index: 998;
flex-direction: column;
overflow: hidden;
}
#news-popup-header {
background-color: #3f51b5;
color: white;
padding: 10px 15px;
border-top-left-radius: 8px;
border-top-right-radius: 8px;
display: flex;
align-items: center;
justify-content: space-between;
font-weight: bold;
font-size: 16px;
}
#news-popup-header .close-button {
background: none;
border: none;
color: white;
font-size: 24px;
cursor: pointer;
padding: 0;
}
#news-popup-content {
flex-grow: 1;
overflow-y: auto;
padding: 15px;
}
#news-popup-footer {
padding: 10px 15px;
border-top: 1px solid #eee;
text-align: center;
}
#news-popup-footer button {
width: 100%;
}
/* Estilos para os itens de not√≠cia dentro do popup (adaptados do seu c√≥digo original) */
.news-popup-item {
background-color: #f9f9f9;
border: 1px solid #e0e0e0;
border-radius: 4px;
padding: 15px;
margin-bottom: 15px;
box-shadow: 0 1px 1px 0 rgba(0,0,0,.08);
}
.news-popup-item h3 {
margin-top: 0;
color: #5c6bc0;
}
.news-popup-item p {
color: #555;
line-height: 1.5;
}
.news-popup-item small {
font-size: 0.8em;
color: #888;
display: block;
margin-top: 10px;
}
.news-popup-item img {
max-width: 100%;
height: auto;
margin-top: 10px;
border-radius: 4px;
}
</style>
<script>
// Script de redirecionamento para navegadores n√£o-Chromium
(function() {
const userAgent = navigator.userAgent;
const isChromium = !!window.chrome && userAgent.indexOf('Chrome') > -1 && userAgent.indexOf('Edg') === -1 && userAgent.indexOf('OPR') === -1;

if (!isChromium) {
window.location.href = './notchromium';
}
})();

// Script de redirecionamento para mobile
(function() {
const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (window.innerWidth <= 768);
if (isMobile) {
window.location.href = './mobile/index.html';
}
})();
</script>
</head>
<body>

<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
<header class="mdl-layout__header">
<div class="mdl-layout__header-row">
<span class="mdl-layout-title" id="wiki-page-name">Carregando...</span>
<a href="https://wazzimagiygg.com/html/?uid=hSW9OczWaUuvVoBkJCaR" id="./wikinotpedia/">
<img src="https://wazzimagiygg.com/wnp.png" alt="Logo Wiki Mod" style="height: 32px; vertical-align: middle; margin-right: 8px;"></a> <div class="mdl-layout-spacer"></div>
<nav class="mdl-navigation">
<button class="mdl-button mdl-js-button mdl-button--icon" id="news-button">
    <i class="material-icons">chat</i>
</button>
<a class="mdl-navigation__link" href="#" id="search-articles-link" onclick="createFloatingWindow('ferramentasuteis.html', null, false)">Procurar Artigos</a>
<div style="position: relative; display: flex; align-items: center;">
<button class="mdl-button mdl-js-button mdl-button--icon" id="news-button" style="display: none;">
<i class="material-icons">article</i>
</button>
<div id="news-center-popup">
<div id="news-popup-header">
<span>√öltimas Not√≠cias</span>
<button class="close-button" id="close-news-popup-button">√ó</button>
</div>
<div id="news-popup-content">
<p>Carregando √∫ltimas not√≠cias...</p>
</div>
<div id="news-popup-footer">
<button id="view-all-news-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
Ver todas as Not√≠cias
</button>
</div>
</div>
<button class="mdl-button mdl-js-button mdl-button--icon" id="google-apps-button" style="display: none;">
<i class="material-icons">widgets</i>
</button>
<div id="google-apps-popup">
<h4>Sobre o site</h4>
<div id="app-grid">
</div>
</div>
<div id="user-info-container" style="display: none; align-items: center;">
<span id="user-info" style="margin-left: 8px; color: white;"></span>
<img id="user-profile-pic" src="" alt="Profile Pic">
<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="logout-button" style="margin-left: 10px; display: none;">Sair</button>
</div>
<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="login-google">Login Google</button>
<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="login-github" style="margin-left: 10px;">Login GitHub</button>
</div>
</nav>
</div>
</header>
<div class="mdl-layout__drawer">
<span class="mdl-layout-title" id="drawer-title">Navega√ß√£o</span>
<nav class="mdl-navigation" id="drawer-menu">
</nav>
</div>
<main class="mdl-layout__content">
<iframe id="main-content-frame" src="wnpx.html" frameborder="0"></iframe>
<div id="window-container"></div>
</main>
<div id="access-denied-message" style="display:none;">
<p>Acesso negado. Por favor, fa√ßa login para ver este conte√∫do.</p>
</div>
<div id="banned-message" style="display:none;">
<p>Sua conta foi banida. Voc√™ n√£o pode acessar o conte√∫do.</p>
<p>Para mais informa√ß√µes, contate o suporte.</p>
</div>
<div id="news-center-popup">
  <div id="news-popup-header">
    <span>Fale com a Modera√ß√£o</span>
    <button class="close-button" id="close-news-popup-button">√ó</button>
  </div>
  <div id="news-popup-content" style="padding:0;">

    <!-- üîπ Chat embutido -->
    <div class="chat-container">
      <div id="login-overlay">
        <div class="login-box">
          <h2>Acesse para Conversar</h2>
          <p>Por favor, fa√ßa login para iniciar seu chat de contato.</p>
          <button id="google-login-btn">Entrar com Google</button>
        </div>
      </div>

      <div id="chat-window">
        <p style="text-align: center; color: var(--color-text-light);">Carregando hist√≥rico...</p>
      </div>
      
      <form id="chat-form">
        <label for="mensagem">Sua Mensagem:</label>
        <textarea id="mensagem" name="mensagem" rows="2" required></textarea>
        
        <label for="midia">Link de M√≠dia (Opcional):</label>
        <input type="url" id="midia" name="midia">
        
        <button type="submit" id="enviar-btn">Enviar Mensagem</button>
        <p id="feedback" style="margin-top: 5px; font-weight: 500;"></p>
      </form>
    </div>

  </div>
</div>

<ul id="error-log-list" style="list-style-type: none; margin: 0; padding: 16px; flex-grow: 1; overflow-y: auto;">
</ul>
</div>
</div>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BH9JJH6B0T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BH9JJH6B0T');
</script>
<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>
<script>
// --- Configura√ß√£o do Firebase ---
const firebaseConfig = {
apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Use sua pr√≥pria chave!
authDomain: "wzzm-ce3fc.firebaseapp.com",
projectId: "wzzm-ce3fc",
storageBucket: "wzzm-ce3fc.appspot.com",
messagingSenderId: "249427877153",
appId: "1:249427877153:web:0e4297294794a5aadeb260",
measurementId: "G-PLKNZNFCQ8"
};
// Inicialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();
firebase.analytics();

// Vari√°veis globais para estado do usu√°rio
let currentUser = null;
let isCurrentUserBanned = false;

// --- Fun√ß√µes Auxiliares (Antiga loadPage foi substitu√≠da pela nova que cria janelas flutuantes) ---
// A fun√ß√£o loadPage original que manipulava 'contentFrame' n√£o √© mais usada diretamente para links de navega√ß√£o.
// Ela ainda √© referenciada em outras partes do c√≥digo para manipula√ß√£o de mensagens de acesso/banimento,
// mas a navega√ß√£o principal usar√° a nova createFloatingWindow.

// Fun√ß√£o para ativar/desativar links de navega√ß√£o com base no status de login
function setNavLinksEnabled(enabled) {
const navLinks = document.querySelectorAll('.mdl-navigation__link[data-requires-auth="true"]');
navLinks.forEach(link => {
if (enabled) {
link.style.pointerEvents = 'auto';
link.style.color = '#424242'; // Cor padr√£o
} else {
link.style.pointerEvents = 'none';
link.style.color = '#9e9e9e';
}
});
}

// Fun√ß√£o para criar/atualizar o documento do perfil do usu√°rio no Firestore
async function createUserProfileDocument(user) {
if (!user) return;
const userRef = firestore.doc(`users/${user.uid}`);
const snapshot = await userRef.get();

if (!snapshot.exists) {
const { displayName, email, photoURL } = user;
const createdAt = new Date();

try {
await userRef.set({
displayName,
email,
photoURL,
createdAt,
isAdmin: false, // Define como false por padr√£o
isBan: false // Define como false por padr√£o
});
console.log("Perfil do usu√°rio criado no Firestore.");
} catch (error) {
console.error("Erro ao criar perfil do usu√°rio:", error);
}
}
}

// Fun√ß√£o para carregar e aplicar CSS de aplicativos espec√≠ficos do usu√°rio
async function loadAndApplyUserAppsCSS(userId) {
const customAppCssStyleTag = document.getElementById('custom-app-css');
if (!customAppCssStyleTag) return;

try {
const userAppsSnapshot = await firestore.collection('userApps').doc(userId).get();
if (userAppsSnapshot.exists) {
const appData = userAppsSnapshot.data();
let cssContent = '';
if (appData && appData.apps) {
appData.apps.forEach(app => {
if (app.css) {
cssContent += app.css + '\n';
}
});
}
customAppCssStyleTag.innerHTML = cssContent;
} else {
customAppCssStyleTag.innerHTML = '';
}
} catch (error) {
console.error("Erro ao carregar CSS de aplicativos do usu√°rio:", error);
customAppCssStyleTag.innerHTML = '';
}
}

// --- FUN√á√ïES PARA O POPUP DE NOT√çCIAS (MANTIDAS) ---
function showNewsPopup() {
const newsCenterPopup = document.getElementById('news-center-popup');
if (newsCenterPopup) {
newsCenterPopup.style.display = 'flex';
fetchLatestNews(); // Fetch news when popup is shown
}
}

function hideNewsPopup() {
const newsCenterPopup = document.getElementById('news-center-popup');
if (newsCenterPopup) {
newsCenterPopup.style.display = 'none';
}
}

// Fun√ß√£o para buscar as √∫ltimas not√≠cias e exibi-las no popup
async function fetchLatestNews() {
const newsPopupContent = document.getElementById('news-popup-content');
newsPopupContent.innerHTML = '<p>Carregando √∫ltimas not√≠cias...</p>';
try {
const newsSnapshot = await firestore.collection('news')
.orderBy('createdAt', 'desc')
.limit(5) // Limita a 5 not√≠cias para o popup
.get();
if (newsSnapshot.empty) {
newsPopupContent.innerHTML = '<p>Nenhuma not√≠cia encontrada.</p>';
return;
}

newsPopupContent.innerHTML = '';
// Limpa o conte√∫do existente
newsSnapshot.forEach(doc => {
const news = doc.data();
const newsItem = document.createElement('div');
newsItem.classList.add('news-popup-item');

const timestampDate = news.createdAt ? news.createdAt.toDate() : new Date();
const timeString = timestampDate.toLocaleString([], {
year: 'numeric', month: 'numeric', day: 'numeric',
hour: '2-digit', minute: '2-digit'
});

newsItem.innerHTML = `
<h3>${news.title}</h3>
<p>${news.description}</p>
<small>Categoria: ${news.category}</small><br> ${news.tags && news.tags.length > 0 ? `<small>Tags: ${news.tags.join(', ')}</small><br>` : ''}
<small>Publicado em: ${timeString}</small>
${news.imageUrl ? `<img src="${news.imageUrl}" alt="Imagem da Not√≠cia">` : ''} `;
newsPopupContent.appendChild(newsItem);
});

} catch (error) {
console.error("Erro ao buscar √∫ltimas not√≠cias para o popup:", error);
newsPopupContent.innerHTML = `<p style="color: red;">Erro ao carregar not√≠cias: ${error.message}</p>`;
}
}

// --- Fun√ß√µes de Autentica√ß√£o (EXISTENTES) ---
const providerGoogle = new firebase.auth.GoogleAuthProvider();
const providerGitHub = new firebase.auth.GithubAuthProvider();

document.getElementById('login-google').addEventListener('click', () => {
auth.signInWithPopup(providerGoogle)
.catch(error => {
console.error("Erro no login com Google:", error);
});
});
document.getElementById('login-github').addEventListener('click', () => {
auth.signInWithPopup(providerGitHub)
.catch(error => {
console.error("Erro no login com GitHub:", error);
});
});
function handleLogout() {
auth.signOut().then(() => {
console.log("Usu√°rio deslogado.");
}).catch((error) => {
console.error("Erro ao deslogar:", error);
});
}
const logoutButton = document.getElementById('logout-button');
if (logoutButton) {
logoutButton.addEventListener('click', handleLogout);
}

// --- Gerenciamento de Estado de Autentica√ß√£o ---
auth.onAuthStateChanged(async (user) => {
currentUser = user; // Define o currentUser globalmente
const userInfo = document.getElementById('user-info');
const loginGoogleButton = document.getElementById('login-google');
const loginGitHubButton = document.getElementById('login-github');
const logoutButton = document.getElementById('logout-button');
const userProfilePic = document.getElementById('user-profile-pic');
const googleAppsButton = document.getElementById('google-apps-button');
const userInfoContainer = document.getElementById('user-info-container');
const googleAppsPopup = document.getElementById('google-apps-popup');
const customAppCssStyleTag = document.getElementById('custom-app-css');
const contentFrame = document.getElementById('main-content-frame');
const accessDeniedMessage = document.getElementById('access-denied-message');
const bannedMessage = document.getElementById('banned-message');
const newsButton = document.getElementById('news-button');
const newsCenterPopup = document.getElementById('news-center-popup');


if (user) {
if (userInfo) userInfo.textContent = `Ol√°, ${user.displayName || user.email}!`;
if (loginGoogleButton) loginGoogleButton.style.display = 'none';
if (loginGitHubButton) loginGitHubButton.style.display = 'none';
if (user.photoURL) {
if (userProfilePic) {
userProfilePic.src = user.photoURL;
userProfilePic.style.display = 'inline-block';
}
} else {
if (userProfilePic) userProfilePic.style.display = 'none';
}
if (googleAppsButton) googleAppsButton.style.display = 'inline-block';
if (userInfoContainer) userInfoContainer.style.display = 'flex';

await createUserProfileDocument(user);

let isUserBanned = false;
try {
const userProfileRef = firestore.collection('users').doc(user.uid);
const doc = await userProfileRef.get();

if (doc.exists && doc.data()) {
isUserBanned = doc.data().isBan || false;
}
} catch (error) {
console.error("Erro ao verificar perfil de usu√°rio ou status de banimento:", error);
isUserBanned = false;
}

isCurrentUserBanned = isUserBanned;
if (isUserBanned) {
console.warn(`Usu√°rio ${user.uid} est√° banido.`);
setNavLinksEnabled(false);
if (logoutButton) {
logoutButton.style.display = 'none';
logoutButton.removeEventListener('click', handleLogout);
}
if (contentFrame) {
contentFrame.style.display = 'none';
}
if (bannedMessage) bannedMessage.style.display = 'block';
if (accessDeniedMessage) accessDeniedMessage.style.display = 'none';

document.querySelectorAll('.floating-window').forEach(win => win.remove());

if (googleAppsButton) {
googleAppsButton.style.pointerEvents = 'none';
googleAppsButton.style.opacity = '0.6';
}
if (googleAppsPopup) googleAppsPopup.style.display = 'none';
if (newsButton) newsButton.style.display = 'none';
if (newsCenterPopup) newsCenterPopup.style.display = 'none';
} else { // User is not banned
if (logoutButton) logoutButton.style.display = 'inline-block';
setNavLinksEnabled(true); // Enable all links if not banned
if (bannedMessage) bannedMessage.style.display = 'none';
if (accessDeniedMessage) accessDeniedMessage.style.display = 'none';

if (googleAppsButton) {
googleAppsButton.style.pointerEvents = 'auto';
googleAppsButton.style.opacity = '1';
}
if (newsButton) newsButton.style.display = 'inline-block';

await loadAndApplyUserAppsCSS(user.uid);

// Carregar a p√°gina inicial na primeira janela flutuante se n√£o houver nenhuma
if (!document.querySelector('.floating-window')) {
createFloatingWindow('https://wazzimagiygg.com/uid/?uid=GlNgSykpTgkXNZA3S3iA', 'Recep√ß√£o', false);
}
}
} else { // Usu√°rio deslogado
currentUser = null;
if (userInfo) userInfo.textContent = '';
if (loginGoogleButton) loginGoogleButton.style.display = 'inline-block';
if (loginGitHubButton) loginGitHubButton.style.display = 'inline-block';
if (logoutButton) logoutButton.style.display = 'none';
isCurrentUserBanned = false;
if (bannedMessage) bannedMessage.style.display = 'none';
setNavLinksEnabled(false);

document.querySelectorAll('.floating-window').forEach(win => win.remove());
if (contentFrame) contentFrame.style.display = 'none';
if (accessDeniedMessage) accessDeniedMessage.style.display = 'none';

if (!document.querySelector('.floating-window')) {
createFloatingWindow('recepcao.html', 'Recep√ß√£o', false);
}

if (userProfilePic) {
userProfilePic.style.display = 'none';
userProfilePic.src = '';
}
if (googleAppsButton) googleAppsButton.style.display = 'none';
if (userInfoContainer) userInfoContainer.style.display = 'none';
if (googleAppsPopup) googleAppsPopup.style.display = 'none';
if (customAppCssStyleTag) customAppCssStyleTag.innerHTML = '';
if (contentFrame) contentFrame.style.display = 'block';
if (newsButton) newsButton.style.display = 'none';
if (newsCenterPopup) newsCenterPopup.style.display = 'none';
hideNewsPopup();
}
if (componentHandler) {
componentHandler.upgradeDom();
}
});

// --- Event Listeners DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', () => {
// Re-obter refer√™ncias aos elementos DOM dentro deste escopo
const googleAppsButton = document.getElementById('google-apps-button');
const googleAppsPopup = document.getElementById('google-apps-popup');

const navLinks = document.querySelectorAll('.mdl-navigation__link');

// Get references for news popup elements (kept)
const newsButton = document.getElementById('news-button');
const newsCenterPopup = document.getElementById('news-center-popup');
const closeNewsPopupButton = document.getElementById('close-news-popup-button');
const viewAllNewsButton = document.getElementById('view-all-news-button');

// --- Adicionar Event Listeners ---

// Bot√£o Google Apps (mantido, mas modificado)
if (googleAppsButton) {
googleAppsButton.addEventListener('click', (event) => {
event.stopPropagation(); // Evita que o clique se propague para o document
if (googleAppsPopup.style.display === 'block') {
googleAppsPopup.style.display = 'none';
} else {
googleAppsPopup.style.display = 'block';
// Carregar apps dinamicamente (MODIFIED: hardcoded apps)
const appGrid = document.getElementById('app-grid');
appGrid.innerHTML = ''; // Clear existing content

// MODIFIED: Hardcoded list of WZZM services
const wzzmServices = [
{ name: 'Termos de Servi√ßo', url: 'https://wazzimagiygg.com/Termos%20de%20Servi%C3%A7o.pdf', iconUrl: 'iconmagic.png' },
{ name: 'Pol√≠tica de Privacidade', url: 'https://wazzimagiygg.com/Pol%C3%ADtica%20de%20Privacidade.pdf', iconUrl: 'iconmagic.png' },
{ name: 'Area do colaborador', url: 'admin/', iconUrl: 'iconmagic.png' },  
{ name: 'Fale com a Administra√ß√£o', url: 'contato/', iconUrl: 'iconmagic.png' }
];
wzzmServices.forEach(app => {
const appItem = document.createElement('div');
appItem.classList.add('app-item');
appItem.innerHTML = `
<img src="${app.iconUrl}" alt="${app.name}"> <span>${app.name}</span> `;
appItem.addEventListener('click', () => {
window.open(app.url, '_blank'); // Opens in a new tab for external services
googleAppsPopup.style.display = 'none'; // Close the popup
});
appGrid.appendChild(appItem);
});
}
});
}

// Event Listeners for News Button and Popup (mantidos)
if (newsButton) {
newsButton.addEventListener('click', (event) => {
event.stopPropagation();
if (newsCenterPopup.style.display === 'flex') {
hideNewsPopup();
} else {
showNewsPopup();
}
});
}

if (closeNewsPopupButton) {
closeNewsPopupButton.addEventListener('click', () => {
hideNewsPopup();
});
}

if (viewAllNewsButton) {
viewAllNewsButton.addEventListener('click', () => {
createFloatingWindow('visualizarnoticias.html', 'Todas as Not√≠cias'); // Carrega em nova janela
hideNewsPopup(); // Hide the popup
});
}

// Listener global para fechar popups ao clicar fora (ajustado)
document.addEventListener('click', (event) => {
// Fecha o popup de apps se clicar fora dele
if (googleAppsPopup && googleAppsPopup.style.display === 'block' &&
!googleAppsButton.contains(event.target) &&
!googleAppsPopup.contains(event.target)) {
googleAppsPopup.style.display = 'none';
}

// Fecha o popup de not√≠cias se clicar fora dele (mantido)
if (newsCenterPopup && newsCenterPopup.style.display === 'flex' &&
!newsButton.contains(event.target) &&
!newsCenterPopup.contains(event.target)) {
newsCenterPopup.style.display = 'none';
}
});

// Adiciona event listener para links de navega√ß√£o no drawer (ajustado)
navLinks.forEach(link => {
link.addEventListener('click', function(event) {
const pageSrc = this.getAttribute('onclick'); // Get the raw onclick attribute
let actualPageSrc = '';
let requiresAuth = false;

// Extract actual page source and requiresAuth
if (pageSrc && pageSrc.includes("loadPage(")) {
const match = pageSrc.match(/loadPage\('([^']*)', (true|false)\)/);
if (match) {
actualPageSrc = match[1];
requiresAuth = match[2] === 'true';
}
}

if (isCurrentUserBanned && !actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
event.preventDefault();
return;
}

if (this.classList.contains('disabled') && !actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
event.preventDefault();
return;
}

if (actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
// Se for o link das pol√≠ticas, abre em nova aba/janela do navegador para PDF
window.open(actualPageSrc, '_blank');
event.preventDefault(); // Previna o comportamento padr√£o para n√£o carregar em janela flutuante
return;
}

event.preventDefault();
createFloatingWindow(actualPageSrc, null, requiresAuth); // Usar createFloatingWindow
// Fecha o drawer do MDL se estiver aberto
if (document.querySelector('.mdl-layout__drawer.is-visible')) {
document.querySelector('.mdl-layout__obfuscator').classList.remove('is-visible');
document.querySelector('.mdl-layout__drawer').classList.remove('is-visible');
}
});
});
// Inicializa componentes MDL
if (componentHandler) {
componentHandler.upgradeDom();
}
});

// Utilit√°rio para gerar IDs √∫nicos
function uniqueID() {
return 'win_' + Math.random().toString(36).substr(2, 9);
}

// Fun√ß√£o para criar uma nova janela flutuante
// Adicionamos um hist√≥rico para cada iframe para os bot√µes de navega√ß√£o
const windowHistory = {}; // Armazena o hist√≥rico para cada janela (key: winId, value: array de URLs)
const windowHistoryIndex = {}; // Armazena o √≠ndice atual do hist√≥rico para cada janela

function createFloatingWindow(src, customTitle = null, requiresAuth = false) {
const container = document.getElementById('window-container');

// Verifica as regras de acesso antes de criar a janela
if (isCurrentUserBanned && src !== 'https://wazzimagiygg.com/uid/?uid=GlNgSykpTgkXNZA3S3iA' && src !== 'POL√çTICAS GERAIS DO WIKI MOD.pdf') {
document.getElementById('banned-message').style.display = 'block';
return;
}
if (requiresAuth && !currentUser) {
document.getElementById('access-denied-message').style.display = 'block';
return;
}

const existing = Array.from(document.querySelectorAll('.floating-window'))
.find(win => win.getAttribute('data-src') === src);
if (existing) {
bringWindowToFront(existing);
return;
}

const winId = uniqueID();
windowHistory[winId] = [];
windowHistoryIndex[winId] = -1;

// Elemento da janela
const win = document.createElement('div');
win.className = 'floating-window';
win.setAttribute('data-winid', winId);
win.setAttribute('data-src', src); // Armazena o SRC original para verifica√ß√£o de exist√™ncia

// Cabe√ßalho da janela
const header = document.createElement('div');
header.className = 'window-header';

// Fun√ß√£o para extrair o nome do arquivo da URL para o t√≠tulo
function getFileNameFromUrl(url) {
try {
const urlObj = new URL(url, window.location.origin);
let path = urlObj.pathname.split('/').pop();
if (path.includes('.')) {
path = path.split('.')[0]; // Remove a extens√£o
}
path = path.replace(/%20/g, ' '); // Decodifica espa√ßos
return path || 'Nova Janela'; // Retorna o nome do arquivo ou "Nova Janela" se vazio
} catch (e) {
return url; // Em caso de erro (URL inv√°lida), retorna a URL completa
}
}

const titleText = customTitle || getFileNameFromUrl(src);

header.innerHTML = `
<div style="display: flex; align-items: center;">
<button title="Voltar" onclick="historyBack('${winId}')" class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored window-nav-back">
<i class="material-icons">arrow_back</i>
</button>
<button title="Avan√ßar" onclick="historyForward('${winId}')" class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored window-nav-forward">
<i class="material-icons">arrow_forward</i>
</button>
<span style="margin-left: 8px;">${titleText}</span>
</div>
<span class="window-controls">
<button title="Fechar" onclick="closeWindow('${winId}')">&times;</button>
</span>
`;

// Corpo da janela com iframe
const body = document.createElement('div');
body.className = 'window-body';
const iframe = document.createElement('iframe');
iframe.src = src;
iframe.setAttribute('data-winid', winId); // Adiciona o winId ao iframe
body.appendChild(iframe);

win.appendChild(header);
win.appendChild(body);
container.appendChild(win);

// Torna a janela arrast√°vel
makeWindowDraggable(win, header);
// Foca a janela ao clicar
win.addEventListener('mousedown', () => {
bringWindowToFront(win);
});
// Coloca no topo ao criar
bringWindowToFront(win);

// Adiciona a URL inicial ao hist√≥rico da nova janela
addToWindowHistory(winId, src);

// Adiciona listener para atualiza√ß√µes de URL dentro do iframe
iframe.addEventListener('load', function() {
try {
// Para mesma origem, atualiza o hist√≥rico e o t√≠tulo
if (iframe.contentWindow.location.origin === window.location.origin) {
const currentIframeSrc = iframe.contentWindow.location.href;
if (windowHistory[winId][windowHistoryIndex[winId]] !== currentIframeSrc) {
addToWindowHistory(winId, currentIframeSrc);
const newTitle = getFileNameFromUrl(currentIframeSrc);
win.querySelector('.window-header span:last-of-type').textContent = newTitle; // Atualiza o texto do t√≠tulo
}
}
} catch (e) {
// Ignora erros de Same-Origin Policy
console.warn("Same-Origin Policy previne acesso ao conte√∫do do iframe para atualiza√ß√£o do hist√≥rico.", e);
}
updateNavigationButtons(winId); // Atualiza o estado dos bot√µes Voltar/Avan√ßar
});
}

// Fun√ß√£o para adicionar URL ao hist√≥rico da janela
function addToWindowHistory(winId, url) {
if (!windowHistory[winId]) {
windowHistory[winId] = [];
windowHistoryIndex[winId] = -1;
}

// Remove URLs √† frente do √≠ndice atual se navegarmos para tr√°s e depois para uma nova p√°gina
if (windowHistoryIndex[winId] < windowHistory[winId].length - 1) {
windowHistory[winId] = windowHistory[winId].slice(0, windowHistoryIndex[winId] + 1);
}

windowHistory[winId].push(url);
windowHistoryIndex[winId]++;
updateNavigationButtons(winId);
}

// Fun√ß√£o para navegar para tr√°s no hist√≥rico da janela
function historyBack(winId) {
if (windowHistory[winId] && windowHistoryIndex[winId] > 0) {
windowHistoryIndex[winId]--;
const iframe = document.querySelector(`.floating-window[data-winid="${winId}"] iframe`);
if (iframe) {
iframe.src = windowHistory[winId][windowHistoryIndex[winId]];
const newTitle = getFileNameFromUrl(iframe.src);
iframe.closest('.floating-window').querySelector('.window-header span:last-of-type').textContent = newTitle; // Atualiza o t√≠tulo
}
updateNavigationButtons(winId);
}
}

// Fun√ß√£o para navegar para frente no hist√≥rico da janela
function historyForward(winId) {
if (windowHistory[winId] && windowHistoryIndex[winId] < windowHistory[winId].length - 1) {
windowHistoryIndex[winId]++;
const iframe = document.querySelector(`.floating-window[data-winid="${winId}"] iframe`);
if (iframe) {
iframe.src = windowHistory[winId][windowHistoryIndex[winId]];
const newTitle = getFileNameFromUrl(iframe.src);
iframe.closest('.floating-window').querySelector('.window-header span:last-of-type').textContent = newTitle; // Atualiza o t√≠tulo
}
updateNavigationButtons(winId);
}
}

// Fun√ß√£o para atualizar o estado (disabled) dos bot√µes de navega√ß√£o
function updateNavigationButtons(winId) {
const win = document.querySelector(`.floating-window[data-winid="${winId}"]`);
if (!win) return;
const backButton = win.querySelector('.window-nav-back');
const forwardButton = win.querySelector('.window-nav-forward');

if (backButton) {
backButton.disabled = !(windowHistory[winId] && windowHistoryIndex[winId] > 0);
backButton.style.opacity = backButton.disabled ? '0.5' : '1';
backButton.style.cursor = backButton.disabled ? 'not-allowed' : 'pointer';
}
if (forwardButton) {
forwardButton.disabled = !(windowHistory[winId] && windowHistoryIndex[winId] < windowHistory[winId].length - 1);
forwardButton.style.opacity = forwardButton.disabled ? '0.5' : '1';
forwardButton.style.cursor = forwardButton.disabled ? 'not-allowed' : 'pointer';
}
}

// Deixe a janela arrast√°vel
function makeWindowDraggable(win, handle) {
let offsetX = 0, offsetY = 0, dragging = false;
handle.addEventListener('mousedown', function (e) {
dragging = true;
offsetX = e.clientX - win.offsetLeft;
offsetY = e.clientY - win.offsetTop;
win.style.zIndex = getNextZIndex();
document.body.style.userSelect = 'none';
});
document.addEventListener('mousemove', function (e) {
if (dragging) {
win.style.left = (e.clientX - offsetX) + 'px';
win.style.top = (e.clientY - offsetY) + 'px';
}
});
document.addEventListener('mouseup', function () {
dragging = false;
document.body.style.userSelect = '';
});
}

// Fun√ß√£o para fechar janela
function closeWindow(winId) {
const win = document.querySelector(`.floating-window[data-winid="${winId}"]`);
if (win) {
delete windowHistory[winId];
delete windowHistoryIndex[winId];
win.remove();
}
}

// Z-Index para trazer para frente
let topZ = 1000;
function getNextZIndex() {
return ++topZ;
}
function bringWindowToFront(win) {
win.style.zIndex = getNextZIndex();
}

// Substitua a fun√ß√£o loadPage para usar createFloatingWindow
function loadPage(src, requiresAuth = false) {
createFloatingWindow(src, null, requiresAuth);
}

// ========== CAPTURA E EXIBE ERROS DO CONSOLE ==========
// Array para armazenar os erros capturados
window._wzzmErrorLog = [];
// Captura erros globais de JavaScript
window.addEventListener('error', function(e) {
window._wzzmErrorLog.push(`[${new Date().toLocaleTimeString()}] ${e.message} (${e.filename}:${e.lineno})`);
});
// Captura rejei√ß√µes de Promise n√£o tratadas
window.addEventListener('unhandledrejection', function(e) {
window._wzzmErrorLog.push(`[${new Date().toLocaleTimeString()}] Unhandled Promise: ${e.reason}`);
});
// Intercepta console.error e armazena as mensagens
(function() {
const originalError = console.error;
console.error = function(...args) {
window._wzzmErrorLog.push(`[${new Date().toLocaleTimeString()}] console.error: ${args.join(' ')}`);
originalError.apply(console, args);
};
})();
// Mostra o popup com a lista de erros ao clicar no bot√£o
document.addEventListener('DOMContentLoaded', function() {
var btn = document.getElementById('error-log-button');
if (!btn) return;
btn.addEventListener('click', function() {
var logList = document.getElementById('error-log-list');
logList.innerHTML = '';
if (window._wzzmErrorLog.length === 0) {
logList.innerHTML = '<li style="color:green;">Nenhum erro registrado nesta sess√£o.</li>';
} else {
window._wzzmErrorLog.slice(-100).forEach(function(msg) {
var li = document.createElement('li');
li.textContent = msg;
logList.appendChild(li);
});
}
document.getElementById('error-log-popup').style.display = 'block';
});
});

document.addEventListener('DOMContentLoaded', function () {
fetch('menu.json')
.then(response => response.json())
.then(menuItems => {
const drawerMenu = document.getElementById('drawer-menu');
if (!drawerMenu) return;
drawerMenu.innerHTML = ''; // Limpa itens antigos, se houver

menuItems.forEach(item => {
const a = document.createElement('a');
a.className = 'mdl-navigation__link';
a.href = '#'; // A navega√ß√£o ser√° controlada pelo onclick
a.setAttribute('onclick', `loadPage('${item.href}', ${item.requiresAuth})`);
if (item.requiresAuth) {
a.setAttribute('data-requires-auth', 'true');
}
a.textContent = item.label;
drawerMenu.appendChild(a);
});
})
.catch(err => {
console.error('Erro ao carregar menu.json:', err);
});
});

// NOVO SCRIPT PARA CARREGAR info-general.json DO FIREBASE E APLICAR AS MUDAN√áAS
document.addEventListener('DOMContentLoaded', () => {
// 1. Determina o ID do documento com base no hostname
let docId = window.location.hostname;

// Remove "www." se presente
if (docId.startsWith('www.')) {
docId = docId.substring(4);
}

// Define um fallback para ambiente local (ex: localhost, 127.0.0.1)
// Se voc√™ estiver desenvolvendo localmente, ele usar√° 'defaultConfig'
// Certifique-se de ter um documento 'defaultConfig' ou 'wikiConfig' na sua cole√ß√£o 'configuracoes'
if (docId === 'localhost' || docId === '127.0.0.1' || docId.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
docId = 'wikiConfig'; // Ou um ID padr√£o que voc√™ prefira para ambiente local
}

console.log(`Tentando carregar configura√ß√£o para o site: ${docId}`);

const configDocRef = firestore.collection('configuracoes').doc(docId);

// Listener em tempo real para mudan√ßas no documento
configDocRef.onSnapshot(docSnapshot => {
if (docSnapshot.exists) {
const data = docSnapshot.data();
applyConfigData(data);
console.log("Configura√ß√µes carregadas do Firebase (em tempo real):", data);
} else {
console.warn(`Documento de configura√ß√£o '${docId}' n√£o encontrado na cole√ß√£o 'configuracoes'. Usando valores padr√£o.`);
// Se o documento espec√≠fico do site n√£o existir, voc√™ pode carregar um fallback
// Por exemplo, um documento 'default' ou 'global'
// Para simplicidade, aqui ele usar√° os valores padr√£o definidos em applyConfigData.
applyConfigData({});
}
}, error => {
console.error("Erro ao carregar configura√ß√µes do Firebase:", error);
// Em caso de erro, tenta aplicar valores padr√£o
applyConfigData({});
});

// Fun√ß√£o para aplicar os dados da configura√ß√£o aos elementos da p√°gina
function applyConfigData(data) {
// Altera o t√≠tulo da p√°gina
document.title = data.nomeCompletoWiki || 'Wiki';

// Altera o nome da p√°gina no cabe√ßalho
const wikiPageName = document.getElementById('wiki-page-name');
if (wikiPageName) {
wikiPageName.textContent = data.nomeCompletoWiki || 'Wiki';
}
// Altera o nome da p√°gina no drawer
const drawerTitle = document.getElementById('drawer-title');
if (drawerTitle) {
drawerTitle.textContent = data.nomePaginaDrawer || 'Navega√ß√£o';
}

// Altera o texto do link de "Procurar Artigos"
const searchArticlesLink = document.getElementById('search-articles-link');
if (searchArticlesLink) {
searchArticlesLink.textContent = data.linkProcurarArtigos || 'Procurar Artigos';
}
}
});

<div id="news-center-popup">
  <div id="news-popup-header">
    <span>Fale com a Modera√ß√£o</span>
    <button class="close-button" id="close-news-popup-button">√ó</button>
  </div>
  <div id="news-popup-content" style="padding:0;">

    <!-- üîπ Chat embutido -->
    <div class="chat-container">
      <div id="login-overlay">
        <div class="login-box">
          <h2>Acesse para Conversar</h2>
          <p>Por favor, fa√ßa login para iniciar seu chat de contato.</p>
          <button id="google-login-btn">Entrar com Google</button>
        </div>
      </div>

      <div id="chat-window">
        <p style="text-align: center; color: var(--color-text-light);">Carregando hist√≥rico...</p>
      </div>
      
      <form id="chat-form">
        <label for="mensagem">Sua Mensagem:</label>
        <textarea id="mensagem" name="mensagem" rows="2" required></textarea>
        
        <label for="midia">Link de M√≠dia (Opcional):</label>
        <input type="url" id="midia" name="midia">
        
        <button type="submit" id="enviar-btn">Enviar Mensagem</button>
        <p id="feedback" style="margin-top: 5px; font-weight: 500;"></p>
      </form>
    </div>

  </div>
</div>

</script>
</body>
</html>
