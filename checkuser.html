<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Labirinto Desafio de Acesso</title>
  <style>
    :root {
      --bg-color: #282c34;
      --border-color: #61dafb;
      --wall-color: #61dafb;
      --path-color: #333;
      --player-color: #e0b0ff;
      --start-color: #4CAF50;
      --start-border-color: #388E3C;
      --end-color: #f44336;
      --end-border-color: #D32F2F;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background-color: var(--bg-color);
      color: white;
      font-family: Arial, sans-serif;
    }

    h1 {
      margin-bottom: 20px;
    }

    #game-container {
      position: relative;
      border: 2px solid var(--border-color);
      overflow: hidden;
      background-color: var(--path-color);
    }

    #maze {
      display: grid;
      background-color: var(--path-color);
    }

    .wall {
      background-color: var(--wall-color);
    }

    .path {
      background-color: var(--path-color);
    }

    #player {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: var(--player-color);
      border-radius: 50%;
      transition: left 0.05s linear, top 0.05s linear;
    }

    #start-point, #end-point {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      box-sizing: border-box;
    }

    #start-point {
      background-color: var(--start-color);
      border: 2px solid var(--start-border-color);
    }

    #end-point {
      background-color: var(--end-color);
      border: 2px solid var(--end-border-color);
    }

    #info {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .buttons-container {
      display: flex;
      gap: 15px;
    }

    button {
      padding: 10px 20px;
      font-size: 1em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Labirinto Desafio de Acesso</h1>
  <div id="game-container">
    <div id="maze"></div>
    <div id="player"></div>
    <div id="start-point">Início</div>
    <div id="end-point">Fim</div>
  </div>
  <div id="info">
    <p>Fase: <span id="level">1</span></p>
    <p>Tempo: <span id="time">00:00</span></p>
    <div class="buttons-container">
      <button id="restart-button">Reiniciar</button>
      <button id="next-level-button" style="display: none;">Próxima Fase</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let URL_DE_REDIRECIONAMENTO = '';
      const FASES_NECESSARIAS = 2;

      async function loadConfig() {
        try {
          const response = await fetch('checkuser.json');
          const data = await response.json();
          URL_DE_REDIRECIONAMENTO = data.url_redirecionamento;
        } catch (error) {
          console.error('Erro ao carregar o arquivo JSON:', error);
        }
      }

      loadConfig();

      const mazeContainer = document.getElementById('maze');
      const player = document.getElementById('player');
      const startPoint = document.getElementById('start-point');
      const endPoint = document.getElementById('end-point');
      const timeDisplay = document.getElementById('time');
      const levelDisplay = document.getElementById('level');
      const restartButton = document.getElementById('restart-button');
      const nextLevelButton = document.getElementById('next-level-button');

      const cellSize = 20;

      let maze = [];
      let numRows, numCols;
      let playerPos = { x: 0, y: 0 };
      let startPos = { x: 0, y: 0 };
      let endPos = { x: 0, y: 0 };
      let startTime;
      let timerInterval;
      let gameActive = false;
      let currentLevel = 1;

      const colorThemes = [
        {
          '--bg-color': '#282c34',
          '--border-color': '#61dafb',
          '--wall-color': '#61dafb',
          '--path-color': '#333',
          '--player-color': '#e0b0ff',
          '--start-color': '#4CAF50',
          '--start-border-color': '#388E3C',
          '--end-color': '#f44336',
          '--end-border-color': '#D32F2F',
        },
        {
          '--bg-color': '#224036',
          '--border-color': '#6cc091',
          '--wall-color': '#6cc091',
          '--path-color': '#1a2a22',
          '--player-color': '#d1f0c4',
          '--start-color': '#A5D6A7',
          '--start-border-color': '#66BB6A',
          '--end-color': '#FF8A65',
          '--end-border-color': '#FF5722',
        }
      ];

      function generateMaze(rows, cols) {
        numRows = rows % 2 === 0 ? rows + 1 : rows;
        numCols = cols % 2 === 0 ? cols + 1 : cols;

        const newMaze = Array(numRows).fill(0).map(() => Array(numCols).fill(1));

        let stack = [[1, 1]];
        newMaze[1][1] = 0;

        while (stack.length > 0) {
          const [r, c] = stack[stack.length - 1];
          const directions = [
            [0, -2], [0, 2], [-2, 0], [2, 0]
          ];

          const neighbors = directions
            .map(([dr, dc]) => [r + dr, c + dc])
            .filter(([nr, nc]) =>
              nr > 0 && nc > 0 && nr < numRows - 1 && nc < numCols - 1 && newMaze[nr][nc] === 1
            );

          if (neighbors.length) {
            const [nr, nc] = neighbors[Math.floor(Math.random() * neighbors.length)];
            newMaze[(r + nr) / 2][(c + nc) / 2] = 0;
            newMaze[nr][nc] = 0;
            stack.push([nr, nc]);
          } else {
            stack.pop();
          }
        }

        startPos = { x: 1, y: 1 };
        do {
          endPos = {
            x: Math.floor(Math.random() * (numCols - 2)) + 1,
            y: Math.floor(Math.random() * (numRows - 2)) + 1,
          };
        } while (
          newMaze[endPos.y][endPos.x] !== 0 ||
          (Math.abs(endPos.x - startPos.x) + Math.abs(endPos.y - startPos.y)) < (numRows + numCols) / 4
        );

        return newMaze;
      }

      function drawMaze() {
        mazeContainer.innerHTML = '';
        mazeContainer.style.gridTemplateColumns = `repeat(${numCols}, ${cellSize}px)`;
        mazeContainer.style.gridTemplateRows = `repeat(${numRows}, ${cellSize}px)`;

        for (let row = 0; row < numRows; row++) {
          for (let col = 0; col < numCols; col++) {
            const cell = document.createElement('div');
            cell.className = maze[row][col] ? 'wall' : 'path';
            mazeContainer.appendChild(cell);
          }
        }

        startPoint.style.left = `${startPos.x * cellSize}px`;
        startPoint.style.top = `${startPos.y * cellSize}px`;
        endPoint.style.left = `${endPos.x * cellSize}px`;
        endPoint.style.top = `${endPos.y * cellSize}px`;
      }

      function updatePlayerPosition() {
        player.style.left = `${playerPos.x * cellSize}px`;
        player.style.top = `${playerPos.y * cellSize}px`;
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const sec = String(elapsed % 60).padStart(2, '0');
          timeDisplay.textContent = `${min}:${sec}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
      }

      function isValidMove(x, y) {
        return x >= 0 && x < numCols && y >= 0 && y < numRows && maze[y][x] === 0;
      }

      function checkWin() {
        if (playerPos.x === endPos.x && playerPos.y === endPos.y) {
          stopTimer();
          gameActive = false;

          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          if (currentLevel === FASES_NECESSARIAS && elapsed < 15) {
            alert("⛔ Suspeito de conexão robô tentando entrar, tente novamente.");
            restartButton.style.display = 'inline-block';
            nextLevelButton.style.display = 'none';
            return;
          }

          if (currentLevel < FASES_NECESSARIAS) {
            alert(`Parabéns! Fase ${currentLevel} concluída.`);
            nextLevelButton.style.display = 'inline-block';
          } else {
            alert("Desafio concluído! Redirecionando...");
            setTimeout(() => {
              if (URL_DE_REDIRECIONAMENTO) {
                window.location.href = URL_DE_REDIRECIONAMENTO;
              } else {
                alert("Erro ao redirecionar. URL não carregada.");
              }
            }, 2000);
          }
        }
      }

      function handleKeyDown(e) {
        if (!gameActive) return;

        let { x, y } = playerPos;
        if (e.key === 'ArrowUp') y--;
        else if (e.key === 'ArrowDown') y++;
        else if (e.key === 'ArrowLeft') x--;
        else if (e.key === 'ArrowRight') x++;
        else return;

        e.preventDefault();

        if (isValidMove(x, y)) {
          playerPos = { x, y };
          updatePlayerPosition();
          checkWin();
        }
      }

      function startNewLevel() {
        currentLevel++;
        levelDisplay.textContent = currentLevel;

        let mazeRows = 15 + (currentLevel - 1) * 2;
        let mazeCols = 25 + (currentLevel - 1) * 2;

        maze = generateMaze(mazeRows, mazeCols);
        numRows = mazeRows;
        numCols = mazeCols;

        drawMaze();
        playerPos = { ...startPos };
        updatePlayerPosition();

        document.getElementById('game-container').style.width = `${numCols * cellSize}px`;
        document.getElementById('game-container').style.height = `${numRows * cellSize}px`;

        const theme = colorThemes[Math.floor(Math.random() * colorThemes.length)];
        Object.entries(theme).forEach(([prop, val]) =>
          document.documentElement.style.setProperty(prop, val)
        );

        timeDisplay.textContent = '00:00';
        gameActive = true;
        startTimer();
        nextLevelButton.style.display = 'none';

        nextLevelButton.textContent = currentLevel === FASES_NECESSARIAS
          ? 'Concluir Desafio'
          : 'Próxima Fase';
      }

      function restartGame() {
        stopTimer();
        currentLevel = 0;
        startNewLevel();
      }

      document.addEventListener('keydown', handleKeyDown);
      restartButton.addEventListener('click', restartGame);
      nextLevelButton.addEventListener('click', startNewLevel);

      restartGame(); // inicializa o jogo
    });
  </script>
</body>
</html>
