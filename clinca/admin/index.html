<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GesPAI - Painel Administrativo</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            Timestamp,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDgm3YoP4HkIrTFOYGYgOR2VD58ctU2D_U",
            authDomain: "gespaimaspia.firebaseapp.com",
            databaseURL: "https://gespaimaspia.firebaseio.com",
            projectId: "gespaimaspia",
            storageBucket: "gespaimaspia.firebasestorage.app",
            messagingSenderId: "245238673674",
            appId: "1:245238673674:web:2c1108fc499a3f1b0d0af3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = {
            auth,
            db,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            Timestamp,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            orderBy
        };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f8fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo-icon {
            font-size: 2rem;
            color: #3498db;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-admin {
            background-color: #e74c3c;
            color: white;
        }
        
        .badge-user {
            background-color: #3498db;
            color: white;
        }
        
        .badge-bloqueado {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #7f8c8d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #6c7b7d;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-purple {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #8e44ad;
        }
        
        .btn-google {
            background-color: #dd4b39;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
        }
        
        .btn-google:hover {
            background-color: #c23321;
        }
        
        main {
            padding: 30px 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            text-align: center;
        }
        
        .login-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
        }
        
        .login-card h2 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .login-card p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 30px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 10px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            text-decoration: none;
            color: #555;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            background-color: #f1f8ff;
            color: #3498db;
        }
        
        .nav-link.active {
            background-color: #e1f0ff;
            color: #3498db;
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .content-area {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
            min-height: 500px;
        }
        
        .page-title {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Users Management */
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            max-width: 400px;
            flex: 1;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
        }
        
        .users-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .users-table th {
            background-color: #2c3e50;
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
            border-bottom: 2px solid #34495e;
        }
        
        .users-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .users-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .users-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-bloqueado {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-admin {
            background-color: #e74c3c;
            color: white;
        }
        
        .status-user {
            background-color: #3498db;
            color: white;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }
        
        /* Form Styles */
        .form-container {
            max-width: 800px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #3498db;
        }
        
        .stat-card.admin {
            border-left-color: #e74c3c;
        }
        
        .stat-card.user {
            border-left-color: #3498db;
        }
        
        .stat-card.active {
            border-left-color: #27ae60;
        }
        
        .stat-card.inactive {
            border-left-color: #f39c12;
        }
        
        .stat-card.blocked {
            border-left-color: #95a5a6;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: inherit;
        }
        
        /* UID Display */
        .uid-display {
            font-family: monospace;
            font-size: 0.85rem;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            word-break: break-all;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                order: 2;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .users-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .users-table {
                font-size: 0.9rem;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-sm {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon">üîê</div>
                <h1>GesPAI - Painel Administrativo</h1>
            </div>
            <div class="user-info">
                <div id="userAvatar" class="user-avatar hidden"></div>
                <span id="userName" class="hidden"></span>
                <div id="userBadge" class="user-badge hidden"></div>
                <button id="logoutBtn" class="btn btn-secondary hidden">Sair</button>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-card">
                <h2>Painel Administrativo</h2>
                <p>Fa√ßa login com sua conta Google para acessar o painel</p>
                <button id="googleLoginBtn" class="btn btn-google">
                    <span>üîê</span> Login com Google
                </button>
            </div>
        </div>
        
        <!-- Dashboard (hidden by default) -->
        <div id="dashboard" class="dashboard hidden">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" id="navDashboard" class="nav-link active">
                            <span class="nav-icon">üìä</span> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="navUsers" class="nav-link">
                            <span class="nav-icon">üë•</span> Gerenciar Usu√°rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="navAddUser" class="nav-link">
                            <span class="nav-icon">‚ûï</span> Adicionar Usu√°rio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="navAudit" class="nav-link">
                            <span class="nav-icon">üìã</span> Logs de Auditoria
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="navSettings" class="nav-link">
                            <span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes
                        </a>
                    </li>
                </ul>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <div style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px;">
                        Seu UID Administrador:
                    </div>
                    <div id="adminUid" class="uid-display" style="font-size: 0.8rem;">
                        Carregando...
                    </div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Content -->
                <div id="dashboardContent">
                    <h2 class="page-title">Dashboard Administrativo</h2>
                    <div id="adminAlert" class="alert hidden"></div>
                    
                    <div id="dashboardStats" class="stats-grid">
                        <!-- Estat√≠sticas ser√£o carregadas aqui -->
                    </div>
                    
                    <div id="loadingDashboard" class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;"></div>
                    
                    <div id="adminActions" class="hidden">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">A√ß√µes R√°pidas</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showSection('users')">
                                üë• Ver Todos Usu√°rios
                            </button>
                            <button class="btn btn-success" onclick="showSection('addUser')">
                                ‚ûï Adicionar Novo Usu√°rio
                            </button>
                            <button class="btn btn-warning" onclick="showSection('audit')">
                                üìã Ver Logs de Auditoria
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Users Management -->
                <div id="usersContent" class="hidden">
                    <div class="users-header">
                        <h2 class="page-title">Gerenciamento de Usu√°rios</h2>
                        <div class="search-box">
                            <input type="text" id="searchUser" placeholder="Buscar por nome, email ou UID...">
                            <button id="searchUserBtn" class="btn btn-primary">Buscar</button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label for="filterRole">Tipo de Usu√°rio</label>
                            <select id="filterRole" class="form-control">
                                <option value="">Todos</option>
                                <option value="admin">Administrador</option>
                                <option value="user">Usu√°rio Comum</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterStatus">Status</label>
                            <select id="filterStatus" class="form-control">
                                <option value="">Todos</option>
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                                <option value="blocked">Bloqueado</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterDate">Data de Cria√ß√£o</label>
                            <input type="date" id="filterDate" class="form-control">
                        </div>
                        
                        <button id="clearFilters" class="btn btn-secondary" style="align-self: flex-end;">
                            Limpar Filtros
                        </button>
                    </div>
                    
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>UID do Sistema</th>
                                    <th>UID Google</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Criado em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Usu√°rios ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="usersPagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                        <!-- Pagina√ß√£o ser√° gerada aqui -->
                    </div>
                </div>
                
                <!-- Add User Form -->
                <div id="addUserContent" class="hidden">
                    <h2 class="page-title">Adicionar Novo Usu√°rio</h2>
                    <div id="addUserAlert" class="alert hidden"></div>
                    <div class="form-container">
                        <form id="addUserForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userNameInput" class="required">Nome Completo</label>
                                    <input type="text" id="userNameInput" name="nome" required>
                                </div>
                                <div class="form-group">
                                    <label for="userEmail" class="required">Email</label>
                                    <input type="email" id="userEmail" name="email" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userUIDGoogle" class="required">UID do Google</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="userUIDGoogle" name="uidGoogle" required placeholder="Cole o UID do Google do usu√°rio">
                                        <button type="button" class="btn btn-secondary" onclick="useCurrentUserUID()">Usar meu UID</button>
                                    </div>
                                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                                        O UID do Google √© o identificador √∫nico da conta Google do usu√°rio.
                                        √â necess√°rio para que ele possa fazer login no sistema.
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="userPhone">Telefone</label>
                                    <input type="tel" id="userPhone" name="telefone" placeholder="(11) 99999-9999">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userRole" class="required">Tipo de Usu√°rio</label>
                                    <select id="userRole" name="role" required>
                                        <option value="user">Usu√°rio Comum</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="userStatus" class="required">Status Inicial</label>
                                    <select id="userStatus" name="status" required>
                                        <option value="active">Ativo</option>
                                        <option value="inactive">Inativo</option>
                                        <option value="blocked">Bloqueado</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userNotes">Observa√ß√µes</label>
                                <textarea id="userNotes" name="observacoes" placeholder="Observa√ß√µes sobre o usu√°rio"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button type="submit" class="btn btn-success">
                                        üíæ Salvar Usu√°rio
                                    </button>
                                    <button type="reset" class="btn btn-secondary">
                                        üîÑ Limpar Formul√°rio
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="showSection('users')">
                                        ‚Ü©Ô∏è Voltar para Lista
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Audit Logs -->
                <div id="auditContent" class="hidden">
                    <div class="users-header">
                        <h2 class="page-title">Logs de Auditoria</h2>
                        <div class="search-box">
                            <input type="text" id="searchAudit" placeholder="Buscar nos logs...">
                            <button id="searchAuditBtn" class="btn btn-primary">Buscar</button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label for="filterAuditAction">A√ß√£o</label>
                            <select id="filterAuditAction" class="form-control">
                                <option value="">Todas</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="create">Cria√ß√£o</option>
                                <option value="update">Atualiza√ß√£o</option>
                                <option value="delete">Exclus√£o</option>
                                <option value="block">Bloqueio</option>
                                <option value="unblock">Desbloqueio</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterAuditDateFrom">Data In√≠cio</label>
                            <input type="date" id="filterAuditDateFrom" class="form-control">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterAuditDateTo">Data Fim</label>
                            <input type="date" id="filterAuditDateTo" class="form-control">
                        </div>
                        
                        <button id="clearAuditFilters" class="btn btn-secondary" style="align-self: flex-end;">
                            Limpar Filtros
                        </button>
                    </div>
                    
                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usu√°rio</th>
                                    <th>A√ß√£o</th>
                                    <th>Detalhes</th>
                                    <th>IP</th>
                                    <th>Dispositivo</th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody">
                                <!-- Logs ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings -->
                <div id="settingsContent" class="hidden">
                    <h2 class="page-title">Configura√ß√µes do Sistema</h2>
                    <div id="settingsAlert" class="alert hidden"></div>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <h3 style="margin-bottom: 15px; color: #2c3e50;">Configura√ß√µes de Seguran√ßa</h3>
                            
                            <div style="margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Administradores do Sistema</h4>
                                <p style="margin-bottom: 10px; color: #666;">
                                    UID's dos administradores principais (somente estes podem gerenciar outros administradores):
                                </p>
                                <div id="adminUidsList" class="uid-display" style="margin-bottom: 15px;">
                                    Carregando...
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newAdminUid" placeholder="Cole um UID para adicionar como administrador" style="flex: 1;">
                                    <button type="button" class="btn btn-success" onclick="addAdminUID()">Adicionar Admin</button>
                                </div>
                                <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                                    Adicione apenas UID's de confian√ßa. Administradores t√™m controle total sobre o sistema.
                                </small>
                            </div>
                            
                            <div style="margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Bloqueio de IP's</h4>
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input type="text" id="blockIP" placeholder="Ex: 192.168.1.1 ou 192.168.1.0/24" style="flex: 1;">
                                    <button type="button" class="btn btn-danger" onclick="addBlockedIP()">Bloquear IP</button>
                                </div>
                                <div id="blockedIPsList">
                                    <!-- IPs bloqueados ser√£o listados aqui -->
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Configura√ß√µes de Sess√£o</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="sessionTimeout">Timeout de Sess√£o (minutos)</label>
                                        <input type="number" id="sessionTimeout" min="5" max="1440" value="30">
                                    </div>
                                    <div class="form-group">
                                        <label for="maxLoginAttempts">Tentativas M√°ximas de Login</label>
                                        <input type="number" id="maxLoginAttempts" min="1" max="10" value="3">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveSessionSettings()">Salvar Configura√ß√µes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit User Modal -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚úèÔ∏è Editar Usu√°rio</h3>
                    <button class="close-modal" onclick="closeEditUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <input type="hidden" id="editUserUID">
                        
                        <div class="form-group">
                            <label>UID do Sistema</label>
                            <div id="editUserUIDDisplay" class="uid-display"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>UID do Google</label>
                            <div id="editUserGoogleUID" class="uid-display"></div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUserName" class="required">Nome Completo</label>
                                <input type="text" id="editUserName" required>
                            </div>
                            <div class="form-group">
                                <label for="editUserEmail" class="required">Email</label>
                                <input type="email" id="editUserEmail" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUserRole" class="required">Tipo de Usu√°rio</label>
                                <select id="editUserRole" required>
                                    <option value="user">Usu√°rio Comum</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editUserStatus" class="required">Status</label>
                                <select id="editUserStatus" required>
                                    <option value="active">Ativo</option>
                                    <option value="inactive">Inativo</option>
                                    <option value="blocked">Bloqueado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editUserPhone">Telefone</label>
                            <input type="tel" id="editUserPhone">
                        </div>
                        
                        <div class="form-group">
                            <label for="editUserNotes">Observa√ß√µes</label>
                            <textarea id="editUserNotes"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editUserLastLogin">√öltimo Login</label>
                            <input type="text" id="editUserLastLogin" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveUserChanges()">Salvar Altera√ß√µes</button>
                    <button class="btn btn-danger" onclick="deleteUser()">Excluir Usu√°rio</button>
                </div>
            </div>
        </div>
        
        <!-- View User Details Modal -->
        <div id="viewUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üë§ Detalhes do Usu√°rio</h3>
                    <button class="close-modal" onclick="closeViewUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="userDetailsContent">
                        <!-- Detalhes ser√£o carregados aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeViewUserModal()">Fechar</button>
                    <button class="btn btn-primary" onclick="editCurrentUser()">Editar Usu√°rio</button>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Firebase references
        const {
            auth,
            db,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            Timestamp,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            orderBy
        } = window.firebase;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userBadge = document.getElementById('userBadge');
        const adminUid = document.getElementById('adminUid');
        
        // Navigation elements
        const navDashboard = document.getElementById('navDashboard');
        const navUsers = document.getElementById('navUsers');
        const navAddUser = document.getElementById('navAddUser');
        const navAudit = document.getElementById('navAudit');
        const navSettings = document.getElementById('navSettings');
        
        // Content sections
        const dashboardContent = document.getElementById('dashboardContent');
        const usersContent = document.getElementById('usersContent');
        const addUserContent = document.getElementById('addUserContent');
        const auditContent = document.getElementById('auditContent');
        const settingsContent = document.getElementById('settingsContent');
        
        // Forms and lists
        const addUserForm = document.getElementById('addUserForm');
        const editUserForm = document.getElementById('editUserForm');
        
        // Tables bodies
        const usersTableBody = document.getElementById('usersTableBody');
        const auditTableBody = document.getElementById('auditTableBody');
        
        // Search and filter elements
        const searchUser = document.getElementById('searchUser');
        const searchUserBtn = document.getElementById('searchUserBtn');
        const searchAudit = document.getElementById('searchAudit');
        const searchAuditBtn = document.getElementById('searchAuditBtn');
        
        const filterRole = document.getElementById('filterRole');
        const filterStatus = document.getElementById('filterStatus');
        const filterDate = document.getElementById('filterDate');
        const clearFilters = document.getElementById('clearFilters');
        
        const filterAuditAction = document.getElementById('filterAuditAction');
        const filterAuditDateFrom = document.getElementById('filterAuditDateFrom');
        const filterAuditDateTo = document.getElementById('filterAuditDateTo');
        const clearAuditFilters = document.getElementById('clearAuditFilters');
        
        // Settings elements
        const adminUidsList = document.getElementById('adminUidsList');
        const newAdminUid = document.getElementById('newAdminUid');
        const blockedIPsList = document.getElementById('blockedIPsList');
        const blockIP = document.getElementById('blockIP');
        
        // Alert elements
        const adminAlert = document.getElementById('adminAlert');
        const addUserAlert = document.getElementById('addUserAlert');
        const settingsAlert = document.getElementById('settingsAlert');
        
        // Dashboard elements
        const dashboardStats = document.getElementById('dashboardStats');
        const loadingDashboard = document.getElementById('loadingDashboard');
        const adminActions = document.getElementById('adminActions');
        
        // Modal elements
        const editUserModal = document.getElementById('editUserModal');
        const viewUserModal = document.getElementById('viewUserModal');
        const userDetailsContent = document.getElementById('userDetailsContent');
        
        // Global variables
        let currentUser = null;
        let currentAdmin = null;
        let allUsers = [];
        let allAuditLogs = [];
        let isSuperAdmin = false;
        
        // Configuration
        const SUPER_ADMIN_UID = "SEU_UID_AQUI"; // Substitua pelo seu UID do Google
        const USERS_PER_PAGE = 10;
        let currentPage = 1;
        let totalPages = 1;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth state
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await checkAdminStatus(user.uid);
                    updateUserInfo();
                    
                    if (currentAdmin) {
                        showDashboard();
                        loadDashboardStats();
                        loadUsers();
                        loadAuditLogs();
                        loadSettings();
                    } else {
                        showNotAdminMessage();
                    }
                } else {
                    showLogin();
                }
            });
            
            // Event listeners
            googleLoginBtn.addEventListener('click', signInWithGoogle);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Navigation event listeners
            navDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('dashboard');
                updateActiveNav(navDashboard);
            });
            
            navUsers.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('users');
                updateActiveNav(navUsers);
            });
            
            navAddUser.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('addUser');
                updateActiveNav(navAddUser);
            });
            
            navAudit.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('audit');
                updateActiveNav(navAudit);
            });
            
            navSettings.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('settings');
                updateActiveNav(navSettings);
            });
            
            // Form submissions
            addUserForm.addEventListener('submit', handleAddUser);
            
            // Search functionality
            searchUserBtn.addEventListener('click', handleUserSearch);
            searchUser.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleUserSearch();
            });
            
            searchAuditBtn.addEventListener('click', handleAuditSearch);
            searchAudit.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleAuditSearch();
            });
            
            // Filter functionality
            filterRole.addEventListener('change', applyUserFilters);
            filterStatus.addEventListener('change', applyUserFilters);
            filterDate.addEventListener('change', applyUserFilters);
            clearFilters.addEventListener('click', clearUserFilters);
            
            filterAuditAction.addEventListener('change', applyAuditFilters);
            filterAuditDateFrom.addEventListener('change', applyAuditFilters);
            filterAuditDateTo.addEventListener('change', applyAuditFilters);
            clearAuditFilters.addEventListener('click', clearAuditFilters);
            
            // Set current date for filter
            const today = new Date().toISOString().split('T')[0];
            filterDate.value = today;
            
            // Initialize settings date filters
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            filterAuditDateFrom.value = oneWeekAgo.toISOString().split('T')[0];
            filterAuditDateTo.value = today;
        });
        
        // Firebase authentication
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Erro ao fazer login:', error);
                showAlert(adminAlert, `Erro ao fazer login: ${error.message}`, 'error');
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }
        
        // Check if user is admin
        async function checkAdminStatus(userId) {
            try {
                // Check if user is super admin
                if (userId === SUPER_ADMIN_UID) {
                    isSuperAdmin = true;
                    currentAdmin = {
                        uid: userId,
                        isSuperAdmin: true,
                        role: 'superadmin'
                    };
                    return;
                }
                
                // Check in usuarios collection
                const q = query(
                    collection(db, "usuarios"),
                    where("uidGoogle", "==", userId)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (userData.role === 'admin' && userData.status === 'active') {
                            currentAdmin = {
                                id: doc.id,
                                ...userData
                            };
                        }
                    });
                }
                
                // If not found in usuarios, check if should create admin record
                if (!currentAdmin && userId === SUPER_ADMIN_UID) {
                    await createSuperAdminRecord(userId);
                }
                
            } catch (error) {
                console.error('Erro ao verificar status de admin:', error);
            }
        }
        
        async function createSuperAdminRecord(userId) {
            try {
                const adminData = {
                    uidGoogle: userId,
                    nome: "Administrador Principal",
                    email: currentUser.email,
                    role: "superadmin",
                    status: "active",
                    criadoPor: userId,
                    criadoEm: Timestamp.now(),
                    ultimoLogin: Timestamp.now()
                };
                
                await addDoc(collection(db, "usuarios"), adminData);
                currentAdmin = {
                    ...adminData,
                    id: "new"
                };
                
            } catch (error) {
                console.error('Erro ao criar registro de super admin:', error);
            }
        }
        
        // UI functions
        function showLogin() {
            loginScreen.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }
        
        function showNotAdminMessage() {
            loginScreen.classList.remove('hidden');
            dashboard.classList.add('hidden');
            
            loginScreen.innerHTML = `
                <div class="login-card">
                    <h2 style="color: #e74c3c;">‚õî Acesso Negado</h2>
                    <p>Voc√™ n√£o tem permiss√£o para acessar o painel administrativo.</p>
                    <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                        Apenas administradores autorizados podem acessar esta √°rea.
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="window.location.reload()">
                            üîÑ Tentar Novamente
                        </button>
                        <button class="btn btn-primary" onclick="handleLogout()" style="margin-left: 10px;">
                            üîí Sair
                        </button>
                    </div>
                </div>
            `;
        }
        
        function showDashboard() {
            loginScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');
            showSection('dashboard');
            updateActiveNav(navDashboard);
        }
        
        function updateUserInfo() {
            if (currentUser) {
                userAvatar.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'A';
                userName.textContent = currentUser.displayName || currentUser.email;
                
                userAvatar.classList.remove('hidden');
                userName.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                if (currentAdmin) {
                    const badgeText = isSuperAdmin ? 'Super Admin' : 'Administrador';
                    userBadge.textContent = badgeText;
                    userBadge.className = `user-badge badge-admin`;
                    userBadge.classList.remove('hidden');
                    
                    // Show admin UID
                    adminUid.textContent = currentUser.uid;
                }
            }
        }
        
        function showSection(section) {
            const sections = [
                'dashboardContent',
                'usersContent',
                'addUserContent',
                'auditContent',
                'settingsContent'
            ];
            
            sections.forEach(sec => {
                document.getElementById(sec).classList.add('hidden');
            });
            
            switch(section) {
                case 'dashboard':
                    dashboardContent.classList.remove('hidden');
                    break;
                case 'users':
                    usersContent.classList.remove('hidden');
                    break;
                case 'addUser':
                    addUserContent.classList.remove('hidden');
                    break;
                case 'audit':
                    auditContent.classList.remove('hidden');
                    break;
                case 'settings':
                    settingsContent.classList.remove('hidden');
                    break;
            }
        }
        
        function updateActiveNav(activeNav) {
            document.querySelectorAll('.nav-link').forEach(item => {
                item.classList.remove('active');
            });
            activeNav.classList.add('active');
        }
        
        // Dashboard functions
        async function loadDashboardStats() {
            try {
                // Load user statistics
                const totalUsers = await getTotalUsers();
                const activeUsers = await getActiveUsers();
                const adminUsers = await getAdminUsers();
                const blockedUsers = await getBlockedUsers();
                const recentUsers = await getRecentUsers();
                
                dashboardStats.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${totalUsers}</div>
                        <div class="stat-label">Total de Usu√°rios</div>
                    </div>
                    <div class="stat-card active">
                        <div class="stat-value">${activeUsers}</div>
                        <div class="stat-label">Usu√°rios Ativos</div>
                    </div>
                    <div class="stat-card admin">
                        <div class="stat-value">${adminUsers}</div>
                        <div class="stat-label">Administradores</div>
                    </div>
                    <div class="stat-card blocked">
                        <div class="stat-value">${blockedUsers}</div>
                        <div class="stat-label">Usu√°rios Bloqueados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${recentUsers}</div>
                        <div class="stat-label">Novos (7 dias)</div>
                    </div>
                `;
                
                dashboardStats.classList.remove('hidden');
                loadingDashboard.classList.add('hidden');
                adminActions.classList.remove('hidden');
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                dashboardStats.innerHTML = `<div class="alert alert-error">Erro ao carregar estat√≠sticas: ${error.message}</div>`;
            }
        }
        
        async function getTotalUsers() {
            try {
                const q = query(collection(db, "usuarios"));
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        async function getActiveUsers() {
            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("status", "==", "active")
                );
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        async function getAdminUsers() {
            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("role", "==", "admin")
                );
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        async function getBlockedUsers() {
            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("status", "==", "blocked")
                );
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        async function getRecentUsers() {
            try {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const q = query(
                    collection(db, "usuarios"),
                    where("criadoEm", ">=", Timestamp.fromDate(oneWeekAgo))
                );
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        // Users management
        async function loadUsers(page = 1) {
            try {
                currentPage = page;
                
                let q;
                if (isSuperAdmin) {
                    q = query(
                        collection(db, "usuarios"),
                        orderBy("criadoEm", "desc")
                    );
                } else {
                    q = query(
                        collection(db, "usuarios"),
                        where("status", "!=", "superadmin"),
                        orderBy("criadoEm", "desc")
                    );
                }
                
                const querySnapshot = await getDocs(q);
                allUsers = [];
                usersTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                Nenhum usu√°rio cadastrado ainda.
                            </td>
                        </tr>
                    `;
                    updatePagination(0);
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const user = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allUsers.push(user);
                });
                
                // Apply filters and pagination
                applyUserFilters();
                
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #e74c3c;">
                            Erro ao carregar usu√°rios: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderUsersTable(users) {
            usersTableBody.innerHTML = '';
            
            if (users.length === 0) {
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            Nenhum usu√°rio encontrado com os filtros aplicados.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * USERS_PER_PAGE;
            const endIndex = startIndex + USERS_PER_PAGE;
            const paginatedUsers = users.slice(startIndex, endIndex);
            
            paginatedUsers.forEach(user => {
                renderUserRow(user);
            });
            
            // Update pagination
            totalPages = Math.ceil(users.length / USERS_PER_PAGE);
            updatePagination(users.length);
        }
        
        function renderUserRow(user) {
            const row = document.createElement('tr');
            
            // Format dates
            const criadoEm = user.criadoEm?.toDate();
            const criadoEmFormatado = criadoEm ? criadoEm.toLocaleDateString('pt-BR') : 'N/A';
            const ultimoLogin = user.ultimoLogin?.toDate();
            const ultimoLoginFormatado = ultimoLogin ? ultimoLogin.toLocaleDateString('pt-BR') + ' ' + ultimoLogin.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Nunca';
            
            // Status badge
            let statusBadge = '';
            let statusClass = '';
            switch(user.status) {
                case 'active':
                    statusBadge = 'Ativo';
                    statusClass = 'status-active';
                    break;
                case 'inactive':
                    statusBadge = 'Inativo';
                    statusClass = 'status-inactive';
                    break;
                case 'blocked':
                    statusBadge = 'Bloqueado';
                    statusClass = 'status-bloqueado';
                    break;
                default:
                    statusBadge = user.status || 'N/A';
                    statusClass = 'status-inactive';
            }
            
            // Role badge
            let roleBadge = '';
            let roleClass = '';
            switch(user.role) {
                case 'admin':
                case 'superadmin':
                    roleBadge = 'Administrador';
                    roleClass = 'status-admin';
                    break;
                case 'user':
                    roleBadge = 'Usu√°rio';
                    roleClass = 'status-user';
                    break;
                default:
                    roleBadge = user.role || 'N/A';
                    roleClass = 'status-user';
            }
            
            row.innerHTML = `
                <td>
                    <strong>${user.nome || 'N/A'}</strong>
                    ${user.email === currentUser.email ? '<br><small style="color: #3498db;">(Voc√™)</small>' : ''}
                </td>
                <td>${user.email || 'N/A'}</td>
                <td>
                    <div class="uid-display" style="font-size: 0.75rem; padding: 4px 8px;">
                        ${user.id.substring(0, 12)}...
                    </div>
                </td>
                <td>
                    <div class="uid-display" style="font-size: 0.75rem; padding: 4px 8px;">
                        ${user.uidGoogle ? user.uidGoogle.substring(0, 12) + '...' : 'N/A'}
                    </div>
                </td>
                <td><span class="status-badge ${roleClass}">${roleBadge}</span></td>
                <td><span class="status-badge ${statusClass}">${statusBadge}</span></td>
                <td>${criadoEmFormatado}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="viewUser('${user.id}')">
                            üëÅÔ∏è
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}')" 
                            ${!isSuperAdmin && user.role === 'superadmin' ? 'disabled' : ''}>
                            ‚úèÔ∏è
                        </button>
                        ${user.status === 'blocked' ? 
                            `<button class="btn btn-success btn-sm" onclick="unblockUser('${user.id}')">üîì</button>` :
                            `<button class="btn btn-danger btn-sm" onclick="blockUser('${user.id}')" 
                                ${!isSuperAdmin && user.role === 'superadmin' ? 'disabled' : ''}>
                                üîí
                            </button>`
                        }
                    </div>
                </td>
            `;
            
            usersTableBody.appendChild(row);
        }
        
        function updatePagination(totalUsers) {
            const paginationDiv = document.getElementById('usersPagination');
            
            if (totalUsers <= USERS_PER_PAGE) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            if (currentPage > 1) {
                html += `<button class="btn btn-secondary btn-sm" onclick="loadUsers(${currentPage - 1})">‚Üê Anterior</button>`;
            }
            
            // Page numbers
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-primary btn-sm" disabled>${i}</button>`;
                } else {
                    html += `<button class="btn btn-secondary btn-sm" onclick="loadUsers(${i})">${i}</button>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                html += `<button class="btn btn-secondary btn-sm" onclick="loadUsers(${currentPage + 1})">Pr√≥ximo ‚Üí</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }
        
        // Add new user
        async function handleAddUser(e) {
            e.preventDefault();
            
            if (!currentAdmin) {
                showAlert(addUserAlert, 'Voc√™ precisa ser administrador para adicionar usu√°rios.', 'error');
                return;
            }
            
            const formData = new FormData(addUserForm);
            const userData = {
                nome: formData.get('nome'),
                email: formData.get('email'),
                uidGoogle: formData.get('uidGoogle'),
                telefone: formData.get('telefone') || null,
                role: formData.get('role'),
                status: formData.get('status'),
                observacoes: formData.get('observacoes') || null,
                criadoPor: currentUser.uid,
                criadoEm: Timestamp.now(),
                ultimoLogin: null
            };
            
            // Validate required fields
            if (!userData.nome || !userData.email || !userData.uidGoogle) {
                showAlert(addUserAlert, 'Preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }
            
            // Check if Google UID already exists
            const existingUser = await getUserByGoogleUID(userData.uidGoogle);
            if (existingUser) {
                showAlert(addUserAlert, 'Este UID do Google j√° est√° cadastrado no sistema.', 'error');
                return;
            }
            
            // Check if email already exists
            const existingEmail = await getUserByEmail(userData.email);
            if (existingEmail) {
                showAlert(addUserAlert, 'Este email j√° est√° cadastrado no sistema.', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, "usuarios"), userData);
                
                // Log the action
                await logAuditAction('create', `Criou o usu√°rio: ${userData.nome} (${userData.email})`, userData);
                
                showAlert(addUserAlert, `Usu√°rio "${userData.nome}" criado com sucesso!`, 'success');
                addUserForm.reset();
                
                // Reload users list
                loadUsers();
                
            } catch (error) {
                console.error('Erro ao criar usu√°rio:', error);
                showAlert(addUserAlert, `Erro ao criar usu√°rio: ${error.message}`, 'error');
            }
        }
        
        async function getUserByGoogleUID(uidGoogle) {
            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("uidGoogle", "==", uidGoogle)
                );
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (error) {
                return false;
            }
        }
        
        async function getUserByEmail(email) {
            try {
                const q = query(
                    collection(db, "usuarios"),
                    where("email", "==", email)
                );
                const snapshot = await getDocs(q);
                return !snapshot.empty;
            } catch (error) {
                return false;
            }
        }
        
        // Edit user
        async function editUser(userId) {
            try {
                const docRef = doc(db, "usuarios", userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const user = { id: docSnap.id, ...docSnap.data() };
                    
                    // Check permissions
                    if (user.role === 'superadmin' && !isSuperAdmin) {
                        showAlert(adminAlert, 'Voc√™ n√£o tem permiss√£o para editar um super administrador.', 'error');
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('editUserUID').value = user.id;
                    document.getElementById('editUserUIDDisplay').textContent = user.id;
                    document.getElementById('editUserGoogleUID').textContent = user.uidGoogle || 'N/A';
                    document.getElementById('editUserName').value = user.nome || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserPhone').value = user.telefone || '';
                    document.getElementById('editUserRole').value = user.role || 'user';
                    document.getElementById('editUserStatus').value = user.status || 'active';
                    document.getElementById('editUserNotes').value = user.observacoes || '';
                    
                    // Format last login
                    const ultimoLogin = user.ultimoLogin?.toDate();
                    const ultimoLoginFormatado = ultimoLogin ? 
                        ultimoLogin.toLocaleDateString('pt-BR') + ' ' + 
                        ultimoLogin.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 
                        'Nunca';
                    document.getElementById('editUserLastLogin').value = ultimoLoginFormatado;
                    
                    // Disable role change for superadmin if not superadmin
                    if (user.role === 'superadmin' && !isSuperAdmin) {
                        document.getElementById('editUserRole').disabled = true;
                    } else {
                        document.getElementById('editUserRole').disabled = false;
                    }
                    
                    editUserModal.classList.add('active');
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                showAlert(adminAlert, `Erro ao carregar usu√°rio: ${error.message}`, 'error');
            }
        }
        
        function closeEditUserModal() {
            editUserModal.classList.remove('active');
            document.getElementById('editUserForm').reset();
        }
        
        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const userData = {
                nome: document.getElementById('editUserName').value,
                email: document.getElementById('editUserEmail').value,
                telefone: document.getElementById('editUserPhone').value || null,
                role: document.getElementById('editUserRole').value,
                status: document.getElementById('editUserStatus').value,
                observacoes: document.getElementById('editUserNotes').value || null,
                atualizadoEm: Timestamp.now(),
                atualizadoPor: currentUser.uid
            };
            
            try {
                const docRef = doc(db, "usuarios", userId);
                await updateDoc(docRef, userData);
                
                // Log the action
                await logAuditAction('update', `Atualizou o usu√°rio: ${userData.nome} (${userData.email})`, userData);
                
                showAlert(adminAlert, 'Usu√°rio atualizado com sucesso!', 'success');
                closeEditUserModal();
                loadUsers();
                
            } catch (error) {
                console.error('Erro ao atualizar usu√°rio:', error);
                showAlert(adminAlert, `Erro ao atualizar usu√°rio: ${error.message}`, 'error');
            }
        }
        
        // View user details
        async function viewUser(userId) {
            try {
                const docRef = doc(db, "usuarios", userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const user = { id: docSnap.id, ...docSnap.data() };
                    
                    // Format dates
                    const criadoEm = user.criadoEm?.toDate();
                    const criadoEmFormatado = criadoEm ? criadoEm.toLocaleDateString('pt-BR') + ' ' + criadoEm.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                    const ultimoLogin = user.ultimoLogin?.toDate();
                    const ultimoLoginFormatado = ultimoLogin ? ultimoLogin.toLocaleDateString('pt-BR') + ' ' + ultimoLogin.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Nunca';
                    const atualizadoEm = user.atualizadoEm?.toDate();
                    const atualizadoEmFormatado = atualizadoEm ? atualizadoEm.toLocaleDateString('pt-BR') + ' ' + atualizadoEm.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                    
                    // Get creator info
                    let criadoPorNome = 'Sistema';
                    if (user.criadoPor && user.criadoPor !== 'system') {
                        const creatorDoc = await getDoc(doc(db, "usuarios", user.criadoPor));
                        if (creatorDoc.exists()) {
                            criadoPorNome = creatorDoc.data().nome || 'Desconhecido';
                        }
                    }
                    
                    userDetailsContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Informa√ß√µes B√°sicas</h4>
                                <p><strong>Nome:</strong> ${user.nome || 'N/A'}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Telefone:</strong> ${user.telefone || 'N/A'}</p>
                                <p><strong>Tipo:</strong> ${user.role === 'admin' ? 'Administrador' : user.role === 'superadmin' ? 'Super Administrador' : 'Usu√°rio'}</p>
                                <p><strong>Status:</strong> ${user.status === 'active' ? 'Ativo' : user.status === 'inactive' ? 'Inativo' : 'Bloqueado'}</p>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Identificadores</h4>
                                <p><strong>UID do Sistema:</strong></p>
                                <div class="uid-display" style="margin-bottom: 10px;">${user.id}</div>
                                <p><strong>UID do Google:</strong></p>
                                <div class="uid-display">${user.uidGoogle || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Datas</h4>
                                <p><strong>Criado em:</strong> ${criadoEmFormatado}</p>
                                <p><strong>Criado por:</strong> ${criadoPorNome}</p>
                                <p><strong>√öltimo login:</strong> ${ultimoLoginFormatado}</p>
                                <p><strong>Atualizado em:</strong> ${atualizadoEmFormatado}</p>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 10px; color: #2c3e50;">Observa√ß√µes</h4>
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; min-height: 100px;">
                                    ${user.observacoes || 'Nenhuma observa√ß√£o.'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-warning" onclick="editUser('${user.id}'); closeViewUserModal();">
                                ‚úèÔ∏è Editar Usu√°rio
                            </button>
                            ${user.status === 'blocked' ? 
                                `<button class="btn btn-success" onclick="unblockUser('${user.id}'); closeViewUserModal();" style="margin-left: 10px;">
                                    üîì Desbloquear
                                </button>` :
                                `<button class="btn btn-danger" onclick="blockUser('${user.id}'); closeViewUserModal();" style="margin-left: 10px;">
                                    üîí Bloquear
                                </button>`
                            }
                        </div>
                    `;
                    
                    viewUserModal.classList.add('active');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do usu√°rio:', error);
                showAlert(adminAlert, `Erro ao carregar detalhes: ${error.message}`, 'error');
            }
        }
        
        function closeViewUserModal() {
            viewUserModal.classList.remove('active');
        }
        
        function editCurrentUser() {
            const userId = document.getElementById('editUserId').value;
            closeViewUserModal();
            editUser(userId);
        }
        
        // Block/Unblock user
        async function blockUser(userId) {
            if (!confirm('Tem certeza que deseja bloquear este usu√°rio? O usu√°rio n√£o poder√° mais fazer login.')) {
                return;
            }
            
            try {
                const docRef = doc(db, "usuarios", userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    
                    // Check permissions
                    if (user.role === 'superadmin' && !isSuperAdmin) {
                        showAlert(adminAlert, 'Voc√™ n√£o tem permiss√£o para bloquear um super administrador.', 'error');
                        return;
                    }
                    
                    await updateDoc(docRef, {
                        status: 'blocked',
                        atualizadoEm: Timestamp.now(),
                        atualizadoPor: currentUser.uid
                    });
                    
                    // Log the action
                    await logAuditAction('block', `Bloqueou o usu√°rio: ${user.nome} (${user.email})`, { userId });
                    
                    showAlert(adminAlert, 'Usu√°rio bloqueado com sucesso!', 'success');
                    loadUsers();
                }
            } catch (error) {
                console.error('Erro ao bloquear usu√°rio:', error);
                showAlert(adminAlert, `Erro ao bloquear usu√°rio: ${error.message}`, 'error');
            }
        }
        
        async function unblockUser(userId) {
            try {
                const docRef = doc(db, "usuarios", userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    
                    await updateDoc(docRef, {
                        status: 'active',
                        atualizadoEm: Timestamp.now(),
                        atualizadoPor: currentUser.uid
                    });
                    
                    // Log the action
                    await logAuditAction('unblock', `Desbloqueou o usu√°rio: ${user.nome} (${user.email})`, { userId });
                    
                    showAlert(adminAlert, 'Usu√°rio desbloqueado com sucesso!', 'success');
                    loadUsers();
                }
            } catch (error) {
                console.error('Erro ao desbloquear usu√°rio:', error);
                showAlert(adminAlert, `Erro ao desbloquear usu√°rio: ${error.message}`, 'error');
            }
        }
        
        // Delete user
        async function deleteUser() {
            const userId = document.getElementById('editUserId').value;
            
            if (!confirm('ATEN√á√ÉO: Tem certeza que deseja excluir este usu√°rio permanentemente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const docRef = doc(db, "usuarios", userId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    
                    // Check permissions
                    if (user.role === 'superadmin' && !isSuperAdmin) {
                        showAlert(adminAlert, 'Voc√™ n√£o tem permiss√£o para excluir um super administrador.', 'error');
                        return;
                    }
                    
                    // Don't allow deleting yourself
                    if (user.uidGoogle === currentUser.uid) {
                        showAlert(adminAlert, 'Voc√™ n√£o pode excluir seu pr√≥prio usu√°rio.', 'error');
                        return;
                    }
                    
                    await deleteDoc(docRef);
                    
                    // Log the action
                    await logAuditAction('delete', `Excluiu o usu√°rio: ${user.nome} (${user.email})`, { userId });
                    
                    showAlert(adminAlert, 'Usu√°rio exclu√≠do com sucesso!', 'success');
                    closeEditUserModal();
                    loadUsers();
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                showAlert(adminAlert, `Erro ao excluir usu√°rio: ${error.message}`, 'error');
            }
        }
        
        // Audit logs
        async function loadAuditLogs() {
            try {
                const q = query(
                    collection(db, "audit_logs"),
                    orderBy("timestamp", "desc"),
                    limit(100)
                );
                
                const querySnapshot = await getDocs(q);
                allAuditLogs = [];
                auditTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    auditTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Nenhum log de auditoria encontrado.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const log = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allAuditLogs.push(log);
                });
                
                renderAuditTable(allAuditLogs);
                
            } catch (error) {
                console.error('Erro ao carregar logs de auditoria:', error);
                auditTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #e74c3c;">
                            Erro ao carregar logs: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderAuditTable(logs) {
            auditTableBody.innerHTML = '';
            
            if (logs.length === 0) {
                auditTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            Nenhum log encontrado com os filtros aplicados.
                        </td>
                    </tr>
                `;
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = log.timestamp?.toDate();
                const timestampFormatado = timestamp ? 
                    timestamp.toLocaleDateString('pt-BR') + ' ' + 
                    timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 
                    'N/A';
                
                // Action badge
                let actionBadge = '';
                let actionClass = '';
                switch(log.action) {
                    case 'login':
                        actionBadge = 'Login';
                        actionClass = 'status-active';
                        break;
                    case 'logout':
                        actionBadge = 'Logout';
                        actionClass = 'status-inactive';
                        break;
                    case 'create':
                        actionBadge = 'Cria√ß√£o';
                        actionClass = 'status-active';
                        break;
                    case 'update':
                        actionBadge = 'Atualiza√ß√£o';
                        actionClass = 'status-user';
                        break;
                    case 'delete':
                        actionBadge = 'Exclus√£o';
                        actionClass = 'status-bloqueado';
                        break;
                    case 'block':
                        actionBadge = 'Bloqueio';
                        actionClass = 'status-bloqueado';
                        break;
                    case 'unblock':
                        actionBadge = 'Desbloqueio';
                        actionClass = 'status-active';
                        break;
                    default:
                        actionBadge = log.action;
                        actionClass = 'status-inactive';
                }
                
                row.innerHTML = `
                    <td>${timestampFormatado}</td>
                    <td>${log.userName || log.userId || 'Sistema'}</td>
                    <td><span class="status-badge ${actionClass}">${actionBadge}</span></td>
                    <td>${log.description || 'N/A'}</td>
                    <td>${log.ipAddress || 'N/A'}</td>
                    <td>${log.userAgent ? log.userAgent.substring(0, 50) + '...' : 'N/A'}</td>
                `;
                
                auditTableBody.appendChild(row);
            });
        }
        
        // Settings
        async function loadSettings() {
            try {
                // Load admin UIDs
                const adminUids = await getAdminUIDs();
                adminUidsList.innerHTML = adminUids.map(uid => 
                    `<div style="margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <code>${uid}</code>
                        ${uid !== SUPER_ADMIN_UID ? 
                            `<button class="btn btn-danger btn-sm" onclick="removeAdminUID('${uid}')">Remover</button>` : 
                            '<span style="color: #e74c3c; font-size: 0.8rem;">(Super Admin)</span>'
                        }
                    </div>`
                ).join('');
                
                // Load blocked IPs
                const blockedIPs = await getBlockedIPs();
                blockedIPsList.innerHTML = blockedIPs.length > 0 ? 
                    blockedIPs.map(ip => 
                        `<div style="margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <code>${ip}</code>
                            <button class="btn btn-danger btn-sm" onclick="removeBlockedIP('${ip}')">Remover</button>
                        </div>`
                    ).join('') :
                    '<div style="color: #7f8c8d; font-style: italic;">Nenhum IP bloqueado.</div>';
                
                // Load session settings
                const settings = await getSessionSettings();
                document.getElementById('sessionTimeout').value = settings.sessionTimeout || 30;
                document.getElementById('maxLoginAttempts').value = settings.maxLoginAttempts || 3;
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }
        
        async function getAdminUIDs() {
            try {
                // In a real system, you'd store this in a configuration collection
                // For now, we'll use a hardcoded approach
                return [SUPER_ADMIN_UID]; // Add more UIDs as needed
            } catch (error) {
                return [SUPER_ADMIN_UID];
            }
        }
        
        async function getBlockedIPs() {
            try {
                // In a real system, you'd store this in a configuration collection
                return []; // Return array of blocked IPs
            } catch (error) {
                return [];
            }
        }
        
        async function getSessionSettings() {
            try {
                // In a real system, you'd store this in a configuration collection
                return {
                    sessionTimeout: 30,
                    maxLoginAttempts: 3
                };
            } catch (error) {
                return {
                    sessionTimeout: 30,
                    maxLoginAttempts: 3
                };
            }
        }
        
        async function addAdminUID() {
            const newUid = newAdminUid.value.trim();
            
            if (!newUid) {
                showAlert(settingsAlert, 'Digite um UID v√°lido.', 'error');
                return;
            }
            
            if (newUid === SUPER_ADMIN_UID) {
                showAlert(settingsAlert, 'Este UID j√° √© do super administrador.', 'warning');
                return;
            }
            
            // In a real system, you'd save this to Firestore
            showAlert(settingsAlert, `UID ${newUid.substring(0, 12)}... adicionado como administrador.`, 'success');
            newAdminUid.value = '';
            
            // Reload settings
            loadSettings();
        }
        
        async function removeAdminUID(uid) {
            if (!confirm(`Tem certeza que deseja remover o UID ${uid.substring(0, 12)}... como administrador?`)) {
                return;
            }
            
            // In a real system, you'd remove this from Firestore
            showAlert(settingsAlert, 'Administrador removido com sucesso!', 'success');
            
            // Reload settings
            loadSettings();
        }
        
        async function addBlockedIP() {
            const ip = blockIP.value.trim();
            
            if (!ip) {
                showAlert(settingsAlert, 'Digite um IP v√°lido.', 'error');
                return;
            }
            
            // Simple IP validation
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
            if (!ipRegex.test(ip)) {
                showAlert(settingsAlert, 'Digite um IP v√°lido (ex: 192.168.1.1 ou 192.168.1.0/24).', 'error');
                return;
            }
            
            // In a real system, you'd save this to Firestore
            showAlert(settingsAlert, `IP ${ip} bloqueado com sucesso!`, 'success');
            blockIP.value = '';
            
            // Reload settings
            loadSettings();
        }
        
        async function removeBlockedIP(ip) {
            if (!confirm(`Tem certeza que deseja remover o bloqueio do IP ${ip}?`)) {
                return;
            }
            
            // In a real system, you'd remove this from Firestore
            showAlert(settingsAlert, 'IP desbloqueado com sucesso!', 'success');
            
            // Reload settings
            loadSettings();
        }
        
        async function saveSessionSettings() {
            const sessionTimeout = parseInt(document.getElementById('sessionTimeout').value);
            const maxLoginAttempts = parseInt(document.getElementById('maxLoginAttempts').value);
            
            if (sessionTimeout < 5 || sessionTimeout > 1440) {
                showAlert(settingsAlert, 'Timeout de sess√£o deve estar entre 5 e 1440 minutos.', 'error');
                return;
            }
            
            if (maxLoginAttempts < 1 || maxLoginAttempts > 10) {
                showAlert(settingsAlert, 'Tentativas m√°ximas de login deve estar entre 1 e 10.', 'error');
                return;
            }
            
            // In a real system, you'd save this to Firestore
            showAlert(settingsAlert, 'Configura√ß√µes de sess√£o salvas com sucesso!', 'success');
        }
        
        // Helper functions
        async function logAuditAction(action, description, details = {}) {
            try {
                const auditData = {
                    action,
                    description,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    timestamp: Timestamp.now(),
                    ipAddress: await getClientIP(),
                    userAgent: navigator.userAgent,
                    details: JSON.stringify(details)
                };
                
                await addDoc(collection(db, "audit_logs"), auditData);
                
            } catch (error) {
                console.error('Erro ao registrar a√ß√£o de auditoria:', error);
            }
        }
        
        async function getClientIP() {
            // In a real application, you'd get this from your backend
            // For Firebase, you might need a Cloud Function to get the real IP
            return '0.0.0.0'; // Placeholder
        }
        
        function useCurrentUserUID() {
            if (currentUser) {
                document.getElementById('userUIDGoogle').value = currentUser.uid;
            }
        }
        
        // Search and filter functions
        function handleUserSearch() {
            applyUserFilters();
        }
        
        function applyUserFilters() {
            let filtered = [...allUsers];
            const searchTerm = searchUser.value.toLowerCase().trim();
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    (user.nome && user.nome.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.uidGoogle && user.uidGoogle.toLowerCase().includes(searchTerm)) ||
                    (user.id && user.id.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply role filter
            const roleFilter = filterRole.value;
            if (roleFilter) {
                filtered = filtered.filter(user => user.role === roleFilter);
            }
            
            // Apply status filter
            const statusFilter = filterStatus.value;
            if (statusFilter) {
                filtered = filtered.filter(user => user.status === statusFilter);
            }
            
            // Apply date filter
            const dateFilter = filterDate.value;
            if (dateFilter) {
                const filterDateObj = new Date(dateFilter);
                filtered = filtered.filter(user => {
                    const userDate = user.criadoEm?.toDate();
                    if (!userDate) return false;
                    return userDate.toDateString() === filterDateObj.toDateString();
                });
            }
            
            renderUsersTable(filtered);
        }
        
        function clearUserFilters() {
            searchUser.value = '';
            filterRole.value = '';
            filterStatus.value = '';
            filterDate.value = new Date().toISOString().split('T')[0];
            renderUsersTable(allUsers);
        }
        
        function handleAuditSearch() {
            applyAuditFilters();
        }
        
        function applyAuditFilters() {
            let filtered = [...allAuditLogs];
            const searchTerm = searchAudit.value.toLowerCase().trim();
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(log => 
                    (log.description && log.description.toLowerCase().includes(searchTerm)) ||
                    (log.userName && log.userName.toLowerCase().includes(searchTerm)) ||
                    (log.action && log.action.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply action filter
            const actionFilter = filterAuditAction.value;
            if (actionFilter) {
                filtered = filtered.filter(log => log.action === actionFilter);
            }
            
            // Apply date range filter
            const dateFrom = filterAuditDateFrom.value;
            const dateTo = filterAuditDateTo.value;
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(log => {
                    const logDate = log.timestamp?.toDate();
                    if (!logDate) return false;
                    return logDate >= fromDate;
                });
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999); // End of day
                filtered = filtered.filter(log => {
                    const logDate = log.timestamp?.toDate();
                    if (!logDate) return false;
                    return logDate <= toDate;
                });
            }
            
            renderAuditTable(filtered);
        }
        
        function clearAuditFilters() {
            searchAudit.value = '';
            filterAuditAction.value = '';
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            filterAuditDateFrom.value = oneWeekAgo.toISOString().split('T')[0];
            filterAuditDateTo.value = new Date().toISOString().split('T')[0];
            
            renderAuditTable(allAuditLogs);
        }
        
        function showAlert(container, message, type) {
            container.innerHTML = '';
            container.className = `alert alert-${type}`;
            container.innerHTML = `
                <div>${message}</div>
                <button class="alert-close" onclick="this.parentElement.classList.add('hidden')">&times;</button>
            `;
            container.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 5000);
            }
        }
    </script>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
