<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contato com Admin - Acesso Restrito</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        /* Estilos b√°sicos para melhor visualiza√ß√£o */
        body { font-family: sans-serif; margin: 20px; }
        #login-page { text-align: center; }
        #app-content { display: none; }
        #mensagens-container { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: scroll; }
        .mensagem { border-bottom: 1px dashed #eee; padding: 5px 0; }
        .mensagem strong { color: #007bff; }
        .mensagem small { color: #6c757d; font-size: 0.8em; }
        #consentimento-link { text-decoration: none; color: blue; }
        .user-info { margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

    <div id="login-page">
        <h2>Acesso Restrito</h2>
        <p>Por favor, fa√ßa login com sua conta Google para continuar.</p>
        <button id="google-login-btn">Entrar com Google</button>
    </div>

    <div id="app-content">
        <div class="user-info">
            <p>Logado como: <strong id="user-display-name"></strong> (<span id="user-uid"></span>)</p>
            <button id="logout-btn">Sair</button>
        </div>
        
        <hr>

        <h3>Suas √öltimas Mensagens Enviadas</h3>
        <div id="mensagens-container">
            <p>Carregando mensagens...</p>
        </div>

        <hr>

        <h3>Enviar Nova Mensagem</h3>
        <form id="mensagem-form">
            <label for="assunto">Assunto:</label><br>
            <input type="text" id="assunto" name="assunto" required><br><br>

            <label for="mensagem">Campo da mensagem:</label><br>
            <textarea id="mensagem" name="mensagem" rows="5" required></textarea><br><br>

            <label for="midia-link">Link de m√≠dias ou PDF externos:</label><br>
            <input type="url" id="midia-link" name="midia-link"><br><br>

            <input type="checkbox" id="consentimento" name="consentimento" required>
            <label for="consentimento">Eu concordo com o <a id="consentimento-link" href="consentimento.pdf" target="_blank">termo de consentimento</a> (PDF)</label><br><br>

            <button type="submit">Enviar Mensagem</button>
            <p id="feedback" style="color: green;"></p>
        </form>
    </div>

    <script>
        // üö® ATEN√á√ÉO: SUBSTITUA ESTA LINHA PELO UID REAL DO SEU ADMINISTRADOR!
        const ADMIN_UID = "sZxfMuOBPbXdR8nttVPXIN8QOOl1"; 
        
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const COLECAO_CONTATO = "contatowazzimagiygg";

        // Elementos do DOM
        const loginPage = document.getElementById('login-page');
        const appContent = document.getElementById('app-content');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const mensagemForm = document.getElementById('mensagem-form');
        const mensagensContainer = document.getElementById('mensagens-container');
        const feedbackElement = document.getElementById('feedback');
        const userDisplayName = document.getElementById('user-display-name');
        const userUID = document.getElementById('user-uid');


        // --- Fun√ß√µes de Autentica√ß√£o e L√≥gica da Aplica√ß√£o ---

        googleLoginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => console.error("Erro no login:", error));
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Observa o estado da autentica√ß√£o
        auth.onAuthStateChanged(user => {
            if (user) {
                // Usu√°rio Logado: Exibe o conte√∫do e carrega mensagens
                loginPage.style.display = 'none';
                appContent.style.display = 'block';

                userDisplayName.textContent = user.displayName || user.email;
                userUID.textContent = user.uid;
                
                carregarUltimasMensagens(user.uid);
            } else {
                // Usu√°rio Deslogado: Exibe a tela de login
                loginPage.style.display = 'block';
                appContent.style.display = 'none';
            }
        });

        // --- Fun√ß√µes do Firestore (Leitura) ---

        function carregarUltimasMensagens(uid) {
            mensagensContainer.innerHTML = 'Carregando...';

            db.collection(COLECAO_CONTATO)
                // Filtra apenas mensagens enviadas pelo usu√°rio logado
                .where("uidRemetente", "==", uid) 
                .orderBy("dataEnvio", "desc")
                .limit(10) 
                .get()
                .then(snapshot => {
                    mensagensContainer.innerHTML = ''; 
                    if (snapshot.empty) {
                        mensagensContainer.innerHTML = '<p>Voc√™ ainda n√£o enviou nenhuma mensagem.</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Nota: O campo 'uidDestinatario' deve ser igual ao ADMIN_UID
                        const destinatario = data.uidDestinatario === ADMIN_UID ? 'Admin' : 'Outro'; 
                        const dataFormatada = data.dataEnvio ? new Date(data.dataEnvio.toDate()).toLocaleString() : 'Data indispon√≠vel';
                        
                        const divMensagem = document.createElement('div');
                        divMensagem.className = 'mensagem';
                        divMensagem.innerHTML = `
                            <strong>Assunto:</strong> ${data.assunto} 
                            <small>(${dataFormatada}) - Enviado para: ${destinatario}</small><br>
                            <p>${data.mensagem.substring(0, 100)}${data.mensagem.length > 100 ? '...' : ''}</p> 
                            ${data.midiaLink ? `<p>Link: <a href="${data.midiaLink}" target="_blank">Abrir M√≠dia/PDF</a></p>` : ''}
                        `;
                        mensagensContainer.appendChild(divMensagem);
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar mensagens:", error);
                    mensagensContainer.innerHTML = '<p style="color: red;">Erro ao carregar mensagens.</p>';
                });
        }

        // --- Fun√ß√µes do Firestore (Escrita) ---

        mensagemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            feedbackElement.textContent = 'Enviando...';
            
            const user = auth.currentUser;
            if (!user) {
                alert("Voc√™ precisa estar logado para enviar uma mensagem.");
                feedbackElement.textContent = '';
                return;
            }

            // Captura os dados do formul√°rio e INCLUI o UID do administrador
            const dadosMensagem = {
                uidRemetente: user.uid, // O UID de quem envia
                emailRemetente: user.email,
                displayNameRemetente: user.displayName,
                uidDestinatario: ADMIN_UID, // O UID do administrador que voc√™ definiu
                assunto: document.getElementById('assunto').value,
                mensagem: document.getElementById('mensagem').value,
                midiaLink: document.getElementById('midia-link').value || null,
                dataEnvio: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pendente' 
            };

            try {
                // Adiciona o documento √† cole√ß√£o
                await db.collection(COLECAO_CONTATO).add(dadosMensagem);
                
                feedbackElement.textContent = 'Mensagem enviada com sucesso! Aguarde o retorno do administrador.';
                mensagemForm.reset(); 
                document.getElementById('consentimento').checked = false; 

                // Recarrega as √∫ltimas mensagens
                carregarUltimasMensagens(user.uid); 

            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                feedbackElement.textContent = `Erro ao enviar mensagem: ${error.message}`;
                feedbackElement.style.color = 'red';
            }
        });

    </script>
</body>
</html>
