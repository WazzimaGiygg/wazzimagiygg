<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WazzimaGiygg - Contato e Mensagens</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Estilos base */
        :root {
            --color-primary: #4285F4;
            --color-text-dark: #202124;
            --color-text-light: #5f6368;
            --color-background-card: #ffffff;
            --border-radius: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        /* Layout de Duas Colunas */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            width: 300px;
            background-color: var(--color-background-card);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .chat-area {
            flex-grow: 1;
            background-color: var(--color-background-card);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Estilos da Sidebar (Contatos e Busca) */
        .contact-item, .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .contact-item:hover, .conversation-item:hover, .conversation-item.active {
            background-color: #e8f0fe;
        }
        .conversation-item strong { display: block; }
        .contact-item strong { color: var(--color-text-dark); }
        .last-message { font-size: 0.8em; color: var(--color-text-light); }

        #search-results { margin-top: 10px; }
        .search-form input, .chat-form textarea, .chat-form input {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #dadce0;
            border-radius: 4px; box-sizing: border-box; resize: vertical;
        }
        .search-form button { padding: 10px 15px; background-color: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* Estilos do Chat */
        #mensagens-container {
            border: 1px solid #dadce0;
            background-color: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            height: 400px; /* Altura fixa */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .mensagem {
            max-width: 80%;
            margin-bottom: 15px;
            padding: 10px 15px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            line-height: 1.4;
            font-size: 15px;
        }

        .chat-remetente { /* Mensagens do Usu√°rio Logado */
            background-color: #e6f4ea; 
            align-self: flex-end;
            border-radius: 18px 18px 0 18px; 
        }

        .chat-destinatario { /* Mensagens do Destinat√°rio (Admin ou outro User) */
            background-color: #ffffff; 
            align-self: flex-start;
            border-radius: 18px 18px 18px 0;
            border: 1px solid #dadce0;
        }
        
        .chat-info {
            font-size: 0.7em !important;
            margin-top: 5px !important;
            text-align: right;
            display: block;
            color: #5f6368;
        }
        .chat-destinatario .chat-info { text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="color: var(--color-primary);">Sistema de Mensagens Diretas (DM)</h1>
        
        <div id="auth-status" style="padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba;">Carregando autentica√ß√£o...</div>

        <div id="app-content" style="display: none;">
            <div class="main-content">
                
                <div class="sidebar">
                    <h3>Buscar Contato</h3>
                    <form id="search-form" class="search-form">
                        <input type="text" id="search-input" placeholder="Buscar por Nome, Email ou UID" required>
                        <button type="submit">Buscar</button>
                    </form>
                    <div id="search-results"></div>
                    
                    <h3 style="margin-top: 20px;">Minhas Conversas</h3>
                    <div id="conversations-list">
                        <div class="conversation-item active" data-uid="" data-displayname="Administrador">
                            <strong>Chat com Administrador</strong>
                            <small class="last-message">Clique para conversar.</small>
                        </div>
                        </div>
                </div>

                <div class="chat-area">
                    <h2 id="chat-status-title">Carregando...</h2>
                    
                    <div id="mensagens-container">
                        <p>Aguardando login...</p>
                    </div>
                    
                    <form id="enviar-mensagem-form" class="chat-form">
                        <textarea id="mensagem-input" rows="3" placeholder="Digite sua mensagem..." required></textarea><br>

                        <label for="midia-link-input" style="font-size: 0.9em; margin-top: 10px;">Link de M√≠dia (Opcional):</label>
                        <input type="url" id="midia-link-input" placeholder="Ex: https://link.para/pdf.ou.imagem"><br>

                        <button type="submit" style="margin-top: 15px;">Enviar Mensagem</button>
                        <p id="feedback-mensagem" style="margin-top: 10px;"></p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üö® CONFIGURA√á√ïES E CONSTANTES - SUBSTITUA PELOS SEUS VALORES REAIS
        const ADMIN_UID = "sZxfMuOBPbXdR8nttVPXIN8QOOl1"; 
        
        const firebaseConfig = {
            apiKey: "SUA_API_KEY", // Substitua
            authDomain: "SEU_AUTH_DOMAIN", // Substitua
            projectId: "SEU_PROJECT_ID", // Substitua
            // ... restante da sua config
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();
        const COLECAO_CONTATO = "contatowazzimagiygg";
        const COLECAO_USERS = "users"; // Ou "usuarios" se for o nome que voc√™ usa

        // Vari√°veis de estado
        let currentUser = null;
        let ultimoUidAtivo = ADMIN_UID;
        let ultimoDisplayNameAtivo = "Administrador";
        let unsubscribeChat = null; 

        // Elementos do DOM
        const authStatus = document.getElementById('auth-status');
        const appContent = document.getElementById('app-content');
        const mensagensContainer = document.getElementById('mensagens-container');
        const chatStatusTitle = document.getElementById('chat-status-title');
        const enviarMensagemForm = document.getElementById('enviar-mensagem-form');
        const feedbackMensagem = document.getElementById('feedback-mensagem');
        const searchForm = document.getElementById('search-form');
        const conversationsList = document.getElementById('conversations-list');
        const adminConversationItem = document.querySelector('.conversation-item[data-uid="ADMIN_UID"]');
        
        // Atribui o UID do Admin ao item fixo na sidebar
        if (adminConversationItem) {
            adminConversationItem.setAttribute('data-uid', ADMIN_UID);
        }

        // --- L√≥gica de Autentica√ß√£o ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authStatus.textContent = `Logado como: ${user.displayName || user.email}`;
                appContent.style.display = 'block';
                
                // 1. Configura o primeiro chat com o Admin
                adminConversationItem.addEventListener('click', () => setChatActive(ADMIN_UID, 'Administrador'));
                
                // 2. Inicia o chat default
                setChatActive(ADMIN_UID, 'Administrador');

                // 3. Opcional: ouvir outras conversas recentes
                // Para manter a simplicidade e a performance, n√£o carregaremos todas as conversas recentes
                // na sidebar do usu√°rio (devido √† limita√ß√£o do Firestore em consultas OR).
                // O usu√°rio deve buscar o contato ou ter√° o chat iniciado ap√≥s a primeira mensagem.

            } else {
                authStatus.innerHTML = 'Voc√™ precisa estar logado para usar o chat. <button onclick="loginWithGoogle()">Fazer Login</button>';
                appContent.style.display = 'none';
                currentUser = null;
            }
        });
        
        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => console.error("Erro no login:", error));
        }

        // --- Fun√ß√µes Auxiliares de Chat ---
        function getTargetUid() {
            return ultimoUidAtivo; // O UID do destinat√°rio √© simplesmente o UID ativo no momento
        }
        
        function setChatActive(uid, displayName) {
            // 1. Desinscreve a escuta anterior, se houver
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            
            ultimoUidAtivo = uid;
            ultimoDisplayNameAtivo = displayName;
            chatStatusTitle.textContent = `Chat com: ${displayName}`;

            // 2. Atualiza a sidebar visualmente
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.querySelector(`.conversation-item[data-uid="${uid}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // 3. Inicia a nova escuta
            ouvirHistoricoChat(uid, displayName);
        }

        // --- L√≥gica de Hist√≥rico de Chat (CORRIGIDA) ---
        function ouvirHistoricoChat(targetUid, targetDisplayName) {
            if (!currentUser) return;
            mensagensContainer.innerHTML = '<p style="color: var(--color-text-light);">Carregando hist√≥rico...</p>';

            const userUid = currentUser.uid;
            
            // O Firestore n√£o suporta OR, ent√£o faremos duas queries de escuta (onSnapshot)
            // e mesclaremos os resultados no c√≥digo.

            const queryUserToTarget = db.collection(COLECAO_CONTATO)
                .where("uidRemetente", "==", userUid)
                .where("uidDestinatario", "==", targetUid)
                .orderBy("dataEnvio", "asc")
                .limit(50);
                
            const queryTargetToUser = db.collection(COLECAO_CONTATO)
                .where("uidRemetente", "==", targetUid)
                .where("uidDestinatario", "==", userUid)
                .orderBy("dataEnvio", "asc")
                .limit(50);

            let allMessages = [];
            let snapshotsReceived = 0;

            const renderCombinedChat = () => {
                // Ordena todas as mensagens combinadas pela data de envio
                allMessages.sort((a, b) => a.dataEnvio.seconds - b.dataEnvio.seconds);
                
                mensagensContainer.innerHTML = '';
                if (allMessages.length === 0) {
                     mensagensContainer.innerHTML = `<p style="text-align: center;">Inicie a conversa com ${targetDisplayName}.</p>`;
                }
                
                allMessages.forEach(data => {
                    const isMyMessage = data.uidRemetente === userUid;
                    const nomeDisplay = isMyMessage ? 'Voc√™' : targetDisplayName;

                    const classeChat = isMyMessage ? 'chat-remetente' : 'chat-destinatario';
                    const dataFormatada = data.dataEnvio ? new Date(data.dataEnvio.toDate()).toLocaleTimeString() : '';
                    
                    const divMensagem = document.createElement('div');
                    divMensagem.className = 'mensagem ' + classeChat;
                    divMensagem.innerHTML = `
                        <p class="chat-text">${data.mensagem}</p>
                        ${data.midiaLink ? `<p><a href="${data.midiaLink}" target="_blank">Abrir M√≠dia/PDF</a></p>` : ''}
                        <small class="chat-info">(${nomeDisplay}) - ${dataFormatada}</small>
                    `;
                    mensagensContainer.appendChild(divMensagem);
                });

                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
            };

            const listener = (snapshot) => {
                 // Mapeia o snapshot para objetos de dados
                 const newMessages = snapshot.docs.map(doc => doc.data());
                 
                 // Combina as mensagens, eliminando duplicatas (se necess√°rio) e reordena
                 allMessages = allMessages.filter(msg => 
                     !newMessages.some(newMsg => newMsg.dataEnvio.isEqual && newMsg.dataEnvio.isEqual(msg.dataEnvio))
                 ).concat(newMessages);
                 
                 renderCombinedChat();
            };
            
            const errorHandler = (error) => {
                console.error("Erro ao carregar chat:", error);
                mensagensContainer.innerHTML = `<p style="color: red;">Erro ao carregar chat: ${error.message}</p>`;
            };

            // 1¬™ Escuta: Mensagens enviadas pelo usu√°rio
            const unsubscribe1 = queryUserToTarget.onSnapshot(listener, errorHandler);

            // 2¬™ Escuta: Mensagens recebidas pelo usu√°rio
            const unsubscribe2 = queryTargetToUser.onSnapshot(listener, errorHandler);
            
            // Retorna uma fun√ß√£o de desinscri√ß√£o combinada
            unsubscribeChat = () => {
                unsubscribe1();
                unsubscribe2();
            };
        }
        
        // --- L√≥gica de Envio de Mensagem ---
        enviarMensagemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;
            
            feedbackMensagem.textContent = 'Enviando...';
            feedbackMensagem.style.color = '#1a73e8';

            const targetUid = getTargetUid();
            const mensagem = document.getElementById('mensagem-input').value;
            const midiaLink = document.getElementById('midia-link-input').value;

            const dadosMensagem = {
                uidRemetente: currentUser.uid,
                emailRemetente: currentUser.email,
                displayNameRemetente: currentUser.displayName,
                uidDestinatario: targetUid, 
                assunto: 'Chat DM', 
                mensagem: mensagem,
                midiaLink: midiaLink || null,
                dataEnvio: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'aberto'
            };

            try {
                await db.collection(COLECAO_CONTATO).add(dadosMensagem);
                
                feedbackMensagem.textContent = 'Mensagem enviada!';
                feedbackMensagem.style.color = 'green';
                enviarMensagemForm.reset(); 

            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                feedbackMensagem.textContent = `Erro ao enviar: ${error.message}`;
                feedbackMensagem.style.color = 'red';
            }
        });

        // --- L√≥gica de Busca de Usu√°rios ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const searchTerm = document.getElementById('search-input').value;
            searchUsers(searchTerm);
        });

        async function searchUsers(searchTerm) {
            if (!currentUser) return;

            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '<p>Buscando...</p>';

            const term = searchTerm.trim();
            if (term.length < 3) {
                resultsContainer.innerHTML = '<p>Digite pelo menos 3 caracteres.</p>';
                return;
            }
            
            let query;
            const isUid = term.length === 28;
            const isEmail = term.includes('@');

            if (isUid) {
                // Busca por UID (document ID)
                query = db.collection(COLECAO_USERS).where(firebase.firestore.FieldPath.documentId(), '==', term).limit(1);
            } else if (isEmail) {
                // Busca por Email (requer que o campo 'email' exista na cole√ß√£o 'users')
                query = db.collection(COLECAO_USERS).where('email', '==', term).limit(1);
            } else {
                // Busca por Nome - (A busca "startswith" requer √≠ndice e √© lenta, mas √© mais amig√°vel)
                // Usaremos uma busca por nome exato para simplificar e garantir precis√£o
                query = db.collection(COLECAO_USERS).where('displayName', '==', term).limit(1);
            }
            

            try {
                const snapshot = await query.get();
                renderSearchResults(snapshot.docs);
            } catch (error) {
                 console.error("Erro ao buscar usu√°rios:", error);
                 resultsContainer.innerHTML = `<p style="color: red;">Erro na busca. Verifique as regras e os √≠ndices do Firestore.</p>`;
            }
        }

        function renderSearchResults(docs) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            if (docs.length === 0) {
                resultsContainer.innerHTML = '<p>Nenhum usu√°rio encontrado.</p>';
                return;
            }

            docs.forEach(doc => {
                const data = doc.data();
                const uid = doc.id;
                
                // Evita mostrar a si mesmo nos resultados da busca
                if (uid === currentUser.uid) return;

                const displayName = data.displayName || data.name || data.email;

                const item = document.createElement('div');
                item.className = 'contact-item';
                item.innerHTML = `<strong>${displayName}</strong> <small>(${data.email})</small>`;
                
                item.addEventListener('click', () => {
                    // 1. Inicia o chat com o usu√°rio encontrado
                    setChatActive(uid, displayName);
                    
                    // 2. Limpa e esconde a busca
                    document.getElementById('search-input').value = '';
                    resultsContainer.innerHTML = '';

                    // 3. Adiciona o item √† lista de conversas (se n√£o existir)
                    let existingItem = document.querySelector(`.conversation-item[data-uid="${uid}"]`);
                    if (!existingItem) {
                         const conversationItem = document.createElement('div');
                         conversationItem.className = 'conversation-item';
                         conversationItem.setAttribute('data-uid', uid);
                         conversationItem.setAttribute('data-displayname', displayName);
                         conversationItem.innerHTML = `<strong>${displayName}</strong> <small class="last-message">Chat DM</small>`;
                         
                         conversationItem.addEventListener('click', () => setChatActive(uid, displayName));
                         conversationsList.appendChild(conversationItem);
                    }
                });

                resultsContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>
