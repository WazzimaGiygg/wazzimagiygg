<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artigos Recentes</title>
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: #fafafa;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px;
    }
    .article-section {
      margin: 30px 20px;
    }
    .article-section h3 {
      border-bottom: 2px solid #3f51b5;
      padding-bottom: 5px;
      color: #3f51b5;
    }
    .article-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .article-item {
      background: white;
      border-radius: 6px;
      padding: 10px 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }
    .article-item:hover {
      background: #f5f5f5;
    }
    .article-item small {
      color: #666;
      display: block;
    }
  </style>
</head>
<body>

  <div class="filters">
    <input type="text" id="search-title" placeholder="Buscar por título..." class="mdl-textfield__input" style="flex:1;">
    <input type="text" id="search-uid" placeholder="Buscar por UID..." class="mdl-textfield__input" style="flex:1;">
    <select id="filter-sector" class="mdl-textfield__input">
      <option value="">Todos os Setores</option>
      <option value="Científico">Científico</option>
      <option value="Tecnologia">Tecnologia</option>
      <option value="História">História</option>
    </select>
    <select id="filter-category" class="mdl-textfield__input">
      <option value="">Todas as Categorias</option>
      <option value="Análises">Análises</option>
      <option value="Notícias">Notícias</option>
      <option value="Documentários">Documentários</option>
    </select>
    <select id="filter-idioma" class="mdl-textfield__input">
      <option value="">Todos os Idiomas</option>
      <option value="pt-BR">Português</option>
      <option value="en-US">Inglês</option>
      <option value="es-ES">Espanhol</option>
    </select>
    <button id="search-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
      Buscar
    </button>
  </div>

  <div id="articles-container"></div>

  <script>
    // --- Configuração Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
      authDomain: "wzzm-ce3fc.firebaseapp.com",
      projectId: "wzzm-ce3fc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const container = document.getElementById("articles-container");
    const searchBtn = document.getElementById("search-button");

    // Função principal de busca
    async function searchArticles() {
      const title = document.getElementById("search-title").value.toLowerCase();
      const uid = document.getElementById("search-uid").value;
      const sector = document.getElementById("filter-sector").value;
      const category = document.getElementById("filter-category").value;
      const idioma = document.getElementById("filter-idioma").value;

      let query = db.collection("artigos").orderBy("createdAt", "desc").limit(100);

      // Filtros dinâmicos
      if (sector) query = query.where("setor", "==", sector);
      if (category) query = query.where("categoria", "==", category);
      if (idioma) query = query.where("idioma", "==", idioma);

      const snapshot = await query.get();
      const results = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const matchTitle = title ? data.titulo.toLowerCase().includes(title) : true;
        const matchUID = uid ? doc.id.includes(uid) : true;

        if (matchTitle && matchUID) results.push({ id: doc.id, ...data });
      });

      renderArticles(results);
    }

    // Renderiza os artigos em cascata
    function renderArticles(articles) {
      container.innerHTML = "";

      const sectors = {};

      // Organiza por setor e categoria
      articles.forEach(a => {
        if (!sectors[a.setor]) sectors[a.setor] = {};
        if (!sectors[a.setor][a.categoria]) sectors[a.setor][a.categoria] = [];
        if (sectors[a.setor][a.categoria].length < 10)
          sectors[a.setor][a.categoria].push(a);
      });

      for (const setor in sectors) {
        const sectorDiv = document.createElement("div");
        sectorDiv.className = "article-section";
        sectorDiv.innerHTML = `<h3>${setor}</h3>`;

        for (const categoria in sectors[setor]) {
          const catDiv = document.createElement("div");
          catDiv.innerHTML = `<h4>${categoria}</h4><div class="article-list"></div>`;
          const list = catDiv.querySelector(".article-list");

          sectors[setor][categoria].forEach(a => {
            const item = document.createElement("div");
            item.className = "article-item";
            item.innerHTML = `
              <strong>${a.titulo}</strong>
              <small>UID: ${a.uid || a.id}</small>
              <small>Idioma: ${a.idioma || 'pt-BR'}</small>
            `;
            item.addEventListener("click", () => {
              window.parent.postMessage({ action: "openArticle", url: a.link || `https://wzzm.org/html/?uid=${a.id}` }, "*");
            });
            list.appendChild(item);
          });

          sectorDiv.appendChild(catDiv);
        }

        container.appendChild(sectorDiv);
      }

      if (articles.length === 0) {
        container.innerHTML = "<p style='margin:20px;color:#777;'>Nenhum artigo encontrado.</p>";
      }
    }

    // Busca inicial (artigos recentes)
    searchBtn.addEventListener("click", searchArticles);
    window.addEventListener("load", searchArticles);
  </script>
</body>
</html>
