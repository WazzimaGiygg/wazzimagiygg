<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Sistema WZZM</title>
    <style>
        /* RESET E ESTILOS GERAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* CONTAINER PRINCIPAL */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, #3f51b5 0%, #2196f3 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-icon {
            font-size: 2.5rem;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* BOT√ïES */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        .btn-google {
            background: #4285f4;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            background: #357ae8;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(66, 133, 244, 0.3);
        }

        .google-icon {
            background: white;
            color: #4285f4;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* TELAS DE ESTADO */
        .screen {
            padding: 40px;
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* TELA DE LOGIN */
        .login-screen {
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .login-title {
            font-size: 2.5rem;
            color: #3f51b5;
            margin-bottom: 15px;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1rem;
            max-width: 500px;
            line-height: 1.6;
        }

        /* TELA DE CARREGAMENTO */
        .loading-screen {
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3f51b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* TELA DE ERRO */
        .error-screen {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px;
            text-align: center;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .error-message {
            font-size: 1.1rem;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* TELA DE PERFIL */
        .profile-screen {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .profile-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #3f51b5;
            transition: transform 0.3s ease;
        }

        .profile-card:hover {
            transform: translateY(-5px);
        }

        .profile-card h3 {
            color: #3f51b5;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .profile-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .item-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .item-value {
            color: #333;
            font-size: 1.1rem;
            word-break: break-word;
        }

        /* BADGES DE STATUS */
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-banned {
            background: #ffebee;
            color: #c62828;
        }

        /* SE√á√ÉO DE A√á√ïES */
        .actions-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* DEBUG PANEL */
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .debug-btn {
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
        }

        .debug-btn:hover {
            transform: scale(1.1);
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
            }
            
            .screen {
                padding: 20px;
            }
            
            .profile-screen {
                grid-template-columns: 1fr;
            }
            
            .actions-section {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* MENSAGENS DE SISTEMA */
        .system-message {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #1565c0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* MODAL SIMPLES */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #3f51b5;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <!-- BOT√ÉO DE DEBUG -->
    <div class="debug-panel">
        <button class="debug-btn" onclick="debugFirebase()" title="Debug Firebase">üêõ</button>
    </div>

    <!-- CONTAINER PRINCIPAL -->
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-icon">üë§</div>
                <h1 class="app-title">Meu Perfil - Sistema WZZM</h1>
            </div>
            <div class="header-right" id="headerButtons" style="display: none;">
                <button class="btn btn-danger" onclick="logout()">
                    <span>üö™</span> Sair
                </button>
            </div>
        </header>

        <!-- TELA DE LOGIN -->
        <div id="loginScreen" class="screen login-screen active">
            <h2 class="login-title">Bem-vindo ao Sistema WZZM</h2>
            <p class="login-subtitle">
                Fa√ßa login com sua conta Google para acessar seu perfil de cliente.<br>
                Se for sua primeira vez, seu perfil ser√° criado automaticamente.
            </p>
            
            <button class="btn-google" onclick="loginWithGoogle()">
                <span class="google-icon">G</span>
                Entrar com Google
            </button>
            
            <div class="system-message">
                <span>‚ÑπÔ∏è</span>
                <div>
                    <strong>Informa√ß√µes importantes:</strong><br>
                    ‚Ä¢ Seus dados s√£o protegidos por criptografia<br>
                    ‚Ä¢ Apenas voc√™ e administradores podem ver estas informa√ß√µes<br>
                    ‚Ä¢ Voc√™ pode editar seus dados a qualquer momento
                </div>
            </div>
        </div>

        <!-- TELA DE CARREGAMENTO -->
        <div id="loadingScreen" class="screen loading-screen">
            <div class="spinner"></div>
            <h2>Carregando seus dados...</h2>
            <p>Por favor, aguarde enquanto buscamos suas informa√ß√µes no sistema.</p>
        </div>

        <!-- TELA DE ERRO -->
        <div id="errorScreen" class="screen">
            <div class="error-screen">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2 class="error-title" id="errorTitle">Erro ao Carregar Dados</h2>
                <p class="error-message" id="errorText">Mensagem de erro</p>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="location.reload()">
                        üîÑ Tentar Novamente
                    </button>
                    <button class="btn btn-secondary" onclick="debugFirebase()">
                        üêõ Debug
                    </button>
                </div>
            </div>
        </div>

        <!-- TELA DE PERFIL -->
        <div id="profileScreen" class="screen">
            <!-- Informa√ß√µes Pessoais -->
            <div class="profile-screen">
                <div class="profile-card">
                    <h3>üë§ Identifica√ß√£o</h3>
                    <div class="profile-item">
                        <div class="item-label">UID do Sistema</div>
                        <div class="item-value" id="uidField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">Nome Completo</div>
                        <div class="item-value" id="nameField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">CPF</div>
                        <div class="item-value" id="cpfField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">RG</div>
                        <div class="item-value" id="rgField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">Nome Social</div>
                        <div class="item-value" id="socialNameField">Carregando...</div>
                    </div>
                </div>

                <div class="profile-card">
                    <h3>üìÖ Dados Pessoais</h3>
                    <div class="profile-item">
                        <div class="item-label">Data de Nascimento</div>
                        <div class="item-value" id="birthDateField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">G√™nero</div>
                        <div class="item-value" id="genderField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">Data de Cadastro</div>
                        <div class="item-value" id="createdAtField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">√öltima Atualiza√ß√£o</div>
                        <div class="item-value" id="updatedAtField">Carregando...</div>
                    </div>
                </div>

                <div class="profile-card">
                    <h3>üìû Contato</h3>
                    <div class="profile-item">
                        <div class="item-label">Telefone(s)</div>
                        <div class="item-value" id="phoneField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">E-mail(s)</div>
                        <div class="item-value" id="emailField">Carregando...</div>
                    </div>
                </div>

                <div class="profile-card">
                    <h3>üè† Endere√ßo</h3>
                    <div class="profile-item">
                        <div class="item-label">Endere√ßo Completo</div>
                        <div class="item-value" id="addressField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">CEP</div>
                        <div class="item-value" id="zipCodeField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">Cidade/Estado</div>
                        <div class="item-value" id="cityStateField">Carregando...</div>
                    </div>
                    <div class="profile-item">
                        <div class="item-label">Pa√≠s</div>
                        <div class="item-value" id="countryField">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="actions-section">
                <button class="btn btn-primary" onclick="editProfile()">
                    ‚úèÔ∏è Editar Perfil
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    üîÑ Atualizar Dados
                </button>
                <button class="btn btn-secondary" onclick="window.print()">
                    üñ®Ô∏è Imprimir
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    üö™ Sair do Sistema
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CRIA√á√ÉO DE PERFIL -->
    <div id="createProfileModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">üéâ Bem-vindo ao Sistema!</h2>
            <p>Parece que √© sua primeira vez aqui. Gostaria de criar seu perfil agora?</p>
            <p><small>Voc√™ poder√° adicionar suas informa√ß√µes pessoais, contato e muito mais.</small></p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="createProfile()">
                    ‚úÖ Criar Perfil
                </button>
                <button class="btn btn-secondary" onclick="skipProfile()">
                    ‚è≠Ô∏è Pular por agora
                </button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SCRIPT -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <script>
        // ========== CONFIGURA√á√ÉO DO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializado com sucesso');
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUser = null;
        let userProfile = null;

        // ========== ELEMENTOS DO DOM ==========
        const loginScreen = document.getElementById('loginScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const errorScreen = document.getElementById('errorScreen');
        const profileScreen = document.getElementById('profileScreen');
        const headerButtons = document.getElementById('headerButtons');
        const errorTitle = document.getElementById('errorTitle');
        const errorText = document.getElementById('errorText');
        const createProfileModal = document.getElementById('createProfileModal');

        // ========== FUN√á√ïES DE GERENCIAMENTO DE TELAS ==========
        function showScreen(screenId) {
            // Esconde todas as telas
            loginScreen.classList.remove('active');
            loadingScreen.classList.remove('active');
            errorScreen.classList.remove('active');
            profileScreen.classList.remove('active');
            
            // Mostra a tela solicitada
            document.getElementById(screenId).classList.add('active');
            
            // Mostra/oculta bot√µes do header
            if (screenId === 'profileScreen') {
                headerButtons.style.display = 'flex';
            } else {
                headerButtons.style.display = 'none';
            }
        }

        // ========== SISTEMA DE LOGIN ==========
        async function loginWithGoogle() {
            try {
                console.log('üîê Iniciando login com Google...');
                
                const result = await auth.signInWithPopup(googleProvider);
                currentUser = result.user;
                
                console.log('‚úÖ Login realizado:', currentUser.email);
                console.log('üë§ UID do usu√°rio:', currentUser.uid);
                
                // Verifica se o perfil existe
                await checkUserProfile();
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                showError('Erro ao fazer login', error.message);
            }
        }

        async function checkUserProfile() {
            try {
                showScreen('loadingScreen');
                
                console.log('üîç Verificando perfil do usu√°rio...');
                const userDoc = await db.collection('clients').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    console.log('üì≠ Perfil n√£o encontrado, mostrando modal...');
                    // Mostra modal para cria√ß√£o de perfil
                    createProfileModal.style.display = 'flex';
                } else {
                    // Carrega perfil existente
                    await loadUserProfile();
                }
                
            } catch (error) {
                console.error('Erro ao verificar perfil:', error);
                showError('Erro ao verificar perfil', error.message);
            }
        }

        async function createProfile() {
            try {
                console.log('üìù Criando perfil para:', currentUser.uid);
                
                // Cria perfil b√°sico
                const profileData = {
                    fullName: currentUser.displayName || '',
                    email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true,
                    isBanned: false
                };
                
                await db.collection('clients').doc(currentUser.uid).set(profileData);
                console.log('‚úÖ Perfil criado com sucesso');
                
                // Fecha modal e carrega dados
                createProfileModal.style.display = 'none';
                await loadUserProfile();
                
            } catch (error) {
                console.error('Erro ao criar perfil:', error);
                showError('Erro ao criar perfil', error.message);
            }
        }

        function skipProfile() {
            createProfileModal.style.display = 'none';
            loadUserProfile();
        }

        // ========== CARREGAMENTO DE DADOS ==========
        async function loadUserProfile() {
            try {
                showScreen('loadingScreen');
                console.log('üîÑ Carregando perfil do usu√°rio...');
                
                // Busca dados do cliente
                const clientDoc = await db.collection('clients').doc(currentUser.uid).get();
                
                if (!clientDoc.exists) {
                    console.log('‚ùå Perfil n√£o encontrado ap√≥s tentativa de cria√ß√£o');
                    showError('Perfil n√£o encontrado', 'Clique em "Editar Perfil" para criar seu perfil.');
                    return;
                }
                
                userProfile = clientDoc.data();
                console.log('‚úÖ Dados do perfil:', userProfile);
                
                // Preenche os campos
                populateProfileFields();
                
                // Carrega dados adicionais (telefones, emails)
                await loadAdditionalData();
                
                // Mostra tela de perfil
                showScreen('profileScreen');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar perfil:', error);
                handleFirestoreError(error);
            }
        }

        function populateProfileFields() {
            // Informa√ß√µes b√°sicas
            document.getElementById('uidField').textContent = currentUser.uid;
            document.getElementById('nameField').textContent = userProfile.fullName || 'N√£o informado';
            document.getElementById('cpfField').textContent = formatCPF(userProfile.cpf) || 'N√£o informado';
            document.getElementById('rgField').textContent = userProfile.rg || 'N√£o informado';
            document.getElementById('socialNameField').textContent = userProfile.socialName || 'N√£o informado';
            
            // Dados pessoais
            document.getElementById('birthDateField').textContent = formatDate(userProfile.birthDate) || 'N√£o informado';
            document.getElementById('genderField').textContent = userProfile.gender || 'N√£o informado';
            document.getElementById('createdAtField').textContent = formatDate(userProfile.createdAt) || 'N√£o informado';
            document.getElementById('updatedAtField').textContent = formatDate(userProfile.updatedAt) || 'N√£o informado';
            
            // Endere√ßo
            document.getElementById('addressField').textContent = userProfile.address || 'N√£o informado';
            document.getElementById('zipCodeField').textContent = userProfile.zipCode || 'N√£o informado';
            const cityState = [userProfile.city, userProfile.state].filter(Boolean).join(', ');
            document.getElementById('cityStateField').textContent = cityState || 'N√£o informado';
            document.getElementById('countryField').textContent = userProfile.country || 'N√£o informado';
            
            // Email principal
            document.getElementById('emailField').textContent = userProfile.email || currentUser.email;
        }

        async function loadAdditionalData() {
            try {
                // Carrega telefones
                const phonesSnapshot = await db.collection('clientPhones')
                    .where('clientId', '==', currentUser.uid)
                    .get();
                
                const phones = phonesSnapshot.docs.map(doc => {
                    return formatPhone(doc.data().phoneNumber);
                }).join(', ');
                
                document.getElementById('phoneField').textContent = phones || 'N√£o informado';
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar dados adicionais:', error);
            }
        }

        // ========== MANIPULA√á√ÉO DE ERROS ==========
        function handleFirestoreError(error) {
            console.error('üî• Erro Firestore:', error.code, error.message);
            
            let title = 'Erro ao Carregar Dados';
            let message = '';
            
            switch (error.code) {
                case 'permission-denied':
                    title = 'üîí Permiss√£o Negada';
                    message = `
                        Voc√™ n√£o tem permiss√£o para acessar estas informa√ß√µes.<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ Sua conta n√£o tem acesso a este perfil<br>
                        ‚Ä¢ Regras de seguran√ßa bloqueiam o acesso<br>
                        ‚Ä¢ Sua conta pode estar banida<br><br>
                        <strong>O que fazer:</strong><br>
                        1. Verifique se est√° logado com a conta correta<br>
                        2. Tente fazer logout e login novamente<br>
                        3. Contacte um administrador se o problema persistir
                    `;
                    break;
                    
                case 'not-found':
                    title = 'üîç Perfil N√£o Encontrado';
                    message = 'N√£o foi encontrado um perfil para seu usu√°rio.';
                    break;
                    
                default:
                    message = `Erro: ${error.message || 'Erro desconhecido'}`;
            }
            
            showError(title, message);
        }

        function showError(title, message) {
            errorTitle.textContent = title;
            errorText.innerHTML = message;
            showScreen('errorScreen');
        }

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function formatDate(timestamp) {
            if (!timestamp) return null;
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('pt-BR') + ' ' + 
                       date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return null;
            }
        }

        function formatCPF(cpf) {
            if (!cpf) return null;
            cpf = cpf.toString().replace(/\D/g, '');
            if (cpf.length === 11) {
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        function formatPhone(phone) {
            if (!phone) return null;
            phone = phone.toString().replace(/\D/g, '');
            if (phone.length === 11) {
                return phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (phone.length === 10) {
                return phone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            }
            return phone;
        }

        // ========== FUN√á√ïES DE INTERA√á√ÉO ==========
        function editProfile() {
            if (currentUser && currentUser.uid) {
                window.location.href = `editar_cliente/?uid=${currentUser.uid}`;
            }
        }

        function refreshData() {
            loadUserProfile();
        }

        async function logout() {
            try {
                await auth.signOut();
                console.log('‚úÖ Logout realizado');
                currentUser = null;
                userProfile = null;
                showScreen('loginScreen');
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        }

        function debugFirebase() {
            console.clear();
            console.log('üîç === DEBUG FIREBASE ===');
            console.log('üìä Configura√ß√£o:', firebaseConfig);
            console.log('üë§ Usu√°rio atual:', currentUser);
            console.log('üìÅ Perfil carregado:', userProfile);
            
            // Testa permiss√µes
            testPermissions();
        }

        async function testPermissions() {
            console.log('\nüîí Testando permiss√µes...');
            
            if (!currentUser) {
                console.log('‚ùå Nenhum usu√°rio logado');
                return;
            }
            
            try {
                // Testa acesso √† cole√ß√£o clients
                const test1 = await db.collection('clients').doc(currentUser.uid).get();
                console.log('‚úÖ clients:', test1.exists ? 'OK' : 'N√£o encontrado');
                
                // Testa acesso √† cole√ß√£o clientPhones
                const test2 = await db.collection('clientPhones')
                    .where('clientId', '==', currentUser.uid)
                    .limit(1)
                    .get();
                console.log('‚úÖ clientPhones:', test2.empty ? 'Vazia' : 'OK');
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error.code, error.message);
            }
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de Perfil carregado');
            
            // Monitora estado de autentica√ß√£o
            auth.onAuthStateChanged((user) => {
                console.log('üîê Estado de autentica√ß√£o:', user ? 'Logado' : 'Deslogado');
                
                if (user) {
                    currentUser = user;
                    console.log('üë§ Usu√°rio logado:', user.email);
                    checkUserProfile();
                } else {
                    currentUser = null;
                    userProfile = null;
                    console.log('üëã Nenhum usu√°rio logado');
                    showScreen('loginScreen');
                }
            });
            
            // Fecha modal ao clicar fora
            createProfileModal.addEventListener('click', function(e) {
                if (e.target === createProfileModal) {
                    createProfileModal.style.display = 'none';
                }
            });
        });

        // ========== FUN√á√ïES GLOBAIS ==========
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
        window.editProfile = editProfile;
        window.refreshData = refreshData;
        window.debugFirebase = debugFirebase;
        window.createProfile = createProfile;
        window.skipProfile = skipProfile;
    </script>
</body>
</html>
