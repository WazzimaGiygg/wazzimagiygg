<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informa√ß√µes do Cliente - WZZM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .content {
            padding: 40px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .data-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .data-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .data-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .value {
            color: #333;
            font-size: 1.1rem;
            word-break: break-word;
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .status-active { background: #e8f5e9; color: #2e7d32; }
        .status-inactive { background: #fff3e0; color: #ef6c00; }
        .status-banned { background: #ffebee; color: #c62828; }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .debug-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff9800;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            z-index: 1000;
        }

        .debug-btn:hover {
            transform: scale(1.1);
        }

        .admin-badge {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
                flex-direction: column;
            }
            
            .content {
                padding: 20px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .data-section {
                grid-template-columns: 1fr;
            }
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .login-prompt {
            text-align: center;
            padding: 40px 20px;
        }

        .login-btn {
            background: #4285f4;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Bot√£o de Debug -->
    <div class="debug-btn" onclick="debugFirebase()" title="Debug Firebase">
        üêõ
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>üë§ Informa√ß√µes do Cliente</span>
                <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            </h1>
            <div class="status-bar" id="statusBar" style="display: none;">
                <div>
                    <strong>UID:</strong> <span id="currentUid"></span>
                </div>
                <div>
                    <strong>Status:</strong> <span id="currentStatus"></span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <h3>Carregando dados do cliente...</h3>
                <p>Por favor, aguarde enquanto buscamos as informa√ß√µes no sistema.</p>
            </div>

            <!-- Error State -->
            <div class="error-box" id="errorState" style="display: none;">
                <h3>‚ö†Ô∏è Erro ao Carregar Dados</h3>
                <p id="errorMessage"></p>
                <div class="actions" style="border: none; padding: 0; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="location.reload()">
                        üîÑ Tentar Novamente
                    </button>
                    <button class="btn btn-secondary" onclick="debugFirebase()">
                        üêõ Debug
                    </button>
                </div>
            </div>

            <!-- Login Prompt -->
            <div class="login-prompt" id="loginPrompt" style="display: none;">
                <h3>üîí Acesso Restrito</h3>
                <p>Voc√™ precisa estar logado para visualizar estas informa√ß√µes.</p>
                <a href="#" onclick="loginWithGoogle()" class="login-btn">
                    <span>G</span> Entrar com Google
                </a>
            </div>

            <!-- Data Display -->
            <div id="dataDisplay" style="display: none;">
                <!-- Warning for admin viewing other profiles -->
                <div class="warning-box" id="adminWarning" style="display: none;">
                    <span>‚ö†Ô∏è</span>
                    <div>
                        <strong>Modo Administrador</strong>
                        <p>Voc√™ est√° visualizando dados de outro usu√°rio. Use com responsabilidade.</p>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="data-section">
                    <div class="data-card">
                        <h3>üë§ Identifica√ß√£o</h3>
                        <div class="data-item">
                            <div class="label">UID do Cliente</div>
                            <div class="value" id="uidDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">Nome Completo</div>
                            <div class="value" id="fullNameDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">CPF</div>
                            <div class="value" id="cpfDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">RG</div>
                            <div class="value" id="rgDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">Nome Social</div>
                            <div class="value" id="socialNameDisplay"></div>
                        </div>
                    </div>

                    <div class="data-card">
                        <h3>üéÇ Dados Pessoais</h3>
                        <div class="data-item">
                            <div class="label">Data de Nascimento</div>
                            <div class="value" id="birthDateDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">G√™nero</div>
                            <div class="value" id="genderDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">Data de Cadastro</div>
                            <div class="value" id="createdAtDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">√öltima Atualiza√ß√£o</div>
                            <div class="value" id="updatedAtDisplay"></div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="data-section">
                    <div class="data-card">
                        <h3>üìû Contato</h3>
                        <div class="data-item">
                            <div class="label">Telefone(s)</div>
                            <div class="value" id="phoneDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">E-mail(s)</div>
                            <div class="value" id="emailDisplay"></div>
                        </div>
                    </div>

                    <div class="data-card">
                        <h3>üè† Endere√ßo</h3>
                        <div class="data-item">
                            <div class="label">Endere√ßo</div>
                            <div class="value" id="addressDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">CEP</div>
                            <div class="value" id="zipCodeDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">Cidade</div>
                            <div class="value" id="cityDisplay"></div>
                        </div>
                        <div class="data-item">
                            <div class="label">Estado/Pa√≠s</div>
                            <div class="value" id="stateCountryDisplay"></div>
                        </div>
                    </div>
                </div>

                <!-- Account Status -->
                <div class="data-section">
                    <div class="data-card">
                        <h3>üîê Status da Conta</h3>
                        <div class="data-item">
                            <div class="label">Status Atual</div>
                            <div class="value">
                                <span class="status" id="accountStatus"></span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="label">Permiss√µes</div>
                            <div class="value">
                                <span id="permissionsDisplay"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button class="btn btn-primary" onclick="editClient()" id="editBtn">
                        ‚úèÔ∏è Editar Informa√ß√µes
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        üîÑ Recarregar
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button class="btn btn-danger" onclick="goBack()">
                        ‚Üê Voltar
                    </button>
                </div>
            </div>

            <!-- Empty State (no client found) -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <h3>üì≠ Cliente N√£o Encontrado</h3>
                <p>N√£o foi encontrado um cadastro para o UID especificado.</p>
                <div class="actions" style="border: none; padding: 0; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="createNewClient()">
                        ‚ûï Criar Novo Cadastro
                    </button>
                    <button class="btn btn-secondary" onclick="goBack()">
                        ‚Üê Voltar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <script>
        // ========== CONFIGURA√á√ÉO DO FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializa Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializado');
        }
        
        const firestore = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // ========== ESTADO DA APLICA√á√ÉO ==========
        let currentClientId = null;
        let currentUser = null;
        let isAdminUser = false;
        let isViewingOwnProfile = false;

        // ========== ELEMENTOS DO DOM ==========
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const dataDisplay = document.getElementById('dataDisplay');
        const emptyState = document.getElementById('emptyState');
        const loginPrompt = document.getElementById('loginPrompt');
        const statusBar = document.getElementById('statusBar');
        const adminBadge = document.getElementById('adminBadge');
        const adminWarning = document.getElementById('adminWarning');
        const editBtn = document.getElementById('editBtn');

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N√£o informado';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('pt-BR') + ' ' + 
                       date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return 'Data inv√°lida';
            }
        }

        function formatCPF(cpf) {
            if (!cpf) return 'N√£o informado';
            cpf = cpf.toString().replace(/\D/g, '');
            if (cpf.length === 11) {
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        // ========== VERIFICA√á√ÉO DE PERMISS√ïES ==========
        async function checkUserPermissions(userId) {
            try {
                console.log('üîç Verificando permiss√µes para usu√°rio:', userId);
                
                // Verifica se √© admin
                const userDoc = await firestore.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    isAdminUser = userData.isAdmin === true || 
                                  userData.isAdminUID === true || 
                                  userId === "sZxfMuOBPbXdR8nttVPXIN8QOOl1";
                    
                    console.log('üëë √â admin?', isAdminUser);
                    
                    // Verifica se est√° banido
                    const isBanned = userData.isBanned === true;
                    console.log('üö´ Est√° banido?', isBanned);
                    
                    if (isBanned) {
                        throw new Error('Usu√°rio banido. Acesso negado.');
                    }
                } else {
                    console.log('üìù Usu√°rio n√£o encontrado na cole√ß√£o users');
                    isAdminUser = false;
                }
                
                // Verifica se est√° visualizando pr√≥prio perfil
                isViewingOwnProfile = userId === currentClientId;
                console.log('üë§ √â pr√≥prio perfil?', isViewingOwnProfile);
                
                // Atualiza interface
                if (isAdminUser) {
                    adminBadge.style.display = 'inline-block';
                    adminWarning.style.display = 'flex';
                }
                
                if (!isViewingOwnProfile && isAdminUser) {
                    adminWarning.style.display = 'flex';
                }
                
                return { isAdmin: isAdminUser, isOwnProfile: isViewingOwnProfile };
                
            } catch (error) {
                console.error('Erro ao verificar permiss√µes:', error);
                return { isAdmin: false, isOwnProfile: false };
            }
        }

        // ========== CARREGAMENTO DE DADOS ==========
        async function loadClientData() {
            console.log('üîÑ Iniciando carregamento de dados...');
            
            // Reseta estados
            loadingState.style.display = 'block';
            errorState.style.display = 'none';
            dataDisplay.style.display = 'none';
            emptyState.style.display = 'none';
            loginPrompt.style.display = 'none';
            statusBar.style.display = 'none';
            
            // Obt√©m UID do cliente
            currentClientId = getUrlParam('uid');
            console.log('üìã UID do cliente:', currentClientId);
            
            if (!currentClientId && auth.currentUser) {
                currentClientId = auth.currentUser.uid;
                console.log('üë§ Usando UID do usu√°rio logado:', currentClientId);
            }
            
            if (!currentClientId) {
                showLoginPrompt();
                return;
            }
            
            // Verifica autentica√ß√£o
            currentUser = auth.currentUser;
            if (!currentUser) {
                showLoginPrompt();
                return;
            }
            
            try {
                // Verifica permiss√µes do usu√°rio logado
                const permissions = await checkUserPermissions(currentUser.uid);
                
                // Verifica se tem permiss√£o para visualizar este perfil
                if (!permissions.isAdmin && currentUser.uid !== currentClientId) {
                    throw new Error('Voc√™ n√£o tem permiss√£o para visualizar este perfil');
                }
                
                // Atualiza barra de status
                document.getElementById('currentUid').textContent = currentClientId;
                statusBar.style.display = 'flex';
                
                // Carrega dados do cliente
                console.log('üì• Buscando dados do cliente...');
                const clientDoc = await firestore.collection('clients').doc(currentClientId).get();
                
                if (!clientDoc.exists) {
                    showEmptyState();
                    return;
                }
                
                const clientData = clientDoc.data();
                console.log('‚úÖ Dados do cliente:', clientData);
                
                // Preenche dados pessoais
                document.getElementById('uidDisplay').textContent = currentClientId;
                document.getElementById('fullNameDisplay').textContent = clientData.fullName || 'N√£o informado';
                document.getElementById('cpfDisplay').textContent = formatCPF(clientData.cpf) || 'N√£o informado';
                document.getElementById('rgDisplay').textContent = clientData.rg || 'N√£o informado';
                document.getElementById('socialNameDisplay').textContent = clientData.socialName || 'N√£o informado';
                document.getElementById('birthDateDisplay').textContent = formatDate(clientData.birthDate) || 'N√£o informado';
                document.getElementById('genderDisplay').textContent = clientData.gender || 'N√£o informado';
                document.getElementById('createdAtDisplay').textContent = formatDate(clientData.createdAt) || 'N√£o informado';
                document.getElementById('updatedAtDisplay').textContent = formatDate(clientData.updatedAt) || 'N√£o informado';
                
                // Endere√ßo
                document.getElementById('addressDisplay').textContent = clientData.address || 'N√£o informado';
                document.getElementById('zipCodeDisplay').textContent = clientData.zipCode || 'N√£o informado';
                document.getElementById('cityDisplay').textContent = clientData.city || 'N√£o informado';
                const stateCountry = [clientData.state, clientData.country]
                    .filter(Boolean)
                    .join(', ');
                document.getElementById('stateCountryDisplay').textContent = stateCountry || 'N√£o informado';
                
                // Status da conta
                const statusElement = document.getElementById('accountStatus');
                if (clientData.isBanned) {
                    statusElement.textContent = 'BANIDO';
                    statusElement.className = 'status status-banned';
                    document.getElementById('currentStatus').textContent = 'BANIDO';
                } else if (clientData.isActive === false) {
                    statusElement.textContent = 'INATIVO';
                    statusElement.className = 'status status-inactive';
                    document.getElementById('currentStatus').textContent = 'INATIVO';
                } else {
                    statusElement.textContent = 'ATIVO';
                    statusElement.className = 'status status-active';
                    document.getElementById('currentStatus').textContent = 'ATIVO';
                }
                
                // Permiss√µes
                const permissionsDisplay = document.getElementById('permissionsDisplay');
                if (permissions.isAdmin) {
                    permissionsDisplay.textContent = 'Administrador';
                    permissionsDisplay.style.color = '#4caf50';
                    permissionsDisplay.style.fontWeight = 'bold';
                } else if (permissions.isOwnProfile) {
                    permissionsDisplay.textContent = 'Usu√°rio (pr√≥prio perfil)';
                    permissionsDisplay.style.color = '#2196f3';
                } else {
                    permissionsDisplay.textContent = 'Usu√°rio limitado';
                    permissionsDisplay.style.color = '#ff9800';
                }
                
                // Carrega telefones
                try {
                    const phonesSnapshot = await firestore.collection('clientPhones')
                        .where('clientId', '==', currentClientId)
                        .get();
                    
                    const phones = phonesSnapshot.docs.map(doc => {
                        const phone = doc.data().phoneNumber || '';
                        // Formata telefone
                        const cleanPhone = phone.replace(/\D/g, '');
                        if (cleanPhone.length === 11) {
                            return cleanPhone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                        } else if (cleanPhone.length === 10) {
                            return cleanPhone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                        }
                        return phone;
                    }).join(', ');
                    
                    document.getElementById('phoneDisplay').textContent = phones || 'N√£o informado';
                } catch (phoneError) {
                    console.warn('‚ö†Ô∏è Erro ao carregar telefones:', phoneError);
                    document.getElementById('phoneDisplay').textContent = 'Erro ao carregar';
                }
                
                // Carrega emails
                try {
                    const emailsSnapshot = await firestore.collection('clientEmails')
                        .where('clientId', '==', currentClientId)
                        .get();
                    
                    const emails = emailsSnapshot.docs.map(doc => {
                        return doc.data().emailAddress || '';
                    }).join(', ');
                    
                    document.getElementById('emailDisplay').textContent = emails || currentUser.email;
                } catch (emailError) {
                    console.warn('‚ö†Ô∏è Erro ao carregar emails:', emailError);
                    document.getElementById('emailDisplay').textContent = currentUser.email || 'N√£o informado';
                }
                
                // Configura bot√£o de edi√ß√£o
                if (permissions.isAdmin || permissions.isOwnProfile) {
                    editBtn.style.display = 'flex';
                } else {
                    editBtn.style.display = 'none';
                }
                
                // Mostra dados
                loadingState.style.display = 'none';
                dataDisplay.style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                handleError(error);
            }
        }

        // ========== MANIPULA√á√ÉO DE ERROS ==========
        function handleError(error) {
            loadingState.style.display = 'none';
            
            let errorMsg = '';
            
            switch (error.code) {
                case 'permission-denied':
                    errorMsg = `
                        <strong>üîí Permiss√£o Negada</strong><br>
                        <p>Voc√™ n√£o tem permiss√£o para acessar estas informa√ß√µes.</p>
                        <p><em>${error.message || 'Verifique se voc√™ est√° logado e tem acesso a este perfil.'}</em></p>
                        <br>
                        <p><strong>Poss√≠veis causas:</strong></p>
                        <ul>
                            <li>‚ùå Voc√™ n√£o est√° autenticado</li>
                            <li>üö´ Seu usu√°rio est√° banido</li>
                            <li>üë§ Voc√™ n√£o √© o propriet√°rio deste perfil</li>
                            <li>üëë Voc√™ n√£o √© um administrador</li>
                        </ul>
                    `;
                    break;
                    
                case 'not-found':
                    errorMsg = `
                        <strong>üîç Cliente N√£o Encontrado</strong><br>
                        <p>N√£o existe um cadastro para o UID: <code>${currentClientId}</code></p>
                        <p>O cliente pode ter sido exclu√≠do ou o UID est√° incorreto.</p>
                    `;
                    break;
                    
                default:
                    errorMsg = `
                        <strong>‚ö†Ô∏è Erro Inesperado</strong><br>
                        <p><em>${error.message || 'Erro ao conectar com o servidor'}</em></p>
                        <p><strong>Detalhes:</strong> ${error.code || 'N/A'}</p>
                    `;
            }
            
            errorMessage.innerHTML = errorMsg;
            errorState.style.display = 'block';
        }

        function showLoginPrompt() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            dataDisplay.style.display = 'none';
            loginPrompt.style.display = 'block';
        }

        function showEmptyState() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            dataDisplay.style.display = 'none';
            emptyState.style.display = 'block';
        }

        // ========== FUN√á√ïES DE INTERA√á√ÉO ==========
        function editClient() {
            if (!currentClientId) return;
            window.location.href = `editar_cliente/?uid=${currentClientId}`;
        }

        function createNewClient() {
            const uid = getUrlParam('uid') || auth.currentUser?.uid;
            if (uid) {
                window.location.href = `editar_cliente/?uid=${uid}`;
            } else {
                window.location.href = 'editar_cliente/';
            }
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '../';
            }
        }

        async function loginWithGoogle() {
            try {
                await auth.signInWithPopup(googleProvider);
                loadClientData();
            } catch (error) {
                console.error('Erro no login:', error);
                showError('Erro ao fazer login: ' + error.message);
            }
        }

        function debugFirebase() {
            console.clear();
            console.log('üîç === DEBUG FIREBASE ===');
            console.log('üìä Configura√ß√£o:', firebaseConfig);
            console.log('üë§ Usu√°rio atual:', auth.currentUser);
            console.log('üìã UID do cliente:', currentClientId);
            console.log('üëë √â admin?', isAdminUser);
            console.log('üë§ √â pr√≥prio perfil?', isViewingOwnProfile);
            
            // Testa permiss√µes
            testPermissions();
        }

        async function testPermissions() {
            console.log('\nüîí Testando permiss√µes...');
            
            // Testa acesso ao cliente
            try {
                const test = await firestore.collection('clients').doc(currentClientId || 'test').get();
                console.log('‚úÖ Acesso √† cole√ß√£o "clients":', test.exists ? 'EXISTE' : 'N√ÉO EXISTE');
            } catch (error) {
                console.error('‚ùå Erro ao acessar "clients":', error.code, error.message);
            }
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina de informa√ß√µes do cliente inicializada');
            
            // Monitora estado de autentica√ß√£o
            auth.onAuthStateChanged((user) => {
                console.log('üîê Estado de autentica√ß√£o alterado:', user ? 'Logado' : 'Deslogado');
                currentUser = user;
                
                if (user) {
                    console.log('üë§ Usu√°rio:', user.email);
                    loadClientData();
                } else {
                    // Se tem UID na URL, tenta carregar mesmo sem login
                    // (√∫til para admins compartilharem links)
                    if (getUrlParam('uid')) {
                        loadClientData();
                    } else {
                        showLoginPrompt();
                    }
                }
            });
            
            // Verifica inicial
            if (auth.currentUser || getUrlParam('uid')) {
                loadClientData();
            }
        });

        // ========== FUN√á√ïES GLOBAIS ==========
        window.debugFirebase = debugFirebase;
        window.editClient = editClient;
        window.createNewClient = createNewClient;
        window.loginWithGoogle = loginWithGoogle;
        
        // Atalho F12 para debug
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12') {
                e.preventDefault();
                debugFirebase();
            }
        });
    </script>
</body>
</html>
