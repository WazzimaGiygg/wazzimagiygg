<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fórum WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-light_blue.min.css">
    <style>
        body {
            font-family: sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 2px 0 rgba(0,0,0,.14), 0 3px 1px -2px rgba(0,0,0,.2), 0 1px 5px 0 rgba(0,0,0,.12);
        }
        #login-button {
            margin-bottom: 20px;
        }
        #forum-container, #new-post-form {
            display: none;
        }
        .post {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }
        .post:last-child {
            border-bottom: none;
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-user {
            font-weight: bold;
            color: #3f51b5;
        }
        .post-date {
            font-size: 0.8em;
            color: #999;
        }
        .post-content {
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="container mdl-shadow--2dp">
    <header class="mdl-grid">
        <h1 class="mdl-cell mdl-cell--12-col">Fórum WZZM</h1>
    </header>

    <div id="login-section">
        <p>Faça login com sua conta Google para continuar.</p>
        <button id="login-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
            <i class="material-icons">person</i>
            Entrar com Google
        </button>
    </div>

    <div id="forum-container">
        <h3>Últimas Mensagens</h3>
        <div id="posts-list">
            </div>

        <div id="new-post-form">
            <h4>Publicar Nova Mensagem</h4>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width: 100%;">
                <textarea class="mdl-textfield__input" type="text" rows="3" id="post-content"></textarea>
                <label class="mdl-textfield__label" for="post-content">Digite sua mensagem...</label>
            </div>
            <button id="submit-post-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored">
                Publicar
            </button>
        </div>
    </div>
</div>

<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>

<script>
    // --- Configuração do Firebase ---
    // --- Configuração do Firebase ---
const firebaseConfig = {
apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Use sua própria chave!
authDomain: "wzzm-ce3fc.firebaseapp.com",
projectId: "wzzm-ce3fc",
storageBucket: "wzzm-ce3fc.appspot.com",
messagingSenderId: "249427877153",
appId: "1:249427877153:web:0e4297294794a5aadeb260",
measurementId: "G-PLKNZNFCQ8"
};
// Inicialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();
firebase.analytics();

    // Referências do HTML
    const loginSection = document.getElementById('login-section');
    const loginButton = document.getElementById('login-button');
    const forumContainer = document.getElementById('forum-container');
    const postsList = document.getElementById('posts-list');
    const newPostForm = document.getElementById('new-post-form');
    const postContentInput = document.getElementById('post-content');
    const submitPostButton = document.getElementById('submit-post-button');

    // Estado do usuário
    let currentUser = null;

    // --- Funções do Fórum ---

    // Função para renderizar as mensagens do fórum
    const renderPosts = (posts) => {
        postsList.innerHTML = '';
        posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.classList.add('post');
            const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString('pt-BR') : 'Data Indisponível';
            postElement.innerHTML = `
                <div class="post-header">
                    <span class="post-user">${post.socialName || post.name || 'Usuário Anônimo'}</span>
                    <span class="post-date">${postDate}</span>
                </div>
                <div class="post-content">${post.content}</div>
            `;
            postsList.appendChild(postElement);
        });
        componentHandler.upgradeDom(); // Para re-renderizar componentes do MDL
    };

    // Função para carregar as mensagens do fórum
    const loadForumPosts = () => {
        firestore.collection('forumwzzm')
            .orderBy('createdAt', 'desc')
            .limit(20) // Exibe as 20 últimas mensagens
            .onSnapshot((snapshot) => {
                const posts = snapshot.docs.map(doc => doc.data());
                renderPosts(posts);
            }, (error) => {
                console.error("Erro ao carregar posts: ", error);
            });
    };

    // Função para adicionar uma nova mensagem
    const addPost = async (content) => {
        if (!currentUser) return;

        try {
            await firestore.collection('forumwzzm').add({
                uidGoogle: currentUser.uid,
                socialName: currentUser.displayName,
                content: content,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            postContentInput.value = '';
        } catch (error) {
            console.error("Erro ao adicionar post: ", error);
            alert("Não foi possível publicar a mensagem. Tente novamente.");
        }
    };

    // Evento de clique para publicar
    submitPostButton.addEventListener('click', () => {
        const content = postContentInput.value.trim();
        if (content) {
            addPost(content);
        }
    });

    // --- Autenticação e Lógica de Cadastro ---

    // Login com Google
    const signInWithGoogle = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .catch((error) => {
                console.error("Erro de autenticação: ", error);
                alert("Falha no login com Google. Tente novamente.");
            });
    };

    loginButton.addEventListener('click', signInWithGoogle);

    // Monitora o estado de autenticação
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            // Usuário logado
            currentUser = user;
            loginSection.style.display = 'none';
            forumContainer.style.display = 'block';
            newPostForm.style.display = 'block';

            // Verifica e cadastra o usuário
            const userRef = firestore.collection('users').doc(user.uid);
            const clientRef = firestore.collection('clients').doc(user.uid);
            const userDoc = await userRef.get();

            if (!userDoc.exists) {
                // Usuário novo, cadastra em ambas as coleções
                const userData = {
                    uidGoogle: user.uid,
                    fullName: user.displayName || '',
                    socialName: user.displayName || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    email: user.email || '',
                    isActive: true,
                    isBanned: false
                };

                const clientData = {
                    uidGoogle: user.uid,
                    fullName: user.displayName || '',
                    socialName: user.displayName || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    email: user.email || '',
                    isActive: true,
                    isBanned: false
                };

                try {
                    await userRef.set(userData);
                    await clientRef.set(clientData);
                    console.log("Novo usuário cadastrado!");
                } catch (error) {
                    console.error("Erro ao cadastrar novo usuário: ", error);
                }
            } else {
                // Usuário existente, apenas atualiza a data de login
                userRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
            }

            // Carrega as mensagens do fórum após o login
            loadForumPosts();

        } else {
            // Usuário deslogado
            currentUser = null;
            loginSection.style.display = 'block';
            forumContainer.style.display = 'none';
            newPostForm.style.display = 'none';
        }
    });
</script>

</body>
</html>
