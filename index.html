<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script>
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const analytics = firebase.analytics();

        // Variáveis globais para o estado do usuário e notificações
        let currentUser = null;
        let unsubscribeNotifications = null;

        // --- Funções Auxiliares (Mantenha-as como estão, pois não dependem diretamente de elementos UI na definição) ---
        // Ex: isAdmin, createUserProfileDocument, loadAndApplyUserAppsCSS, loadPage
        async function createUserProfileDocument(user) { /* ... seu código ... */ }
        async function loadAndApplyUserAppsCSS(userUid) { /* ... seu código ... */ }
        function loadPage(url) {
            document.getElementById('main-iframe').src = url;
        }
        function toggleNotificationsPopup() { /* ... seu código ... */ }
        function showNotificationsPopup() { /* ... seu código ... */ }
        function hideNotificationsPopup() { /* ... seu código ... */ }
        function listenForNotifications(userUid) { /* ... seu código ... */ }


        // --- Event Listeners e Elementos da UI - Coloque TUDO AQUI DENTRO ---
        // Isso garante que o DOM esteja completamente carregado antes de tentar acessá-los.
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos da UI (Agora seguros para acessar) ---
            const notificationBellButton = document.getElementById('notification-bell-button');
            const unreadNotificationsCount = document.getElementById('unread-notifications-count');
            const notificationsPopup = document.getElementById('notifications-popup');
            const notificationsList = document.getElementById('notifications-list');
            const noNotificationsMessage = document.getElementById('no-notifications');
            const viewAllChatMessagesButton = document.getElementById('view-all-chat-messages-button');
            const mainIframe = document.getElementById('main-iframe');

            // Autenticação
            const loginGoogleButton = document.getElementById('login-google');
            const loginGitHubButton = document.getElementById('login-github');
            const logoutButton = document.getElementById('logout-button');
            const adminPanelButton = document.getElementById('admin-panel-button');

            // Google Apps Popup (se existir no seu HTML)
            const googleAppsButton = document.getElementById('google-apps-button');
            const googleAppsPopup = document.getElementById('google-apps-popup');

            // Mini-chat (se existir no seu HTML)
            const chatNotificationButton = document.getElementById('chat-notification-button');
            const miniChatContainer = document.getElementById('mini-chat-container');
            const miniChatCloseButton = document.getElementById('mini-chat-close-button');


            // --- Funções de Autenticação (Podem estar aqui ou serem chamadas a partir daqui) ---
            const handleLogout = () => {
                auth.signOut().then(() => {
                    console.log("Usuário deslogado.");
                }).catch((error) => {
                    console.error("Erro ao fazer logout:", error);
                    alert(`Erro ao fazer logout: ${error.message}`);
                });
            };

            // Event Listeners para autenticação
            if (loginGoogleButton) { // Verificação para garantir que o elemento existe
                loginGoogleButton.addEventListener('click', async () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        console.error("Erro ao fazer login com Google:", error);
                        alert(`Erro ao fazer login com Google: ${error.message}`);
                    }
                });
            }
            if (loginGitHubButton) {
                loginGitHubButton.addEventListener('click', async () => {
                    const provider = new firebase.auth.GithubAuthProvider();
                    try {
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        console.error("Erro ao fazer login com GitHub:", error);
                        alert(`Erro ao fazer login com GitHub: ${error.message}`);
                    }
                });
            }
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }

            // --- Event Listeners para Notificações e Chat ---
            if (notificationBellButton) {
                notificationBellButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    toggleNotificationsPopup();
                });
            }

            if (viewAllChatMessagesButton) {
                viewAllChatMessagesButton.addEventListener('click', () => {
                    loadPage('chat/');
                    hideNotificationsPopup();
                });
            }

            // Listener global para fechar pop-ups ao clicar fora
            document.addEventListener('click', (event) => {
                if (notificationsPopup && notificationsPopup.style.display === 'flex' &&
                    !notificationBellButton.contains(event.target) &&
                    !notificationsPopup.contains(event.target)) {
                    hideNotificationsPopup();
                }
                if (googleAppsPopup && googleAppsPopup.style.display === 'flex' &&
                    !googleAppsButton.contains(event.target) &&
                    !googleAppsPopup.contains(event.target)) {
                    googleAppsPopup.style.display = 'none';
                }
                if (miniChatContainer && miniChatContainer.style.display === 'flex' &&
                    chatNotificationButton && !chatNotificationButton.contains(event.target) &&
                    !miniChatContainer.contains(event.target)) {
                    miniChatContainer.style.display = 'none';
                }
            });

            // --- Inicialização MDL e Polyfill para dialog (se necessário) ---
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
            // A parte do dialogPolyfill pode ser removida do index.html se você moveu o diálogo para chat.html
            // Se você ainda tiver diálogos showModal() no index.html, mantenha:
            // const addContactDialog = document.getElementById('add-contact-dialog'); // Se este diálogo existir no index.html
            // if (addContactDialog && !addContactDialog.showModal) {
            //     dialogPolyfill.registerDialog(addContactDialog);
            // }
        });

        // --- Gerenciamento de Estado de Autenticação (Pode continuar aqui, pois 'auth' é global) ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log("Usuário logado:", user.uid);

                // Acesse os botões diretamente aqui, pois DOMContentLoaded já foi disparado
                // ou passe-os como parâmetro se a função estiver em outro lugar
                const loginGoogleButton = document.getElementById('login-google');
                const loginGitHubButton = document.getElementById('login-github');
                const logoutButton = document.getElementById('logout-button');
                const adminPanelButton = document.getElementById('admin-panel-button');
                const unreadNotificationsCount = document.getElementById('unread-notifications-count'); // Recupere novamente se necessário

                if (loginGoogleButton) loginGoogleButton.style.display = 'none';
                if (loginGitHubButton) loginGitHubButton.style.display = 'none';
                if (logoutButton) logoutButton.style.display = 'inline-block';

                await createUserProfileDocument(user);
                await loadAndApplyUserAppsCSS(user.uid);
                listenForNotifications(user.uid); // Começa a ouvir notificações

                // Lógica de adminPanelButton aqui, se aplicável
                firestore.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().isAdmin && adminPanelButton) {
                        adminPanelButton.style.display = 'inline-block';
                    } else if (adminPanelButton) {
                        adminPanelButton.style.display = 'none';
                    }
                }).catch(error => console.error("Erro ao verificar status de admin:", error));

            } else {
                currentUser = null;
                console.log("Usuário deslogado.");

                const loginGoogleButton = document.getElementById('login-google');
                const loginGitHubButton = document.getElementById('login-github');
                const logoutButton = document.getElementById('logout-button');
                const adminPanelButton = document.getElementById('admin-panel-button');
                const unreadNotificationsCount = document.getElementById('unread-notifications-count');
                const notificationsList = document.getElementById('notifications-list');
                const noNotificationsMessage = document.getElementById('no-notifications');


                if (loginGoogleButton) loginGoogleButton.style.display = 'inline-block';
                if (loginGitHubButton) loginGitHubButton.style.display = 'inline-block';
                if (logoutButton) logoutButton.style.display = 'none';
                if (adminPanelButton) adminPanelButton.style.display = 'none';

                if (unsubscribeNotifications) {
                    unsubscribeNotifications(); // Desinscreve-se das notificações ao deslogar
                }
                if (unreadNotificationsCount) unreadNotificationsCount.style.display = 'none';
                if (notificationsList) notificationsList.innerHTML = '';
                if (noNotificationsMessage) {
                    noNotificationsMessage.style.display = 'block';
                    noNotificationsMessage.textContent = 'Faça login para ver as notificações.';
                }
            }
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
        });
    </script>
</body>
</html>
