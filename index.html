<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki Zone Zero Mod</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style id="custom-app-css">
        /* Este será o local onde o CSS dos aplicativos do usuário será injetado */
    </style>
    <style>
        /* Seus estilos CSS existentes aqui */
        body {
            display: flex; [cite_start]/* [cite: 2] */
            flex-direction: column; [cite_start]/* [cite: 2] */
            min-height: 100vh; [cite_start]/* [cite: 2] */
            margin: 0; [cite_start]/* [cite: 2] */
            font-family: 'Roboto', sans-serif; [cite_start]/* [cite: 3] */
            background-color: #f5f5f5; [cite_start]/* [cite: 3] */
        }
        .mdl-layout__content {
            flex-grow: 1; [cite_start]/* [cite: 4] */
            display: flex; [cite_start]/* [cite: 4] */
            flex-direction: column; [cite_start]/* [cite: 4] */
            padding: 0; [cite_start]/* [cite: 4] */
        }
        .page-content {
            flex-grow: 1; [cite_start]/* [cite: 5] */
        }

        /* Estilos adicionais para o recurso de notícias */
        #news-button {
            position: fixed; [cite_start]/* [cite: 5] */
            bottom: 20px; [cite_start]/* [cite: 6] */
            right: 20px; [cite_start]/* [cite: 6] */
            z-index: 1000; [cite_start]/* [cite: 6] */
            display: flex; [cite_start]/* [cite: 6] */
            align-items: center; [cite_start]/* [cite: 6] */
            justify-content: center; [cite_start]/* [cite: 6] */
            padding: 10px; [cite_start]/* [cite: 6] */
            background-color: #3f51b5; [cite_start]/* [cite: 6] */
            color: white; [cite_start]/* [cite: 6] */
            border-radius: 50%; [cite_start]/* [cite: 6] */
            width: 56px; [cite_start]/* [cite: 7] */
            height: 56px; [cite_start]/* [cite: 7] */
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.26); [cite_start]/* [cite: 7] */
            cursor: pointer; [cite_start]/* [cite: 7] */
            transition: background-color 0.3s; [cite_start]/* [cite: 7] */
        }
        #news-button:hover {
            background-color: #303f9f; [cite_start]/* [cite: 8] */
        }

        .notification-badge {
            background-color: red; [cite_start]/* [cite: 9] */
            color: white; [cite_start]/* [cite: 10] */
            border-radius: 50%; [cite_start]/* [cite: 10] */
            padding: 2px 6px; [cite_start]/* [cite: 10] */
            font-size: 0.7em; [cite_start]/* [cite: 10] */
            position: absolute; [cite_start]/* [cite: 10] */
            top: 0px; [cite_start]/* [cite: 10] */
            right: 0px; [cite_start]/* [cite: 10] */
            transform: translate(50%, -50%); [cite_start]/* [cite: 10] */
            min-width: 15px; [cite_start]/* [cite: 10] */
            /* Garante que o círculo seja visível mesmo com um único dígito */
            text-align: center; [cite_start]/* [cite: 11] */
        }

        #news-center-popup {
            display: none; [cite_start]/* [cite: 12] */
            /* Escondido por padrão */
            position: fixed; [cite_start]/* [cite: 13] */
            top: 50%; [cite_start]/* [cite: 13] */
            left: 50%; [cite_start]/* [cite: 14] */
            transform: translate(-50%, -50%); [cite_start]/* [cite: 14] */
            width: 80%; [cite_start]/* [cite: 14] */
            max-width: 600px; [cite_start]/* [cite: 14] */
            max-height: 90%; [cite_start]/* [cite: 14] */
            background-color: white; [cite_start]/* [cite: 14] */
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3); [cite_start]/* [cite: 15] */
            border-radius: 8px; [cite_start]/* [cite: 15] */
            z-index: 2000; [cite_start]/* [cite: 15] */
            overflow: hidden; [cite_start]/* [cite: 15] */
            flex-direction: column; [cite_start]/* [cite: 15] */
            /* Para organização do conteúdo */
        }

        #news-popup-header {
            display: flex; [cite_start]/* [cite: 16] */
            justify-content: space-between; [cite_start]/* [cite: 17] */
            align-items: center; [cite_start]/* [cite: 17] */
            padding: 16px; [cite_start]/* [cite: 17] */
            background-color: #3f51b5; [cite_start]/* [cite: 17] */
            color: white; [cite_start]/* [cite: 17] */
            border-top-left-radius: 8px; [cite_start]/* [cite: 17] */
            border-top-right-radius: 8px; [cite_start]/* [cite: 18] */
        }

        #news-popup-header h2 {
            margin: 0; [cite_start]/* [cite: 18] */
            font-size: 1.5em; [cite_start]/* [cite: 19] */
        }

        #close-news-popup {
            background: none; [cite_start]/* [cite: 19] */
            border: none; [cite_start]/* [cite: 20] */
            color: white; [cite_start]/* [cite: 20] */
            font-size: 1.8em; [cite_start]/* [cite: 20] */
            cursor: pointer; [cite_start]/* [cite: 20] */
            padding: 0; [cite_start]/* [cite: 20] */
            display: flex; [cite_start]/* [cite: 20] */
            /* Para centralizar o ícone */
            align-items: center; [cite_start]/* [cite: 21] */
            justify-content: center; [cite_start]/* [cite: 22] */
        }

        #news-popup-content {
            padding: 16px; [cite_start]/* [cite: 22] */
            overflow-y: auto; /* Adiciona scroll se o conteúdo for muito grande */
            flex-grow: 1; [cite_start]/* [cite: 23] */
            /* Permite que o conteúdo ocupe o espaço restante */
        }

        .news-popup-item {
            background-color: #f9f9f9; [cite_start]/* [cite: 24] */
            border: 1px solid #ddd; [cite_start]/* [cite: 25] */
            border-radius: 5px; [cite_start]/* [cite: 25] */
            margin-bottom: 10px; [cite_start]/* [cite: 25] */
            padding: 15px; [cite_start]/* [cite: 25] */
            cursor: pointer; [cite_start]/* [cite: 25] */
            transition: background-color 0.3s, border-color 0.3s; [cite_start]/* [cite: 26] */
        }

        .news-popup-item:hover {
            background-color: #f0f0f0; [cite_start]/* [cite: 26] */
        }

        .news-popup-item.unread {
            border: 2px solid #3f51b5; [cite_start]/* [cite: 27] */
            /* Exemplo: borda azul para não lidas */
            background-color: #e8eaf6; [cite_start]/* [cite: 28] */
            /* Exemplo: fundo mais claro para não lidas */
            font-weight: bold; [cite_start]/* [cite: 29] */
        }

        .news-popup-item h3 {
            margin-top: 0; [cite_start]/* [cite: 30] */
            color: #333; [cite_start]/* [cite: 31] */
        }

        .news-popup-item p {
            font-size: 0.9em; [cite_start]/* [cite: 31] */
            color: #555; [cite_start]/* [cite: 32] */
            line-height: 1.5; [cite_start]/* [cite: 32] */
        }

        .news-popup-item small {
            display: block; [cite_start]/* [cite: 32] */
            margin-top: 10px; [cite_start]/* [cite: 33] */
            color: #777; [cite_start]/* [cite: 33] */
            text-align: right; [cite_start]/* [cite: 33] */
        }

        #news-popup-footer {
            padding: 10px 16px; [cite_start]/* [cite: 33] */
            background-color: #f0f0f0; [cite_start]/* [cite: 34] */
            border-top: 1px solid #ddd; [cite_start]/* [cite: 34] */
            text-align: right; [cite_start]/* [cite: 34] */
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Wiki Zone Zero Mod</span>
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation mdl-layout--large-screen-only">
                    <div id="user-info-container" style="display: none; align-items: center; margin-right: 15px;"> <img id="user-profile-pic" src="" alt="Foto de Perfil" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                        <span id="user-info" style="font-size: 0.9em; color: #fff; margin-right: 15px;"></span>
                        <button id="google-apps-button" class="mdl-button mdl-js-button mdl-button--icon" style="color: white; display: none;"> <i class="material-icons">apps</i>
                        </button>
                        <div id="google-apps-popup" class="mdl-shadow--2dp" style="display: none; position: absolute; top: 50px; right: 0; background-color: white; padding: 10px; border-radius: 8px; width: 250px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"> <h4 style="margin-top: 0; text-align: center;">Meus Aplicativos</h4> <div id="app-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;"> </div>
                        </div>
                        <button id="logout-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" style="display: none;">Sair</button>
                    </div> <button id="login-google" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" style="margin-right: 10px;">Login Google</button>
                    <button id="login-github" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">Login GitHub</button>
                </nav>
            </div>
        </header> <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">Navegação</span>
            <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="#" data-page-src="recepcao.html" data-requires-auth="false">Página Inicial</a>
                <a class="mdl-navigation__link" href="#" data-page-src="admintools/editordeartigos.html" data-requires-auth="true">Adicionar Artigo</a>
                <a class="mdl-navigation__link" href="#" data-page-src="register-material.html" data-requires-auth="true">Registrar Matéria</a>
                <a class="mdl-navigation__link" href="#" data-page-src="conhecawazzimagiygg.html" data-requires-auth="false">Conheça WazzimaGiygg</a> <a class="mdl-navigation__link" href="#" data-page-src="admintools/cadastrarprofessor.html" data-requires-auth="true">Cadastrar Professor</a>
                <a class="mdl-navigation__link" href="#" data-page-src="detalhes_cliente/" data-requires-auth="true">Procurar informações sobre Cliente</a>
                <a class="mdl-navigation__link" href="#" data-page-src="admintools/editordenoticias.html" data-requires-auth="true">Adicionar Noticia</a>
                <a class="mdl-navigation__link" href="#" data-page-src="administrarcustos/" data-requires-auth="true">Administrar Custos</a>
                <a class="mdl-navigation__link" href="#" data-page-src="admintools/configuracoes.html" data-requires-auth="true">Configurações</a> <a class="mdl-navigation__link" href="#" data-page-src="admintools/estatisticas.html" data-requires-auth="true">Estatísticas</a>
                <a class="mdl-navigation__link" href="#" data-page-src="admintools/pageadmin.html" data-requires-auth="true">Página Administradora</a>
                <a class="mdl-navigation__link" href="#" onclick="loadPageInNewWindow('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf', false)">Regras</a>
            </nav>
        </div>
        <main class="mdl-layout__content"> <div class="page-content">
                <iframe id="content-iframe" src="desktop.html" frameborder="0" style="width: 100%; height: 100%; border: none;"></iframe> <div id="access-denied-message" style="display: none; text-align: center; padding: 20px; color: red;"> <h3>Acesso Negado</h3>
                    <p>Você precisa estar logado para acessar esta página.</p>
                </div>
                <div id="banned-message" style="display: none; text-align: center; padding: 20px; color: red;"> <h3>Sua conta foi banida</h3>
                    <p>Você não tem permissão para acessar esta página. Entre em contato com o suporte para mais informações.</p>
                </div>
            </div>
        </main> </div>

    <button id="news-button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored" style="display: none;">
        <i class="material-icons">notifications_active</i>
        <span class="notification-badge" style="display: none;">0</span> </button>

    <div id="news-center-popup">
        <div id="news-popup-header">
            <h2>Últimas Notícias</h2>
            <button id="close-news-popup"><i class="material-icons">close</i></button>
        </div>
        <div id="news-popup-content">
            <p>Carregando últimas notícias...</p> </div>
        <div id="news-popup-footer">
            <button id="view-all-news-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                Ver Todas as Notícias
            </button>
        </div>
    </div>

    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script> <script type="text/javascript">
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            [cite_start]apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Use sua própria chave! [cite: 52]
            [cite_start]authDomain: "wzzm-ce3fc.firebaseapp.com", /* [cite: 52] */
            [cite_start]projectId: "wzzm-ce3fc", /* [cite: 52] */
            [cite_start]storageBucket: "wzzm-ce3fc.appspot.com", /* [cite: 52] */
            [cite_start]messagingSenderId: "249427877153", /* [cite: 52] */
            [cite_start]appId: "1:249427877153:web:0e4297294794a5aadeb260", /* [cite: 52] */
            [cite_start]measurementId: "G-PLKNZNFCQ8" /* [cite: 52] */
        };
        [cite_start]// Inicialize Firebase [cite: 53]
        const app = firebase.initializeApp(firebaseConfig); [cite_start]/* [cite: 53] */
        const auth = firebase.auth(); [cite_start]/* [cite: 53] */
        const firestore = firebase.firestore(); [cite_start]/* [cite: 54] */
        firebase.analytics(); [cite_start]/* [cite: 54] */

        // Variáveis globais para estado do usuário
        let currentUser = null; [cite_start]/* [cite: 54] */
        let isCurrentUserBanned = false; [cite_start]/* [cite: 55] */
        let unsubscribeNewsListener = null; [cite_start]/* [cite: 55] */
        let unsubscribeReadNewsListener = null; [cite_start]/* [cite: 55] */
        // Referências aos elementos do DOM
        const newsButton = document.getElementById('news-button'); [cite_start]/* [cite: 56] */
        const newsCenterPopup = document.getElementById('news-center-popup'); [cite_start]/* [cite: 57] */
        const closeNewsPopup = document.getElementById('close-news-popup'); [cite_start]// ID no HTML é 'close-news-popup' [cite: 57]
        const newsPopupContent = document.getElementById('news-popup-content'); [cite_start]/* [cite: 57] */
        const notificationBadge = newsButton.querySelector('.notification-badge'); [cite_start]/* [cite: 58] */
        const viewAllNewsButton = document.getElementById('view-all-news-button'); [cite_start]// Novo botão [cite: 58]

        // --- Funções Auxiliares ---
        // A função loadPage original foi substituída por loadPageInNewWindow
        // e agora o controle de "access denied" e "banned" será feito dentro do iframe
        // pela mensagem recebida.
        function loadPageInNewWindow(src, requiresAuth = false) {
            const contentFrame = document.getElementById('content-iframe');
            if (contentFrame && contentFrame.contentWindow) {
                // Envia uma mensagem para o iframe para que ele crie a nova janela
                contentFrame.contentWindow.postMessage({
                    type: 'openWindow',
                    url: src,
                    requiresAuth: requiresAuth,
                    currentUserUid: currentUser ? currentUser.uid : null, // Passa o UID do usuário
                    isCurrentUserBanned: isCurrentUserBanned // Passa o status de banimento
                }, window.location.origin); // Use window.location.origin para segurança
            }
        }

        // Função para ativar/desativar links de navegação com base no status de login
        function setNavLinksEnabled(enabled) {
            const navLinks = document.querySelectorAll('.mdl-navigation__link[data-requires-auth="true"]'); [cite_start]/* [cite: 65] */
            navLinks.forEach(link => {
                if (enabled) {
                    link.style.pointerEvents = 'auto';
                    link.style.color = '#424242'; // Cor padrão
                } else {
                    [cite_start]link.style.pointerEvents = 'none'; /* [cite: 66] */
                    link.style.color = '#9e9e9e'; // Cor para desabilitado
                }
            }); [cite_start]/* [cite: 67] */
        }

        // Função para criar/atualizar o documento do perfil do usuário no Firestore
        async function createUserProfileDocument(user) {
            if (!user) return; [cite_start]/* [cite: 67] */
            const userRef = firestore.doc(`users/${user.uid}`); [cite_start]/* [cite: 68] */
            const snapshot = await userRef.get(); [cite_start]/* [cite: 68] */

            if (!snapshot.exists) {
                const { displayName, email, photoURL } = user; [cite_start]/* [cite: 69] */
                const createdAt = firebase.firestore.FieldValue.serverTimestamp(); [cite_start]// Usar timestamp do servidor [cite: 69]

                try {
                    await userRef.set({
                        displayName: displayName || email, // Usar email se display name não estiver disponível
                        [cite_start]email, /* [cite: 70] */
                        photoURL: photoURL || [cite_start]'', /* [cite: 70] */
                        [cite_start]createdAt, /* [cite: 70] */
                        [cite_start]isAdmin: false, // Define como false por padrão [cite: 70]
                        [cite_start]isBan: false // Define como false por padrão [cite: 71]
                    });
                    console.log("Perfil do usuário criado no Firestore."); [cite_start]/* [cite: 72] */
                } catch (error) {
                    console.error("Erro ao criar perfil do usuário:", error); [cite_start]/* [cite: 73] */
                }
            }
        }

        // Função para carregar e aplicar CSS de aplicativos específicos do usuário
        async function loadAndApplyUserAppsCSS(userId) {
            const customAppCssStyleTag = document.getElementById('custom-app-css'); [cite_start]/* [cite: 73] */
            if (!customAppCssStyleTag) return; [cite_start]/* [cite: 74] */

            try {
                const userAppsSnapshot = await firestore.collection('userApps').doc(userId).get(); [cite_start]/* [cite: 74] */
                if (userAppsSnapshot.exists) {
                    const appData = userAppsSnapshot.data(); [cite_start]/* [cite: 75] */
                    let cssContent = ''; [cite_start]/* [cite: 76] */
                    if (appData && appData.apps) {
                        appData.apps.forEach(app => {
                            if (app.css) {
                                [cite_start]cssContent += app.css + '\n'; /* [cite: 77] */
                            }
                        }); [cite_start]/* [cite: 78] */
                    }
                    customAppCssStyleTag.innerHTML = cssContent; [cite_start]/* [cite: 78] */
                } else {
                    customAppCssStyleTag.innerHTML = ''; [cite_start]/* [cite: 79] */
                    // Limpa se não houver apps
                }
            } catch (error) {
                console.error("Erro ao carregar CSS de aplicativos do usuário:", error); [cite_start]/* [cite: 80] */
                customAppCssStyleTag.innerHTML = ''; [cite_start]/* [cite: 81] */
            }
        }

        // --- FUNÇÕES PARA O POPUP DE NOTÍCIAS ---
        function showNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'flex'; [cite_start]/* [cite: 82] */
                loadNewsForPopup(); // Carrega notícias quando o popup é mostrado
            }
        }

        function hideNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'none'; [cite_start]/* [cite: 83] */
            }
        }

        // Função para carregar e exibir notícias no popup
        async function loadNewsForPopup() {
            newsPopupContent.innerHTML = '<p>Carregando últimas notícias...</p>'; [cite_start]/* [cite: 84] */
            if (!currentUser) {
                newsPopupContent.innerHTML = '<p>Faça login para ver suas notícias personalizadas.</p>'; [cite_start]/* [cite: 85] */
                return;
            }

            try {
                const newsSnapshot = await firestore.collection('news')
                    .orderBy('publishDate', 'desc') // Assume um campo 'publishDate' ou 'createdAt'
                    .limit(10) // Limita a 10 notícias no popup
                    .get(); [cite_start]/* [cite: 86] */
                if (newsSnapshot.empty) {
                    newsPopupContent.innerHTML = '<p>Nenhuma notícia encontrada.</p>'; [cite_start]/* [cite: 87] */
                    return;
                }

                newsPopupContent.innerHTML = ''; [cite_start]/* [cite: 88] */
                // Limpa o conteúdo existente

                const readNewsIds = new Set(); [cite_start]/* [cite: 89] */
                const readNewsSnapshot = await firestore.collection('users').doc(currentUser.uid).collection('readNews').get(); [cite_start]/* [cite: 90] */
                readNewsSnapshot.forEach(doc => readNewsIds.add(doc.id));

                newsSnapshot.forEach(doc => {
                    const news = doc.data();
                    const newsId = doc.id;
                    const isRead = readNewsIds.has(newsId);

                    [cite_start]const newsElement = document.createElement('div'); /* [cite: 91] */
                    newsElement.classList.add('news-popup-item');
                    if (!isRead) {
                        newsElement.classList.add('unread'); // Adiciona classe CSS para notícias não lidas
                    }

                    const publishDate = news.publishDate ? news.publishDate.toDate() : new Date(); [cite_start]// Usar news.publishDate ou criar novo [cite: 92]
                    const timeString = publishDate.toLocaleString([], {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        [cite_start]hour: '2-digit', minute: '2-digit' /* [cite: 93] */
                    });

                    newsElement.innerHTML = `
                        <h3>${news.title || 'Sem Título'}</h3>
                        <p>${news.content || news.description || 'Sem conteúdo.'}</p> ${news.category ? `<small>Categoria: ${news.category}</small><br>` : ''} ${news.tags && news.tags.length > 0 ? `<small>Tags: ${news.tags.join(', ')}</small><br>` : ''} <small>Publicado em: ${timeString}</small>
                        ${news.imageUrl ? `<img src="${news.imageUrl}" alt="Imagem da Notícia" style="max-width: 100%; height: auto; margin-top: 10px;">` : ''} `;
                    newsElement.addEventListener('click', () => markNewsAsRead(currentUser.uid, newsId)); [cite_start]/* [cite: 98] */
                    newsPopupContent.appendChild(newsElement);
                });

            } catch (error) {
                console.error("Erro ao buscar notícias para o popup:", error); [cite_start]/* [cite: 99] */
                newsPopupContent.innerHTML = `<p style="color: red;">Erro ao carregar notícias: ${error.message}</p>`; [cite_start]/* [cite: 99] */
            }
        }

        // Função para marcar notícia como lida
        async function markNewsAsRead(userId, newsId) {
            const readNewsDocRef = firestore.collection('users').doc(userId).collection('readNews').doc(newsId); [cite_start]/* [cite: 99] */
            try {
                await readNewsDocRef.set({ readAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); [cite_start]/* [cite: 100] */
                console.log(`Notícia ${newsId} marcada como lida para o usuário ${userId}`); [cite_start]/* [cite: 101] */
                // Atualiza o contador e a lista de notícias no popup
                updateNewsNotificationCount(userId); [cite_start]/* [cite: 101] */
                loadNewsForPopup(); [cite_start]/* [cite: 102] */
            } catch (error) {
                console.error("Erro ao marcar notícia como lida:", error); [cite_start]/* [cite: 103] */
            }
        }

        // Função para atualizar o contador de notícias não lidas
        async function updateNewsNotificationCount(userId) {
            if (!userId) {
                notificationBadge.style.display = 'none'; [cite_start]/* [cite: 103] */
                notificationBadge.textContent = '0'; [cite_start]/* [cite: 104] */
                return;
            }

            try {
                const newsSnapshot = await firestore.collection('news').get(); [cite_start]/* [cite: 104] */
                const totalNewsCount = newsSnapshot.size; [cite_start]/* [cite: 105] */

                const readNewsSnapshot = await firestore.collection('users').doc(userId).collection('readNews').get(); [cite_start]/* [cite: 105] */
                const readNewsCount = readNewsSnapshot.size; [cite_start]/* [cite: 105] */

                const unreadCount = totalNewsCount - readNewsCount; [cite_start]/* [cite: 106] */
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount; [cite_start]/* [cite: 106] */
                    notificationBadge.style.display = 'block'; [cite_start]// Mostra o badge [cite: 107]
                } else {
                    notificationBadge.style.display = 'none'; [cite_start]/* [cite: 107] */
                    // Esconde o badge
                    notificationBadge.textContent = '0'; [cite_start]/* [cite: 108] */
                }
            } catch (error) {
                console.error("Erro ao atualizar contador de notícias:", error); [cite_start]/* [cite: 109] */
                notificationBadge.style.display = 'none'; [cite_start]/* [cite: 110] */
                notificationBadge.textContent = '0'; [cite_start]/* [cite: 110] */
            }
        }

        // --- Funções de Autenticação (EXISTENTES) ---
        const providerGoogle = new firebase.auth.GoogleAuthProvider(); [cite_start]/* [cite: 111] */
        const providerGitHub = new firebase.auth.GithubAuthProvider(); [cite_start]/* [cite: 111] */

        document.getElementById('login-google').addEventListener('click', () => {
            auth.signInWithPopup(providerGoogle)
                .catch(error => {
                    console.error("Erro no login com Google:", error);
                });
        });
        document.getElementById('login-github').addEventListener('click', () => {
            auth.signInWithPopup(providerGitHub)
                .catch(error => {
                    console.error("Erro no login com GitHub:", error);
                });
        }); [cite_start]/* [cite: 112] */
        function handleLogout() {
            auth.signOut().then(() => {
                console.log("Usuário deslogado.");
            }).catch((error) => {
                console.error("Erro ao deslogar:", error);
            }); [cite_start]/* [cite: 114] */
        }
        const logoutButton = document.getElementById('logout-button'); [cite_start]/* [cite: 114] */
        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout); [cite_start]/* [cite: 115] */
        }

        // --- Gerenciamento de Estado de Autenticação ---
        auth.onAuthStateChanged(async (user) => {
            [cite_start]currentUser = user; // Define o currentUser globalmente [cite: 149]
            const userInfo = document.getElementById('user-info');
            const loginGoogleButton = document.getElementById('login-google');
            const loginGitHubButton = document.getElementById('login-github');
            const logoutButton = document.getElementById('logout-button'); [cite_start]/* [cite: 117] */
            const userProfilePic = document.getElementById('user-profile-pic');
            const googleAppsButton = document.getElementById('google-apps-button');
            const userInfoContainer = document.getElementById('user-info-container');
            const googleAppsPopup = document.getElementById('google-apps-popup');
            const customAppCssStyleTag = document.getElementById('custom-app-css');
            const contentFrame = document.getElementById('content-iframe'); [cite_start]// ID correto do [cite: 117]
            const accessDeniedMessage = document.getElementById('access-denied-message'); [cite_start]/* [cite: 118] */
            const bannedMessage = document.getElementById('banned-message'); [cite_start]/* [cite: 118] */
            const newsButton = document.getElementById('news-button'); [cite_start]/* [cite: 119] */
            const newsCenterPopup = document.getElementById('news-center-popup'); [cite_start]/* [cite: 119] */


            if (user) {
                if (userInfo) userInfo.textContent = `Olá, ${user.displayName || user.email}!`; [cite_start]/* [cite: 120] */
                if (loginGoogleButton) loginGoogleButton.style.display = 'none'; [cite_start]/* [cite: 120] */
                if (loginGitHubButton) loginGitHubButton.style.display = 'none'; [cite_start]/* [cite: 121] */
                if (user.photoURL) {
                    if (userProfilePic) {
                        userProfilePic.src = user.photoURL; [cite_start]/* [cite: 121] */
                        userProfilePic.style.display = 'inline-block'; [cite_start]/* [cite: 122] */
                    }
                } else {
                    if (userProfilePic) userProfilePic.style.display = 'none'; [cite_start]/* [cite: 122] */
                }
                if (googleAppsButton) googleAppsButton.style.display = 'inline-block'; [cite_start]/* [cite: 123] */
                if (userInfoContainer) userInfoContainer.style.display = 'flex'; [cite_start]/* [cite: 124] */

                await createUserProfileDocument(user);

                let isUserBanned = false; [cite_start]/* [cite: 124] */
                try {
                    const userProfileRef = firestore.collection('users').doc(user.uid); [cite_start]/* [cite: 125] */
                    const doc = await userProfileRef.get(); [cite_start]/* [cite: 126] */

                    if (doc.exists && doc.data()) {
                        isUserBanned = doc.data().isBan || false; [cite_start]/* [cite: 127] */
                    }
                } catch (error) {
                    console.error("Erro ao verificar perfil de usuário ou status de banimento:", error); [cite_start]/* [cite: 128] */
                    isUserBanned = false;
                }

                isCurrentUserBanned = isUserBanned; [cite_start]/* [cite: 128] */
                if (isUserBanned) {
                    console.warn(`Usuário ${user.uid} está banido.`); [cite_start]/* [cite: 129] */
                    setNavLinksEnabled(false); [cite_start]/* [cite: 130] */
                    if (logoutButton) {
                        logoutButton.style.display = 'none'; [cite_start]/* [cite: 130] */
                        logoutButton.removeEventListener('click', handleLogout); [cite_start]/* [cite: 131] */
                    }
                    // Quando banido, a página inicial padrão é carregada no iframe
                    // e as mensagens de banimento/acesso negado são gerenciadas dentro do iframe.
                    if (bannedMessage) bannedMessage.style.display = 'block'; [cite_start]/* [cite: 132] */
                    if (contentFrame) contentFrame.style.display = 'none'; [cite_start]/* [cite: 132] */
                    if (googleAppsButton) {
                        googleAppsButton.style.pointerEvents = 'none'; [cite_start]/* [cite: 133] */
                        googleAppsButton.style.opacity = '0.6'; [cite_start]/* [cite: 134] */
                    }
                    if (googleAppsPopup) googleAppsPopup.style.display = 'none'; [cite_start]/* [cite: 134] */
                    if (newsButton) newsButton.style.display = 'none'; [cite_start]/* [cite: 135] */
                    if (newsCenterPopup) newsCenterPopup.style.display = 'none'; [cite_start]/* [cite: 135] */

                    // Enviar mensagem para o iframe sobre o status de banimento
                    if (contentFrame && contentFrame.contentWindow) {
                        contentFrame.contentWindow.postMessage({
                            type: 'userStatusUpdate',
                            isBanned: true
                        }, window.location.origin);
                    }

                } else { // User is not banned
                    if (logoutButton) logoutButton.style.display = 'inline-block'; [cite_start]/* [cite: 136] */
                    setNavLinksEnabled(true); [cite_start]// Enable all links if not banned [cite: 137]
                    if (bannedMessage) bannedMessage.style.display = 'none'; [cite_start]/* [cite: 137] */
                    if (contentFrame) contentFrame.style.display = 'block'; [cite_start]/* [cite: 138] */
                    if (accessDeniedMessage) accessDeniedMessage.style.display = 'none'; [cite_start]/* [cite: 139] */
                    if (googleAppsButton) {
                        googleAppsButton.style.pointerEvents = 'auto'; [cite_start]/* [cite: 139] */
                        googleAppsButton.style.opacity = '1'; [cite_start]/* [cite: 140] */
                    }
                    if (newsButton) newsButton.style.display = 'inline-block'; [cite_start]/* [cite: 140] */
                    await loadAndApplyUserAppsCSS(user.uid); [cite_start]/* [cite: 141] */

                    // Adicionar ouvintes em tempo real para notícias e status de leitura
                    if (unsubscribeNewsListener) {
                        unsubscribeNewsListener(); [cite_start]/* [cite: 141] */
                        // Desinscreve o ouvinte anterior
                    }
                    unsubscribeNewsListener = firestore.collection('news').onSnapshot(() => {
                        updateNewsNotificationCount(user.uid);
                        [cite_start]if (newsCenterPopup.style.display === 'flex') { /* [cite: 143] */
                            loadNewsForPopup();
                        }
                    }, error => console.error("Erro ao ouvir notícias:", error)); [cite_start]/* [cite: 144] */
                    if (unsubscribeReadNewsListener) {
                        unsubscribeReadNewsListener(); [cite_start]/* [cite: 144] */
                        // Desinscreve o ouvinte anterior
                    }
                    unsubscribeReadNewsListener = firestore.collection('users').doc(user.uid).collection('readNews').onSnapshot(() => {
                        updateNewsNotificationCount(user.uid);
                        [cite_start]if (newsCenterPopup.style.display === 'flex') { /* [cite: 146] */
                            loadNewsForPopup();
                        }
                    }, error => console.error("Erro ao ouvir status de leitura:", error)); [cite_start]/* [cite: 147] */
                    // Carrega o contador inicial de notificações ao iniciar
                    updateNewsNotificationCount(user.uid); [cite_start]/* [cite: 147] */

                    // Enviar mensagem para o iframe sobre o status de login/não banimento
                    if (contentFrame && contentFrame.contentWindow) {
                        contentFrame.contentWindow.postMessage({
                            type: 'userStatusUpdate',
                            isBanned: false,
                            isLoggedIn: true,
                            currentUserUid: user.uid
                        }, window.location.origin);
                    }
                }

            } else { // Usuário deslogado
                currentUser = null; [cite_start]/* [cite: 148] */
                if (userInfo) userInfo.textContent = ''; [cite_start]/* [cite: 149] */
                if (loginGoogleButton) loginGoogleButton.style.display = 'inline-block'; [cite_start]/* [cite: 149] */
                if (loginGitHubButton) loginGitHubButton.style.display = 'inline-block'; [cite_start]/* [cite: 149] */
                if (logoutButton) logoutButton.style.display = 'none'; [cite_start]/* [cite: 149] */
                isCurrentUserBanned = false; [cite_start]/* [cite: 150] */
                if (bannedMessage) bannedMessage.style.display = 'none'; [cite_start]/* [cite: 150] */
                setNavLinksEnabled(false);
                // Quando deslogado, a página inicial padrão é carregada no iframe
                // e as mensagens de banimento/acesso negado são gerenciadas dentro do iframe.
                if (userProfilePic) {
                    userProfilePic.style.display = 'none'; [cite_start]/* [cite: 151] */
                    userProfilePic.src = ''; [cite_start]/* [cite: 152] */
                }
                if (googleAppsButton) googleAppsButton.style.display = 'none'; [cite_start]/* [cite: 152] */
                if (userInfoContainer) userInfoContainer.style.display = 'none'; [cite_start]/* [cite: 153] */
                if (googleAppsPopup) googleAppsPopup.style.display = 'none'; [cite_start]/* [cite: 153] */
                if (customAppCssStyleTag) customAppCssStyleTag.innerHTML = ''; [cite_start]/* [cite: 153] */
                if (contentFrame) contentFrame.style.display = 'block'; [cite_start]/* [cite: 153] */
                if (accessDeniedMessage) accessDeniedMessage.style.display = 'none'; [cite_start]/* [cite: 154] */
                if (newsButton) newsButton.style.display = 'none'; [cite_start]/* [cite: 154] */
                if (newsCenterPopup) newsCenterPopup.style.display = 'none'; [cite_start]/* [cite: 154] */

                hideNewsPopup(); [cite_start]/* [cite: 154] */
                // Desinscreve os ouvintes quando o usuário desloga
                if (unsubscribeNewsListener) {
                    unsubscribeNewsListener(); [cite_start]/* [cite: 155] */
                    unsubscribeNewsListener = null; [cite_start]/* [cite: 156] */
                }
                if (unsubscribeReadNewsListener) {
                    unsubscribeReadNewsListener(); [cite_start]/* [cite: 156] */
                    unsubscribeReadNewsListener = null; [cite_start]/* [cite: 157] */
                }
                notificationBadge.style.display = 'none'; [cite_start]/* [cite: 157] */
                // Garante que o badge esteja oculto
                notificationBadge.textContent = '0'; [cite_start]/* [cite: 158] */

                // Enviar mensagem para o iframe sobre o status de deslogado
                if (contentFrame && contentFrame.contentWindow) {
                    contentFrame.contentWindow.postMessage({
                        type: 'userStatusUpdate',
                        isLoggedIn: false
                    }, window.location.origin);
                }
            }
            if (componentHandler) {
                componentHandler.upgradeDom(); [cite_start]/* [cite: 159] */
            }
        });

        // --- Event Listeners DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            const googleAppsButton = document.getElementById('google-apps-button');
            const googleAppsPopup = document.getElementById('google-apps-popup');
            const navLinks = document.querySelectorAll('.mdl-navigation__link');

            // Get references for news popup elements
            [cite_start]const newsButton = document.getElementById('news-button'); /* [cite: 161] */
            const newsCenterPopup = document.getElementById('news-center-popup'); [cite_start]/* [cite: 161] */
            const closeNewsPopup = document.getElementById('close-news-popup'); [cite_start]// ID correto [cite: 162]
            const viewAllNewsButton = document.getElementById('view-all-news-button'); [cite_start]/* [cite: 162] */


            // --- Adicionar Event Listeners ---

            // Botão Google Apps (mantido)
            if (googleAppsButton) {
                [cite_start]googleAppsButton.addEventListener('click', (event) => { /* [cite: 162] */
                    event.stopPropagation(); [cite_start]/* [cite: 163] */
                    if (googleAppsPopup.style.display === 'block') {
                        googleAppsPopup.style.display = 'none'; [cite_start]/* [cite: 164] */
                    } else {
                        googleAppsPopup.style.display = 'block'; [cite_start]/* [cite: 164] */
                        // Carregar apps dinamicamente
                        const appGrid = document.getElementById('app-grid'); [cite_start]/* [cite: 165] */
                        appGrid.innerHTML = '<p>Carregando aplicativos...</p>'; [cite_start]/* [cite: 166] */
                        if (currentUser) {
                            firestore.collection('userApps').doc(currentUser.uid).get()
                                .then(doc => {
                                    [cite_start]if (doc.exists && doc.data() && doc.data().apps) { /* [cite: 167] */
                                        appGrid.innerHTML = ''; // Limpa o conteúdo
                                        doc.data().apps.forEach(app => {
                                            [cite_start]const appItem = document.createElement('div'); /* [cite: 168] */
                                            appItem.classList.add('app-item');
                                            appItem.innerHTML = `
                                                <img src="${app.iconUrl}" alt="${app.name}">
                                                <span>${app.name}</span> `; [cite_start]/* [cite: 169] */
                                            appItem.addEventListener('click', () => {
                                                // Chamada modificada para abrir na nova janela
                                                [cite_start]loadPageInNewWindow(app.url, app.requiresAuth || false); /* [cite: 171] */
                                                googleAppsPopup.style.display = 'none'; [cite_start]// Fecha o popup [cite: 172]
                                            });
                                            appGrid.appendChild(appItem); [cite_start]/* [cite: 173] */
                                        });
                                    } else {
                                        appGrid.innerHTML = '<p>Nenhum aplicativo encontrado.</p>'; [cite_start]/* [cite: 174] */
                                    }
                                })
                                .catch(error => {
                                    [cite_start]console.error("Erro ao carregar aplicativos:", error); /* [cite: 175] */
                                    appGrid.innerHTML = '<p>Erro ao carregar aplicativos.</p>';
                                });
                        } else {
                            appGrid.innerHTML = '<p>Faça login para ver seus aplicativos.</p>'; [cite_start]/* [cite: 176] */
                        }
                    }
                }); [cite_start]/* [cite: 178] */
            }

            // Event Listeners for News Button and Popup (mantidos e atualizados)
            if (newsButton) {
                newsButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (newsCenterPopup.style.display === 'flex') {
                        [cite_start]hideNewsPopup(); /* [cite: 179] */
                    } else {
                        showNewsPopup();
                    }
                }); [cite_start]/* [cite: 180] */
            }

            if (closeNewsPopup) { // Usar o ID correto
                closeNewsPopup.addEventListener('click', () => {
                    hideNewsPopup();
                }); [cite_start]/* [cite: 181] */
            }

            if (viewAllNewsButton) {
                viewAllNewsButton.addEventListener('click', () => {
                    // Chamada modificada para abrir na nova janela
                    loadPageInNewWindow('visualizarnoticias.html', false); // Carrega a página completa de notícias
                    hideNewsPopup(); // Esconde o popup
                }); [cite_start]/* [cite: 182] */
            }

            // Listener global para fechar popups ao clicar fora (ajustado)
            document.addEventListener('click', (event) => {
                // Fecha o popup de apps se clicar fora dele
                if (googleAppsPopup && googleAppsPopup.style.display === 'block' &&
                    [cite_start]!googleAppsButton.contains(event.target) && /* [cite: 183] */
                    !googleAppsPopup.contains(event.target)) {
                    googleAppsPopup.style.display = 'none';
                }

                // Fecha o popup de notícias se clicar fora dele
                [cite_start]if (newsCenterPopup && newsCenterPopup.style.display === 'flex' && /* [cite: 184] */
                    !newsButton.contains(event.target) &&
                    !newsCenterPopup.contains(event.target)) {
                    newsCenterPopup.style.display = 'none';
                }
            }); [cite_start]/* [cite: 185] */

            // Adiciona event listener para links de navegação no drawer (ajustado)
            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    // Previne o comportamento padrão do link (evita que o href="#" recarregue a página)
                    [cite_start]event.preventDefault(); /* [cite: 186] */

                    // Obtém o src da página do atributo 'data-page-src'
                    let actualPageSrc = this.getAttribute('data-page-src');

                    // Obtém o requisito de autenticação do atributo 'data-requires-auth'
                    [cite_start]// Ele será 'true' se o atributo existir e for 'true', caso contrário, 'false'. [cite: 187]
                    let requiresAuth = this.getAttribute('data-requires-auth') === 'true';

                    // === NOVAS CONDIÇÕES PARA LINKS QUE NÃO TÊM data-page-src (como 'Regras') ===
                    [cite_start]// Se o data-page-src não estiver definido, tente extrair do onclick [cite: 188]
                    // como fallback
                    if (!actualPageSrc) {
                        const onclickAttr = this.getAttribute('onclick'); [cite_start]/* [cite: 188] */
                        if (onclickAttr && onclickAttr.includes("loadPageInNewWindow(")) {
                            [cite_start]const match = onclickAttr.match(/loadPageInNewWindow\('([^']*)', (true|false)\)/); /* [cite: 189] */
                            if (match) {
                                actualPageSrc = match[1]; [cite_start]/* [cite: 190] */
                                requiresAuth = match[2] === 'true'; [cite_start]/* [cite: 190] */
                            }
                        }
                    [cite_start]} /* [cite: 191] */
                    // ===========================================================================

                    // Se por algum motivo ainda não tivermos um src, pare a execução
                    if (!actualPageSrc) {
                        console.warn('Nenhum src de página encontrado para o link:', this); [cite_start]/* [cite: 192] */
                        return;
                    }

                    // A lógica de banimento agora é verificada dentro do iframe ao receber a mensagem
                    // e ao abrir a janela.
                    // O preventDefault já foi chamado.
                    // A condição de disabled será gerenciada pelo setNavLinksEnabled.

                    // Para PDFs, vamos permitir que ele seja aberto na nova janela como os outros
                    // se você quer que abra em nova aba, precisaria de um target="_blank"
                    // ou um tratamento JS diferente.

                    loadPageInNewWindow(actualPageSrc, requiresAuth); // Chama a função para carregar a página na nova janela
                    
                    // Fecha o drawer do MDL se estiver aberto
                    if (document.querySelector('.mdl-layout__drawer.is-visible')) {
                        document.querySelector('.mdl-layout__obfuscator').classList.remove('is-visible'); [cite_start]/* [cite: 202] */
                        document.querySelector('.mdl-layout__drawer').classList.remove('is-visible'); [cite_start]/* [cite: 202] */
                    }
                }); [cite_start]/* [cite: 203] */
            });

            // Inicializa componentes MDL
            if (componentHandler) {
                componentHandler.upgradeDom(); [cite_start]/* [cite: 204] */
            }
        });
    </script>
</body>
</html>
