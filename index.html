<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki Zone Zero Mod</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style id="custom-app-css">
        /* Este será o local onde o CSS dos aplicativos do usuário será injetado */
    </style>
    <style>
        /* Seus estilos CSS existentes aqui */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .mdl-layout__content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        .page-content {
            flex-grow: 1;
        }

        /* Estilos adicionais para o recurso de notícias */
        #news-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }

        #news-center-popup {
            display: none; /* Inicia oculto */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .news-popup-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative; /* Para posicionar o botão de fechar */
        }

        .news-popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .news-item {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-item h3 {
            margin-top: 0;
            color: #3f51b5;
        }

        .news-item p {
            color: #555;
        }

        .news-item small {
            color: #888;
            font-size: 0.8em;
        }

        .news-item.read {
            opacity: 0.6;
        }

        #notification-badge {
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.8em;
            position: absolute;
            top: -5px;
            right: -5px;
            display: none;
        }

        .mdl-navigation__link.disabled {
            pointer-events: none;
            color: #9e9e9e; /* Cor para links desabilitados */
        }

        #login-google-button,
        #login-github-button,
        #logout-button {
            display: none; /* Oculta os botões por padrão */
        }

        #user-profile-pic {
            display: none; /* Oculta a imagem de perfil por padrão */
            width: 40px; /* Ajuste o tamanho conforme necessário */
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        #user-info-container {
            display: none; /* Oculta o contêiner de informações do usuário por padrão */
            display: flex;
            align-items: center;
        }

        #banned-message {
            display: none; /* Oculta a mensagem de banimento por padrão */
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
        }
        #google-apps-button {
            display: none;
        }
        #google-apps-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .google-apps-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .google-apps-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .google-app-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .google-app-item img {
            width: 48px;
            height: 48px;
            margin-right: 15px;
        }

        .google-app-item a {
            font-size: 1.2em;
            color: #3f51b5;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Wiki Zone Zero Mod</span>
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation mdl-layout--large-screen-only">
                    <a class="mdl-navigation__link" href="#" data-page-src="recepcao.html" data-requires-auth="false">Página Inicio</a>
                    <a class="mdl-navigation__link" href="#" onclick="window.open('POLÍTICAS GERAIS DO WIKI ZONE ZERO MOD.pdf', '_blank'); return false;">Regras</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="artigos.html" data-requires-auth="true">Artigos</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="imagens.html" data-requires-auth="true">Imagens</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="client-wzzm.html" data-requires-auth="true">Client WZZM</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="contato.html" data-requires-auth="true">Contato</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="user-page.html" data-requires-auth="true">Página do Usuário</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="track-report-user.html" data-requires-auth="true">Rastrear usuário / Denunciar</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="other-services.html" data-requires-auth="true">Outros serviços da Wiki Zone Zero Mod</a>
                    <a class="mdl-navigation__link" href="#" data-page-src="noticias.html" data-requires-auth="true">Visualizar Noticias</a>
                </nav>
                <div id="user-info-container">
                    <img id="user-profile-pic" src="" alt="Foto de Perfil">
                    <span id="user-info"></span>
                    <button id="google-apps-button" class="mdl-button mdl-js-button mdl-button--icon">
                        <i class="material-icons">apps</i>
                    </button>
                    <button id="login-google-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
                        Login Google
                    </button>
                    <button id="login-github-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
                        Login GitHub
                    </button>
                    <button id="logout-button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">Menu</span>
            <nav class="mdl-navigation">
                <a class="mdl-navigation__link" href="#" data-page-src="recepcao.html" data-requires-auth="false">Página Inicio</a>
                <a class="mdl-navigation__link" href="#" onclick="window.open('POLÍTICAS GERAIS DO WIKI ZONE ZERO MOD.pdf', '_blank'); return false;">Regras</a>
                <a class="mdl-navigation__link" href="#" data-page-src="artigos.html" data-requires-auth="true">Artigos</a>
                <a class="mdl-navigation__link" href="#" data-page-src="imagens.html" data-requires-auth="true">Imagens</a>
                <a class="mdl-navigation__link" href="#" data-page-src="client-wzzm.html" data-requires-auth="true">Client WZZM</a>
                <a class="mdl-navigation__link" href="#" data-page-src="contato.html" data-requires-auth="true">Contato</a>
                <a class="mdl-navigation__link" href="#" data-page-src="user-page.html" data-requires-auth="true">Página do Usuário</a>
                <a class="mdl-navigation__link" href="#" data-page-src="track-report-user.html" data-requires-auth="true">Rastrear usuário / Denunciar</a>
                <a class="mdl-navigation__link" href="#" data-page-src="other-services.html" data-requires-auth="true">Outros serviços da Wiki Zone Zero Mod</a>
                <a class="mdl-navigation__link" href="#" data-page-src="noticias.html" data-requires-auth="true">Visualizar Noticias</a>
            </nav>
        </div>
        <main class="mdl-layout__content">
            <div id="banned-message" class="mdl-typography--headline">
                Você está banido do Wiki Zone Zero Mod. Você ainda pode visualizar a "Página Inicio" e as "Regras".
            </div>
            <iframe id="content-frame" class="page-content" src="recepcao.html" frameborder="0"></iframe>
            <div id="access-denied-message" class="mdl-typography--headline" style="display: none;">
                Acesso negado. Faça login para visualizar este conteúdo.
            </div>
        </main>
    </div>

    <button id="news-button" class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored">
        <i class="material-icons">announcement</i>
        <span id="notification-badge">0</span>
    </button>

    <div id="news-center-popup">
        <div class="mdl-card mdl-shadow--8dp news-popup-card">
            <button class="news-popup-close">&times;</button>
            <h3>Notícias</h3>
            <div id="news-popup-content">
                </div>
        </div>
    </div>

    <div id="google-apps-popup">
        <div class="mdl-card mdl-shadow--8dp google-apps-card">
            <button class="google-apps-close">&times;</button>
            <h3>Aplicativos Google</h3>
            <div id="google-apps-content">
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/drive_48dp.png" alt="Google Drive">
                    <a href="https://drive.google.com/" target="_blank">Google Drive</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/docs_48dp.png" alt="Google Docs">
                    <a href="https://docs.google.com/" target="_blank">Google Docs</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/sheets_48dp.png" alt="Google Sheets">
                    <a href="https://sheets.google.com/" target="_blank">Google Sheets</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/slides_48dp.png" alt="Google Slides">
                    <a href="https://slides.google.com/" target="_blank">Google Slides</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/gmail_48dp.png" alt="Gmail">
                    <a href="https://mail.google.com/" target="_blank">Gmail</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/calendar_48dp.png" alt="Google Calendar">
                    <a href="https://calendar.google.com/" target="_blank">Google Calendar</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/photos_48dp.png" alt="Google Photos">
                    <a href="https://photos.google.com/" target="_blank">Google Photos</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/meet_48dp.png" alt="Google Meet">
                    <a href="https://meet.google.com/" target="_blank">Google Meet</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/classroom_48dp.png" alt="Google Classroom">
                    <a href="https://classroom.google.com/" target="_blank">Google Classroom</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/forms_48dp.png" alt="Google Forms">
                    <a href="https://docs.google.com/forms/" target="_blank">Google Forms</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/sites_48dp.png" alt="Google Sites">
                    <a href="https://sites.google.com/" target="_blank">Google Sites</a>
                </div>
                <div class="google-app-item">
                    <img src="https://www.gstatic.com/images/branding/product/2x/keep_48dp.png" alt="Google Keep">
                    <a href="https://keep.google.com/" target="_blank">Google Keep</a>
                </div>
            </div>
        </div>
    </div>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="module">
        // Importa as bibliotecas Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, GoogleAuthProvider, GithubAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            // Suas credenciais de configuração do Firebase aqui
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        // Referências aos elementos do DOM
        let currentUser = null;
        let isCurrentUserBanned = false;
        let unsubscribeNewsListener = null;
        let unsubscribeReadNewsListener = null;

        const userInfo = document.getElementById('user-info');
        const loginGoogleButton = document.getElementById('login-google-button');
        const loginGitHubButton = document.getElementById('login-github-button');
        const logoutButton = document.getElementById('logout-button');
        const userProfilePic = document.getElementById('user-profile-pic');
        const userInfoContainer = document.getElementById('user-info-container');
        const bannedMessage = document.getElementById('banned-message');
        const contentFrame = document.getElementById('content-frame');
        const accessDeniedMessage = document.getElementById('access-denied-message');
        const customAppCssStyleTag = document.getElementById('custom-app-css');
        const googleAppsButton = document.getElementById('google-apps-button');
        const googleAppsPopup = document.getElementById('google-apps-popup');
        const googleAppsCloseButton = document.querySelector('.google-apps-close');

        const newsButton = document.getElementById('news-button');
        const newsCenterPopup = document.getElementById('news-center-popup');
        const newsPopupCloseButton = document.querySelector('.news-popup-close');
        const newsPopupContent = document.getElementById('news-popup-content');
        const notificationBadge = document.getElementById('notification-badge');

        // Provedores de Autenticação
        const googleProvider = new GoogleAuthProvider();
        const githubProvider = new GithubAuthProvider();

        // Funções de Autenticação
        const handleLogin = async (provider) => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Erro no login:", error);
                alert(`Erro ao fazer login: ${error.message}`);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                alert("Você foi desconectado.");
            } catch (error) {
                console.error("Erro no logout:", error);
                alert(`Erro ao fazer logout: ${error.message}`);
            }
        };

        // Função para carregar o conteúdo da página no iframe
        function loadPage(src, requiresAuth) {
            if (isCurrentUserBanned && src !== 'recepcao.html' && src !== 'POLÍTICAS GERAIS DO WIKI ZONE ZERO MOD.pdf') {
                contentFrame.style.display = 'none';
                accessDeniedMessage.style.display = 'none';
                bannedMessage.style.display = 'block';
                return;
            }

            if (requiresAuth && !currentUser) {
                contentFrame.style.display = 'none';
                accessDeniedMessage.style.display = 'block';
                bannedMessage.style.display = 'none';
            } else {
                contentFrame.src = src;
                contentFrame.style.display = 'block';
                accessDeniedMessage.style.display = 'none';
                bannedMessage.style.display = 'none';
            }
        }

        // Função para habilitar/desabilitar links de navegação
        function setNavLinksEnabled(enabled) {
            const navLinks = document.querySelectorAll('.mdl-navigation__link');
            navLinks.forEach(link => {
                const requiresAuth = link.getAttribute('data-requires-auth') === 'true';
                const isRulesLink = link.getAttribute('onclick') && link.getAttribute('onclick').includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf');
                const isHomePage = link.getAttribute('data-page-src') === 'recepcao.html';

                if (isHomePage || isRulesLink || (requiresAuth && enabled) || (!requiresAuth && enabled)) {
                    link.style.pointerEvents = 'auto';
                    link.style.color = '#424242'; // Cor padrão
                    link.classList.remove('disabled');
                } else {
                    link.style.pointerEvents = 'none';
                    link.style.color = '#9e9e9e'; // Cor para desabilitado
                    link.classList.add('disabled');
                }
            });
        }

        // Funções para gerenciar o popup de notícias
        function showNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'flex';
                loadNewsForPopup(); // Garante que as notícias sejam carregadas ao abrir o popup
            }
        }

        function hideNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'none';
                newsPopupContent.innerHTML = ''; // Limpa o conteúdo quando o popup é escondido
            }
        }

        async function loadNewsForPopup() {
            newsPopupContent.innerHTML = 'Carregando últimas notícias...'; // Garante que esta mensagem seja exibida apenas uma vez
            try {
                const newsSnapshot = await firestore.collection('news').orderBy('timestamp', 'desc').get();
                const readNewsDoc = currentUser ? await getDoc(doc(firestore, 'users', currentUser.uid, 'readNews', 'status')) : null;
                const readNews = readNewsDoc && readNewsDoc.exists() ? readNewsDoc.data().read : [];

                newsPopupContent.innerHTML = ''; // Limpa a mensagem de carregamento
                newsSnapshot.forEach(doc => {
                    const news = doc.data();
                    const newsId = doc.id;
                    const isRead = readNews.includes(newsId);

                    const newsItemDiv = document.createElement('div');
                    newsItemDiv.classList.add('news-item');
                    if (isRead) {
                        newsItemDiv.classList.add('read');
                    }
                    newsItemDiv.innerHTML = `
                        <h3>${news.title}</h3>
                        <p>${news.content}</p>
                        <small>${news.timestamp ? new Date(news.timestamp.toDate()).toLocaleString() : 'Data desconhecida'}</small>
                    `;
                    newsItemDiv.addEventListener('click', async () => {
                        if (currentUser && !isRead) {
                            await updateDoc(doc(firestore, 'users', currentUser.uid, 'readNews', 'status'), {
                                read: [...readNews, newsId]
                            }, { merge: true });
                            newsItemDiv.classList.add('read'); // Marca como lida imediatamente na UI
                        }
                    });
                    newsPopupContent.appendChild(newsItemDiv);
                });
            } catch (error) {
                console.error("Erro ao carregar notícias:", error);
                newsPopupContent.innerHTML = '<p>Erro ao carregar notícias. Tente novamente mais tarde.</p>';
            }
        }

        async function updateNewsNotificationCount(userId) {
            if (!userId) {
                notificationBadge.style.display = 'none';
                notificationBadge.textContent = '0';
                return;
            }

            try {
                const newsSnapshot = await firestore.collection('news').get();
                const readNewsDoc = await getDoc(doc(firestore, 'users', userId, 'readNews', 'status'));
                const readNews = readNewsDoc.exists() ? readNewsDoc.data().read : [];

                const unreadCount = newsSnapshot.docs.filter(doc => !readNews.includes(doc.id)).length;

                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount.toString();
                    notificationBadge.style.display = 'block';
                } else {
                    notificationBadge.style.display = 'none';
                    notificationBadge.textContent = '0';
                }
            } catch (error) {
                console.error("Erro ao atualizar contador de notificações:", error);
                notificationBadge.style.display = 'none';
            }
        }

        // Funções para gerenciar o popup de aplicativos Google
        function showGoogleAppsPopup() {
            if (googleAppsPopup) {
                googleAppsPopup.style.display = 'flex';
            }
        }

        function hideGoogleAppsPopup() {
            if (googleAppsPopup) {
                googleAppsPopup.style.display = 'none';
            }
        }

        // Event Listeners
        loginGoogleButton.addEventListener('click', () => handleLogin(googleProvider));
        loginGitHubButton.addEventListener('click', () => handleLogin(githubProvider));
        logoutButton.addEventListener('click', handleLogout);

        newsButton.addEventListener('click', showNewsPopup);
        newsPopupCloseButton.addEventListener('click', hideNewsPopup);
        newsCenterPopup.addEventListener('click', (e) => {
            if (e.target === newsCenterPopup) {
                hideNewsPopup();
            }
        });

        googleAppsButton.addEventListener('click', showGoogleAppsPopup);
        googleAppsCloseButton.addEventListener('click', hideGoogleAppsPopup);
        googleAppsPopup.addEventListener('click', (e) => {
            if (e.target === googleAppsPopup) {
                hideGoogleAppsPopup();
            }
        });

        // Monitora o estado de autenticação
        onAuthStateChanged(auth, async (user) => {
            currentUser = user; // Atualiza a variável global
            let actualPageSrc = contentFrame.src; // Pega a página atual do iframe

            if (user) {
                userInfo.textContent = `Bem-vindo, ${user.displayName || user.email}!`;
                userInfoContainer.style.display = 'flex';
                loginGoogleButton.style.display = 'none';
                loginGitHubButton.style.display = 'none';
                logoutButton.style.display = 'inline-block';
                userProfilePic.style.display = 'inline-block';
                userProfilePic.src = user.photoURL || '';
                googleAppsButton.style.display = 'inline-block';
                newsButton.style.display = 'block';

                // Verifica status de banimento
                const userDocRef = doc(firestore, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    isCurrentUserBanned = userData.isBanned || false;
                    if (userData.customAppCss) {
                        customAppCssStyleTag.innerHTML = userData.customAppCss;
                    }
                } else {
                    // Cria o documento do usuário se não existir (primeiro login)
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        createdAt: serverTimestamp(),
                        isBanned: false,
                        customAppCss: ''
                    });
                    isCurrentUserBanned = false;
                }

                if (isCurrentUserBanned) {
                    console.warn(`Usuário ${user.uid} está banido.`);
                    bannedMessage.style.display = 'block';
                    setNavLinksEnabled(false); // Desabilita todos, exceto "Página Inicio" e "Regras"
                    loadPage('recepcao.html', false); // Redireciona para a página inicial
                    contentFrame.style.display = 'none'; // Oculta o iframe para exibir a mensagem de banimento
                    accessDeniedMessage.style.display = 'none'; // Garante que a mensagem de acesso negado esteja oculta
                } else {
                    bannedMessage.style.display = 'none';
                    setNavLinksEnabled(true); // Habilita todos os links
                    // Se o usuário não está banido e estava em uma página restrita, redireciona para a página original
                    // ou para 'recepcao.html' se a página atual for inacessível
                    if (actualPageSrc.includes('access-denied.html')) { // Se a página atual é a de acesso negado
                        loadPage('recepcao.html', false); // Redireciona para a página inicial
                    } else {
                        // Recarrega a página atual com as permissões corretas
                        const currentNavLink = document.querySelector(`.mdl-navigation__link[data-page-src="${actualPageSrc}"]`);
                        const requiresAuthCurrentPage = currentNavLink ? currentNavLink.getAttribute('data-requires-auth') === 'true' : false;
                        loadPage(actualPageSrc, requiresAuthCurrentPage);
                    }
                }

                // Inscrição em tempo real para notícias e status de leitura
                if (unsubscribeNewsListener) {
                    unsubscribeNewsListener(); // Desinscreve o ouvinte anterior
                }
                unsubscribeNewsListener = onSnapshot(query(collection(firestore, 'news'), orderBy('timestamp', 'desc')), snapshot => {
                    if (newsCenterPopup.style.display === 'flex') {
                        loadNewsForPopup(); // Recarrega notícias se o popup estiver aberto
                    }
                    updateNewsNotificationCount(user.uid); // Atualiza o badge
                }, error => console.error("Erro ao ouvir notícias:", error));

                if (unsubscribeReadNewsListener) {
                    unsubscribeReadNewsListener(); // Desinscreve o ouvinte anterior
                }
                unsubscribeReadNewsListener = onSnapshot(doc(firestore, 'users', user.uid, 'readNews', 'status'), () => {
                    updateNewsNotificationCount(user.uid); // Atualiza o contador de notificações
                    if (newsCenterPopup.style.display === 'flex') {
                        loadNewsForPopup(); // Recarrega notícias se o popup estiver aberto
                    }
                }, error => console.error("Erro ao ouvir status de leitura:", error));

                updateNewsNotificationCount(user.uid); // Carrega o contador inicial de notificações ao iniciar

            } else { // Usuário deslogado
                currentUser = null;
                userInfo.textContent = '';
                userInfoContainer.style.display = 'none';
                loginGoogleButton.style.display = 'inline-block';
                loginGitHubButton.style.display = 'inline-block';
                logoutButton.style.display = 'none';
                isCurrentUserBanned = false; // Garante que o status de banimento seja resetado
                bannedMessage.style.display = 'none';
                setNavLinksEnabled(false); // Desabilita todos, exceto "Página Inicio" e "Regras"
                loadPage('recepcao.html', false); // Redireciona para a página inicial
                userProfilePic.style.display = 'none';
                userProfilePic.src = '';
                googleAppsButton.style.display = 'none';
                googleAppsPopup.style.display = 'none'; // Esconde o popup de apps
                customAppCssStyleTag.innerHTML = ''; // Limpa CSS de app personalizado
                contentFrame.style.display = 'block'; // Garante que o iframe esteja visível na página inicial
                accessDeniedMessage.style.display = 'none'; // Garante que a mensagem de acesso negado esteja oculta
                newsButton.style.display = 'none';
                hideNewsPopup(); // Garante que o popup de notícias esteja oculto

                // Desinscreve os ouvintes quando o usuário desloga
                if (unsubscribeNewsListener) {
                    unsubscribeNewsListener();
                }
                if (unsubscribeReadNewsListener) {
                    unsubscribeReadNewsListener();
                }
                notificationBadge.style.display = 'none'; // Garante que o badge esteja oculto
                notificationBadge.textContent = '0';
            }
            // Garante que os componentes MDL sejam atualizados após as mudanças no DOM
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
        });

        // Event listener para links de navegação
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.mdl-navigation__link');
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    // Se o link tem um onclick, ele já está sendo tratado (ex: regras.pdf)
                    if (link.getAttribute('onclick')) {
                        return;
                    }

                    event.preventDefault(); // Impede o comportamento padrão do link

                    const actualPageSrc = link.getAttribute('data-page-src');
                    const requiresAuth = link.getAttribute('data-requires-auth') === 'true';

                    // Se o usuário está banido, apenas "Página Inicio" e "Regras" são permitidos
                    if (isCurrentUserBanned && actualPageSrc !== 'recepcao.html' && actualPageSrc !== 'POLÍTICAS GERAIS DO WIKI ZONE ZERO MOD.pdf') {
                        // O loadPage já vai lidar com a exibição da mensagem de banimento
                        loadPage(actualPageSrc, requiresAuth);
                        return;
                    }

                    // Se a página requer autenticação e o usuário não está logado
                    if (requiresAuth && !currentUser) {
                        loadPage(actualPageSrc, true); // Chame loadPage para mostrar a mensagem de acesso negado
                        return;
                    }

                    loadPage(actualPageSrc, requiresAuth); // Chama a função para carregar a página

                    // Fecha o drawer do MDL se estiver aberto
                    if (document.querySelector('.mdl-layout__drawer.is-visible')) {
                        document.querySelector('.mdl-layout__obfuscator').classList.remove('is-visible');
                        document.querySelector('.mdl-layout__drawer').classList.remove('is-visible');
                    }
                });
            });

            // Inicializa componentes MDL ao carregar o DOM pela primeira vez
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
        });
    </script>
</body>
</html>
