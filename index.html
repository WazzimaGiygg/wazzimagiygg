<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Inicial com Chat WZZM</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        header {
            background-color: #3f51b5;
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
        }

        p {
            line-height: 1.6;
            color: #555;
        }

        /* --- Estilos para o Botão do Chat e Notificação --- */
        #chat-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000; /* Garante que fique acima de outros conteúdos */
        }

        #open-chat-button {
            position: relative; /* Para o badge de notificação */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #3f51b5; /* Cor primária do chat */
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: background-color 0.3s ease;
        }

        #open-chat-button:hover {
            background-color: #303f9f;
        }

        #notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #f44336; /* Vermelho vibrante */
            color: white;
            border-radius: 50%;
            padding: 6px 9px;
            font-size: 14px;
            font-weight: bold;
            display: none; /* Escondido por padrão */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Estilos para o Popup do Chat (Container do Iframe) --- */
        #chat-popup-container {
            position: fixed;
            bottom: 90px; /* Acima do botão */
            right: 20px;
            width: 380px; /* Largura do popup do chat */
            height: 500px; /* Altura do popup do chat */
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden; /* Garante que o iframe fique dentro */
            z-index: 999; /* Abaixo do botão de chat, mas acima do conteúdo */
            display: none; /* Escondido por padrão */
            flex-direction: column; /* Para organizar o título e o iframe */
            background-color: white;
        }

        #chat-popup-header {
            background-color: #3f51b5;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
        }

        #chat-popup-header .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        #chat-iframe {
            width: 100%;
            flex-grow: 1; /* O iframe ocupa o espaço restante */
            border: none;
        }

        /* --- Estilos para o Modal de Notificação de Nova Mensagem --- */
        #new-message-modal {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 1002; /* Acima de tudo */
            width: 350px;
            max-width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        #new-message-modal h3 {
            margin-top: 0;
            color: #3f51b5;
            font-size: 20px;
        }

        #new-message-modal p {
            margin: 15px 0;
            color: #666;
            font-size: 15px;
        }

        #modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px; /* Espaço entre os botões */
            margin-top: 20px;
        }

        #modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #modal-buttons #reply-message-btn {
            background-color: #4caf50; /* Verde */
            color: white;
        }
        #modal-buttons #reply-message-btn:hover {
            background-color: #43a047;
        }

        #modal-buttons #close-modal-btn {
            background-color: #9e9e9e; /* Cinza */
            color: white;
        }
        #modal-buttons #close-modal-btn:hover {
            background-color: #757575;
        }

        /* Opcional: Estilo para o backdrop do modal */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
        }
    </style>
</head>
<body>
    <header>
        <h1>Bem-vindo à Página Inicial WZZM</h1>
        <div id="userUid" data-uid="USUARIO_ID_EXEMPLO_12345" style="display: none;"></div>
    </header>

    <main>
        <p>Este é o conteúdo principal da sua página. O chat estará disponível no canto inferior direito.</p>
        <p>Você pode navegar e usar outras funcionalidades do site enquanto o chat se mantém atualizado em segundo plano.</p>
    </main>

    <div id="chat-button-container">
        <button id="open-chat-button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
            <i class="material-icons">message</i>
            <span id="notification-badge" class="notification-badge">0</span>
        </button>
    </div>

    <div id="chat-popup-container">
        <div id="chat-popup-header">
            <span>WZZM Chat</span>
            <button class="close-button" id="close-chat-popup-button">&times;</button>
        </div>
        <iframe id="chat-iframe" src="chat.html?uid=PLACEHOLDER_UID"></iframe>
    </div>

    <div id="new-message-modal">
        <h3>Nova Mensagem!</h3>
        <p>De: <strong id="modal-sender-name"></strong></p>
        <p id="modal-message-snippet"></p>
        <div id="modal-buttons">
            <button id="reply-message-btn">Responder</button>
            <button id="close-modal-btn">Fechar</button>
        </div>
    </div>
    <div class="modal-backdrop" id="modal-backdrop"></div>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script>
        // index.js (JavaScript para a página principal)
        document.addEventListener('DOMContentLoaded', () => {
            const openChatButton = document.getElementById('open-chat-button');
            const notificationBadge = document.getElementById('notification-badge');
            const chatPopupContainer = document.getElementById('chat-popup-container');
            const closeChatPopupButton = document.getElementById('close-chat-popup-button');
            const chatIframe = document.getElementById('chat-iframe');
            const userUidElement = document.getElementById('userUid'); // Onde seu UID está

            const newMessageModal = document.getElementById('new-message-modal');
            const modalSenderName = document.getElementById('modal-sender-name');
            const modalMessageSnippet = document.getElementById('modal-message-snippet');
            const replyMessageBtn = document.getElementById('reply-message-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalBackdrop = document.getElementById('modal-backdrop');

            let unreadMessageCount = 0;
            let lastMessageSender = ''; // Para armazenar o remetente da última notificação

            // --- Carrega o UID do usuário e passa para o iframe ---
            const userUid = userUidElement.dataset.uid;
            // IMPORTANTE: O UID DEVE SER OBTIDO DO SEU SISTEMA DE AUTENTICAÇÃO REAL (ex: Firebase Auth).
            // Se o UID estiver vazio (PLACEHOLDER_UID), o chat não funcionará corretamente.
            // Exemplo de como obter o UID do Firebase Auth (se você estiver usando):
            /*
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    chatIframe.src = `chat.html?uid=${user.uid}`;
                    console.log("UID do usuário carregado no iframe:", user.uid);
                    userUidElement.dataset.uid = user.uid; // Atualiza o elemento invisível também
                } else {
                    console.warn("Nenhum usuário logado. Chat não inicializado no iframe.");
                    // Você pode redirecionar para login ou mostrar uma mensagem
                }
            });
            */
            // Por enquanto, usaremos o UID do elemento invisível para demonstração.
            chatIframe.src = `chat.html?uid=${userUid}`;


            // --- Funções de Notificação ---
            function updateNotificationBadge() {
                if (unreadMessageCount > 0) {
                    notificationBadge.textContent = unreadMessageCount;
                    notificationBadge.style.display = 'inline-block';
                } else {
                    notificationBadge.textContent = '0';
                    notificationBadge.style.display = 'none';
                }
            }

            function showNewMessageModal(sender, snippet) {
                modalSenderName.textContent = sender;
                modalMessageSnippet.textContent = snippet;
                newMessageModal.style.display = 'block';
                modalBackdrop.style.display = 'block';
                lastMessageSender = sender; // Guarda o remetente para a ação de responder
            }

            function hideNewMessageModal() {
                newMessageModal.style.display = 'none';
                modalBackdrop.style.display = 'none';
            }

            // --- Lógica de Comunicação entre Iframe e Pai ---
            // Ouve mensagens vindas do iframe (chat.html)
            window.addEventListener('message', (event) => {
                // MUITO IMPORTANTE: Em produção, verifique a origem do evento para segurança!
                // if (event.origin !== 'https://seudominio.com.br') { return; } // Substitua pelo seu domínio

                const messageData = event.data;

                // Quando o chat envia uma nova mensagem recebida (pode ser de terceiros ou sua)
                if (messageData.type === 'chatNewMessage' && messageData.senderId && messageData.text) {
                    // Se o chat NÃO ESTÁ VISÍVEL ou o usuário NÃO ESTÁ NA ABA ATIVA
                    // E se a mensagem não é do próprio usuário logado (para não notificar a si mesmo)
                    if (messageData.senderId !== userUidElement.dataset.uid && (chatPopupContainer.style.display === 'none' || document.hidden)) {
                        unreadMessageCount++;
                        updateNotificationBadge();
                        showNewMessageModal(messageData.senderName, messageData.text);
                    } else if (messageData.senderId !== userUidElement.dataset.uid) {
                        // Se o chat está aberto e visível, e a mensagem é de outro usuário,
                        // ainda assim, zere o badge se o usuário estiver focado no chat.
                        // A ideia é que o "chatOpenedAndRead" no foco do iframe já zere.
                        // Esta condição é mais uma redundância ou para casos específicos.
                        // O importante é que a notificação visual do modal não apareça se o chat já está aberto.
                        unreadMessageCount = 0; // Zera se o chat está aberto e a mensagem foi lida visualmente
                        updateNotificationBadge();
                    }
                }
                // Quando o chat sinaliza que o usuário leu/abriu, zera as notificações
                else if (messageData.type === 'chatOpenedAndRead') {
                    unreadMessageCount = 0;
                    updateNotificationBadge();
                    hideNewMessageModal(); // Garante que o modal esteja escondido
                }
            });

            // --- Event Listeners do Botão e Popup do Chat ---
            openChatButton.addEventListener('click', () => {
                chatPopupContainer.style.display = 'flex'; // Mostra o popup
                unreadMessageCount = 0; // Zera as notificações ao abrir o chat
                updateNotificationBadge();
                hideNewMessageModal(); // Esconde o modal de notificação

                // Envia mensagem para o iframe para que ele saiba que foi aberto
                chatIframe.contentWindow.postMessage({ type: 'parentChatOpened' }, '*'); // * em dev, domínio real em prod
                // Opcional: Foca no iframe para interação imediata
                chatIframe.contentWindow.focus();
            });

            closeChatPopupButton.addEventListener('click', () => {
                chatPopupContainer.style.display = 'none'; // Esconde o popup
                // Você pode querer enviar uma mensagem para o iframe que ele foi fechado se precisar.
                chatIframe.contentWindow.postMessage({ type: 'parentChatClosed' }, '*'); // * em dev, domínio real em prod
            });

            // --- Event Listeners do Modal de Notificação ---
            replyMessageBtn.addEventListener('click', () => {
                hideNewMessageModal(); // Esconde o modal
                chatPopupContainer.style.display = 'flex'; // Abre o chat
                unreadMessageCount = 0; // Zera notificações
                updateNotificationBadge();

                // Envia uma mensagem para o iframe para que ele possa selecionar a conversa do remetente
                chatIframe.contentWindow.postMessage({
                    type: 'replyToSender',
                    senderName: lastMessageSender // O nome do remetente da última mensagem notificada
                }, '*'); // * em dev, domínio real em prod
                chatIframe.contentWindow.focus(); // Foca no iframe
            });

            closeModalBtn.addEventListener('click', () => {
                hideNewMessageModal();
                // As notificações permanecem no badge até o chat ser realmente aberto
            });

            modalBackdrop.addEventListener('click', () => {
                hideNewMessageModal();
            });

            // Inicializa o badge no carregamento
            updateNotificationBadge();
        });
    </script>
</body>
</html>
