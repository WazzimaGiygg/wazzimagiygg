<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Dados para Firebase</title>
    <style>
        /* ... (mantenha todos os estilos anteriores) ... */
        
        .uid-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        
        .uid-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
        
        .auto-uid {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>üìÑ Gerador de Dados Pessoais - Firebase</h1>
            <p>Cada usu√°rio gerencia apenas seu pr√≥prio documento na cole√ß√£o "gespai"</p>
        </div>
        
        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div class="auth-section" id="authSection">
            <h3>üîê Autentica√ß√£o Obrigat√≥ria</h3>
            <div id="authStatus" class="auth-status"></div>
            
            <div id="loginForm" style="display: none;">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" class="form-control" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" class="form-control" placeholder="Sua senha">
                </div>
                <div class="auth-buttons">
                    <button class="btn btn-primary" onclick="login()">Entrar</button>
                    <button class="btn btn-secondary" onclick="signup()">Cadastrar</button>
                    <button class="btn" onclick="loginAnonymously()" style="background: #666; color: white;">
                        Acesso An√¥nimo
                    </button>
                </div>
            </div>
            
            <div id="userInfo" style="display: none;">
                <div class="uid-section">
                    <p><strong>Seu ID de usu√°rio (UID):</strong></p>
                    <div class="uid-info" id="userUid"></div>
                    <p class="auto-uid">Este ser√° automaticamente o nome do seu documento na cole√ß√£o "gespai"</p>
                </div>
                <p>Logado como: <strong id="userEmail"></strong></p>
                <button class="btn btn-danger" onclick="logout()">Sair</button>
            </div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-button active" onclick="switchMode('editor')">‚úèÔ∏è Meu Editor</button>
            <button class="mode-button" onclick="switchMode('viewer')">üëÅÔ∏è Meus Dados</button>
        </div>
        
        <!-- MODO EDITOR -->
        <div id="editorMode" class="mode-content active">
            <div class="uid-section">
                <h4>üìã Informa√ß√µes do Documento</h4>
                <p><strong>Documento atual:</strong> <span id="currentDocId">N√£o autenticado</span></p>
                <p class="auto-uid">O documento ser√° salvo automaticamente com seu UID como nome</p>
            </div>
            
            <div class="password-section">
                <h3>üîê Criptografia (Opcional)</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="encryptData" onchange="toggleEncryption()">
                    <label for="encryptData">Criptografar conte√∫do das abas</label>
                </div>
                
                <div id="encryptionFields" style="display: none;">
                    <div class="form-group">
                        <label for="encryptionKey">Chave de Criptografia:</label>
                        <input type="password" id="encryptionKey" class="form-control" 
                               placeholder="Digite uma senha para criptografar">
                        <small style="color: #666;">Esta senha ser√° necess√°ria para visualizar seus dados</small>
                    </div>
                </div>
            </div>
            
            <div class="tab-manager">
                <h3>üìë Minhas P√°ginas</h3>
                <p>Adicione p√°ginas que ser√£o salvas no seu documento pessoal</p>
                
                <div id="tabList" class="tab-list">
                    <!-- Tabs ser√£o adicionadas aqui -->
                </div>
                
                <div class="add-tab-form">
                    <input type="text" id="newTabName" class="form-control" 
                           placeholder="Nome da p√°gina (ex: home, perfil, config)">
                    <button type="button" class="btn btn-primary" onclick="addNewTab()">+ Adicionar P√°gina</button>
                </div>
            </div>
            
            <div class="editor-container" id="editorContainer">
                <!-- Editor ser√° criado dinamicamente -->
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="saveMyDocument()">
                    üíæ Salvar Meu Documento
                </button>
                <button type="button" class="btn btn-secondary" onclick="loadMyDocument()">
                    üìÇ Carregar Meu Documento
                </button>
                <button type="button" class="btn" onclick="addSampleData()" style="background: #9c27b0; color: white;">
                    ‚ú® Dados de Exemplo
                </button>
                <button type="button" class="btn btn-danger" onclick="clearMyDocument()">
                    üóëÔ∏è Limpar Localmente
                </button>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <!-- MODO VISUALIZADOR -->
        <div id="viewerMode" class="mode-content">
            <div class="uid-section">
                <h4>üë§ Visualizando Seus Dados</h4>
                <p>Voc√™ est√° visualizando seu pr√≥prio documento</p>
                <p><strong>Documento ID:</strong> <span id="viewerDocIdDisplay">-</span></p>
            </div>
            
            <div class="form-group">
                <label for="viewerPassword">Senha de criptografia (se usou):</label>
                <input type="password" id="viewerPassword" class="form-control" 
                       placeholder="Digite a senha que usou para criptografar">
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="loadForViewing()">
                    üîÑ Atualizar Visualiza√ß√£o
                </button>
            </div>
            
            <div id="viewerStatus" class="status-message"></div>
            
            <div id="viewerContent" class="viewer-container" style="display: none;">
                <div class="tabs" id="viewerTabs"></div>
                <div id="viewerIframesContainer"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Estado da aplica√ß√£o
        let tabs = [];
        let activeEditorTab = null;
        let currentUser = null;

        // Observador de estado de autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI();
            
            if (user) {
                console.log('Usu√°rio autenticado. UID:', user.uid);
                showStatus(`‚úÖ Ol√° ${user.email || 'Usu√°rio An√¥nimo'}!`, 'success');
                
                // Atualizar displays de UID
                document.getElementById('currentDocId').textContent = user.uid;
                document.getElementById('viewerDocIdDisplay').textContent = user.uid;
                document.getElementById('userUid').textContent = user.uid;
                
                // Carregar automaticamente o documento do usu√°rio
                setTimeout(() => loadMyDocument(), 1000);
                
            } else {
                console.log('Usu√°rio n√£o autenticado');
                showStatus('üîê Fa√ßa login para acessar seus dados', 'info');
                document.getElementById('currentDocId').textContent = 'N√£o autenticado';
            }
        });

        // Atualizar interface de autentica√ß√£o
        function updateAuthUI() {
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const authStatus = document.getElementById('authStatus');
            
            if (currentUser) {
                // Usu√°rio logado
                loginForm.style.display = 'none';
                userInfo.style.display = 'block';
                document.getElementById('userEmail').textContent = 
                    currentUser.email || 'Usu√°rio An√¥nimo';
                authStatus.textContent = '‚úÖ Autenticado';
                authStatus.className = 'auth-status authenticated';
                authStatus.style.display = 'block';
                
                // Habilitar bot√µes de a√ß√£o
                document.querySelectorAll('.action-buttons button').forEach(btn => {
                    btn.disabled = false;
                });
                
            } else {
                // Usu√°rio n√£o logado
                loginForm.style.display = 'block';
                userInfo.style.display = 'none';
                authStatus.textContent = '‚ö†Ô∏è N√£o autenticado';
                authStatus.className = 'auth-status not-authenticated';
                authStatus.style.display = 'block';
                
                // Desabilitar bot√µes de a√ß√£o
                document.querySelectorAll('.action-buttons button').forEach(btn => {
                    if (!btn.onclick || btn.onclick.toString().includes('login')) {
                        return;
                    }
                    btn.disabled = true;
                });
            }
        }

        // Fun√ß√µes de autentica√ß√£o
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showStatus('‚úÖ Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no login:', error);
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showStatus('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showStatus('‚úÖ Cadastro realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function loginAnonymously() {
            try {
                await auth.signInAnonymously();
                showStatus('‚úÖ Acesso an√¥nimo ativado', 'success');
            } catch (error) {
                console.error('Erro no acesso an√¥nimo:', error);
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                await auth.signOut();
                tabs = [];
                renderTabList();
                renderEditor();
                showStatus('‚úÖ Logout realizado.', 'info');
            } catch (error) {
                console.error('Erro no logout:', error);
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // ========== FUN√á√ïES PRINCIPAIS ==========

        // Salvar o documento do usu√°rio atual
        async function saveMyDocument() {
            if (!currentUser) {
                showStatus('‚ùå Voc√™ precisa estar autenticado para salvar.', 'error');
                return;
            }
            
            if (tabs.length === 0) {
                showStatus('Adicione pelo menos uma p√°gina antes de salvar.', 'error');
                return;
            }
            
            try {
                // Preparar dados
                const data = {};
                const encryptData = document.getElementById('encryptData').checked;
                const encryptionKey = document.getElementById('encryptionKey').value;
                
                for (const tab of tabs) {
                    if (encryptData && encryptionKey) {
                        const encrypted = CryptoJS.AES.encrypt(tab.content, encryptionKey).toString();
                        data[tab.name] = encrypted;
                    } else {
                        data[tab.name] = tab.content;
                    }
                }
                
                // Adicionar metadados
                data._metadata = {
                    userEmail: currentUser.email || 'anonymous',
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    tabsCount: tabs.length,
                    tabNames: tabs.map(t => t.name),
                    encrypted: encryptData,
                    version: '1.0'
                };
                
                // Salvar usando o UID como ID do documento
                const docId = currentUser.uid;
                await db.collection('gespai').doc(docId).set(data, { merge: true });
                
                showStatus(`‚úÖ Seu documento foi salvo com sucesso! (ID: ${docId})`, 'success');
                
                console.log('Documento salvo com sucesso:', {
                    collection: 'gespai',
                    documentId: docId,
                    tabs: tabs.length,
                    encrypted: encryptData
                });
                
            } catch (error) {
                console.error('Erro detalhado ao salvar:', error);
                
                if (error.code === 'permission-denied') {
                    showStatus('‚ùå Permiss√£o negada. Verifique se est√° autenticado corretamente.', 'error');
                    console.log('Dica: O UID do usu√°rio deve ser igual ao ID do documento');
                } else {
                    showStatus(`‚ùå Erro ao salvar: ${error.message}`, 'error');
                }
            }
        }

        // Carregar o documento do usu√°rio atual
        async function loadMyDocument() {
            if (!currentUser) {
                showStatus('‚ùå Voc√™ precisa estar autenticado para carregar.', 'error');
                return;
            }
            
            try {
                showStatus('Carregando seu documento...', 'info');
                
                const docId = currentUser.uid;
                const docRef = db.collection('gespai').doc(docId);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    showStatus('üìù Voc√™ ainda n√£o tem um documento. Crie suas p√°ginas e salve!', 'info');
                    // Adiciona uma p√°gina padr√£o se n√£o houver documento
                    if (tabs.length === 0) {
                        addTab('home', '<h1>Minha P√°gina Inicial</h1>\n<p>Bem-vindo ao seu espa√ßo pessoal!</p>');
                    }
                    return;
                }
                
                const data = doc.data();
                
                // Limpar abas atuais
                tabs = [];
                
                // Processar dados (ignorar metadados)
                for (const key in data) {
                    if (key !== '_metadata') {
                        tabs.push({ name: key, content: data[key] });
                    }
                }
                
                // Atualizar interface
                renderTabList();
                renderEditor();
                
                // Mostrar metadados
                if (data._metadata) {
                    const meta = data._metadata;
                    const msg = `‚úÖ Documento carregado (${meta.tabsCount || 0} p√°ginas, ` +
                               `√∫ltima atualiza√ß√£o: ${new Date().toLocaleTimeString()})`;
                    showStatus(msg, 'success');
                } else {
                    showStatus(`‚úÖ Seu documento foi carregado (${tabs.length} p√°ginas)`, 'success');
                }
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                showStatus(`‚ùå Erro ao carregar: ${error.message}`, 'error');
            }
        }

        // Carregar para visualiza√ß√£o
        async function loadForViewing() {
            if (!currentUser) {
                showViewerStatus('‚ùå Voc√™ precisa estar autenticado para visualizar.', 'error');
                return;
            }
            
            try {
                showViewerStatus('Carregando...', 'info');
                
                const docId = currentUser.uid;
                const password = document.getElementById('viewerPassword').value;
                const docRef = db.collection('gespai').doc(docId);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    showViewerStatus('Voc√™ ainda n√£o tem um documento salvo.', 'info');
                    return;
                }
                
                const data = doc.data();
                
                // Limpar visualiza√ß√£o anterior
                document.getElementById('viewerTabs').innerHTML = '';
                document.getElementById('viewerIframesContainer').innerHTML = '';
                
                // Processar cada campo
                let hasContent = false;
                
                for (const key in data) {
                    if (key !== '_metadata') {
                        let content = data[key];
                        
                        // Tentar descriptografar
                        if (password && typeof content === 'string') {
                            try {
                                const bytes = CryptoJS.AES.decrypt(content, password);
                                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                                if (decrypted) {
                                    content = decrypted;
                                }
                            } catch (e) {
                                // Continua com conte√∫do original
                            }
                        }
                        
                        addViewerTab(content, key);
                        hasContent = true;
                    }
                }
                
                if (hasContent) {
                    document.getElementById('viewerContent').style.display = 'block';
                    showViewerStatus(`‚úÖ Documento carregado com sucesso!`, 'success');
                } else {
                    showViewerStatus('Nenhum conte√∫do encontrado.', 'info');
                }
                
            } catch (error) {
                console.error('Erro ao carregar para visualiza√ß√£o:', error);
                showViewerStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // ========== FUN√á√ïES AUXILIARES ==========

        // Adicionar dados de exemplo
        function addSampleData() {
            if (!currentUser) {
                showStatus('Autentique-se primeiro para usar exemplos.', 'error');
                return;
            }
            
            tabs = [];
            
            addTab('home', `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
                        h1 { color: #4285F4; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üè† Minha P√°gina Inicial</h1>
                        <p>Bem-vindo(a) ao seu espa√ßo pessoal!</p>
                        <p>Este √© um exemplo de p√°gina que voc√™ pode personalizar.</p>
                        <ul>
                            <li>Edite este conte√∫do como quiser</li>
                            <li>Adicione suas pr√≥prias p√°ginas</li>
                            <li>Use HTML, CSS e JavaScript</li>
                        </ul>
                    </div>
                </body>
                </html>
            `);
            
            addTab('perfil', `
                <div style="padding: 20px; font-family: Arial;">
                    <h1>üë§ Meu Perfil</h1>
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                        <p><strong>Usu√°rio:</strong> ${currentUser.email || 'An√¥nimo'}</p>
                        <p><strong>UID:</strong> ${currentUser.uid}</p>
                        <p><strong>Documento salvo em:</strong> gespai/${currentUser.uid}</p>
                    </div>
                </div>
            `);
            
            addTab('config', `
                <div style="padding: 20px;">
                    <h1>‚öôÔ∏è Configura√ß√µes</h1>
                    <p>P√°gina de configura√ß√µes pessoais.</p>
                    <p>Voc√™ pode adicionar prefer√™ncias, temas, ou qualquer configura√ß√£o que desejar.</p>
                </div>
            `);
            
            showStatus('‚ú® Dados de exemplo adicionados! Edite e salve.', 'success');
        }

        // Limpar documento localmente
        function clearMyDocument() {
            if (confirm('Tem certeza que deseja limpar todas as p√°ginas localmente?')) {
                tabs = [];
                document.getElementById('encryptData').checked = false;
                document.getElementById('encryptionKey').value = '';
                toggleEncryption();
                renderTabList();
                renderEditor();
                showStatus('‚úÖ Todas as p√°ginas foram removidas localmente.', 'success');
            }
        }

        // ... (mantenha as outras fun√ß√µes auxiliares: addTab, removeTab, renderTabList, 
        // renderEditor, setActiveEditorTab, updateTabContent, etc. do c√≥digo anterior) ...

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Tentar login autom√°tico se j√° estiver logado
            if (auth.currentUser) {
                console.log('Usu√°rio j√° logado:', auth.currentUser.uid);
            }
            
            // Adicionar p√°gina inicial padr√£o se n√£o houver autentica√ß√£o
            if (!auth.currentUser && tabs.length === 0) {
                addTab('home', '<h1>üîê Fa√ßa login para come√ßar</h1><p>Autentique-se para acessar seu espa√ßo pessoal.</p>');
            }
        });

        // ========== FUN√á√ïES DE INTERFACE (mantidas do anterior) ==========
        // (Manter todas as fun√ß√µes: switchMode, toggleEncryption, addNewTab, addTab, 
        // removeTab, renderTabList, renderEditor, setActiveEditorTab, updateTabContent,
        // showStatus, showViewerStatus, addViewerTab, setActiveViewerTab, etc.)
    </script>
</body>
</html>
