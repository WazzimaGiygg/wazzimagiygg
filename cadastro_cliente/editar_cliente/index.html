<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Cadastro - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Use uma CDN alternativa para o Material Design -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.indigo-pink.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #3f51b5, #303f9f);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            color: #3f51b5;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3f51b5;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            position: relative;
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3f51b5;
            background: white;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1);
        }
        
        .form-group .error {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .form-group.required label::after {
            content: ' *';
            color: #f44336;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-group input {
            width: 18px;
            height: 18px;
        }
        
        .checkbox-group label {
            margin: 0;
            font-size: 14px;
            color: #555;
        }
        
        .checkbox-group a {
            color: #3f51b5;
            text-decoration: none;
        }
        
        .checkbox-group a:hover {
            text-decoration: underline;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 180px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3f51b5, #303f9f);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #303f9f, #283593);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(63, 81, 181, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #3f51b5;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3f51b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #e8f5e9;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c8e6c9;
        }
        
        .user-status .icon {
            font-size: 24px;
        }
        
        .user-status .text {
            flex: 1;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-radius: 3px;
            transition: width 0.5s;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Estilos espec√≠ficos para campos */
        .phone-input {
            display: flex;
            gap: 10px;
        }

        .phone-input select {
            flex: 0 0 100px;
            padding: 12px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .phone-input select:focus {
            outline: none;
            border-color: #3f51b5;
            background: white;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1);
        }

        .phone-input input {
            flex: 1;
        }
        
        .field-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .character-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .character-count.near-limit {
            color: #ff9800;
        }
        
        .character-count.over-limit {
            color: #f44336;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="header">
            <h1><i class="material-icons">edit</i> Editar Cadastro</h1>
            <p>Atualize suas informa√ß√µes pessoais para manter seu cadastro sempre atualizado</p>
        </div>
        
        <!-- Conte√∫do -->
        <div class="content">
            <!-- Mensagens -->
            <div id="message" class="message"></div>
            
            <!-- Status do Usu√°rio -->
            <div class="user-status" id="userStatus">
                <div class="icon">üë§</div>
                <div class="text">
                    <strong id="statusUserName">Carregando informa√ß√µes...</strong>
                    <div id="statusUserEmail"></div>
                </div>
            </div>
            
            <!-- Barra de Progresso do Cadastro -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-text">
                    <span id="progressText">Completando cadastro...</span>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Formul√°rio -->
            <form id="editClientForm">
                <!-- Se√ß√£o 1: Informa√ß√µes Pessoais -->
                <div class="form-section">
                    <div class="section-title"><i class="material-icons">person</i> Informa√ß√µes Pessoais</div>
                    
                    <div class="form-grid">
                        <div class="form-group required">
                            <label for="fullName">Nome Completo</label>
                            <input type="text" id="fullName" placeholder="Digite seu nome completo" required>
                            <div class="error" id="fullNameError"></div>
                        </div>
                        
                        <div class="form-group required">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14" required>
                            <div class="error" id="cpfError"></div>
                            <div class="field-hint">Apenas n√∫meros, ser√° formatado automaticamente</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rg">RG</label>
                            <input type="text" id="rg" placeholder="Digite seu RG">
                        </div>
                        
                        <div class="form-group">
                            <label for="socialName">Nome Social (opcional)</label>
                            <input type="text" id="socialName" placeholder="Se voc√™ usa outro nome social">
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 2: Dados de Nascimento e G√™nero -->
                <div class="form-section">
                    <div class="section-title"><i class="material-icons">cake</i> Dados Pessoais</div>
                    
                    <div class="form-grid">
                        <div class="form-group required">
                            <label for="birthDate">Data de Nascimento</label>
                            <input type="date" id="birthDate" required>
                            <div class="error" id="birthDateError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="gender">G√™nero</label>
                            <select id="gender">
                                <option value="">Selecione...</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                                <option value="nao-binario">N√£o Bin√°rio</option>
                                <option value="outro">Outro</option>
                                <option value="prefiro-nao-dizer">Prefiro n√£o dizer</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 3: Endere√ßo -->
                <div class="form-section">
                    <div class="section-title"><i class="material-icons">home</i> Endere√ßo</div>
                    
                    <div class="form-group required">
                        <label for="address">Endere√ßo Completo</label>
                        <input type="text" id="address" placeholder="Rua, n√∫mero, bairro" required>
                        <div class="error" id="addressError"></div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group required">
                            <label for="zipCode">CEP</label>
                            <input type="text" id="zipCode" placeholder="00000-000" maxlength="9" required>
                            <div class="error" id="zipCodeError"></div>
                            <div class="field-hint">Digite o CEP para buscar automaticamente</div>
                        </div>
                        
                        <div class="form-group required">
                            <label for="city">Cidade</label>
                            <input type="text" id="city" placeholder="Nome da cidade" required>
                            <div class="error" id="cityError"></div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group required">
                            <label for="state">Estado</label>
                            <input type="text" id="state" placeholder="UF" maxlength="2" required>
                            <div class="error" id="stateError"></div>
                        </div>
                        
                        <div class="form-group required">
                            <label for="country">Pa√≠s</label>
                            <input type="text" id="country" value="Brasil" required>
                            <div class="error" id="countryError"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 4: Contato -->
                <div class="form-section">
                    <div class="section-title"><i class="material-icons">contact_phone</i> Contato</div>
                    
                    <div class="form-group required">
                        <label for="phoneNumber">Telefone</label>
                        <div class="phone-input">
                            <select id="phoneDDD" required>
                                <!-- Ser√° preenchido dinamicamente pelo JavaScript -->
                                <option value="">Carregando DDDs...</option>
                            </select>
                            <input type="tel" id="phoneNumber" placeholder="999999999" maxlength="9" required>
                        </div>
                        <div class="error" id="phoneError"></div>
                        <div class="field-hint">Digite apenas n√∫meros (8 ou 9 d√≠gitos)</div>
                    </div>
                    
                    <div class="form-group required">
                        <label for="emailAddress">E-mail de Contato</label>
                        <input type="email" id="emailAddress" placeholder="seu@email.com" required>
                        <div class="error" id="emailError"></div>
                        <div class="field-hint">Ser√° usado para contato importante</div>
                    </div>
                </div>
                
                <!-- Se√ß√£o 5: Termos -->
                <div class="form-section">
                    <div class="section-title"><i class="material-icons">gavel</i> Termos e Condi√ß√µes</div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms">
                            Concordo com os <a href="https://wazzimagiygg.com/pdf/?uid=Termos%20de%20Servi%C3%A7o.pdf" target="_blank">Termos de Servi√ßo</a> *
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="acceptPrivacy" required>
                        <label for="acceptPrivacy">
                            Concordo com a <a href="https://wazzimagiygg.com/pdf/?uid=Pol%C3%ADtica%20de%20Privacidade.pdf" target="_blank">Pol√≠tica de Privacidade</a> *
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="marketingEmails">
                        <label for="marketingEmails">
                            Aceito receber e-mails promocionais e novidades (opcional)
                        </label>
                    </div>
                </div>
                
                <!-- A√ß√µes do Formul√°rio -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        <i class="material-icons">arrow_back</i> Voltar
                    </button>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="material-icons">save</i> Salvar Cadastro
                    </button>
                </div>
            </form>
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Processando suas informa√ß√µes...</p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <!-- Script Principal -->
    <script>
        // ============================================
// CONFIGURA√á√ÉO DO FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
};

// Inicializar Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const firestore = firebase.firestore();
const auth = firebase.auth();

// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================
let currentUser = null;
let currentClientId = null;
let isExistingClient = false;
let clientData = null;

// ============================================
// ELEMENTOS DOM
// ============================================
const editClientForm = document.getElementById('editClientForm');
const loadingDiv = document.getElementById('loading');
const messageDiv = document.getElementById('message');
const submitBtn = document.getElementById('submitBtn');
const cancelBtn = document.getElementById('cancelBtn');
const userStatus = document.getElementById('userStatus');
const statusUserName = document.getElementById('statusUserName');
const statusUserEmail = document.getElementById('statusUserEmail');
const progressSection = document.getElementById('progressSection');
const progressText = document.getElementById('progressText');
const progressPercentage = document.getElementById('progressPercentage');
const progressFill = document.getElementById('progressFill');

// Campos do formul√°rio
const fullNameInput = document.getElementById('fullName');
const cpfInput = document.getElementById('cpf');
const rgInput = document.getElementById('rg');
const socialNameInput = document.getElementById('socialName');
const birthDateInput = document.getElementById('birthDate');
const genderSelect = document.getElementById('gender');
const addressInput = document.getElementById('address');
const zipCodeInput = document.getElementById('zipCode');
const cityInput = document.getElementById('city');
const stateInput = document.getElementById('state');
const countryInput = document.getElementById('country');
const phoneDDDSelect = document.getElementById('phoneDDD');
const phoneNumberInput = document.getElementById('phoneNumber');
const emailAddressInput = document.getElementById('emailAddress');
const acceptTermsCheck = document.getElementById('acceptTerms');
const acceptPrivacyCheck = document.getElementById('acceptPrivacy');
const marketingEmailsCheck = document.getElementById('marketingEmails');

// ============================================
// FUN√á√ïES DE UTILIDADE
// ============================================
function showMessage(text, type = 'info', duration = 5000) {
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';
    
    if (duration > 0) {
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, duration);
    }
}

function showLoading(show) {
    loadingDiv.style.display = show ? 'block' : 'none';
    editClientForm.style.display = show ? 'none' : 'block';
}

function updateProgress(percentage, text) {
    progressSection.style.display = 'block';
    progressFill.style.width = `${percentage}%`;
    progressPercentage.textContent = `${percentage}%`;
    progressText.textContent = text || 'Completando cadastro...';
}

function hideProgress() {
    progressSection.style.display = 'none';
}

function setDefaultBirthDate() {
    const today = new Date();
    const eighteenYearsAgo = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
    birthDateInput.value = eighteenYearsAgo.toISOString().split('T')[0];
}

// ============================================
// FORMATA√á√ÉO DE CAMPOS
// ============================================
function formatCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length > 11) cpf = cpf.substring(0, 11);
    
    if (cpf.length <= 11) {
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }
    
    return cpf;
}

function formatPhone(phone) {
    phone = phone.replace(/\D/g, '');
    if (phone.length > 11) phone = phone.substring(0, 11);
    
    if (phone.length === 11) {
        return phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (phone.length === 10) {
        return phone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    
    return phone;
}

function formatCEP(cep) {
    cep = cep.replace(/\D/g, '');
    if (cep.length > 8) cep = cep.substring(0, 8);
    
    if (cep.length === 8) {
        return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }
    
    return cep;
}

// ============================================
// VALIDA√á√ïES B√ÅSICAS
// ============================================
function validateCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    
    if (cpf.length !== 11) {
        return { valid: false, message: 'CPF deve conter 11 d√≠gitos' };
    }
    
    if (/^(\d)\1+$/.test(cpf)) {
        return { valid: false, message: 'CPF inv√°lido' };
    }
    
    return { valid: true };
}

function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        return { valid: false, message: 'E-mail inv√°lido' };
    }
    return { valid: true };
}

function validatePhone(ddd, phone) {
    if (!ddd || ddd === '') {
        return { valid: false, message: 'Selecione um DDD' };
    }
    
    const fullPhone = (ddd + phone).replace(/\D/g, '');
    
    if (fullPhone.length !== 10 && fullPhone.length !== 11) {
        return { valid: false, message: 'Telefone deve ter 10 ou 11 d√≠gitos (com DDD)' };
    }
    
    const numberWithoutDDD = phone.replace(/\D/g, '');
    if (numberWithoutDDD.length < 8 || numberWithoutDDD.length > 9) {
        return { valid: false, message: 'N√∫mero deve ter 8 ou 9 d√≠gitos' };
    }
    
    return { valid: true };
}

// ============================================
// VERIFICA√á√ÉO DE DUPLICIDADE (NOVO)
// ============================================
async function checkDuplicateFields() {
    const duplicates = [];
    
    // Verificar CPF
    const cpf = cpfInput.value.replace(/\D/g, '');
    if (cpf && cpf.length === 11) {
        const cpfQuery = await firestore.collection('clients')
            .where('cpf', '==', cpf)
            .get();
        
        if (!cpfQuery.empty) {
            const isSelf = cpfQuery.docs.some(doc => doc.id === currentClientId);
            if (!isSelf) {
                duplicates.push({
                    field: 'cpf',
                    message: 'CPF j√° cadastrado no sistema'
                });
            }
        }
    }
    
    // Verificar RG
    const rg = rgInput.value.trim();
    if (rg) {
        const rgQuery = await firestore.collection('clients')
            .where('rg', '==', rg)
            .get();
        
        if (!rgQuery.empty) {
            const isSelf = rgQuery.docs.some(doc => doc.id === currentClientId);
            if (!isSelf) {
                duplicates.push({
                    field: 'rg',
                    message: 'RG j√° cadastrado no sistema'
                });
            }
        }
    }
    
    // Verificar Nome Completo
    const fullName = fullNameInput.value.trim();
    if (fullName) {
        const nameQuery = await firestore.collection('clients')
            .where('fullName', '==', fullName)
            .get();
        
        if (!nameQuery.empty) {
            const isSelf = nameQuery.docs.some(doc => doc.id === currentClientId);
            if (!isSelf) {
                duplicates.push({
                    field: 'fullName',
                    message: 'Este nome completo j√° est√° cadastrado no sistema'
                });
            }
        }
    }
    
    // Verificar Nome Social
    const socialName = socialNameInput.value.trim();
    if (socialName) {
        const socialNameQuery = await firestore.collection('clients')
            .where('socialName', '==', socialName)
            .get();
        
        if (!socialNameQuery.empty) {
            const isSelf = socialNameQuery.docs.some(doc => doc.id === currentClientId);
            if (!isSelf) {
                duplicates.push({
                    field: 'socialName',
                    message: 'Este nome social j√° est√° cadastrado no sistema'
                });
            }
        }
    }
    
    return duplicates;
}

function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(`${fieldId}Error`);
    
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        field.style.borderColor = '#f44336';
        field.style.backgroundColor = '#ffebee';
    }
}

function clearFieldErrors() {
    const fields = ['fullName', 'cpf', 'rg', 'socialName'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(`${fieldId}Error`);
        
        if (errorDiv) {
            errorDiv.style.display = 'none';
            field.style.borderColor = '#e0e0e0';
            field.style.backgroundColor = '#f8f9fa';
        }
    });
}

// ============================================
// VALIDA√á√ÉO COMPLETA DO FORMUL√ÅRIO (ASS√çNCRONA)
// ============================================
async function validateForm() {
    const errors = [];
    clearFieldErrors();
    
    // Valida√ß√µes b√°sicas
    if (!fullNameInput.value.trim()) {
        errors.push({ field: 'fullName', message: 'Nome completo √© obrigat√≥rio' });
    }
    
    const cpfValidation = validateCPF(cpfInput.value);
    if (!cpfValidation.valid) {
        errors.push({ field: 'cpf', message: cpfValidation.message });
    }
    
    if (!birthDateInput.value) {
        errors.push({ field: 'birthDate', message: 'Data de nascimento √© obrigat√≥ria' });
    } else {
        const birthDate = new Date(birthDateInput.value);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear();
        if (age < 18) {
            errors.push({ field: 'birthDate', message: 'Voc√™ deve ter pelo menos 18 anos' });
        }
    }
    
    if (!addressInput.value.trim()) {
        errors.push({ field: 'address', message: 'Endere√ßo √© obrigat√≥rio' });
    }
    
    const cepNumbers = zipCodeInput.value.replace(/\D/g, '');
    if (cepNumbers.length !== 8) {
        errors.push({ field: 'zipCode', message: 'CEP deve ter 8 d√≠gitos' });
    }
    
    if (!cityInput.value.trim()) {
        errors.push({ field: 'city', message: 'Cidade √© obrigat√≥ria' });
    }
    
    if (!stateInput.value.trim() || stateInput.value.length !== 2) {
        errors.push({ field: 'state', message: 'Estado deve ter 2 letras' });
    }
    
    const phoneValidation = validatePhone(phoneDDDSelect.value, phoneNumberInput.value);
    if (!phoneValidation.valid) {
        errors.push({ field: 'phoneNumber', message: phoneValidation.message });
    }
    
    const emailValidation = validateEmail(emailAddressInput.value);
    if (!emailValidation.valid) {
        errors.push({ field: 'emailAddress', message: emailValidation.message });
    }
    
    if (!acceptTermsCheck.checked) {
        errors.push({ field: 'acceptTerms', message: 'Aceite dos Termos de Servi√ßo √© obrigat√≥rio' });
    }
    
    if (!acceptPrivacyCheck.checked) {
        errors.push({ field: 'acceptPrivacy', message: 'Aceite da Pol√≠tica de Privacidade √© obrigat√≥rio' });
    }
    
    // Verificar duplicidade se n√£o houver erros b√°sicos
    if (errors.length === 0) {
        try {
            updateProgress(10, 'Verificando duplicidade de dados...');
            const duplicates = await checkDuplicateFields();
            
            duplicates.forEach(dup => {
                errors.push({ field: dup.field, message: dup.message });
                showFieldError(dup.field, dup.message);
            });
            
            if (duplicates.length > 0) {
                showMessage('Existem dados j√° cadastrados no sistema. Verifique os campos destacados.', 'error', 5000);
            }
        } catch (error) {
            console.error('Erro ao verificar duplicidade:', error);
            showMessage('Erro ao verificar dados duplicados. Tente novamente.', 'error', 3000);
        }
    }
    
    return errors;
}

// ============================================
// FUN√á√ïES DE CARREGAMENTO DE DADOS
// ============================================
async function loadBrazilianDDDs() {
    try {
        const brazilianDDDs = [
            '11', '12', '13', '14', '15', '16', '17', '18', '19',
            '21', '22', '24', '27', '28',
            '31', '32', '33', '34', '35', '37', '38',
            '41', '42', '43', '44', '45', '46', '47', '48', '49',
            '51', '53', '54', '55',
            '61', '62', '63', '64', '65', '66', '67', '68', '69',
            '71', '73', '74', '75', '77', '79',
            '81', '82', '83', '84', '85', '86', '87', '88', '89',
            '91', '92', '93', '94', '95', '96', '97', '98', '99'
        ];
        
        const select = document.getElementById('phoneDDD');
        select.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'DDD';
        select.appendChild(defaultOption);
        
        brazilianDDDs.forEach(ddd => {
            const option = document.createElement('option');
            option.value = ddd;
            option.textContent = ddd;
            select.appendChild(option);
        });
        
        if (clientData && clientData.phoneDDD) {
            select.value = clientData.phoneDDD;
        } else {
            if (stateInput.value) {
                detectDDDByState(stateInput.value);
            }
        }
        
    } catch (error) {
        console.error('Erro ao carregar DDDs:', error);
    }
}

function detectDDDByState(state) {
    const stateDDDs = {
        'SP': ['11', '12', '13', '14', '15', '16', '17', '18', '19'],
        'RJ': ['21', '22', '24'],
        'ES': ['27', '28'],
        'MG': ['31', '32', '33', '34', '35', '37', '38'],
        'PR': ['41', '42', '43', '44', '45', '46'],
        'SC': ['47', '48', '49'],
        'RS': ['51', '53', '54', '55'],
        'DF': ['61'],
        'GO': ['61', '62', '64'],
        'MT': ['65', '66'],
        'MS': ['67'],
        'AC': ['68'],
        'RO': ['69'],
        'BA': ['71', '73', '74', '75', '77'],
        'SE': ['79'],
        'PE': ['81', '87'],
        'AL': ['82'],
        'PB': ['83'],
        'RN': ['84'],
        'CE': ['85', '88'],
        'PI': ['86', '89'],
        'MA': ['98', '99'],
        'PA': ['91', '93', '94'],
        'AP': ['96'],
        'AM': ['92', '97'],
        'RR': ['95'],
        'TO': ['63']
    };
    
    const select = document.getElementById('phoneDDD');
    const stateCode = state.toUpperCase();
    
    if (stateDDDs[stateCode] && stateDDDs[stateCode].length > 0) {
        if (!select.value || !stateDDDs[stateCode].includes(select.value)) {
            select.value = stateDDDs[stateCode][0];
        }
    }
}

async function loadClientData() {
    try {
        showLoading(true);
        
        const user = auth.currentUser;
        if (!user) {
            showMessage('Voc√™ precisa estar logado para editar o cadastro', 'error');
            setTimeout(() => {
                if (window.parent && window.parent.loadPage) {
                    window.parent.loadPage('index.html', true);
                } else {
                    window.location.href = 'https://wazzimagiygg.com';
                }
            }, 2000);
            return;
        }
        
        currentUser = user;
        currentClientId = user.uid;
        
        statusUserName.textContent = user.displayName || 'Usu√°rio';
        statusUserEmail.textContent = user.email;
        
        const clientDoc = await firestore.collection('clients').doc(currentClientId).get();
        
        if (clientDoc.exists) {
            isExistingClient = true;
            clientData = clientDoc.data();
            
            fullNameInput.value = clientData.fullName || '';
            cpfInput.value = clientData.cpf ? formatCPF(clientData.cpf) : '';
            rgInput.value = clientData.rg || '';
            socialNameInput.value = clientData.socialName || '';
            
            if (clientData.birthDate) {
                try {
                    if (clientData.birthDate.seconds) {
                        const date = new Date(clientData.birthDate.seconds * 1000);
                        if (!isNaN(date.getTime())) {
                            birthDateInput.value = date.toISOString().split('T')[0];
                        } else {
                            setDefaultBirthDate();
                        }
                    } else if (clientData.birthDate instanceof Date) {
                        if (!isNaN(clientData.birthDate.getTime())) {
                            birthDateInput.value = clientData.birthDate.toISOString().split('T')[0];
                        } else {
                            setDefaultBirthDate();
                        }
                    } else if (typeof clientData.birthDate === 'string') {
                        const date = new Date(clientData.birthDate);
                        if (!isNaN(date.getTime())) {
                            birthDateInput.value = date.toISOString().split('T')[0];
                        } else {
                            setDefaultBirthDate();
                        }
                    } else {
                        setDefaultBirthDate();
                    }
                } catch (error) {
                    console.error('Erro ao processar data de nascimento:', error);
                    setDefaultBirthDate();
                }
            } else {
                setDefaultBirthDate();
            }
            
            genderSelect.value = clientData.gender || '';
            addressInput.value = clientData.address || '';
            zipCodeInput.value = clientData.zipCode ? formatCEP(clientData.zipCode) : '';
            cityInput.value = clientData.city || '';
            stateInput.value = clientData.state || '';
            countryInput.value = clientData.country || 'Brasil';
            
            await loadBrazilianDDDs();
            
            const phoneSnapshot = await firestore.collection('clientPhones')
                .where('clientId', '==', currentClientId)
                .where('isPrimary', '==', true)
                .limit(1)
                .get();
            
            if (!phoneSnapshot.empty) {
                const phoneData = phoneSnapshot.docs[0].data();
                const phone = phoneData.phoneNumber || '';
                const phoneNumbers = phone.replace(/\D/g, '');
                
                if (phoneNumbers.length >= 2) {
                    const ddd = phoneNumbers.substring(0, 2);
                    const number = phoneNumbers.substring(2);
                    
                    setTimeout(() => {
                        if (phoneDDDSelect.querySelector(`option[value="${ddd}"]`)) {
                            phoneDDDSelect.value = ddd;
                        } else {
                            console.warn(`DDD ${ddd} n√£o encontrado na lista`);
                            phoneDDDSelect.value = '';
                        }
                    }, 100);
                    
                    phoneNumberInput.value = number;
                }
            }
            
            const emailSnapshot = await firestore.collection('clientEmails')
                .where('clientId', '==', currentClientId)
                .where('isPrimary', '==', true)
                .limit(1)
                .get();
            
            if (!emailSnapshot.empty) {
                const emailData = emailSnapshot.docs[0].data();
                emailAddressInput.value = emailData.emailAddress || user.email || '';
            } else {
                emailAddressInput.value = user.email || '';
            }
            
            acceptTermsCheck.checked = clientData.acceptedTerms || false;
            acceptPrivacyCheck.checked = clientData.acceptedPrivacyPolicy || false;
            marketingEmailsCheck.checked = clientData.marketingEmails || false;
            
            updateRegistrationProgress();
            
        } else {
            isExistingClient = false;
            
            fullNameInput.value = user.displayName || '';
            emailAddressInput.value = user.email || '';
            
            setDefaultBirthDate();
            
            await loadBrazilianDDDs();
            
            showMessage('Complete seu cadastro pela primeira vez', 'info');
        }
        
        showLoading(false);
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showMessage(`Erro ao carregar dados: ${error.message}`, 'error');
        showLoading(false);
    }
}

function formatPhoneNumberInput() {
    let value = phoneNumberInput.value.replace(/\D/g, '');
    
    if (value.length > 9) {
        value = value.substring(0, 9);
    }
    
    phoneNumberInput.value = value;
}

function updateRegistrationProgress() {
    if (!clientData) return;
    
    const requiredFields = [
        'fullName', 'cpf', 'birthDate', 'address', 
        'zipCode', 'city', 'state', 'phoneNumber', 'emailAddress',
        'acceptedTerms', 'acceptedPrivacyPolicy'
    ];
    
    let completedFields = 0;
    
    requiredFields.forEach(field => {
        if (field === 'phoneNumber') {
            const phone = (phoneDDDSelect.value + phoneNumberInput.value).replace(/\D/g, '');
            if (phone.length >= 10) completedFields++;
        } else if (field === 'emailAddress') {
            if (emailAddressInput.value && validateEmail(emailAddressInput.value).valid) completedFields++;
        } else if (field === 'acceptedTerms') {
            if (acceptTermsCheck.checked) completedFields++;
        } else if (field === 'acceptedPrivacyPolicy') {
            if (acceptPrivacyCheck.checked) completedFields++;
        } else {
            if (clientData[field] && clientData[field].toString().trim() !== '') {
                completedFields++;
            }
        }
    });
    
    const percentage = Math.round((completedFields / requiredFields.length) * 100);
    updateProgress(percentage, `Cadastro ${percentage}% completo`);
}

// ============================================
// SALVAR DADOS (VERS√ÉO √öNICA E CORRETA)
// ============================================
async function saveClientData() {
    try {
        const errors = await validateForm();
        
        if (errors.length > 0) {
            showMessage(errors[0].message, 'error', 3000);
            return false;
        }
        
        showLoading(true);
        updateProgress(20, 'Validando dados...');
        
        const user = auth.currentUser;
        if (!user) {
            throw new Error('Usu√°rio n√£o autenticado');
        }
        
        // Verifica√ß√£o final de duplicidade
        updateProgress(30, 'Verificando duplicidade novamente...');
        const finalDuplicates = await checkDuplicateFields();
        if (finalDuplicates.length > 0) {
            finalDuplicates.forEach(dup => {
                showFieldError(dup.field, dup.message);
            });
            showMessage('Dados duplicados encontrados. Por favor, verifique os campos destacados.', 'error', 5000);
            showLoading(false);
            hideProgress();
            return false;
        }
        
        updateProgress(40, 'Salvando informa√ß√µes b√°sicas...');
        
        const clientDataToSave = {
            fullName: fullNameInput.value.trim(),
            cpf: cpfInput.value.replace(/\D/g, ''),
            rg: rgInput.value.trim() || '',
            socialName: socialNameInput.value.trim() || '',
            birthDate: new Date(birthDateInput.value),
            gender: genderSelect.value || '',
            address: addressInput.value.trim(),
            zipCode: zipCodeInput.value.replace(/\D/g, ''),
            city: cityInput.value.trim(),
            state: stateInput.value.trim().toUpperCase(),
            country: countryInput.value.trim(),
            phoneDDD: phoneDDDSelect.value,
            acceptedTerms: acceptTermsCheck.checked,
            acceptedPrivacyPolicy: acceptPrivacyCheck.checked,
            marketingEmails: marketingEmailsCheck.checked,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            registrationComplete: true
        };
        
        if (isExistingClient) {
            await firestore.collection('clients').doc(currentClientId).update(clientDataToSave);
        } else {
            clientDataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            clientDataToSave.uid = currentClientId;
            clientDataToSave.email = user.email;
            clientDataToSave.isActive = true;
            clientDataToSave.isBanned = false;
            
            await firestore.collection('clients').doc(currentClientId).set(clientDataToSave);
        }
        
        updateProgress(60, 'Salvando telefone...');
        
        const phoneNumber = (phoneDDDSelect.value + phoneNumberInput.value).replace(/\D/g, '');
        const phoneSnapshot = await firestore.collection('clientPhones')
            .where('clientId', '==', currentClientId)
            .where('isPrimary', '==', true)
            .limit(1)
            .get();
        
        if (!phoneSnapshot.empty) {
            await phoneSnapshot.docs[0].ref.update({
                phoneNumber: phoneNumber,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await firestore.collection('clientPhones').add({
                clientId: currentClientId,
                phoneNumber: phoneNumber,
                isPrimary: true,
                type: 'mobile',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        updateProgress(80, 'Salvando e-mail...');
        
        const emailAddress = emailAddressInput.value.trim().toLowerCase();
        const emailSnapshot = await firestore.collection('clientEmails')
            .where('clientId', '==', currentClientId)
            .where('isPrimary', '==', true)
            .limit(1)
            .get();
        
        if (!emailSnapshot.empty) {
            await emailSnapshot.docs[0].ref.update({
                emailAddress: emailAddress,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await firestore.collection('clientEmails').add({
                clientId: currentClientId,
                emailAddress: emailAddress,
                isPrimary: true,
                verified: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        updateProgress(100, 'Cadastro completo!');
        
        notifyRegistrationCompletion();
        showMessage('‚úÖ Cadastro salvo com sucesso!', 'success');
        
        setTimeout(() => {
            if (window.parent && window.parent.loadPage) {
                window.parent.loadPage('informacoes_cliente/?uid=' + currentClientId, true);
            } else {
                window.location.href = '../informacoes_cliente/?uid=' + currentClientId;
            }
        }, 2000);
        
        return true;
        
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showMessage(`‚ùå Erro ao salvar: ${error.message}`, 'error');
        showLoading(false);
        hideProgress();
        return false;
    }
}

// ============================================
// NOTIFICA√á√ÉO PARA SISTEMA PAI
// ============================================
function notifyRegistrationCompletion() {
    if (window.parent) {
        window.parent.postMessage({
            type: 'registrationCompleted',
            userId: currentClientId,
            timestamp: Date.now()
        }, '*');
    }
    
    localStorage.setItem('clientRegistrationComplete', 'true');
    localStorage.setItem('clientRegistrationDate', new Date().toISOString());
}

// ============================================
// BUSCAR CEP
// ============================================
async function buscarCEP(cep) {
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (!data.erro) {
            addressInput.value = `${data.logradouro}, ${data.bairro}`;
            cityInput.value = data.localidade;
            stateInput.value = data.uf;
            
            showMessage('Endere√ßo preenchido automaticamente pelo CEP', 'info', 3000);
        }
    } catch (error) {
        console.log('N√£o foi poss√≠vel buscar o CEP:', error);
    }
}

// ============================================
// EVENT LISTENERS
// ============================================

// Remover listeners antigos e adicionar apenas um de cada
editClientForm.removeEventListener('submit', saveClientData);
editClientForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveClientData();
});

stateInput.addEventListener('change', function() {
    detectDDDByState(this.value);
    
    if (phoneNumberInput.value && phoneDDDSelect.value) {
        const phoneValidation = validatePhone(phoneDDDSelect.value, phoneNumberInput.value);
        if (!phoneValidation.valid) {
            showMessage(`Ap√≥s selecionar DDD: ${phoneValidation.message}`, 'error', 3000);
        }
    }
});

phoneDDDSelect.addEventListener('change', function() {
    if (!this.value) {
        showMessage('Selecione um DDD', 'error', 2000);
    }
});

cancelBtn.addEventListener('click', () => {
    if (window.parent && window.parent.loadPage) {
        window.parent.loadPage('informacoes_cliente/?uid=' + currentClientId, true);
    } else {
        window.location.href = '../informacoes_cliente/?uid=' + currentClientId;
    }
});

// Formata√ß√£o em tempo real
cpfInput.addEventListener('input', function(e) {
    this.value = formatCPF(this.value);
});

zipCodeInput.addEventListener('input', function(e) {
    this.value = formatCEP(this.value);
    
    const cep = this.value.replace(/\D/g, '');
    if (cep.length === 8) {
        buscarCEP(cep);
    }
});

phoneNumberInput.addEventListener('input', function(e) {
    formatPhoneNumberInput();
    updateRegistrationProgress();
    
    if (phoneDDDSelect.value && this.value) {
        const phoneValidation = validatePhone(phoneDDDSelect.value, this.value);
        if (!phoneValidation.valid && this.value.length >= 8) {
            showMessage(phoneValidation.message, 'error', 2000);
        }
    }
});

// Valida√ß√£o de duplicidade em tempo real (on blur)
fullNameInput.addEventListener('blur', async function() {
    if (this.value.trim()) {
        const duplicates = await checkDuplicateFields();
        const nameDuplicate = duplicates.find(d => d.field === 'fullName');
        if (nameDuplicate) {
            showFieldError('fullName', nameDuplicate.message);
        }
    }
});

cpfInput.addEventListener('blur', async function() {
    if (this.value.replace(/\D/g, '').length === 11) {
        const duplicates = await checkDuplicateFields();
        const cpfDuplicate = duplicates.find(d => d.field === 'cpf');
        if (cpfDuplicate) {
            showFieldError('cpf', cpfDuplicate.message);
        }
    }
});

rgInput.addEventListener('blur', async function() {
    if (this.value.trim()) {
        const duplicates = await checkDuplicateFields();
        const rgDuplicate = duplicates.find(d => d.field === 'rg');
        if (rgDuplicate) {
            showFieldError('rg', rgDuplicate.message);
        }
    }
});

socialNameInput.addEventListener('blur', async function() {
    if (this.value.trim()) {
        const duplicates = await checkDuplicateFields();
        const socialNameDuplicate = duplicates.find(d => d.field === 'socialName');
        if (socialNameDuplicate) {
            showFieldError('socialName', socialNameDuplicate.message);
        }
    }
});

// Progresso do cadastro
const fieldsToValidate = [fullNameInput, cpfInput, birthDateInput, addressInput, 
                          zipCodeInput, cityInput, stateInput, phoneNumberInput, emailAddressInput];

fieldsToValidate.forEach(field => {
    field.addEventListener('blur', updateRegistrationProgress);
});

acceptTermsCheck.addEventListener('change', updateRegistrationProgress);
acceptPrivacyCheck.addEventListener('change', updateRegistrationProgress);

// ============================================
// INICIALIZA√á√ÉO
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    auth.onAuthStateChanged((user) => {
        if (user) {
            loadClientData();
        } else {
            showMessage('Redirecionando para login...', 'info');
            setTimeout(() => {
                if (window.parent && window.parent.loadPage) {
                    window.parent.loadPage('index.html', true);
                } else {
                    window.location.href = 'https://wazzimagiygg.com';
                }
            }, 1500);
        }
    });
});

    </script>
</body>
</html>
