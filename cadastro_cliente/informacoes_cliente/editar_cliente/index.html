<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro do Cliente - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: calc(100vh - 200px);
            padding: 20px;
            box-sizing: border-box;
        }
        .mdl-card {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .mdl-textfield {
            width: 100%;
            margin-bottom: 16px;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .form-actions button {
            margin-left: 10px;
        }
        #message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        #message.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        #message.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        #message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .mdl-selectfield {
            width: 100%;
            margin-bottom: 16px;
        }
        .mdl-selectfield label {
            width: 100%;
            padding-bottom: 8px;
            color: rgba(0,0,0,.54);
            font-size: 16px;
        }
        .mdl-selectfield select {
            width: 100%;
            padding: 8px 0;
            border: none;
            border-bottom: 1px solid rgba(0,0,0,.12);
            background-color: transparent;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        .mdl-selectfield select:focus {
            outline: none;
            border-bottom: 2px solid #3f51b5;
        }
        .mdl-selectfield {
            position: relative;
        }
        .mdl-selectfield:after {
            content: '▼';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: rgba(0,0,0,.54);
        }
        .loading-container {
            text-align: center;
            padding: 40px;
            color: #3f51b5;
            font-size: 16px;
        }
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3f51b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-required {
            text-align: center;
            padding: 40px;
            color: #f44336;
        }
        .auth-required button {
            margin-top: 20px;
        }
        .phone-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>

    <div class="mdl-card mdl-shadow--2dp">
        <div class="mdl-card__title mdl-card--expand">
            <h2 class="mdl-card__title-text" id="pageTitle">Cadastro do Cliente</h2>
        </div>
        
        <div id="loadingContainer" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Verificando autenticação...</p>
        </div>
        
        <div id="authRequiredContainer" class="auth-required" style="display:none;">
            <h3>Login Necessário</h3>
            <p>Você precisa estar logado para acessar esta página.</p>
            <button id="loginRedirectBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">
                Ir para Login
            </button>
        </div>
        
        <div id="formContainer" class="mdl-card__supporting-text" style="display:none;">
            <form id="editClientForm">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="fullName" required>
                    <label class="mdl-textfield__label" for="fullName">Nome Completo</label>
                    <span class="mdl-textfield__error">Campo obrigatório</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" pattern="[0-9]{11}" id="cpf" required>
                    <label class="mdl-textfield__label" for="cpf">CPF (somente números)</label>
                    <span class="mdl-textfield__error">Apenas 11 dígitos numéricos são permitidos!</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="rg">
                    <label class="mdl-textfield__label" for="rg">RG</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="socialName">
                    <label class="mdl-textfield__label" for="socialName">Nome Social (opcional)</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="date" id="birthDate" required>
                    <label class="mdl-textfield__label" for="birthDate">Data de Nascimento</label>
                    <span class="mdl-textfield__error">Campo obrigatório</span>
                </div>
                <div class="mdl-selectfield mdl-js-selectfield mdl-selectfield--floating-label">
                    <label for="gender">Gênero</label>
                    <select id="gender" class="mdl-textfield__input">
                        <option value=""></option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="nao-binario">Não Binário</option>
                        <option value="outro">Outro</option>
                        <option value="prefiro-nao-dizer">Prefiro não dizer</option>
                    </select>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="address" required>
                    <label class="mdl-textfield__label" for="address">Endereço (Rua, Número, Bairro)</label>
                    <span class="mdl-textfield__error">Campo obrigatório</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" pattern="[0-9]{8}" id="zipCode" required>
                    <label class="mdl-textfield__label" for="zipCode">CEP (somente números)</label>
                    <span class="mdl-textfield__error">Apenas 8 dígitos numéricos são permitidos!</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="city" required>
                    <label class="mdl-textfield__label" for="city">Cidade</label>
                    <span class="mdl-textfield__error">Campo obrigatório</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="state" required maxlength="2">
                    <label class="mdl-textfield__label" for="state">Estado (Ex: SP)</label>
                    <span class="mdl-textfield__error">Campo obrigatório (2 letras)</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="country" required value="Brasil">
                    <label class="mdl-textfield__label" for="country">País</label>
                    <span class="mdl-textfield__error">Campo obrigatório</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="tel" id="phoneNumber" placeholder="Ex: 11999998888" required>
                    <label class="mdl-textfield__label" for="phoneNumber">Telefone (com DDD, somente números)</label>
                    <span class="mdl-textfield__error">Apenas números (10 ou 11 dígitos)</span>
                    <span class="phone-hint">Exemplo: 11999998888 (11 dígitos) ou 1199998888 (10 dígitos)</span>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="email" id="emailAddress" required>
                    <label class="mdl-textfield__label" for="emailAddress">E-mail de Contato</label>
                    <span class="mdl-textfield__error">E-mail válido obrigatório</span>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect" id="submitBtn">
                        Salvar Cadastro
                    </button>
                    <button type="button" id="cancelEditBtn" class="mdl-button mdl-js-button mdl-js-ripple-effect">
                        Cancelar
                    </button>
                </div>
            </form>
            <div id="message"></div>
        </div>
    </div>

    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();
        const auth = firebase.auth();

        // Elementos DOM
        const loadingContainer = document.getElementById('loadingContainer');
        const authRequiredContainer = document.getElementById('authRequiredContainer');
        const formContainer = document.getElementById('formContainer');
        const pageTitle = document.getElementById('pageTitle');
        const editClientForm = document.getElementById('editClientForm');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const loginRedirectBtn = document.getElementById('loginRedirectBtn');
        
        // Campos do formulário
        const fullNameInput = document.getElementById('fullName');
        const cpfInput = document.getElementById('cpf');
        const rgInput = document.getElementById('rg');
        const socialNameInput = document.getElementById('socialName');
        const birthDateInput = document.getElementById('birthDate');
        const genderSelect = document.getElementById('gender');
        const addressInput = document.getElementById('address');
        const zipCodeInput = document.getElementById('zipCode');
        const cityInput = document.getElementById('city');
        const stateInput = document.getElementById('state');
        const countryInput = document.getElementById('country');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const emailAddressInput = document.getElementById('emailAddress');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let currentClientId = null;
        let isExistingClient = false;

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = '';
            messageDiv.classList.add(type);
            messageDiv.style.display = 'block';
        }

        function showLoading() {
            loadingContainer.style.display = 'block';
            authRequiredContainer.style.display = 'none';
            formContainer.style.display = 'none';
        }

        function showAuthRequired() {
            loadingContainer.style.display = 'none';
            authRequiredContainer.style.display = 'block';
            formContainer.style.display = 'none';
        }

        function showForm() {
            loadingContainer.style.display = 'none';
            authRequiredContainer.style.display = 'none';
            formContainer.style.display = 'block';
        }

        function updateMDLFields() {
            // Atualiza todos os campos MDL
            const fields = [
                fullNameInput, cpfInput, rgInput, socialNameInput, birthDateInput,
                addressInput, zipCodeInput, cityInput, stateInput, countryInput,
                phoneNumberInput, emailAddressInput
            ];
            
            fields.forEach(input => {
                if (input.parentElement && input.parentElement.MaterialTextfield) {
                    input.parentElement.MaterialTextfield.checkDirty();
                    input.parentElement.MaterialTextfield.checkValidity();
                }
            });
        }

        function formatPhoneForDisplay(phone) {
            // Remove tudo que não é número
            const numbers = phone.replace(/\D/g, '');
            
            // Formata para exibição: (XX) XXXXX-XXXX ou (XX) XXXX-XXXX
            if (numbers.length === 11) {
                return `(${numbers.substring(0,2)}) ${numbers.substring(2,7)}-${numbers.substring(7)}`;
            } else if (numbers.length === 10) {
                return `(${numbers.substring(0,2)}) ${numbers.substring(2,6)}-${numbers.substring(6)}`;
            }
            return phone; // Retorna como está se não tiver 10 ou 11 dígitos
        }

        async function loadClientData() {
            showLoading();
            
            const user = auth.currentUser;
            
            if (!user) {
                showAuthRequired();
                return;
            }
            
            currentClientId = user.uid;
            
            try {
                // Busca o documento do cliente
                const clientDoc = await firestore.collection('clients').doc(currentClientId).get();
                
                if (clientDoc.exists) {
                    // Cliente já existe - modo edição
                    isExistingClient = true;
                    const data = clientDoc.data();
                    
                    // Preenche os campos
                    fullNameInput.value = data.fullName || '';
                    cpfInput.value = data.cpf || '';
                    rgInput.value = data.rg || '';
                    socialNameInput.value = data.socialName || '';
                    birthDateInput.value = data.birthDate || '';
                    genderSelect.value = data.gender || '';
                    addressInput.value = data.address || '';
                    zipCodeInput.value = data.zipCode || '';
                    cityInput.value = data.city || '';
                    stateInput.value = data.state || '';
                    countryInput.value = data.country || 'Brasil';
                    
                    // Busca telefone
                    const phoneSnapshot = await firestore.collection('clientPhones')
                        .where('clientId', '==', currentClientId)
                        .where('isPrimary', '==', true)
                        .limit(1).get();
                    
                    if (!phoneSnapshot.empty) {
                        const phoneData = phoneSnapshot.docs[0].data();
                        let phoneNumber = phoneData.phoneNumber || '';
                        // Remove formatação para armazenar apenas números
                        phoneNumber = phoneNumber.replace(/\D/g, '');
                        phoneNumberInput.value = phoneNumber;
                    }
                    
                    // Busca email
                    const emailSnapshot = await firestore.collection('clientEmails')
                        .where('clientId', '==', currentClientId)
                        .where('isPrimary', '==', true)
                        .limit(1).get();
                    
                    if (!emailSnapshot.empty) {
                        const emailData = emailSnapshot.docs[0].data();
                        emailAddressInput.value = emailData.emailAddress || user.email || '';
                    } else {
                        emailAddressInput.value = user.email || '';
                    }
                    
                    pageTitle.textContent = 'Editar Informações do Cliente';
                    submitBtn.textContent = 'Atualizar Cadastro';
                    showMessage('Edite suas informações abaixo', 'info');
                    
                } else {
                    // Cliente não existe - modo criação
                    isExistingClient = false;
                    
                    // Preenche com dados do Google, se disponíveis
                    if (user.displayName) {
                        fullNameInput.value = user.displayName;
                    }
                    
                    emailAddressInput.value = user.email || '';
                    
                    // Preenche data de nascimento padrão (18 anos atrás)
                    const today = new Date();
                    const eighteenYearsAgo = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
                    birthDateInput.value = eighteenYearsAgo.toISOString().split('T')[0];
                    
                    pageTitle.textContent = 'Cadastro do Cliente';
                    submitBtn.textContent = 'Salvar Cadastro';
                    showMessage('Complete seu cadastro pela primeira vez', 'info');
                }
                
                updateMDLFields();
                showForm();
                
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showMessage(`Erro ao carregar dados: ${error.message}`, 'error');
                showForm();
            }
        }

        async function saveClientData() {
            const user = auth.currentUser;
            
            if (!user || !currentClientId) {
                showMessage('Erro: Usuário não autenticado.', 'error');
                return false;
            }
            
            // Validação dos campos obrigatórios
            if (!fullNameInput.value || !cpfInput.value || !birthDateInput.value || 
                !addressInput.value || !zipCodeInput.value || !cityInput.value || 
                !stateInput.value || !phoneNumberInput.value || !emailAddressInput.value) {
                showMessage('Por favor, preencha todos os campos obrigatórios.', 'error');
                return false;
            }
            
            // Validação de CPF (11 dígitos)
            const cpfNumbers = cpfInput.value.replace(/\D/g, '');
            if (cpfNumbers.length !== 11) {
                showMessage('CPF deve conter 11 dígitos.', 'error');
                return false;
            }
            
            // Validação de CEP (8 dígitos)
            const zipCodeNumbers = zipCodeInput.value.replace(/\D/g, '');
            if (zipCodeNumbers.length !== 8) {
                showMessage('CEP deve conter 8 dígitos.', 'error');
                return false;
            }
            
            // Validação de estado (2 letras)
            if (stateInput.value.trim().length !== 2) {
                showMessage('Estado deve ter 2 letras (ex: SP).', 'error');
                return false;
            }
            
            // Validação de telefone (10 ou 11 dígitos)
            const phoneNumbers = phoneNumberInput.value.replace(/\D/g, '');
            if (phoneNumbers.length < 10 || phoneNumbers.length > 11) {
                showMessage('Telefone deve conter 10 ou 11 dígitos.', 'error');
                return false;
            }
            
            // Validação de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailAddressInput.value)) {
                showMessage('Por favor, insira um e-mail válido.', 'error');
                return false;
            }
            
            const clientData = {
                fullName: fullNameInput.value.trim(),
                cpf: cpfNumbers,
                rg: rgInput.value.trim() || '',
                socialName: socialNameInput.value.trim() || '',
                birthDate: birthDateInput.value,
                gender: genderSelect.value || '',
                address: addressInput.value.trim(),
                zipCode: zipCodeNumbers,
                city: cityInput.value.trim(),
                state: stateInput.value.trim().toUpperCase(),
                country: countryInput.value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const phoneNumber = phoneNumbers; // Já está apenas com números
            const emailAddress = emailAddressInput.value.trim().toLowerCase();
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvando...';
                
                if (isExistingClient) {
                    // Atualização
                    await firestore.collection('clients').doc(currentClientId).update(clientData);
                    showMessage('Informações atualizadas com sucesso!', 'success');
                } else {
                    // Criação
                    clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    clientData.isActive = true;
                    clientData.isBanned = false;
                    
                    await firestore.collection('clients').doc(currentClientId).set(clientData);
                    showMessage('Cadastro criado com sucesso!', 'success');
                }
                
                // Salva/atualiza telefone
                const phoneSnapshot = await firestore.collection('clientPhones')
                    .where('clientId', '==', currentClientId)
                    .where('isPrimary', '==', true)
                    .limit(1).get();
                
                if (!phoneSnapshot.empty) {
                    await phoneSnapshot.docs[0].ref.update({
                        phoneNumber: phoneNumber,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await firestore.collection('clientPhones').add({
                        clientId: currentClientId,
                        phoneNumber: phoneNumber,
                        isPrimary: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Salva/atualiza email
                const emailSnapshot = await firestore.collection('clientEmails')
                    .where('clientId', '==', currentClientId)
                    .where('isPrimary', '==', true)
                    .limit(1).get();
                
                if (!emailSnapshot.empty) {
                    await emailSnapshot.docs[0].ref.update({
                        emailAddress: emailAddress,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await firestore.collection('clientEmails').add({
                        clientId: currentClientId,
                        emailAddress: emailAddress,
                        isPrimary: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Redireciona após 2 segundos
                setTimeout(() => {
                    if (window.parent && window.parent.loadPage) {
                        window.parent.loadPage('informacoes_cliente.html', true);
                    } else {
                        window.location.href = 'informacoes_cliente.html';
                    }
                }, 2000);
                
                return true;
                
            } catch (error) {
                console.error("Erro ao salvar cliente:", error);
                showMessage(`Erro ao salvar: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = isExistingClient ? 'Atualizar Cadastro' : 'Salvar Cadastro';
                return false;
            }
        }

        // Event Listeners
        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveClientData();
        });

        cancelEditBtn.addEventListener('click', () => {
            if (window.parent && window.parent.loadPage) {
                window.parent.loadPage('informacoes_cliente.html', true);
            } else {
                window.location.href = 'informacoes_cliente.html';
            }
        });

        loginRedirectBtn.addEventListener('click', () => {
            if (window.parent && window.parent.loadPage) {
                window.parent.loadPage('index.html', true);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Formatação simples do telefone durante a digitação
        phoneNumberInput.addEventListener('input', function(e) {
            // Remove tudo que não é número
            let value = e.target.value.replace(/\D/g, '');
            
            // Limita a 11 dígitos
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            
            // Atualiza o valor sem formatação
            e.target.value = value;
        });

        // Formatação para exibição quando o campo perde o foco
        phoneNumberInput.addEventListener('blur', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            if (value.length === 10 || value.length === 11) {
                e.target.value = formatPhoneForDisplay(value);
            }
        });

        // Remove formatação quando o campo ganha foco
        phoneNumberInput.addEventListener('focus', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
        });

        // Inicialização
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Usuário está logado
                loadClientData();
            } else {
                // Usuário não está logado
                showAuthRequired();
            }
        });

        // Carrega os dados quando a página estiver pronta
        document.addEventListener('DOMContentLoaded', () => {
            // Inicia verificando o estado de autenticação
            const user = auth.currentUser;
            if (user) {
                loadClientData();
            } else {
                showAuthRequired();
            }
        });
    </script>
</body>
</html>
