<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Eletrônico - Sistema de Saúde</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1a5a8a 0%, #0d3b66 100%);
            color: white;
            padding: 25px;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .back-button i {
            margin-right: 8px;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .sidebar {
            flex: 0 0 350px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .main-content {
            flex: 1;
            min-width: 300px;
        }
        
        .section-title {
            color: #1a5a8a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title button {
            padding: 8px 15px;
            background-color: #1a5a8a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a5a8a;
            box-shadow: 0 0 0 2px rgba(26, 90, 138, 0.2);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .required {
            color: #e74c3c;
        }
        
        button {
            background: linear-gradient(to right, #1a5a8a, #0d3b66);
            color: white;
            border: none;
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background: linear-gradient(to right, #0d3b66, #072540);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        #saveButton {
            background: linear-gradient(to right, #27ae60, #219653);
        }
        
        #saveButton:hover {
            background: linear-gradient(to right, #219653, #1e8449);
        }
        
        #clearButton {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
        }
        
        #clearButton:hover {
            background: linear-gradient(to right, #7f8c8d, #6c7b7d);
        }
        
        .status-message {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .patient-info-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .patient-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .patient-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1a5a8a, #0d3b66);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin-right: 20px;
        }
        
        .patient-details h2 {
            color: #1a5a8a;
            margin-bottom: 5px;
        }
        
        .patient-details p {
            color: #666;
            margin-bottom: 3px;
        }
        
        .patient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-top: 4px solid #1a5a8a;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1a5a8a;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            border-right: 1px solid #eee;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab.active {
            background-color: white;
            color: #1a5a8a;
            border-bottom: 3px solid #1a5a8a;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .consultas-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .consulta-item {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #1a5a8a;
            transition: all 0.3s;
        }
        
        .consulta-item:hover {
            background-color: #e8f4ff;
            transform: translateX(5px);
        }
        
        .consulta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .consulta-title {
            font-weight: 600;
            color: #1a5a8a;
            font-size: 1.1rem;
        }
        
        .consulta-date {
            font-size: 0.9rem;
            color: #666;
        }
        
        .consulta-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #555;
        }
        
        .consulta-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .consulta-actions button {
            padding: 8px 15px;
            font-size: 0.9rem;
            margin-top: 0;
            width: auto;
        }
        
        .view-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
        }
        
        .edit-btn {
            background: linear-gradient(to right, #f39c12, #e67e22);
        }
        
        .delete-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #1a5a8a;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #1a5a8a;
            border: 2px solid white;
            box-shadow: 0 0 0 3px #1a5a8a;
        }
        
        .timeline-date {
            font-weight: 600;
            color: #1a5a8a;
            margin-bottom: 5px;
        }
        
        .timeline-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #1a5a8a;
        }
        
        .medications-grid, .allergies-grid, .diagnoses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .medication-card, .allergy-card, .diagnosis-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .medication-name, .allergy-name, .diagnosis-name {
            font-weight: 600;
            color: #1a5a8a;
            margin-bottom: 5px;
        }
        
        .add-item-btn {
            background-color: #f8f9fa;
            border: 2px dashed #ddd;
            color: #95a5a6;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-item-btn:hover {
            border-color: #1a5a8a;
            color: #1a5a8a;
            background-color: #e8f4ff;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            color: #1a5a8a;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        #searchInput {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-weight: 600;
            color: #1a5a8a;
            font-size: 1.2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #95a5a6;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                flex: 1;
            }
            
            .form-row {
                flex-direction: column;
                gap: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .patient-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .patient-stats {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
        
        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a5a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .vital-signs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .vital-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-top: 3px solid #1a5a8a;
        }
        
        .vital-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a5a8a;
            margin-bottom: 5px;
        }
        
        .vital-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .vital-date {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
        }
        
        .emergency-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .warning-alert {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-alert {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Prontuário Eletrônico do Paciente</h1>
            <p class="subtitle">Visualização e gerenciamento completo do histórico médico</p>
            <a href="#" class="back-button" id="backButton">
                <i class="fas fa-arrow-left"></i> Voltar ao Sistema
            </a>
        </header>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="content">
            <div class="sidebar">
                <div class="form-group">
                    <label for="patientSelect">Selecionar Paciente <span class="required">*</span></label>
                    <select id="patientSelect">
                        <option value="">Selecione um paciente</option>
                        <!-- Pacientes serão carregados aqui -->
                    </select>
                    <button id="searchPatientBtn" style="margin-top: 10px; font-size: 0.9rem; padding: 10px;">
                        <i class="fas fa-search"></i> Buscar Paciente por CPF/Nome
                    </button>
                </div>
                
                <div id="patientQuickInfo" style="display: none;">
                    <div class="patient-header">
                        <div class="patient-avatar" id="patientAvatar">JD</div>
                        <div class="patient-details">
                            <h2 id="patientName">Nome do Paciente</h2>
                            <p id="patientAge">Idade: -- anos</p>
                            <p id="patientGender">Sexo: --</p>
                            <p id="patientBloodType">Tipo Sanguíneo: --</p>
                        </div>
                    </div>
                    
                    <div class="patient-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="statConsultas">0</div>
                            <div class="stat-label">Consultas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statExames">0</div>
                            <div class="stat-label">Exames</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statMedicamentos">0</div>
                            <div class="stat-label">Medicamentos</div>
                        </div>
                    </div>
                    
                    <div class="emergency-alert" id="emergencyAlert" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Alerta de Emergência!</strong>
                            <div id="alertMessage">Este paciente tem alergias graves registradas.</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="newConsultationForm" style="display: none; margin-top: 20px;">
                    <h3 class="section-title">Nova Consulta</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="consultaData">Data</label>
                            <input type="date" id="consultaData">
                        </div>
                        
                        <div class="form-group">
                            <label for="consultaHora">Hora</label>
                            <input type="time" id="consultaHora">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="consultaMotivo">Motivo</label>
                        <textarea id="consultaMotivo" placeholder="Motivo da consulta" rows="3"></textarea>
                    </div>
                    
                    <button id="quickConsultaBtn">
                        <i class="fas fa-calendar-plus"></i> Agendar Consulta Rápida
                    </button>
                </div>
                
                <div class="instructions" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; font-size: 0.9rem;">
                    <p><strong>Instruções:</strong></p>
                    <p>1. Selecione um paciente para visualizar o prontuário</p>
                    <p>2. Use as abas para navegar entre as seções</p>
                    <p>3. Clique em uma consulta para ver detalhes</p>
                    <p>4. Use o botão "Nova Consulta" para agendar rapidamente</p>
                </div>
            </div>
            
            <div class="main-content">
                <div id="prontuarioContent" style="display: none;">
                    <div class="tabs">
                        <div class="tab active" data-tab="resumo">Resumo</div>
                        <div class="tab" data-tab="consultas">Consultas</div>
                        <div class="tab" data-tab="exames">Exames</div>
                        <div class="tab" data-tab="medicamentos">Medicamentos</div>
                        <div class="tab" data-tab="alergias">Alergias</div>
                        <div class="tab" data-tab="diagnosticos">Diagnósticos</div>
                        <div class="tab" data-tab="vitals">Sinais Vitais</div>
                    </div>
                    
                    <!-- Tab: Resumo -->
                    <div class="tab-content active" id="resumoTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Resumo do Prontuário
                                <button id="exportProntuarioBtn">
                                    <i class="fas fa-download"></i> Exportar PDF
                                </button>
                            </h2>
                            
                            <div class="vital-signs-grid" id="vitalsGrid">
                                <!-- Sinais vitais serão carregados aqui -->
                            </div>
                            
                            <div class="charts-container">
                                <div class="chart-card">
                                    <div class="chart-title">Consultas por Mês</div>
                                    <div class="chart-container">
                                        <canvas id="consultasChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <div class="chart-title">Tipos de Exames</div>
                                    <div class="chart-container">
                                        <canvas id="examesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline" id="timeline">
                                <!-- Linha do tempo será carregada aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Consultas -->
                    <div class="tab-content" id="consultasTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Histórico de Consultas
                                <button id="novaConsultaBtn">
                                    <i class="fas fa-plus"></i> Nova Consulta
                                </button>
                            </h2>
                            
                            <div class="search-box">
                                <input type="text" id="searchConsultas" placeholder="Buscar consultas por motivo, diagnóstico, etc...">
                            </div>
                            
                            <div class="filters">
                                <select class="filter-select" id="filterAno">
                                    <option value="">Todos os anos</option>
                                    <!-- Anos serão carregados dinamicamente -->
                                </select>
                                
                                <select class="filter-select" id="filterProfissional">
                                    <option value="">Todos os profissionais</option>
                                    <!-- Profissionais serão carregados dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="consultas-list" id="consultasList">
                                <!-- Consultas serão carregadas aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Exames -->
                    <div class="tab-content" id="examesTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">Exames Realizados</h2>
                            
                            <div class="exames-grid" id="examesGrid">
                                <!-- Exames serão carregados aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Medicamentos -->
                    <div class="tab-content" id="medicamentosTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Medicamentos em Uso
                                <button id="addMedicamentoBtn">
                                    <i class="fas fa-plus"></i> Adicionar Medicamento
                                </button>
                            </h2>
                            
                            <div class="medications-grid" id="medicationsGrid">
                                <!-- Medicamentos serão carregados aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Alergias -->
                    <div class="tab-content" id="alergiasTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Alergias Conhecidas
                                <button id="addAlergiaBtn">
                                    <i class="fas fa-plus"></i> Adicionar Alergia
                                </button>
                            </h2>
                            
                            <div class="allergies-grid" id="allergiesGrid">
                                <!-- Alergias serão carregadas aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Diagnósticos -->
                    <div class="tab-content" id="diagnosticosTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Diagnósticos Registrados
                                <button id="addDiagnosticoBtn">
                                    <i class="fas fa-plus"></i> Adicionar Diagnóstico
                                </button>
                            </h2>
                            
                            <div class="diagnoses-grid" id="diagnosesGrid">
                                <!-- Diagnósticos serão carregados aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Sinais Vitais -->
                    <div class="tab-content" id="vitalsTab">
                        <div class="patient-info-card">
                            <h2 class="section-title">
                                Sinais Vitais
                                <button id="addVitalBtn">
                                    <i class="fas fa-plus"></i> Registrar Sinal Vital
                                </button>
                            </h2>
                            
                            <div class="vital-signs-grid" id="allVitalsGrid">
                                <!-- Todos os sinais vitais serão carregados aqui -->
                            </div>
                            
                            <div class="charts-container">
                                <div class="chart-card">
                                    <div class="chart-title">Evolução da Pressão Arterial</div>
                                    <div class="chart-container">
                                        <canvas id="pressaoChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <div class="chart-title">Evolução da Glicemia</div>
                                    <div class="chart-container">
                                        <canvas id="glicemiaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-user-injured"></i>
                    <h3>Nenhum paciente selecionado</h3>
                    <p>Selecione um paciente no menu à esquerda para visualizar o prontuário.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para detalhes da consulta -->
    <div class="modal-overlay" id="consultaModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="consultaModalTitle">Detalhes da Consulta</div>
                <button class="modal-close" id="closeConsultaModal">&times;</button>
            </div>
            <div class="modal-body" id="consultaModalBody">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Modal para adicionar medicamento -->
    <div class="modal-overlay" id="medicamentoModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Adicionar Medicamento</div>
                <button class="modal-close" id="closeMedicamentoModal">&times;</button>
            </div>
            <div class="modal-body" id="medicamentoModalBody">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Modal para adicionar alergia -->
    <div class="modal-overlay" id="alergiaModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Adicionar Alergia</div>
                <button class="modal-close" id="closeAlergiaModal">&times;</button>
            </div>
            <div class="modal-body" id="alergiaModalBody">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDgm3YoP4HkIrTFOYGYgOR2VD58ctU2D_U",
            authDomain: "gespaimaspia.firebaseapp.com",
            databaseURL: "https://gespaimaspia.firebaseio.com",
            projectId: "gespaimaspia",
            storageBucket: "gespaimaspia.firebasestorage.app",
            messagingSenderId: "245238673674",
            appId: "1:245238673674:web:2c1108fc499a3f1b0d0af3"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Referências às coleções
        const prontuariosRef = db.collection("prontuarios");
        const pacientesRef = db.collection("pacientes");
        const consultasRef = db.collection("consultas");
        const examesRef = db.collection("examessolicitados");
        const receitasRef = db.collection("receituario");
        
        // Estado da aplicação
        let currentUser = null;
        let currentPacienteId = null;
        let currentPaciente = null;
        let pacienteConsultas = [];
        let pacienteExames = [];
        let pacienteMedicamentos = [];
        let pacienteAlergias = [];
        let pacienteDiagnosticos = [];
        let pacienteSinaisVitais = [];
        
        // Gráficos
        let consultasChart = null;
        let examesChart = null;
        let pressaoChart = null;
        let glicemiaChart = null;
        
        // Elementos DOM
        const statusMessage = document.getElementById('statusMessage');
        const backButton = document.getElementById('backButton');
        
        // Sidebar
        const patientSelect = document.getElementById('patientSelect');
        const searchPatientBtn = document.getElementById('searchPatientBtn');
        const patientQuickInfo = document.getElementById('patientQuickInfo');
        const patientAvatar = document.getElementById('patientAvatar');
        const patientName = document.getElementById('patientName');
        const patientAge = document.getElementById('patientAge');
        const patientGender = document.getElementById('patientGender');
        const patientBloodType = document.getElementById('patientBloodType');
        const statConsultas = document.getElementById('statConsultas');
        const statExames = document.getElementById('statExames');
        const statMedicamentos = document.getElementById('statMedicamentos');
        const emergencyAlert = document.getElementById('emergencyAlert');
        const alertMessage = document.getElementById('alertMessage');
        const newConsultationForm = document.getElementById('newConsultationForm');
        const consultaDataInput = document.getElementById('consultaData');
        const consultaHoraInput = document.getElementById('consultaHora');
        const consultaMotivoInput = document.getElementById('consultaMotivo');
        const quickConsultaBtn = document.getElementById('quickConsultaBtn');
        
        // Conteúdo principal
        const prontuarioContent = document.getElementById('prontuarioContent');
        const emptyState = document.getElementById('emptyState');
        
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Botões
        const exportProntuarioBtn = document.getElementById('exportProntuarioBtn');
        const novaConsultaBtn = document.getElementById('novaConsultaBtn');
        const addMedicamentoBtn = document.getElementById('addMedicamentoBtn');
        const addAlergiaBtn = document.getElementById('addAlergiaBtn');
        const addDiagnosticoBtn = document.getElementById('addDiagnosticoBtn');
        const addVitalBtn = document.getElementById('addVitalBtn');
        
        // Filtros
        const searchConsultasInput = document.getElementById('searchConsultas');
        const filterAnoInput = document.getElementById('filterAno');
        const filterProfissionalInput = document.getElementById('filterProfissional');
        
        // Containers
        const vitalsGrid = document.getElementById('vitalsGrid');
        const consultasList = document.getElementById('consultasList');
        const examesGrid = document.getElementById('examesGrid');
        const medicationsGrid = document.getElementById('medicationsGrid');
        const allergiesGrid = document.getElementById('allergiesGrid');
        const diagnosesGrid = document.getElementById('diagnosesGrid');
        const allVitalsGrid = document.getElementById('allVitalsGrid');
        const timeline = document.getElementById('timeline');
        
        // Modais
        const consultaModal = document.getElementById('consultaModal');
        const medicamentoModal = document.getElementById('medicamentoModal');
        const alergiaModal = document.getElementById('alergiaModal');
        const closeConsultaModal = document.getElementById('closeConsultaModal');
        const closeMedicamentoModal = document.getElementById('closeMedicamentoModal');
        const closeAlergiaModal = document.getElementById('closeAlergiaModal');
        const consultaModalBody = document.getElementById('consultaModalBody');
        const medicamentoModalBody = document.getElementById('medicamentoModalBody');
        const alergiaModalBody = document.getElementById('alergiaModalBody');
        
        // Inicializar data e hora atuais
        const hoje = new Date();
        consultaDataInput.value = hoje.toISOString().split('T')[0];
        consultaHoraInput.value = hoje.toTimeString().slice(0, 5);
        
        // Mostrar mensagem de status
        function showMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Carregar usuário atual
        function loadCurrentUser() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || 'Profissional'
                    };
                    console.log('Usuário autenticado:', currentUser);
                    
                    // Carregar pacientes
                    loadPacientes();
                } else {
                    // Simular usuário para desenvolvimento
                    currentUser = {
                        uid: 'profissional-123',
                        email: 'medico@hospital.com',
                        displayName: 'Dr. João Silva',
                        role: 'medico'
                    };
                    console.log('Usuário simulado para desenvolvimento');
                    
                    // Carregar pacientes
                    loadPacientes();
                }
            });
        }
        
        // Carregar pacientes
        async function loadPacientes() {
            try {
                showMessage('Carregando pacientes...', 'loading');
                
                const snapshot = await pacientesRef.orderBy('nome').get();
                patientSelect.innerHTML = '<option value="">Selecione um paciente</option>';
                
                snapshot.forEach(doc => {
                    const paciente = doc.data();
                    paciente.id = doc.id;
                    
                    // Adicionar ao select
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = `${paciente.nome} (${paciente.cpf || 'Sem CPF'})`;
                    patientSelect.appendChild(option);
                });
                
                showMessage(`${snapshot.size} pacientes carregados.`, 'success');
            } catch (error) {
                console.error('Erro ao carregar pacientes:', error);
                showMessage('Erro ao carregar pacientes.', 'error');
            }
        }
        
        // Selecionar paciente
        async function selectPaciente(pacienteId) {
            if (!pacienteId) {
                prontuarioContent.style.display = 'none';
                emptyState.style.display = 'block';
                patientQuickInfo.style.display = 'none';
                newConsultationForm.style.display = 'none';
                return;
            }
            
            try {
                showMessage('Carregando prontuário...', 'loading');
                
                // Carregar dados do paciente
                const pacienteDoc = await pacientesRef.doc(pacienteId).get();
                
                if (!pacienteDoc.exists) {
                    showMessage('Paciente não encontrado.', 'error');
                    return;
                }
                
                currentPacienteId = pacienteId;
                currentPaciente = pacienteDoc.data();
                currentPaciente.id = pacienteId;
                
                // Atualizar sidebar
                updatePatientSidebar();
                
                // Carregar prontuário do paciente
                await loadProntuario();
                
                // Mostrar conteúdo
                prontuarioContent.style.display = 'block';
                emptyState.style.display = 'none';
                patientQuickInfo.style.display = 'block';
                newConsultationForm.style.display = 'block';
                
                // Ativar primeira tab
                switchTab('resumo');
                
                showMessage('Prontuário carregado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao carregar prontuário:', error);
                showMessage('Erro ao carregar prontuário do paciente.', 'error');
            }
        }
        
        // Atualizar sidebar do paciente
        function updatePatientSidebar() {
            if (!currentPaciente) return;
            
            // Avatar com iniciais
            const initials = currentPaciente.nome.split(' ').map(n => n[0]).join('').toUpperCase();
            patientAvatar.textContent = initials.substring(0, 2);
            
            // Informações básicas
            patientName.textContent = currentPaciente.nome;
            
            // Idade
            if (currentPaciente.dataNascimento) {
                const nascimento = new Date(currentPaciente.dataNascimento);
                const idade = calcularIdade(nascimento);
                patientAge.textContent = `Idade: ${idade} anos`;
            } else {
                patientAge.textContent = 'Idade: Não informada';
            }
            
            // Sexo
            patientGender.textContent = `Sexo: ${currentPaciente.sexo || 'Não informado'}`;
            
            // Tipo sanguíneo
            patientBloodType.textContent = `Tipo Sanguíneo: ${currentPaciente.tipoSanguineo || 'Não informado'}`;
            
            // Alerta de emergência
            if (pacienteAlergias.length > 0) {
                const alergiasGraves = pacienteAlergias.filter(a => a.gravidade === 'grave' || a.gravidade === 'severa');
                if (alergiasGraves.length > 0) {
                    alertMessage.textContent = `Este paciente tem ${alergiasGraves.length} alergia(s) grave(s) registrada(s).`;
                    emergencyAlert.style.display = 'flex';
                } else {
                    emergencyAlert.style.display = 'none';
                }
            } else {
                emergencyAlert.style.display = 'none';
            }
        }
        
        // Calcular idade
        function calcularIdade(dataNascimento) {
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            
            return idade;
        }
        
        // Carregar prontuário completo do paciente
        async function loadProntuario() {
            try {
                // Carregar consultas do paciente
                await loadConsultasPaciente();
                
                // Carregar exames do paciente
                await loadExamesPaciente();
                
                // Carregar medicamentos do paciente
                await loadMedicamentosPaciente();
                
                // Carregar alergias do paciente
                await loadAlergiasPaciente();
                
                // Carregar diagnósticos do paciente
                await loadDiagnosticosPaciente();
                
                // Carregar sinais vitais do paciente
                await loadSinaisVitaisPaciente();
                
                // Atualizar estatísticas
                updateStats();
                
                // Renderizar conteúdo da tab ativa
                renderActiveTab();
                
                // Criar gráficos
                createCharts();
                
            } catch (error) {
                console.error('Erro ao carregar prontuário:', error);
            }
        }
        
        // Carregar consultas do paciente
        async function loadConsultasPaciente() {
            try {
                const snapshot = await consultasRef
                    .where('pacienteId', '==', currentPacienteId)
                    .orderBy('dataConsulta', 'desc')
                    .orderBy('horaConsulta', 'desc')
                    .get();
                
                pacienteConsultas = [];
                snapshot.forEach(doc => {
                    const consulta = doc.data();
                    consulta.id = doc.id;
                    pacienteConsultas.push(consulta);
                });
                
                console.log(`${pacienteConsultas.length} consultas carregadas.`);
                
            } catch (error) {
                console.error('Erro ao carregar consultas:', error);
            }
        }
        
        // Carregar exames do paciente
        async function loadExamesPaciente() {
            try {
                // Primeiro precisamos das consultas para pegar os exames
                const consultasIds = pacienteConsultas.map(c => c.id);
                
                if (consultasIds.length === 0) {
                    pacienteExames = [];
                    return;
                }
                
                // Buscar exames para cada consulta
                pacienteExames = [];
                
                for (const consultaId of consultasIds) {
                    const snapshot = await examesRef
                        .where('consultaId', '==', consultaId)
                        .get();
                    
                    snapshot.forEach(doc => {
                        const exame = doc.data();
                        exame.id = doc.id;
                        exame.consultaId = consultaId;
                        pacienteExames.push(exame);
                    });
                }
                
                console.log(`${pacienteExames.length} exames carregados.`);
                
            } catch (error) {
                console.error('Erro ao carregar exames:', error);
            }
        }
        
        // Carregar medicamentos do paciente
        async function loadMedicamentosPaciente() {
            try {
                // Primeiro, tentar pegar da coleção de receitas
                const consultasIds = pacienteConsultas.map(c => c.id);
                
                if (consultasIds.length === 0) {
                    pacienteMedicamentos = [];
                    return;
                }
                
                pacienteMedicamentos = [];
                
                for (const consultaId of consultasIds) {
                    const snapshot = await receitasRef
                        .where('consultaId', '==', consultaId)
                        .get();
                    
                    snapshot.forEach(doc => {
                        const receita = doc.data();
                        
                        // Extrair medicamentos da receita
                        if (receita.medicamentos) {
                            const medicamentos = receita.medicamentos.split('\n').filter(m => m.trim());
                            
                            medicamentos.forEach(med => {
                                pacienteMedicamentos.push({
                                    nome: med,
                                    receitaId: doc.id,
                                    consultaId: consultaId,
                                    data: receita.dataCriacao
                                });
                            });
                        }
                    });
                }
                
                console.log(`${pacienteMedicamentos.length} medicamentos carregados.`);
                
            } catch (error) {
                console.error('Erro ao carregar medicamentos:', error);
            }
        }
        
        // Carregar alergias do paciente
        async function loadAlergiasPaciente() {
            try {
                // Em um sistema real, as alergias estariam em uma subcoleção do prontuário
                // Por enquanto, vamos usar as alergias do cadastro do paciente
                pacienteAlergias = [];
                
                if (currentPaciente.alergias) {
                    // Parse das alergias do campo texto
                    const alergiasTexto = currentPaciente.alergias.split(',').map(a => a.trim()).filter(a => a);
                    
                    alergiasTexto.forEach(alergia => {
                        pacienteAlergias.push({
                            nome: alergia,
                            gravidade: 'moderada', // Default
                            tipo: 'alimento' // Default
                        });
                    });
                }
                
                console.log(`${pacienteAlergias.length} alergias carregadas.`);
                
            } catch (error) {
                console.error('Erro ao carregar alergias:', error);
            }
        }
        
        // Carregar diagnósticos do paciente
        async function loadDiagnosticosPaciente() {
            try {
                // Extrair diagnósticos das consultas
                pacienteDiagnosticos = [];
                
                pacienteConsultas.forEach(consulta => {
                    if (consulta.hipotesesDiagnosticas) {
                        const diagnosticos = consulta.hipotesesDiagnosticas.split('\n').filter(d => d.trim());
                        
                        diagnosticos.forEach(diag => {
                            pacienteDiagnosticos.push({
                                nome: diag,
                                consultaId: consulta.id,
                                data: consulta.dataConsulta,
                                profissional: consulta.profissionalNome
                            });
                        });
                    }
                });
                
                console.log(`${pacienteDiagnosticos.length} diagnósticos carregados.`);
                
            } catch (error) {
                console.error('Erro ao carregar diagnósticos:', error);
            }
        }
        
        // Carregar sinais vitais do paciente
        async function loadSinaisVitaisPaciente() {
            try {
                // Em um sistema real, os sinais vitais estariam em uma subcoleção
                // Por enquanto, vamos simular dados baseados nas consultas
                pacienteSinaisVitais = [];
                
                // Sinais vitais comuns
                const sinais = [
                    { tipo: 'pressao', label: 'Pressão Arterial', unidade: 'mmHg', min: 90, max: 140 },
                    { tipo: 'temperatura', label: 'Temperatura', unidade: '°C', min: 36, max: 37.5 },
                    { tipo: 'frequencia', label: 'Frequência Cardíaca', unidade: 'bpm', min: 60, max: 100 },
                    { tipo: 'saturacao', label: 'Saturação O₂', unidade: '%', min: 95, max: 100 },
                    { tipo: 'glicemia', label: 'Glicemia', unidade: 'mg/dL', min: 70, max: 100 },
                    { tipo: 'peso', label: 'Peso', unidade: 'kg', min: 50, max: 100 },
                    { tipo: 'altura', label: 'Altura', unidade: 'm', min: 1.5, max: 2.0 }
                ];
                
                // Gerar dados simulados para cada consulta
                pacienteConsultas.forEach(consulta => {
                    sinais.forEach(sinal => {
                        const valor = (Math.random() * (sinal.max - sinal.min) + sinal.min).toFixed(1);
                        
                        pacienteSinaisVitais.push({
                            tipo: sinal.tipo,
                            label: sinal.label,
                            valor: valor,
                            unidade: sinal.unidade,
                            data: consulta.dataConsulta,
                            hora: consulta.horaConsulta,
                            consultaId: consulta.id
                        });
                    });
                });
                
                console.log(`${pacienteSinaisVitais.length} sinais vitais carregados.`);
                
            } catch (error) {
                console.error('Erro ao carregar sinais vitais:', error);
            }
        }
        
        // Atualizar estatísticas
        function updateStats() {
            statConsultas.textContent = pacienteConsultas.length;
            statExames.textContent = pacienteExames.length;
            statMedicamentos.textContent = pacienteMedicamentos.length;
        }
        
        // Alternar entre tabs
        function switchTab(tabName) {
            // Remover classe active de todas as tabs
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Ativar tab selecionada
            const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`${tabName}Tab`);
            
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                renderTabContent(tabName);
            }
        }
        
        // Renderizar conteúdo da tab ativa
        function renderActiveTab() {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.dataset.tab;
                renderTabContent(tabName);
            }
        }
        
        // Renderizar conteúdo específico de uma tab
        function renderTabContent(tabName) {
            switch (tabName) {
                case 'resumo':
                    renderResumo();
                    break;
                case 'consultas':
                    renderConsultas();
                    break;
                case 'exames':
                    renderExames();
                    break;
                case 'medicamentos':
                    renderMedicamentos();
                    break;
                case 'alergias':
                    renderAlergias();
                    break;
                case 'diagnosticos':
                    renderDiagnosticos();
                    break;
                case 'vitals':
                    renderSinaisVitais();
                    break;
            }
        }
        
        // Renderizar resumo
        function renderResumo() {
            // Sinais vitais mais recentes
            renderSinaisVitaisResumo();
            
            // Linha do tempo
            renderTimeline();
        }
        
        // Renderizar sinais vitais no resumo
        function renderSinaisVitaisResumo() {
            vitalsGrid.innerHTML = '';
            
            // Agrupar sinais vitais por tipo, pegando o mais recente de cada
            const sinaisAgrupados = {};
            
            pacienteSinaisVitais.forEach(sinal => {
                if (!sinaisAgrupados[sinal.tipo] || new Date(sinal.data) > new Date(sinaisAgrupados[sinal.tipo].data)) {
                    sinaisAgrupados[sinal.tipo] = sinal;
                }
            });
            
            // Renderizar os 6 sinais mais importantes
            const sinaisImportantes = ['pressao', 'temperatura', 'frequencia', 'saturacao', 'glicemia', 'peso'];
            
            sinaisImportantes.forEach(tipo => {
                if (sinaisAgrupados[tipo]) {
                    const sinal = sinaisAgrupados[tipo];
                    
                    const vitalCard = document.createElement('div');
                    vitalCard.className = 'vital-card';
                    
                    vitalCard.innerHTML = `
                        <div class="vital-value">${sinal.valor} ${sinal.unidade}</div>
                        <div class="vital-label">${sinal.label}</div>
                        <div class="vital-date">${formatarData(sinal.data)}</div>
                    `;
                    
                    vitalsGrid.appendChild(vitalCard);
                }
            });
            
            if (Object.keys(sinaisAgrupados).length === 0) {
                vitalsGrid.innerHTML = '<div class="info-alert"><i class="fas fa-info-circle"></i> Nenhum sinal vital registrado.</div>';
            }
        }
        
        // Renderizar linha do tempo
        function renderTimeline() {
            timeline.innerHTML = '';
            
            // Combinar todos os eventos (consultas, exames, etc.)
            const eventos = [];
            
            // Consultas
            pacienteConsultas.forEach(consulta => {
                eventos.push({
                    tipo: 'consulta',
                    data: consulta.dataConsulta,
                    titulo: `Consulta - ${consulta.tipoConsulta || 'Geral'}`,
                    conteudo: consulta.motivoConsulta || 'Consulta realizada',
                    profissional: consulta.profissionalNome
                });
            });
            
            // Exames importantes
            pacienteExames.filter(e => e.tipo === 'alto_risco' || e.tipo === 'alto_custo').forEach(exame => {
                eventos.push({
                    tipo: 'exame',
                    data: exame.dataSolicitacao,
                    titulo: `Exame - ${exame.nome}`,
                    conteudo: exame.observacoes || 'Exame solicitado',
                    status: exame.status
                });
            });
            
            // Ordenar por data (mais recente primeiro)
            eventos.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            if (eventos.length === 0) {
                timeline.innerHTML = '<div class="info-alert"><i class="fas fa-info-circle"></i> Nenhum evento registrado.</div>';
                return;
            }
            
            // Renderizar até 10 eventos mais recentes
            eventos.slice(0, 10).forEach(evento => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                const icon = evento.tipo === 'consulta' ? 'fa-stethoscope' : 
                           evento.tipo === 'exame' ? 'fa-microscope' : 'fa-calendar-check';
                
                timelineItem.innerHTML = `
                    <div class="timeline-date">${formatarData(evento.data)}</div>
                    <div class="timeline-content">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas ${icon}" style="color: #1a5a8a; margin-right: 10px;"></i>
                            <strong>${evento.titulo}</strong>
                        </div>
                        <p>${evento.conteudo}</p>
                        ${evento.profissional ? `<div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Profissional: ${evento.profissional}</div>` : ''}
                        ${evento.status ? `<div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Status: ${evento.status}</div>` : ''}
                    </div>
                `;
                
                timeline.appendChild(timelineItem);
            });
        }
        
        // Renderizar consultas
        function renderConsultas() {
            consultasList.innerHTML = '';
            
            if (pacienteConsultas.length === 0) {
                consultasList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-check"></i>
                        <h3>Nenhuma consulta encontrada</h3>
                        <p>Este paciente ainda não possui consultas registradas.</p>
                    </div>
                `;
                return;
            }
            
            // Atualizar filtro de anos
            updateAnoFilter();
            
            // Atualizar filtro de profissionais
            updateProfissionalFilter();
            
            // Aplicar filtros
            const consultasFiltradas = filterConsultas();
            
            if (consultasFiltradas.length === 0) {
                consultasList.innerHTML = '<div class="info-alert"><i class="fas fa-info-circle"></i> Nenhuma consulta encontrada com os filtros aplicados.</div>';
                return;
            }
            
            consultasFiltradas.forEach(consulta => {
                const consultaItem = document.createElement('div');
                consultaItem.className = 'consulta-item';
                
                const dataFormatada = formatarData(consulta.dataConsulta);
                
                consultaItem.innerHTML = `
                    <div class="consulta-header">
                        <div class="consulta-title">${consulta.tipoConsulta || 'Consulta Geral'}</div>
                        <div class="consulta-date">${dataFormatada} - ${consulta.horaConsulta || ''}</div>
                    </div>
                    <div class="consulta-info">
                        <div><strong>Profissional:</strong> ${consulta.profissionalNome || 'Não informado'}</div>
                        <div><strong>Motivo:</strong> ${consulta.motivoConsulta ? consulta.motivoConsulta.substring(0, 100) + (consulta.motivoConsulta.length > 100 ? '...' : '') : 'Não informado'}</div>
                    </div>
                    <div class="consulta-actions">
                        <button class="view-btn" onclick="viewConsulta('${consulta.id}')">
                            <i class="fas fa-eye"></i> Ver Detalhes
                        </button>
                        <button class="edit-btn" onclick="editConsulta('${consulta.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                `;
                
                consultasList.appendChild(consultaItem);
            });
        }
        
        // Atualizar filtro de anos
        function updateAnoFilter() {
            filterAnoInput.innerHTML = '<option value="">Todos os anos</option>';
            
            const anos = new Set();
            pacienteConsultas.forEach(consulta => {
                if (consulta.dataConsulta) {
                    const ano = consulta.dataConsulta.split('-')[0];
                    anos.add(ano);
                }
            });
            
            Array.from(anos).sort().reverse().forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                filterAnoInput.appendChild(option);
            });
        }
        
        // Atualizar filtro de profissionais
        function updateProfissionalFilter() {
            filterProfissionalInput.innerHTML = '<option value="">Todos os profissionais</option>';
            
            const profissionais = new Set();
            pacienteConsultas.forEach(consulta => {
                if (consulta.profissionalNome) {
                    profissionais.add(consulta.profissionalNome);
                }
            });
            
            Array.from(profissionais).sort().forEach(prof => {
                const option = document.createElement('option');
                option.value = prof;
                option.textContent = prof;
                filterProfissionalInput.appendChild(option);
            });
        }
        
        // Filtrar consultas
        function filterConsultas() {
            const searchTerm = searchConsultasInput.value.toLowerCase();
            const anoFilter = filterAnoInput.value;
            const profissionalFilter = filterProfissionalInput.value;
            
            return pacienteConsultas.filter(consulta => {
                // Busca por texto
                const matchesSearch = !searchTerm || 
                    (consulta.motivoConsulta && consulta.motivoConsulta.toLowerCase().includes(searchTerm)) ||
                    (consulta.tipoConsulta && consulta.tipoConsulta.toLowerCase().includes(searchTerm)) ||
                    (consulta.hipotesesDiagnosticas && consulta.hipotesesDiagnosticas.toLowerCase().includes(searchTerm));
                
                // Filtro por ano
                const matchesAno = !anoFilter || 
                    (consulta.dataConsulta && consulta.dataConsulta.startsWith(anoFilter));
                
                // Filtro por profissional
                const matchesProfissional = !profissionalFilter || 
                    consulta.profissionalNome === profissionalFilter;
                
                return matchesSearch && matchesAno && matchesProfissional;
            });
        }
        
        // Renderizar exames
        function renderExames() {
            examesGrid.innerHTML = '';
            
            if (pacienteExames.length === 0) {
                examesGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-microscope"></i>
                        <h3>Nenhum exame encontrado</h3>
                        <p>Este paciente ainda não possui exames registrados.</p>
                    </div>
                `;
                return;
            }
            
            pacienteExames.forEach(exame => {
                const exameCard = document.createElement('div');
                exameCard.className = 'medication-card';
                
                const tipoExameText = {
                    'laboratorio': 'Laboratório',
                    'imagem': 'Imagem',
                    'alto_custo': 'Alto Custo',
                    'alto_risco': 'Alto Risco',
                    'outro': 'Outro'
                }[exame.tipo] || 'Exame';
                
                const dataFormatada = formatarData(exame.dataSolicitacao);
                
                exameCard.innerHTML = `
                    <div class="medication-name">${exame.nome || 'Exame sem nome'}</div>
                    <div style="margin-bottom: 5px;"><strong>Tipo:</strong> ${tipoExameText}</div>
                    <div style="margin-bottom: 5px;"><strong>Data:</strong> ${dataFormatada}</div>
                    <div style="margin-bottom: 10px;"><strong>Status:</strong> <span style="color: ${exame.status === 'realizado' ? '#27ae60' : exame.status === 'pendente' ? '#f39c12' : '#e74c3c'}">${exame.status || 'Pendente'}</span></div>
                    <div style="font-size: 0.9rem; color: #666;">${exame.observacoes ? `Observações: ${exame.observacoes.substring(0, 100)}${exame.observacoes.length > 100 ? '...' : ''}` : ''}</div>
                `;
                
                examesGrid.appendChild(exameCard);
            });
        }
        
        // Renderizar medicamentos
        function renderMedicamentos() {
            medicationsGrid.innerHTML = '';
            
            if (pacienteMedicamentos.length === 0) {
                medicationsGrid.innerHTML = `
                    <div class="add-item-btn" onclick="openMedicamentoModal()">
                        <i class="fas fa-pills" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>Adicionar Primeiro Medicamento</div>
                    </div>
                `;
                return;
            }
            
            // Agrupar medicamentos por nome (evitar duplicatas)
            const medicamentosUnicos = {};
            
            pacienteMedicamentos.forEach(med => {
                if (!medicamentosUnicos[med.nome]) {
                    medicamentosUnicos[med.nome] = med;
                }
            });
            
            Object.values(medicamentosUnicos).forEach(med => {
                const medCard = document.createElement('div');
                medCard.className = 'medication-card';
                
                medCard.innerHTML = `
                    <div class="medication-name">${med.nome}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        <i class="far fa-calendar"></i> Prescrito em: ${formatarData(med.data)}
                    </div>
                `;
                
                medicationsGrid.appendChild(medCard);
            });
            
            // Adicionar botão para novo medicamento
            const addButton = document.createElement('div');
            addButton.className = 'add-item-btn';
            addButton.onclick = openMedicamentoModal;
            addButton.innerHTML = `
                <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>Adicionar Novo Medicamento</div>
            `;
            
            medicationsGrid.appendChild(addButton);
        }
        
        // Renderizar alergias
        function renderAlergias() {
            allergiesGrid.innerHTML = '';
            
            if (pacienteAlergias.length === 0) {
                allergiesGrid.innerHTML = `
                    <div class="add-item-btn" onclick="openAlergiaModal()">
                        <i class="fas fa-allergies" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <div>Adicionar Primeira Alergia</div>
                    </div>
                `;
                return;
            }
            
            pacienteAlergias.forEach(alergia => {
                const alergiaCard = document.createElement('div');
                alergiaCard.className = 'allergy-card';
                
                const gravidadeCor = {
                    'leve': '#27ae60',
                    'moderada': '#f39c12',
                    'grave': '#e74c3c',
                    'severa': '#c0392b'
                }[alergia.gravidade] || '#95a5a6';
                
                alergiaCard.innerHTML = `
                    <div class="allergy-name">${alergia.nome}</div>
                    <div style="margin-bottom: 5px;">
                        <strong>Gravidade:</strong> 
                        <span style="color: ${gravidadeCor}">${alergia.gravidade || 'Não especificada'}</span>
                    </div>
                    <div><strong>Tipo:</strong> ${alergia.tipo || 'Não especificado'}</div>
                `;
                
                allergiesGrid.appendChild(alergiaCard);
            });
            
            // Adicionar botão para nova alergia
            const addButton = document.createElement('div');
            addButton.className = 'add-item-btn';
            addButton.onclick = openAlergiaModal;
            addButton.innerHTML = `
                <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>Adicionar Nova Alergia</div>
            `;
            
            allergiesGrid.appendChild(addButton);
        }
        
        // Renderizar diagnósticos
        function renderDiagnosticos() {
            diagnosesGrid.innerHTML = '';
            
            if (pacienteDiagnosticos.length === 0) {
                diagnosesGrid.innerHTML = `
                    <div class="info-alert">
                        <i class="fas fa-info-circle"></i>
                        <div>Nenhum diagnóstico registrado. Os diagnósticos são extraídos automaticamente das consultas.</div>
                    </div>
                `;
                return;
            }
            
            // Agrupar diagnósticos por nome
            const diagnosticosUnicos = {};
            
            pacienteDiagnosticos.forEach(diag => {
                if (!diagnosticosUnicos[diag.nome]) {
                    diagnosticosUnicos[diag.nome] = diag;
                }
            });
            
            Object.values(diagnosticosUnicos).forEach(diag => {
                const diagCard = document.createElement('div');
                diagCard.className = 'diagnosis-card';
                
                diagCard.innerHTML = `
                    <div class="diagnosis-name">${diag.nome}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        <i class="far fa-calendar"></i> Diagnosticado em: ${formatarData(diag.data)}
                        <br>
                        <i class="fas fa-user-md"></i> Por: ${diag.profissional}
                    </div>
                `;
                
                diagnosesGrid.appendChild(diagCard);
            });
        }
        
        // Renderizar sinais vitais
        function renderSinaisVitais() {
            allVitalsGrid.innerHTML = '';
            
            if (pacienteSinaisVitais.length === 0) {
                allVitalsGrid.innerHTML = `
                    <div class="info-alert">
                        <i class="fas fa-info-circle"></i>
                        <div>Nenhum sinal vital registrado.</div>
                    </div>
                `;
                return;
            }
            
            // Agrupar por tipo e ordenar por data
            const sinaisPorTipo = {};
            
            pacienteSinaisVitais.forEach(sinal => {
                if (!sinaisPorTipo[sinal.tipo]) {
                    sinaisPorTipo[sinal.tipo] = [];
                }
                sinaisPorTipo[sinal.tipo].push(sinal);
            });
            
            // Ordenar cada grupo por data (mais recente primeiro)
            Object.keys(sinaisPorTipo).forEach(tipo => {
                sinaisPorTipo[tipo].sort((a, b) => new Date(b.data) - new Date(a.data));
            });
            
            // Renderizar os 12 sinais mais recentes de cada tipo
            Object.keys(sinaisPorTipo).forEach(tipo => {
                const sinais = sinaisPorTipo[tipo].slice(0, 12);
                
                sinais.forEach(sinal => {
                    const vitalCard = document.createElement('div');
                    vitalCard.className = 'vital-card';
                    
                    vitalCard.innerHTML = `
                        <div class="vital-value">${sinal.valor} ${sinal.unidade}</div>
                        <div class="vital-label">${sinal.label}</div>
                        <div class="vital-date">${formatarData(sinal.data)} ${sinal.hora || ''}</div>
                    `;
                    
                    allVitalsGrid.appendChild(vitalCard);
                });
            });
        }
        
        // Formatar data
        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }
        
        // Criar gráficos
        function createCharts() {
            // Destruir gráficos existentes
            if (consultasChart) consultasChart.destroy();
            if (examesChart) examesChart.destroy();
            if (pressaoChart) pressaoChart.destroy();
            if (glicemiaChart) glicemiaChart.destroy();
            
            // Gráfico de consultas por mês
            createConsultasChart();
            
            // Gráfico de tipos de exames
            createExamesChart();
            
            // Gráfico de evolução da pressão arterial
            createPressaoChart();
            
            // Gráfico de evolução da glicemia
            createGlicemiaChart();
        }
        
        // Criar gráfico de consultas por mês
        function createConsultasChart() {
            const ctx = document.getElementById('consultasChart').getContext('2d');
            
            // Agrupar consultas por mês
            const consultasPorMes = {};
            
            pacienteConsultas.forEach(consulta => {
                if (consulta.dataConsulta) {
                    const data = new Date(consulta.dataConsulta);
                    const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
                    
                    if (!consultasPorMes[mesAno]) {
                        consultasPorMes[mesAno] = 0;
                    }
                    consultasPorMes[mesAno]++;
                }
            });
            
            const labels = Object.keys(consultasPorMes);
            const data = Object.values(consultasPorMes);
            
            consultasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Consultas',
                        data: data,
                        backgroundColor: 'rgba(26, 90, 138, 0.7)',
                        borderColor: 'rgba(26, 90, 138, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Criar gráfico de tipos de exames
        function createExamesChart() {
            const ctx = document.getElementById('examesChart').getContext('2d');
            
            // Contar exames por tipo
            const examesPorTipo = {};
            
            pacienteExames.forEach(exame => {
                const tipo = exame.tipo || 'outro';
                if (!examesPorTipo[tipo]) {
                    examesPorTipo[tipo] = 0;
                }
                examesPorTipo[tipo]++;
            });
            
            const tipos = {
                'laboratorio': 'Laboratório',
                'imagem': 'Imagem',
                'alto_custo': 'Alto Custo',
                'alto_risco': 'Alto Risco',
                'outro': 'Outro'
            };
            
            const labels = Object.keys(examesPorTipo).map(tipo => tipos[tipo] || tipo);
            const data = Object.values(examesPorTipo);
            
            // Cores para cada tipo
            const cores = [
                'rgba(52, 152, 219, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(241, 196, 15, 0.7)',
                'rgba(231, 76, 60, 0.7)',
                'rgba(149, 165, 166, 0.7)'
            ];
            
            examesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: cores.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Criar gráfico de evolução da pressão arterial
        function createPressaoChart() {
            const ctx = document.getElementById('pressaoChart').getContext('2d');
            
            // Filtrar sinais de pressão arterial
            const pressoes = pacienteSinaisVitais
                .filter(s => s.tipo === 'pressao')
                .sort((a, b) => new Date(a.data) - new Date(b.data));
            
            if (pressoes.length === 0) {
                document.getElementById('pressaoChart').parentElement.innerHTML = '<div class="info-alert"><i class="fas fa-info-circle"></i> Nenhum dado de pressão arterial disponível.</div>';
                return;
            }
            
            const labels = pressoes.map(s => formatarData(s.data));
            const data = pressoes.map(s => parseFloat(s.valor));
            
            pressaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pressão Arterial (mmHg)',
                        data: data,
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        // Criar gráfico de evolução da glicemia
        function createGlicemiaChart() {
            const ctx = document.getElementById('glicemiaChart').getContext('2d');
            
            // Filtrar sinais de glicemia
            const glicemias = pacienteSinaisVitais
                .filter(s => s.tipo === 'glicemia')
                .sort((a, b) => new Date(a.data) - new Date(b.data));
            
            if (glicemias.length === 0) {
                document.getElementById('glicemiaChart').parentElement.innerHTML = '<div class="info-alert"><i class="fas fa-info-circle"></i> Nenhum dado de glicemia disponível.</div>';
                return;
            }
            
            const labels = glicemias.map(s => formatarData(s.data));
            const data = glicemias.map(s => parseFloat(s.valor));
            
            glicemiaChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Glicemia (mg/dL)',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        // Visualizar consulta
        async function viewConsulta(consultaId) {
            try {
                const consulta = pacienteConsultas.find(c => c.id === consultaId);
                if (!consulta) return;
                
                // Buscar exames desta consulta
                const examesDaConsulta = pacienteExames.filter(e => e.consultaId === consultaId);
                
                consultaModalTitle.textContent = `Consulta - ${formatarData(consulta.dataConsulta)}`;
                
                consultaModalBody.innerHTML = `
                    <div style="padding: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <strong>Data:</strong> ${formatarData(consulta.dataConsulta)}<br>
                                <strong>Hora:</strong> ${consulta.horaConsulta || 'Não informada'}<br>
                                <strong>Profissional:</strong> ${consulta.profissionalNome || 'Não informado'}
                            </div>
                            <div>
                                <strong>Tipo:</strong> ${consulta.tipoConsulta || 'Geral'}<br>
                                <strong>Status:</strong> ${consulta.status || 'Realizada'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Motivo da Consulta</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.motivoConsulta || 'Não informado'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Queixa Principal</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.queixaPrincipal || 'Não informado'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Histórico da Doença Atual</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.historicoAtual || 'Não informado'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Exame Físico</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.exameFisico || 'Não informado'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Hipóteses Diagnósticas</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.hipotesesDiagnosticas || 'Não informado'}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Conduta Médica</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${consulta.conduta || 'Não informado'}
                            </div>
                        </div>
                        
                        ${examesDaConsulta.length > 0 ? `
                        <div class="form-group">
                            <label>Exames Solicitados (${examesDaConsulta.length})</label>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                                ${examesDaConsulta.map(exame => `
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                                        <strong>${exame.nome}</strong><br>
                                        <small>Tipo: ${exame.tipo || 'Não informado'} | Status: ${exame.status || 'Pendente'}</small>
                                        ${exame.observacoes ? `<br><small>Observações: ${exame.observacoes}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="button-group">
                            <button onclick="editConsulta('${consultaId}')" style="background: linear-gradient(to right, #f39c12, #e67e22);">
                                <i class="fas fa-edit"></i> Editar Consulta
                            </button>
                            <button onclick="consultaModal.style.display='none'" style="background: linear-gradient(to right, #95a5a6, #7f8c8d);">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                consultaModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Erro ao visualizar consulta:', error);
                showMessage('Erro ao carregar detalhes da consulta.', 'error');
            }
        }
        
        // Editar consulta (redireciona para página de consultas)
        function editConsulta(consultaId) {
            // Em um sistema real, redirecionaria para a página de edição de consultas
            showMessage('Redirecionando para edição da consulta...', 'loading');
            setTimeout(() => {
                // Simulação - em sistema real, seria um redirecionamento
                window.open(`consultas.html?edit=${consultaId}`, '_blank');
            }, 1000);
        }
        
        // Abrir modal de medicamento
        function openMedicamentoModal() {
            medicamentoModalBody.innerHTML = `
                <div style="padding: 10px;">
                    <div class="form-group">
                        <label for="medNome">Nome do Medicamento <span class="required">*</span></label>
                        <input type="text" id="medNome" placeholder="Ex: Dipirona 500mg">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="medDose">Dose</label>
                            <input type="text" id="medDose" placeholder="Ex: 1 comprimido">
                        </div>
                        
                        <div class="form-group">
                            <label for="medFrequencia">Frequência</label>
                            <input type="text" id="medFrequencia" placeholder="Ex: A cada 6 horas">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="medVia">Via de Administração</label>
                            <select id="medVia">
                                <option value="">Selecione</option>
                                <option value="oral">Oral</option>
                                <option value="topica">Tópica</option>
                                <option value="injetavel">Injetável</option>
                                <option value="inalatoria">Inalatória</option>
                                <option value="outra">Outra</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="medDuracao">Duração do Tratamento</label>
                            <input type="text" id="medDuracao" placeholder="Ex: 7 dias">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="medIndicacao">Indicação</label>
                        <textarea id="medIndicacao" placeholder="Para que o medicamento foi prescrito" rows="3"></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button id="saveMedicamentoBtn" style="background: linear-gradient(to right, #27ae60, #219653);">
                            <i class="fas fa-save"></i> Salvar Medicamento
                        </button>
                        <button id="cancelMedicamentoBtn" style="background: linear-gradient(to right, #95a5a6, #7f8c8d);">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            medicamentoModal.style.display = 'flex';
            
            // Event listeners
            document.getElementById('saveMedicamentoBtn').addEventListener('click', saveMedicamento);
            document.getElementById('cancelMedicamentoBtn').addEventListener('click', () => {
                medicamentoModal.style.display = 'none';
            });
        }
        
        // Salvar medicamento
        async function saveMedicamento() {
            const nome = document.getElementById('medNome').value;
            
            if (!nome) {
                showMessage('Por favor, informe o nome do medicamento.', 'error');
                return;
            }
            
            try {
                // Em um sistema real, salvaríamos na subcoleção do prontuário
                const medicamentoData = {
                    nome: nome,
                    dose: document.getElementById('medDose').value,
                    frequencia: document.getElementById('medFrequencia').value,
                    via: document.getElementById('medVia').value,
                    duracao: document.getElementById('medDuracao').value,
                    indicacao: document.getElementById('medIndicacao').value,
                    pacienteId: currentPacienteId,
                    profissionalUID: currentUser.uid,
                    profissionalNome: currentUser.displayName,
                    dataRegistro: new Date()
                };
                
                // Aqui salvaríamos no Firebase
                // await prontuariosRef.doc(currentPacienteId).collection('medicamentos').add(medicamentoData);
                
                // Por enquanto, apenas adicionar à lista local
                pacienteMedicamentos.push({
                    nome: nome,
                    data: new Date()
                });
                
                medicamentoModal.style.display = 'none';
                showMessage('Medicamento adicionado com sucesso!', 'success');
                
                // Atualizar exibição
                renderMedicamentos();
                updateStats();
                
            } catch (error) {
                console.error('Erro ao salvar medicamento:', error);
                showMessage('Erro ao salvar medicamento. Tente novamente.', 'error');
            }
        }
        
        // Abrir modal de alergia
        function openAlergiaModal() {
            alergiaModalBody.innerHTML = `
                <div style="padding: 10px;">
                    <div class="form-group">
                        <label for="alergiaNome">Substância/Medicamento <span class="required">*</span></label>
                        <input type="text" id="alergiaNome" placeholder="Ex: Penicilina, Amendoim, etc.">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="alergiaTipo">Tipo de Alergia</label>
                            <select id="alergiaTipo">
                                <option value="medicamento">Medicamento</option>
                                <option value="alimento">Alimento</option>
                                <option value="ambiente">Ambiente (pólen, ácaro)</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="alergiaGravidade">Gravidade</label>
                            <select id="alergiaGravidade">
                                <option value="leve">Leve</option>
                                <option value="moderada">Moderada</option>
                                <option value="grave">Grave</option>
                                <option value="severa">Severa (Anafilaxia)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="alergiaSintomas">Sintomas</label>
                        <textarea id="alergiaSintomas" placeholder="Descreva os sintomas apresentados" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="alergiaReacao">Tipo de Reação</label>
                        <input type="text" id="alergiaReacao" placeholder="Ex: Urticária, Edema, Dificuldade respiratória">
                    </div>
                    
                    <div class="button-group">
                        <button id="saveAlergiaBtn" style="background: linear-gradient(to right, #27ae60, #219653);">
                            <i class="fas fa-save"></i> Salvar Alergia
                        </button>
                        <button id="cancelAlergiaBtn" style="background: linear-gradient(to right, #95a5a6, #7f8c8d);">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            alergiaModal.style.display = 'flex';
            
            // Event listeners
            document.getElementById('saveAlergiaBtn').addEventListener('click', saveAlergia);
            document.getElementById('cancelAlergiaBtn').addEventListener('click', () => {
                alergiaModal.style.display = 'none';
            });
        }
        
        // Salvar alergia
        async function saveAlergia() {
            const nome = document.getElementById('alergiaNome').value;
            
            if (!nome) {
                showMessage('Por favor, informe a substância/alergeno.', 'error');
                return;
            }
            
            try {
                const alergiaData = {
                    nome: nome,
                    tipo: document.getElementById('alergiaTipo').value,
                    gravidade: document.getElementById('alergiaGravidade').value,
                    sintomas: document.getElementById('alergiaSintomas').value,
                    reacao: document.getElementById('alergiaReacao').value,
                    pacienteId: currentPacienteId,
                    profissionalUID: currentUser.uid,
                    profissionalNome: currentUser.displayName,
                    dataRegistro: new Date()
                };
                
                // Aqui salvaríamos no Firebase
                // await prontuariosRef.doc(currentPacienteId).collection('alergias').add(alergiaData);
                
                // Por enquanto, apenas adicionar à lista local
                pacienteAlergias.push({
                    nome: nome,
                    tipo: alergiaData.tipo,
                    gravidade: alergiaData.gravidade
                });
                
                alergiaModal.style.display = 'none';
                showMessage('Alergia registrada com sucesso!', 'success');
                
                // Atualizar exibição
                renderAlergias();
                updatePatientSidebar(); // Para atualizar alerta de emergência
                
            } catch (error) {
                console.error('Erro ao salvar alergia:', error);
                showMessage('Erro ao salvar alergia. Tente novamente.', 'error');
            }
        }
        
        // Agendar consulta rápida
        async function agendarConsultaRapida() {
            const data = consultaDataInput.value;
            const hora = consultaHoraInput.value;
            const motivo = consultaMotivoInput.value;
            
            if (!data || !hora) {
                showMessage('Por favor, informe data e hora.', 'error');
                return;
            }
            
            if (!motivo) {
                showMessage('Por favor, informe o motivo da consulta.', 'error');
                return;
            }
            
            try {
                const consultaData = {
                    pacienteId: currentPacienteId,
                    dataConsulta: data,
                    horaConsulta: hora,
                    motivoConsulta: motivo,
                    tipoConsulta: 'consulta_rapida',
                    status: 'agendada',
                    profissionalUID: currentUser.uid,
                    profissionalNome: currentUser.displayName,
                    dataCriacao: new Date()
                };
                
                await consultasRef.add(consultaData);
                
                showMessage('Consulta agendada com sucesso!', 'success');
                
                // Limpar formulário
                consultaMotivoInput.value = '';
                
                // Recarregar consultas
                await loadConsultasPaciente();
                updateStats();
                
                // Atualizar exibição se estiver na tab de consultas
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.dataset.tab === 'consultas') {
                    renderConsultas();
                }
                
            } catch (error) {
                console.error('Erro ao agendar consulta:', error);
                showMessage('Erro ao agendar consulta. Tente novamente.', 'error');
            }
        }
        
        // Exportar prontuário para PDF (simulação)
        function exportProntuario() {
            showMessage('Gerando PDF do prontuário...', 'loading');
            
            setTimeout(() => {
                showMessage('PDF gerado com sucesso! O download começará em breve.', 'success');
                
                // Em um sistema real, geraria um PDF com todas as informações
                // Por enquanto, apenas simulação
            }, 2000);
        }
        
        // Buscar paciente por CPF/nome
        function buscarPaciente() {
            const termo = prompt('Digite o CPF ou nome do paciente:');
            if (!termo) return;
            
            showMessage(`Buscando paciente: ${termo}...`, 'loading');
            
            // Em um sistema real, faria uma busca no Firebase
            // Por enquanto, apenas simulação
            setTimeout(() => {
                showMessage('Paciente não encontrado na busca rápida. Use a lista completa.', 'error');
            }, 1500);
        }
        
        // Inicializar event listeners
        function initEventListeners() {
            // Selecionar paciente
            patientSelect.addEventListener('change', function() {
                selectPaciente(this.value);
            });
            
            // Buscar paciente
            searchPatientBtn.addEventListener('click', buscarPaciente);
            
            // Agendar consulta rápida
            quickConsultaBtn.addEventListener('click', agendarConsultaRapida);
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // Filtros de consultas
            searchConsultasInput.addEventListener('input', () => {
                if (document.querySelector('#consultasTab').classList.contains('active')) {
                    renderConsultas();
                }
            });
            
            filterAnoInput.addEventListener('change', () => {
                if (document.querySelector('#consultasTab').classList.contains('active')) {
                    renderConsultas();
                }
            });
            
            filterProfissionalInput.addEventListener('change', () => {
                if (document.querySelector('#consultasTab').classList.contains('active')) {
                    renderConsultas();
                }
            });
            
            // Botões
            exportProntuarioBtn.addEventListener('click', exportProntuario);
            novaConsultaBtn.addEventListener('click', () => {
                // Redirecionar para página de nova consulta
                window.open('consultas.html', '_blank');
            });
            
            addMedicamentoBtn.addEventListener('click', openMedicamentoModal);
            addAlergiaBtn.addEventListener('click', openAlergiaModal);
            addDiagnosticoBtn.addEventListener('click', () => {
                showMessage('Os diagnósticos são registrados automaticamente nas consultas.', 'info');
            });
            
            addVitalBtn.addEventListener('click', () => {
                showMessage('Os sinais vitais são registrados automaticamente nas consultas.', 'info');
            });
            
            // Voltar ao sistema
            backButton.addEventListener('click', (e) => {
                e.preventDefault();
                window.history.back();
            });
            
            // Fechar modais
            closeConsultaModal.addEventListener('click', () => {
                consultaModal.style.display = 'none';
            });
            
            closeMedicamentoModal.addEventListener('click', () => {
                medicamentoModal.style.display = 'none';
            });
            
            closeAlergiaModal.addEventListener('click', () => {
                alergiaModal.style.display = 'none';
            });
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === consultaModal) consultaModal.style.display = 'none';
                if (e.target === medicamentoModal) medicamentoModal.style.display = 'none';
                if (e.target === alergiaModal) alergiaModal.style.display = 'none';
            });
        }
        
        // Inicializar aplicação
        function init() {
            loadCurrentUser();
            initEventListeners();
            
            console.log('Sistema de Prontuário Eletrônico inicializado com sucesso!');
            console.log('Estrutura do prontuário:');
            console.log('- Cada paciente tem um prontuário único vinculado ao seu UID');
            console.log('- As consultas são vinculadas ao prontuário através do pacienteId');
            console.log('- Subcoleções: medicamentos, alergias, sinais_vitais, etc.');
        }
        
        // Iniciar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
        
        // Exportar funções para uso global
        window.viewConsulta = viewConsulta;
        window.editConsulta = editConsulta;
        window.openMedicamentoModal = openMedicamentoModal;
        window.openAlergiaModal = openAlergiaModal;
    </script>
</body>
</html>
