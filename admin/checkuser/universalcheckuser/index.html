// CÃ³digo para registro de dados na coleÃ§Ã£o "checkuser"
// Salve este cÃ³digo em um arquivo separado para usar em um iframe

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
};

// Inicializar Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    serverTimestamp,
    doc,
    setDoc,
    getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Constantes
const USER_LOGS_COLLECTION = "checkuser";

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: GERAR ID DE SESSÃƒO
// -------------------------------------------------------------
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: OBTER CONTAGEM DE LOGINS
// -------------------------------------------------------------
async function getLoginCount(uid) {
    try {
        const userDocRef = doc(db, "users", uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            return userDoc.data().loginCount || 0;
        }
        return 0;
    } catch (error) {
        console.error("Erro ao obter contagem de logins:", error);
        return 0;
    }
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: OBTER DADOS DE IP E LOCALIZAÃ‡ÃƒO
// -------------------------------------------------------------
async function getIPData() {
    try {
        const response = await fetch('https://ipinfo.io/json');
        const data = await response.json();
        return data;
    } catch (error) {
        console.error("Erro ao obter dados de IP:", error);
        return {
            ip: 'N/A',
            city: 'Desconhecida',
            region: 'Desconhecido',
            country: 'Desconhecido',
            loc: 'N/A',
            org: 'N/A',
            postal: 'N/A',
            timezone: 'N/A'
        };
    }
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: REGISTRAR LOG NO FIRESTORE (SIMPLIFICADA)
// -------------------------------------------------------------
async function registerUserLog(user, action = "iframe_access") {
    try {
        // Se nÃ£o houver usuÃ¡rio, nÃ£o registra
        if (!user) {
            console.warn("UsuÃ¡rio nÃ£o disponÃ­vel para registrar log.");
            return;
        }

        // Coletar informaÃ§Ãµes do navegador
        const browserInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            colorDepth: window.screen.colorDepth,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            referrer: document.referrer,
            pageUrl: window.location.href
        };

        // Coletar informaÃ§Ãµes de localizaÃ§Ã£o
        const ipData = await getIPData();
        const locationInfo = {
            ip: ipData?.ip || 'N/A',
            city: ipData?.city || 'Desconhecida',
            region: ipData?.region || 'Desconhecido',
            country: ipData?.country || 'Desconhecido',
            loc: ipData?.loc || 'N/A',
            org: ipData?.org || 'N/A',
            postal: ipData?.postal || 'N/A',
            timezone: ipData?.timezone || 'N/A'
        };

        // InformaÃ§Ãµes do usuÃ¡rio
        const userInfo = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            providerId: user.providerId,
            emailVerified: user.emailVerified
        };

        // Dados completos para log
        const logData = {
            user: userInfo,
            location: locationInfo,
            browser: browserInfo,
            action: action,
            timestamp: serverTimestamp(),
            clientTimestamp: new Date().toISOString(),
            sessionId: generateSessionId(),
            source: "iframe_logger"
        };

        // Registrar no Firestore
        const logsRef = collection(db, USER_LOGS_COLLECTION);
        await addDoc(logsRef, logData);
        
        console.log("âœ… Log registrado com sucesso no Firebase - ColeÃ§Ã£o: checkuser");
        
        // Atualizar Ãºltimo acesso no documento do usuÃ¡rio
        try {
            const userDocRef = doc(db, "users", user.uid);
            const loginCount = await getLoginCount(user.uid);
            await setDoc(userDocRef, {
                lastLogin: serverTimestamp(),
                lastIP: locationInfo.ip,
                lastLocation: `${locationInfo.city}, ${locationInfo.region}, ${locationInfo.country}`,
                loginCount: loginCount + 1,
                lastAccessFromIframe: true
            }, { merge: true });
        } catch (updateError) {
            console.warn("Aviso: NÃ£o foi possÃ­vel atualizar documento do usuÃ¡rio:", updateError);
        }
        
        // Enviar mensagem de confirmaÃ§Ã£o para o parent
        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'LOGGING_SUCCESS',
                userId: user.uid,
                timestamp: new Date().toISOString(),
                action: action
            }, '*');
        }
        
        return logData;
        
    } catch (error) {
        console.error("âŒ Erro ao registrar log:", error);
        
        // Enviar mensagem de erro para o parent
        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'LOGGING_ERROR',
                error: error.message,
                timestamp: new Date().toISOString()
            }, '*');
        }
        
        throw error;
    }
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: REGISTRAR EVENTO ESPECÃFICO
// -------------------------------------------------------------
async function logUserEvent(eventType, additionalData = {}) {
    const user = auth.currentUser;
    if (!user) return null;
    
    try {
        const logData = {
            userUid: user.uid,
            userEmail: user.email,
            eventType: eventType,
            additionalData: additionalData,
            timestamp: new Date().toISOString(),
            pageUrl: window.location.href
        };
        
        const logsRef = collection(db, "user_events");
        await addDoc(logsRef, logData);
        
        console.log(`âœ… Evento "${eventType}" registrado`);
        return logData;
    } catch (error) {
        console.error(`âŒ Erro ao registrar evento "${eventType}":`, error);
        return null;
    }
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: VERIFICAR SE USUÃRIO ESTÃ LOGADO E REGISTRAR
// -------------------------------------------------------------
async function checkAndLogUser() {
    return new Promise((resolve, reject) => {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const logResult = await registerUserLog(user, "iframe_access");
                    resolve({
                        success: true,
                        user: user,
                        log: logResult
                    });
                } catch (error) {
                    reject(error);
                }
            } else {
                resolve({
                    success: false,
                    message: "UsuÃ¡rio nÃ£o autenticado"
                });
            }
        });
    });
}

// -------------------------------------------------------------
// ðŸš€ FUNÃ‡ÃƒO: INICIALIZAR REGISTRADOR
// -------------------------------------------------------------
async function initializeLogger() {
    console.log("ðŸ”„ Inicializando registrador de logs...");
    
    try {
        const result = await checkAndLogUser();
        
        if (result.success) {
            console.log("âœ… Registrador inicializado com sucesso!");
            console.log("ðŸ‘¤ UsuÃ¡rio:", result.user.email);
            
            // Registrar evento de inicializaÃ§Ã£o
            await logUserEvent("iframe_logger_initialized", {
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                userAgent: navigator.userAgent.substring(0, 100)
            });
            
            return result;
        } else {
            console.log("âš ï¸ UsuÃ¡rio nÃ£o autenticado - Log nÃ£o registrado");
            return result;
        }
    } catch (error) {
        console.error("âŒ Falha ao inicializar registrador:", error);
        throw error;
    }
}

// -------------------------------------------------------------
// ðŸš€ EXPORTAR FUNÃ‡Ã•ES PARA USO EXTERNO
// -------------------------------------------------------------
window.iframeLogger = {
    initialize: initializeLogger,
    logEvent: logUserEvent,
    registerLog: registerUserLog,
    getCurrentUser: () => auth.currentUser
};

// Auto-inicializar quando o script for carregado
document.addEventListener('DOMContentLoaded', function() {
    console.log("ðŸ“ Script de registro de logs carregado");
    
    // Inicializar automaticamente apÃ³s um pequeno delay
    setTimeout(async () => {
        try {
            await initializeLogger();
        } catch (error) {
            console.warn("âš ï¸ NÃ£o foi possÃ­vel auto-inicializar o registrador:", error);
        }
    }, 1000);
});

// Ouvir mensagens do parent
window.addEventListener('message', async function(event) {
    // Verificar origem se necessÃ¡rio (para produÃ§Ã£o, verifique a origem)
    // if (event.origin !== "https://seu-dominio.com") return;
    
    if (event.data && event.data.type === 'REQUEST_LOG') {
        try {
            const user = auth.currentUser;
            if (user) {
                const logResult = await registerUserLog(user, event.data.action || "manual_request");
                event.source.postMessage({
                    type: 'LOG_RESPONSE',
                    success: true,
                    data: logResult
                }, event.origin);
            } else {
                event.source.postMessage({
                    type: 'LOG_RESPONSE',
                    success: false,
                    message: "UsuÃ¡rio nÃ£o autenticado"
                }, event.origin);
            }
        } catch (error) {
            event.source.postMessage({
                type: 'LOG_RESPONSE',
                success: false,
                error: error.message
            }, event.origin);
        }
    }
});

// Verificar autenticaÃ§Ã£o em intervalos (para capturar logins que aconteÃ§am apÃ³s o carregamento)
setInterval(() => {
    const user = auth.currentUser;
    if (user && !window.lastLoggedUser) {
        console.log("ðŸ”„ UsuÃ¡rio autenticado detectado, registrando log...");
        registerUserLog(user, "interval_check");
        window.lastLoggedUser = user.uid;
    } else if (!user && window.lastLoggedUser) {
        console.log("ðŸ”’ UsuÃ¡rio deslogado detectado");
        window.lastLoggedUser = null;
    }
}, 30000); // Verificar a cada 30 segundos
