<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Advertências</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --cor-primaria: #4361ee;
            --cor-secundaria: #3a0ca3;
            --cor-perigo: #dc3545;
            --cor-sucesso: #28a745;
            --cor-aviso: #ffc107;
            --cor-info: #17a2b8;
            --cor-texto: #333;
            --cor-texto-claro: #666;
            --cor-fundo: #f8f9fa;
            --cor-borda: #dee2e6;
            --cor-card: #fff;
            --sombra: 0 4px 6px rgba(0, 0, 0, 0.1);
            --sombra-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--cor-texto);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Container */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }

        .login-card h2 {
            color: var(--cor-primaria);
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .login-card p {
            color: var(--cor-texto-claro);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .btn-google {
            background: #DB4437;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }

        .btn-google:hover {
            background: #C33C2F;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(219, 68, 55, 0.4);
        }

        /* Main Content */
        #mainContent {
            display: none;
        }

        .user-header {
            display: none;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--sombra);
            justify-content: space-between;
            align-items: center;
        }

        .user-info-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cor-primaria);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .btn-logout {
            background: var(--cor-perigo);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--sombra);
            text-align: center;
            border-left: 5px solid var(--cor-primaria);
        }

        .header h1 {
            color: var(--cor-primaria);
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: var(--cor-texto-claro);
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--cor-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--sombra);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 5px solid var(--cor-primaria);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--sombra-hover);
        }

        .card-title {
            color: var(--cor-primaria);
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Formulário */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--cor-texto);
            font-size: 0.95em;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--cor-borda);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--cor-primaria);
            background: white;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-block {
            width: 100%;
        }

        /* Lista de Advertências */
        .advertencias-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .advertencia-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--cor-perigo);
            transition: all 0.3s;
        }

        .advertencia-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .advertencia-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .advertencia-titulo {
            font-weight: 700;
            color: var(--cor-perigo);
            font-size: 1.1em;
        }

        .advertencia-data {
            font-size: 0.85em;
            color: var(--cor-texto-claro);
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .advertencia-conteudo {
            color: var(--cor-texto);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .advertencia-acoes {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Mensagens */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .message.show {
            display: block;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--cor-primaria);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--cor-texto-claro);
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-ativa {
            background-color: #ffeaea;
            color: #dc3545;
        }

        .status-resolvida {
            background-color: #e8f5e9;
            color: #28a745;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--cor-texto-claro);
        }

        .loading::after {
            content: ".";
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: var(--cor-perigo);
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--cor-texto-claro);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--cor-perigo);
        }
    </style>
</head>
<body>
    <!-- Container de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h2><i class="fas fa-shield-alt"></i> Sistema de Advertências</h2>
            <p>Faça login com sua conta Google para acessar o sistema de gerenciamento de advertências.</p>
            <button id="btnGoogleLogin" class="btn-google">
                <i class="fab fa-google"></i> Entrar com Google
            </button>
            <div style="margin-top: 20px; color: #666; font-size: 0.9em;">
                <p><strong>Apenas administradores podem acessar este sistema.</strong></p>
                <p id="loginStatus" style="margin-top: 10px; font-size: 0.8em;">Aguardando login...</p>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="mainContent" class="container">
        <!-- Cabeçalho do Usuário -->
        <div id="userHeader" class="user-header">
            <div class="user-info-left">
                <div class="user-avatar-small" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div id="currentUserName" style="font-weight: 600;">Usuário</div>
                    <div id="currentUserEmail" style="font-size: 0.9em; color: #666;">usuario@email.com</div>
                </div>
            </div>
            <button id="btnLogout" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>

        <!-- Cabeçalho Principal -->
        <div class="header">
            <h1><i class="fas fa-exclamation-triangle"></i> Sistema de Advertências</h1>
            <p>Gerencie advertências para usuários do sistema</p>
        </div>

        <!-- Área de Mensagens -->
        <div id="messageArea"></div>

        <!-- Conteúdo Principal -->
        <div class="main-content">
            <!-- Painel de Estatísticas e Busca -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-bar"></i> Estatísticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAdvertencias">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="advertenciasAtivas">0</div>
                        <div class="stat-label">Ativas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="advertenciasResolvidas">0</div>
                        <div class="stat-label">Resolvidas</div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <h3 style="color: var(--cor-primaria); margin-bottom: 15px; font-size: 1.1em;">
                        <i class="fas fa-search"></i> Buscar Usuário
                    </h3>
                    <div class="form-group">
                        <label class="form-label">UID do Usuário</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="searchUserId" class="form-control" 
                                   placeholder="Cole o UID do usuário">
                            <button id="btnSearchById" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <small style="color: var(--cor-texto-claro); margin-top: 5px; display: block;">
                            Para encontrar o UID: Acesse a página do usuário no sistema principal e copie da URL
                        </small>
                    </div>
                </div>
            </div>

            <!-- Formulário de Advertência -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-plus-circle"></i> Nova Advertência</h2>
                <form id="advertenciaForm">
                    <div class="form-group">
                        <label class="form-label">Usuário Destino</label>
                        <input type="text" id="userId" class="form-control" 
                               placeholder="UID do usuário" required readonly>
                        <small style="color: var(--cor-texto-claro); margin-top: 5px; display: block;">
                            Primeiro busque o usuário acima
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Título da Advertência *</label>
                        <input type="text" id="advertenciaTitulo" class="form-control" 
                               placeholder="Ex: Uso inadequado do sistema" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Conteúdo *</label>
                        <textarea id="advertenciaConteudo" class="form-control" 
                                  placeholder="Descreva detalhadamente a advertência..." 
                                  rows="5" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nível de Gravidade</label>
                        <select id="advertenciaGravidade" class="form-control">
                            <option value="leve">⚠️ Leve</option>
                            <option value="moderada" selected>⚠️⚠️ Moderada</option>
                            <option value="grave">⚠️⚠️⚠️ Grave</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="advertenciaStatus" class="form-control">
                            <option value="ativa" selected>Ativa</option>
                            <option value="resolvida">Resolvida</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Advertência
                        </button>
                        <button type="button" id="btnLimparForm" class="btn btn-warning">
                            <i class="fas fa-broom"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Advertências -->
        <div class="card" style="margin-top: 20px;">
            <h2 class="card-title"><i class="fas fa-list"></i> Advertências do Usuário</h2>
            <div id="advertenciasList" class="advertencias-list">
                <div class="loading">Selecione um usuário para ver as advertências...</div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-circle"></i> Confirmar Ação</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Tem certeza que deseja realizar esta ação?</p>
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button id="confirmAction" class="btn" style="background: var(--cor-perigo); color: white;">Confirmar</button>
                    <button onclick="closeModal()" class="btn" style="background: #6c757d; color: white;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase e Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
            showMessage('Erro ao conectar ao banco de dados. Recarregue a página.', 'error');
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // Variáveis globais
        let selectedUserId = null;
        let currentUserAdvertencias = [];
        let currentCallback = null;

        // Elementos DOM
        const loginContainer = document.getElementById('loginContainer');
        const mainContent = document.getElementById('mainContent');
        const userHeader = document.getElementById('userHeader');
        const userAvatar = document.getElementById('userAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserEmail = document.getElementById('currentUserEmail');
        const loginStatus = document.getElementById('loginStatus');
        const btnGoogleLogin = document.getElementById('btnGoogleLogin');
        const btnLogout = document.getElementById('btnLogout');
        const searchUserId = document.getElementById('searchUserId');
        const btnSearchById = document.getElementById('btnSearchById');
        const userIdInput = document.getElementById('userId');
        const advertenciaForm = document.getElementById('advertenciaForm');
        const advertenciasList = document.getElementById('advertenciasList');
        const messageArea = document.getElementById('messageArea');
        const totalAdvertencias = document.getElementById('totalAdvertencias');
        const advertenciasAtivas = document.getElementById('advertenciasAtivas');
        const advertenciasResolvidas = document.getElementById('advertenciasResolvidas');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmAction = document.getElementById('confirmAction');

        // ================= FUNÇÕES PRINCIPAIS =================

        // Mostrar mensagem
        function showMessage(text, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${text}</span>
                </div>
            `;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            messageDiv.classList.add('show');
            
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    messageArea.innerHTML = '';
                }, 300);
            }, 5000);
        }

        // Login com Google
        async function loginWithGoogle() {
            try {
                showMessage('Iniciando login com Google...', 'info');
                loginStatus.textContent = 'Abrindo janela de login...';
                
                // Usar popup para login
                const result = await auth.signInWithPopup(googleProvider);
                
                if (result.user) {
                    console.log('Login bem-sucedido:', result.user.email);
                    
                    // Verificar se é administrador
                    const isAdmin = await checkAdminStatus(result.user);
                    
                    if (isAdmin) {
                        showMessage('Login realizado com sucesso!', 'success');
                        updateUIForUser(result.user);
                    } else {
                        showMessage('Esta conta não tem permissões de administrador.', 'error');
                        await auth.signOut();
                        loginStatus.textContent = 'Permissão negada. Faça login com uma conta de administrador.';
                    }
                }
                
            } catch (error) {
                console.error('Erro no login:', error);
                
                let errorMsg = 'Erro ao fazer login: ';
                if (error.code === 'auth/popup-blocked') {
                    errorMsg = 'O popup foi bloqueado pelo navegador. Permita popups para este site.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMsg = 'Login cancelado. A janela de login foi fechada.';
                } else {
                    errorMsg += error.message;
                }
                
                showMessage(errorMsg, 'error');
                loginStatus.textContent = errorMsg;
            }
        }

        // Verificar se usuário é administrador
        async function checkAdminStatus(user) {
            try {
                // Lista de UIDs permitidos (administradores)
                const adminUIDs = [
                    'sZxfMuOBPbXdR8nttVPXIN8QOOl1', // UID do seu sistema
                    user.uid // Para desenvolvimento, permitir o próprio usuário
                ];
                
                // Verificar se está na lista de UIDs permitidos
                if (adminUIDs.includes(user.uid)) {
                    console.log('Usuário autorizado (UID na lista)');
                    return true;
                }
                
                // Tentar verificar na coleção users
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        if (userData.isAdmin === true) {
                            console.log('Usuário é admin (coleção users)');
                            return true;
                        }
                    }
                } catch (dbError) {
                    console.log('Não foi possível verificar na coleção users:', dbError.message);
                }
                
                // Se chegou aqui, não é admin
                console.log('Usuário não é administrador');
                return false;
                
            } catch (error) {
                console.error('Erro ao verificar admin:', error);
                
                // Em caso de erro, pedir confirmação ao usuário
                const confirmAdmin = confirm('Não foi possível verificar suas permissões. Você é administrador?');
                
                if (confirmAdmin) {
                    // Permitir acesso temporário para testes
                    console.log('Acesso concedido por confirmação manual');
                    return true;
                }
                
                return false;
            }
        }

        // Atualizar UI após login
        function updateUIForUser(user) {
            loginContainer.style.display = 'none';
            mainContent.style.display = 'block';
            userHeader.style.display = 'flex';
            
            // Atualizar informações do usuário
            currentUserName.textContent = user.displayName || 'Administrador';
            currentUserEmail.textContent = user.email || 'Usuário Google';
            
            // Atualizar avatar
            if (user.photoURL) {
                userAvatar.innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:50%;">`;
            } else {
                const initials = (user.displayName || 'A').charAt(0).toUpperCase();
                userAvatar.innerHTML = initials;
                userAvatar.style.background = 'linear-gradient(135deg, #4361ee, #3a0ca3)';
                userAvatar.style.color = 'white';
                userAvatar.style.fontWeight = 'bold';
            }
            
            loginStatus.textContent = `Logado como: ${user.email}`;
        }

        // Logout
        async function logout() {
            try {
                await auth.signOut();
                showMessage('Logout realizado com sucesso.', 'info');
                loginContainer.style.display = 'flex';
                mainContent.style.display = 'none';
                userHeader.style.display = 'none';
                loginStatus.textContent = 'Desconectado';
                
                // Limpar dados
                selectedUserId = null;
                currentUserAdvertencias = [];
                userIdInput.value = '';
                searchUserId.value = '';
                advertenciasList.innerHTML = '<div class="loading">Selecione um usuário para ver as advertências...</div>';
                updateStatistics();
                
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                showMessage('Erro ao fazer logout: ' + error.message, 'error');
            }
        }

        // Buscar usuário por UID
        async function searchUserById(uid) {
            if (!uid) {
                showMessage('Por favor, digite um UID para buscar.', 'warning');
                return null;
            }

            try {
                showMessage('Buscando usuário...', 'info');
                
                // Buscar na coleção userpage
                const userDoc = await db.collection('userpage').doc(uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    return {
                        uid: uid,
                        name: userData.dadosCadastro?.nomeCompleto || 
                              userData.criadorNome || 
                              'Usuário sem nome',
                        email: userData.dadosCadastro?.email || 
                               userData.criadorEmail || 
                               'Email não informado',
                        hasUserPage: true
                    };
                } else {
                    // Usuário não tem página ainda
                    return {
                        uid: uid,
                        name: 'Usuário sem página',
                        email: 'Não disponível',
                        hasUserPage: false
                    };
                }

            } catch (error) {
                console.error('Erro ao buscar usuário:', error);
                
                if (error.code === 'permission-denied') {
                    showMessage('Permissão negada para buscar usuários.', 'error');
                } else {
                    showMessage('Erro: ' + error.message, 'error');
                }
                
                return null;
            }
        }

        // Selecionar usuário
        async function selectUser(user) {
            selectedUserId = user.uid;
            userIdInput.value = user.uid;
            
            // Carregar advertências
            await loadUserAdvertencias(user.uid);
            
            showMessage(`Usuário ${user.name || user.uid} selecionado!`, 'success');
        }

        // Carregar advertências do usuário
        async function loadUserAdvertencias(userId) {
            try {
                advertenciasList.innerHTML = '<div class="loading">Carregando advertências...</div>';
                
                const userPageDoc = await db.collection('userpage').doc(userId).get();
                
                if (!userPageDoc.exists) {
                    advertenciasList.innerHTML = '<div class="message message-warning">Este usuário não possui página ainda. Você ainda pode adicionar advertências.</div>';
                    currentUserAdvertencias = [];
                    updateStatistics();
                    return;
                }

                const userPageData = userPageDoc.data();
                currentUserAdvertencias = userPageData.advertências || [];
                
                displayAdvertencias(currentUserAdvertencias);
                updateStatistics();

            } catch (error) {
                console.error('Erro ao carregar advertências:', error);
                advertenciasList.innerHTML = '<div class="message message-error">Erro ao carregar advertências.</div>';
            }
        }

        // Exibir advertências
        function displayAdvertencias(advertencias) {
            if (!advertencias || advertencias.length === 0) {
                advertenciasList.innerHTML = '<div class="message message-info">Nenhuma advertência encontrada para este usuário.</div>';
                return;
            }

            // Ordenar por data (mais recente primeiro)
            advertencias.sort((a, b) => {
                const dateA = a.data ? (a.data.toDate ? a.data.toDate() : new Date(a.data)) : new Date(0);
                const dateB = b.data ? (b.data.toDate ? b.data.toDate() : new Date(b.data)) : new Date(0);
                return dateB - dateA;
            });

            let html = '';
            
            advertencias.forEach((advertencia, index) => {
                const data = advertencia.data ? formatDate(advertencia.data) : 'Data não registrada';
                const gravidade = advertencia.gravidade || 'moderada';
                const status = advertencia.status || 'ativa';
                
                let gravidadeText = '';
                switch(gravidade) {
                    case 'leve': gravidadeText = '⚠️ Leve'; break;
                    case 'moderada': gravidadeText = '⚠️⚠️ Moderada'; break;
                    case 'grave': gravidadeText = '⚠️⚠️⚠️ Grave'; break;
                }
                
                html += `
                    <div class="advertencia-item" data-status="${status}" data-index="${index}">
                        <div class="advertencia-header">
                            <div>
                                <div class="advertencia-titulo">${advertencia.titulo || 'Sem título'}</div>
                                <small style="color: var(--cor-texto-claro);">${gravidadeText}</small>
                            </div>
                            <div style="text-align: right;">
                                <div class="advertencia-data">${data}</div>
                                <span class="status-badge status-${status}">${status === 'ativa' ? 'Ativa' : 'Resolvida'}</span>
                            </div>
                        </div>
                        <div class="advertencia-conteudo">
                            ${advertencia.conteudo || ''}
                        </div>
                        <div class="advertencia-acoes">
                            <button onclick="toggleAdvertenciaStatus(${index})" class="btn btn-sm ${status === 'ativa' ? 'btn-success' : 'btn-warning'}">
                                <i class="fas fa-${status === 'ativa' ? 'check' : 'undo'}"></i> ${status === 'ativa' ? 'Marcar como Resolvida' : 'Marcar como Ativa'}
                            </button>
                            <button onclick="deleteAdvertencia(${index})" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                `;
            });

            advertenciasList.innerHTML = html;
        }

        // Atualizar estatísticas
        function updateStatistics() {
            const total = currentUserAdvertencias.length;
            const ativas = currentUserAdvertencias.filter(a => a.status === 'ativa').length;
            const resolvidas = total - ativas;
            
            totalAdvertencias.textContent = total;
            advertenciasAtivas.textContent = ativas;
            advertenciasResolvidas.textContent = resolvidas;
        }

        // Adicionar nova advertência
        async function addAdvertencia(userId, advertenciaData) {
            try {
                showMessage('Adicionando advertência...', 'info');
                
                const userPageRef = db.collection('userpage').doc(userId);
                
                // Buscar advertências existentes
                const userPageDoc = await userPageRef.get();
                let advertências = [];
                let userData = {};
                
                if (userPageDoc.exists) {
                    userData = userPageDoc.data();
                    advertências = userData.advertências || [];
                }
                
                // Adicionar nova advertência
                advertências.push({
                    ...advertenciaData,
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    criador: {
                        id: auth.currentUser.uid,
                        nome: auth.currentUser.displayName || 'Administrador',
                        email: auth.currentUser.email
                    }
                });
                
                // Preparar dados para atualização
                const updateData = {
                    advertências: advertências,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Se não existir a página, criar estrutura básica
                if (!userPageDoc.exists) {
                    updateData.titulo = `Página de Usuário ${userId.substring(0, 8)}...`;
                    updateData.descricao = 'Página criada automaticamente pelo sistema de advertências';
                    updateData.criadorId = 'sistema';
                    updateData.criadorNome = 'Sistema de Advertências';
                    updateData.criadoEm = firebase.firestore.FieldValue.serverTimestamp();
                    updateData.restrito = true;
                    updateData.tipo = 'userpage';
                }
                
                // Salvar no Firestore
                await userPageRef.set(updateData, { merge: true });
                
                // Recarregar lista
                await loadUserAdvertencias(userId);
                
                showMessage('Advertência adicionada com sucesso!', 'success');
                return true;

            } catch (error) {
                console.error('Erro ao adicionar advertência:', error);
                showMessage('Erro ao adicionar advertência: ' + error.message, 'error');
                return false;
            }
        }

        // Alternar status da advertência
        async function toggleAdvertenciaStatus(index) {
            if (index < 0 || index >= currentUserAdvertencias.length) return;
            
            try {
                const advertencia = currentUserAdvertencias[index];
                const novoStatus = advertencia.status === 'ativa' ? 'resolvida' : 'ativa';
                
                // Atualizar localmente
                currentUserAdvertencias[index].status = novoStatus;
                
                // Atualizar no Firestore
                const userPageRef = db.collection('userpage').doc(selectedUserId);
                await userPageRef.update({
                    advertências: currentUserAdvertencias,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage(`Advertência marcada como ${novoStatus === 'ativa' ? 'ativa' : 'resolvida'}!`, 'success');
                
                // Atualizar exibição
                displayAdvertencias(currentUserAdvertencias);
                updateStatistics();

            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                showMessage('Erro ao atualizar status da advertência.', 'error');
            }
        }

        // Excluir advertência
        async function deleteAdvertencia(index) {
            if (index < 0 || index >= currentUserAdvertencias.length) return;
            
            openModal('Tem certeza que deseja excluir esta advertência?', async () => {
                try {
                    showMessage('Excluindo advertência...', 'info');
                    
                    // Remover do array local
                    currentUserAdvertencias.splice(index, 1);
                    
                    // Atualizar no Firestore
                    const userPageRef = db.collection('userpage').doc(selectedUserId);
                    await userPageRef.update({
                        advertências: currentUserAdvertencias,
                        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showMessage('Advertência excluída com sucesso!', 'success');
                    
                    // Atualizar exibição
                    displayAdvertencias(currentUserAdvertencias);
                    updateStatistics();

                } catch (error) {
                    console.error('Erro ao excluir advertência:', error);
                    showMessage('Erro ao excluir advertência.', 'error');
                }
            });
        }

        // Formatar data
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
            } catch (e) {
                return 'Data inválida';
            }
        }

        // Limpar formulário
        function clearForm() {
            document.getElementById('advertenciaTitulo').value = '';
            document.getElementById('advertenciaConteudo').value = '';
            document.getElementById('advertenciaGravidade').value = 'moderada';
            document.getElementById('advertenciaStatus').value = 'ativa';
        }

        // ================= FUNÇÕES DO MODAL =================

        function openModal(message, callback) {
            confirmMessage.textContent = message;
            currentCallback = callback;
            confirmModal.classList.add('active');
        }

        function closeModal() {
            confirmModal.classList.remove('active');
            currentCallback = null;
        }

        // ================= EVENT LISTENERS =================

        function setupEventListeners() {
            // Buscar por UID
            btnSearchById.addEventListener('click', async () => {
                const uid = searchUserId.value.trim();
                if (!uid) return;
                
                const user = await searchUserById(uid);
                if (user) {
                    selectUser(user);
                }
            });
            
            // Permitir busca com Enter
            searchUserId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') btnSearchById.click();
            });
            
            // Formulário de advertência
            advertenciaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!selectedUserId) {
                    showMessage('Por favor, selecione um usuário primeiro.', 'warning');
                    return;
                }
                
                const titulo = document.getElementById('advertenciaTitulo').value.trim();
                const conteudo = document.getElementById('advertenciaConteudo').value.trim();
                const gravidade = document.getElementById('advertenciaGravidade').value;
                const status = document.getElementById('advertenciaStatus').value;
                
                if (!titulo || !conteudo) {
                    showMessage('Por favor, preencha título e conteúdo.', 'warning');
                    return;
                }
                
                const advertenciaData = {
                    titulo,
                    conteudo,
                    gravidade,
                    status
                };
                
                const success = await addAdvertencia(selectedUserId, advertenciaData);
                if (success) {
                    clearForm();
                }
            });
            
            // Botão limpar formulário
            document.getElementById('btnLimparForm').addEventListener('click', clearForm);
            
            // Confirmar ação no modal
            confirmAction.addEventListener('click', () => {
                if (currentCallback) {
                    currentCallback();
                }
                closeModal();
            });
            
            // Fechar modal ao clicar fora
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    closeModal();
                }
            });
            
            // Fechar modal com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && confirmModal.classList.contains('active')) {
                    closeModal();
                }
            });
        }

        // ================= INICIALIZAÇÃO =================

        // Monitorar estado de autenticação
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('Usuário logado:', user.email);
                loginStatus.textContent = `Logado como: ${user.email}`;
                
                // Verificar se é administrador
                const isAdmin = await checkAdminStatus(user);
                
                if (isAdmin) {
                    updateUIForUser(user);
                    setupEventListeners();
                    showMessage('Bem-vindo ao sistema de gerenciamento de advertências!', 'success');
                } else {
                    showMessage('Você não tem permissão para acessar este sistema.', 'error');
                    loginStatus.textContent = 'Acesso negado: não é administrador';
                    
                    // Tentar fazer logout após 3 segundos
                    setTimeout(() => {
                        if (auth.currentUser) {
                            auth.signOut();
                        }
                    }, 3000);
                }
            } else {
                console.log('Nenhum usuário logado');
                loginContainer.style.display = 'flex';
                mainContent.style.display = 'none';
                userHeader.style.display = 'none';
                loginStatus.textContent = 'Não logado';
            }
        });

        // Event listeners para login/logout
        btnGoogleLogin.addEventListener('click', loginWithGoogle);
        btnLogout.addEventListener('click', logout);

        // Funções globais
        window.toggleAdvertenciaStatus = toggleAdvertenciaStatus;
        window.deleteAdvertencia = deleteAdvertencia;
        window.closeModal = closeModal;

        // Mostrar status inicial
        setTimeout(() => {
            if (!auth.currentUser) {
                loginStatus.textContent = 'Aguardando login...';
            }
        }, 1000);
    </script>
</body>
</html>
