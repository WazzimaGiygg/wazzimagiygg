<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WazzimaGiygg Admin Desktop</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <style>
        body {
            margin: 0;
            background: url(''http://wazzimagiygg.com/heitorcarvalhojorge.jpg') center/cover no-repeat;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Barra de tarefas */
        .taskbar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 20, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0 10px;
            color: white;
            box-sizing: border-box;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Container da esquerda (bot√µes e √≠cones minimizados) */
        .taskbar-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        /* √Årea dos √≠cones minimizados */
        .taskbar-icons {
            display: flex;
            align-items: center;
            margin-left: 10px;
            gap: 5px;
            max-width: 60%;
            overflow-x: auto;
            padding: 0 5px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .taskbar-icons::-webkit-scrollbar {
            height: 3px;
        }

        .taskbar-icons::-webkit-scrollbar-track {
            background: transparent;
        }

        .taskbar-icons::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* √çcone de janela minimizada */
        .taskbar-icon {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            max-width: 150px;
            min-width: 40px;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .taskbar-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .taskbar-icon.active {
            background: rgba(255, 255, 255, 0.25);
            border-bottom: 2px solid #0078d7;
        }

        .taskbar-icon img {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* Estilo para o rel√≥gio na direita */
        #clock {
            padding: 0 10px;
            text-align: right;
            line-height: 1.2;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .start-button {
            background: rgba(40, 40, 40, 0.9);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .start-button:hover {
            background: rgba(60, 60, 60, 0.9);
        }

        /* MENUS DESLIZANTES */
        .menu, .admin-popup, .tools-popup, #notificationPopup, #userMenu {
            position: absolute;
            bottom: 40px;
            left: 10px;
            background: rgba(30, 30, 30, 0.98);
            color: white;
            border-radius: 8px;
            padding: 10px;
            width: 300px;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(30, 30, 30, 0.5);
            z-index: 1000;
        }

        #userMenu {
            left: auto;
            right: 10px;
            width: 250px;
        }

        .menu::-webkit-scrollbar,
        .admin-popup::-webkit-scrollbar,
        .tools-popup::-webkit-scrollbar,
        #notificationPopup::-webkit-scrollbar,
        #userMenu::-webkit-scrollbar {
            width: 8px;
        }

        .menu::-webkit-scrollbar-track,
        .admin-popup::-webkit-scrollbar-track,
        .tools-popup::-webkit-scrollbar-track,
        #notificationPopup::-webkit-scrollbar-track,
        #userMenu::-webkit-scrollbar-track {
            background: rgba(30, 30, 30, 0.5);
            border-radius: 4px;
        }

        .menu::-webkit-scrollbar-thumb,
        .admin-popup::-webkit-scrollbar-thumb,
        .tools-popup::-webkit-scrollbar-thumb,
        #notificationPopup::-webkit-scrollbar-thumb,
        #userMenu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        /* Posicionamento espec√≠fico para cada menu */
        .admin-popup {
            left: 120px;
        }

        .tools-popup {
            left: 230px;
        }

        #notificationPopup {
            left: auto;
            right: 60px;
            bottom: 50px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .menu-item img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        /* Janela */
        .window {
            position: absolute;
            top: 60px;
            left: 60px;
            width: 800px;
            height: 500px;
            background: white;
            border: 1px solid #666;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            border-radius: 8px;
            z-index: 100;
            min-width: 300px;
            min-height: 200px;
            opacity: 1;
            transition: opacity 0.2s, transform 0.2s;
        }

        .window.minimized {
            display: none;
        }

        .window-header {
            background: linear-gradient(135deg, #0078d7, #005a9e);
            color: white;
            padding: 6px 10px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-controls button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 3px;
            transition: background 0.2s;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .window-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Tela de login */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        #login-screen h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        #login-screen p {
            margin-bottom: 30px;
            opacity: 0.8;
        }

        #login-screen button {
            padding: 12px 30px;
            background: #0078d7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }

        #login-screen button:hover {
            background: #005a9e;
            transform: scale(1.05);
        }
        
        /* Menu de ferramentas */
        .tools-popup a {
            display: block;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            text-decoration: none;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tools-popup a:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .taskbar-right {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        /* √çcone de Notifica√ß√£o */
        #notificationIcon {
            cursor: pointer;
            font-size: 1.2em;
            margin-right: 15px;
            transition: color 0.2s, transform 0.2s;
            color: white;
            padding: 5px;
            border-radius: 4px;
        }

        #notificationIcon:hover {
            color: #0078d7;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Notifica√ß√µes */
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item strong {
            color: #4CAF50;
        }

        /* Notifica√ß√£o de San√ß√£o */
        .sancao-alerta {
            background-color: rgba(204, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
            border-left: 4px solid #cc0000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { background-color: rgba(204, 0, 0, 0.2); }
            50% { background-color: rgba(204, 0, 0, 0.3); }
            100% { background-color: rgba(204, 0, 0, 0.2); }
        }

        /* Overlay para fechar menus */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999;
            display: none;
        }

        /* Indicador de janela ativa */
        .window.active {
            z-index: 101;
            box-shadow: 0 0 20px rgba(0, 120, 215, 0.3);
        }

        /* Bot√£o para mostrar/ocultar todas as janelas */
        .show-all-windows {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .show-all-windows:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Estilos para o menu do usu√°rio */
        .user-info-header {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #0078d7;
        }

        .user-email {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* Janela de personaliza√ß√£o */
        .customization-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 400px;
            background: white;
            border: 1px solid #666;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            z-index: 1001;
            display: none;
        }

        .customization-header {
            background: linear-gradient(135deg, #0078d7, #005a9e);
            color: white;
            padding: 10px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customization-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .customization-option {
            margin-bottom: 20px;
        }

        .customization-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #ddd;
            cursor: pointer;
            display: inline-block;
            margin-right: 10px;
        }

        .color-input {
            width: 100px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .save-button {
            background: #0078d7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }

        .save-button:hover {
            background: #005a9e;
        }

        /* Responsividade */
        @media (max-height: 600px) {
            .menu, .admin-popup, .tools-popup, #notificationPopup, #userMenu {
                max-height: 50vh;
            }
        }

        @media (max-width: 768px) {
            .menu, .admin-popup, .tools-popup, #notificationPopup, #userMenu {
                width: 250px;
                max-height: 50vh;
            }
            
            .start-button {
                padding: 5px 10px;
                font-size: 14px;
            }
            
            #clock {
                font-size: 0.75em;
            }
            
            .taskbar-icon {
                max-width: 120px;
            }
            
            #userMenu {
                width: 200px;
            }
            
            .customization-window {
                width: 90%;
                height: 80%;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="login-screen">
        <h2>Bem-vindo(a) ao Wiki Not Pedia WZZM</h2>
        <p>Fa√ßa login para acessar a √°rea de trabalho</p>
        <button id="loginBtn">Entrar com Google</button>
    </div>

    <!-- Overlay para fechar menus ao clicar fora -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Janela de personaliza√ß√£o -->
    <div id="customizationWindow" class="customization-window">
        <div class="customization-header">
            <span>Personaliza√ß√£o do Sistema</span>
            <button id="closeCustomization" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 1.2em;">‚úñ</button>
        </div>
        <div class="customization-content">
            <div class="customization-option">
                <label>Cor do Menu:</label>
                <div id="menuColorPreview" class="color-preview"></div>
                <input type="color" id="menuColorInput" class="color-input" value="#1e1e1e">
            </div>
            <div class="customization-option">
                <label>Wallpaper Personalizado:</label>
                <input type="text" id="wallpaperInput" placeholder="URL da imagem" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small>Insira a URL de uma imagem para usar como wallpaper</small>
            </div>
            <button id="saveCustomization" class="save-button">Salvar Personaliza√ß√£o</button>
            <button id="resetCustomization" class="save-button" style="background: #666; margin-left: 10px;">Redefinir Padr√£o</button>
        </div>
    </div>

    <div id="desktop">
        
        <div class="taskbar">
            <div class="taskbar-left">
                <button class="start-button" id="startBtn">Iniciar</button>
                <button class="start-button" id="adminBtn">Wiki Not P√©dia</button>
                <button class="start-button" id="toolsBtn">Ferramentas</button>
                
                <!-- √Årea de √≠cones de janelas minimizadas -->
                <div class="taskbar-icons" id="taskbarIcons"></div>
                
                <!-- Bot√£o para mostrar todas as janelas -->
                <button class="show-all-windows" id="showAllBtn" title="Mostrar todas as janelas">‚ãÆ</button>
            </div>
            
            <div class="taskbar-right"> 
                <span id="notificationIcon">üîî</span>
                <div id="clock"></div>
            </div>
        </div>

        <div class="menu" id="startMenu"></div>
        <div class="admin-popup" id="adminMenu"></div>
        <div class="tools-popup" id="toolsMenu"></div>
        <div id="userMenu"></div>
        <div id="notificationPopup"></div>
    </div>

   <script type="module">
// üîπ Firebase Auth & Firestore Config
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// üîπ Configurar para sempre pedir sele√ß√£o de conta
provider.setCustomParameters({
  prompt: 'select_account'
});

// CONSTANTES DO FIRESTORE
const KEY_ARRAY_FIELD = "itens_menu";
const USER_CUSTOMIZATION_COLLECTION = "espacowazzimagiygg";
const USER_LOGS_COLLECTION = "checkuser"; // Nova cole√ß√£o para logs

// CONSTANTES DE ELEMENTOS
const notificationIcon = document.getElementById("notificationIcon");
const notificationPopup = document.getElementById("notificationPopup");
const menuOverlay = document.getElementById("menuOverlay");
const taskbarIcons = document.getElementById("taskbarIcons");
const showAllBtn = document.getElementById("showAllBtn");
const JSON_URL = 'cidades_sancionadas.json'; 

const loginScreen = document.getElementById("login-screen");
const loginBtn = document.getElementById("loginBtn");
const desktop = document.getElementById("desktop");
const startMenu = document.getElementById("startMenu");
const adminMenu = document.getElementById("adminMenu");
const toolsMenu = document.getElementById("toolsMenu");
const userMenu = document.getElementById("userMenu");
const clockElement = document.getElementById("clock");
const customizationWindow = document.getElementById("customizationWindow");

// Elementos de personaliza√ß√£o
const menuColorInput = document.getElementById("menuColorInput");
const wallpaperInput = document.getElementById("wallpaperInput");
const saveCustomizationBtn = document.getElementById("saveCustomization");
const resetCustomizationBtn = document.getElementById("resetCustomization");
const closeCustomizationBtn = document.getElementById("closeCustomization");

// BOT√ïES DA TASKBAR
const startBtn = document.getElementById("startBtn");
const adminBtn = document.getElementById("adminBtn");
const toolsBtn = document.getElementById("toolsBtn");

// Vari√°vel para rastrear p√°ginas abertas
let openWindows = [];
let currentUser = null;

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: REGISTRAR LOG NO FIRESTORE
// -------------------------------------------------------------
async function registerUserLog(user, ipData, action = "login") {
    try {
        // Se n√£o houver usu√°rio, n√£o registra
        if (!user) {
            console.warn("Usu√°rio n√£o dispon√≠vel para registrar log.");
            return;
        }

        // Coletar informa√ß√µes do navegador
        const browserInfo = {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            screenResolution: `${window.screen.width}x${window.screen.height}`,
            colorDepth: window.screen.colorDepth,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        // Coletar informa√ß√µes de localiza√ß√£o, usando ipData ou valores padr√£o
        const locationInfo = {
            ip: ipData?.ip || 'N/A',
            city: ipData?.city || 'Desconhecida',
            region: ipData?.region || 'Desconhecido',
            country: ipData?.country || 'Desconhecido',
            loc: ipData?.loc || 'N/A',
            org: ipData?.org || 'N/A',
            postal: ipData?.postal || 'N/A',
            timezone: ipData?.timezone || 'N/A'
        };

        // Informa√ß√µes do usu√°rio
        const userInfo = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            providerId: user.providerId,
            emailVerified: user.emailVerified
        };

        // P√°ginas atualmente abertas (janelas do sistema)
        const activePages = openWindows.map(win => ({
            title: win.title,
            url: win.url,
            timestamp: new Date().toISOString()
        }));

        // Dados completos para log
        const logData = {
            user: userInfo,
            location: locationInfo,
            browser: browserInfo,
            action: action,
            activePages: activePages,
            timestamp: serverTimestamp(),
            clientTimestamp: new Date().toISOString(),
            sessionId: generateSessionId()
        };

        // Registrar no Firestore
        const logsRef = collection(db, USER_LOGS_COLLECTION);
        await addDoc(logsRef, logData);
        
        console.log("Log registrado com sucesso no Firebase");
        
        // Tamb√©m atualizar √∫ltimo acesso no documento do usu√°rio
        const userDocRef = doc(db, "users", user.uid);
        const loginCount = await getLoginCount(user.uid);
        await setDoc(userDocRef, {
            lastLogin: serverTimestamp(),
            lastIP: locationInfo.ip,
            lastLocation: `${locationInfo.city}, ${locationInfo.region}, ${locationInfo.country}`,
            loginCount: loginCount + 1
        }, { merge: true });
        
    } catch (error) {
        console.error("Erro ao registrar log:", error);
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: REGISTRAR ABERTURA DE JANELA
// -------------------------------------------------------------
function registerWindowOpen(title, url) {
    if (!currentUser) return;
    
    const windowData = {
        title: title,
        url: url,
        timestamp: new Date().toISOString(),
        uid: currentUser.uid
    };
    
    openWindows.push(windowData);
    
    // Registrar no Firestore
    try {
        const windowLogsRef = collection(db, "window_logs");
        addDoc(windowLogsRef, windowData);
    } catch (error) {
        console.error("Erro ao registrar janela:", error);
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: REGISTRAR FECHAMENTO DE JANELA
// -------------------------------------------------------------
function registerWindowClose(title, url) {
    if (!currentUser) return;
    
    openWindows = openWindows.filter(win => win.title !== title || win.url !== url);
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: GERAR ID DE SESS√ÉO
// -------------------------------------------------------------
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: OBTER CONTAGEM DE LOGINS
// -------------------------------------------------------------
async function getLoginCount(uid) {
    try {
        const userDocRef = doc(db, "users", uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            return userDoc.data().loginCount || 0;
        }
        return 0;
    } catch (error) {
        console.error("Erro ao obter contagem de logins:", error);
        return 0;
    }
}

// GERENCIADOR DE JANELAS (modificado para registrar abertura/fechamento)
const windowManager = {
    windows: [], // Array para armazenar todas as janelas
    activeWindow: null,
    
    // Adiciona uma nova janela ao gerenciador
    addWindow: function(windowElement, title, icon = 'iconmagic.png', url) {
        const windowId = 'window_' + Date.now() + Math.random().toString(36).substr(2, 9);
        windowElement.dataset.windowId = windowId;
        
        const windowData = {
            id: windowId,
            element: windowElement,
            title: title,
            icon: icon,
            url: url,
            minimized: false,
            taskbarIcon: null
        };
        
        this.windows.push(windowData);
        this.setActiveWindow(windowId);
        this.createTaskbarIcon(windowData);
        
        // Registrar abertura da janela
        registerWindowOpen(title, url);
        
        return windowId;
    },
    
    // Remove uma janela do gerenciador
    removeWindow: function(windowId) {
        const index = this.windows.findIndex(w => w.id === windowId);
        if (index !== -1) {
            const windowData = this.windows[index];
            
            // Registrar fechamento da janela
            registerWindowClose(windowData.title, windowData.url);
            
            // Remove o √≠cone da taskbar
            if (windowData.taskbarIcon) {
                windowData.taskbarIcon.remove();
            }
            
            // Remove a janela do array
            this.windows.splice(index, 1);
            
            // Atualiza a janela ativa se necess√°rio
            if (this.activeWindow === windowId) {
                this.activeWindow = this.windows.length > 0 ? this.windows[this.windows.length - 1].id : null;
                this.updateActiveWindow();
            }
        }
    },
    
    // ... resto do c√≥digo do windowManager permanece igual ...
    // Minimiza uma janela
    minimizeWindow: function(windowId) {
        const windowData = this.windows.find(w => w.id === windowId);
        if (windowData) {
            windowData.minimized = true;
            windowData.element.classList.add('minimized');
            this.updateTaskbarIcon(windowData);
            
            // Se a janela minimizada era a ativa, ativa outra janela
            if (this.activeWindow === windowId) {
                const visibleWindows = this.windows.filter(w => !w.minimized && w.id !== windowId);
                if (visibleWindows.length > 0) {
                    this.setActiveWindow(visibleWindows[0].id);
                } else {
                    this.activeWindow = null;
                    this.updateActiveWindow();
                }
            }
        }
    },
    
    // Restaura uma janela minimizada
    restoreWindow: function(windowId) {
        const windowData = this.windows.find(w => w.id === windowId);
        if (windowData) {
            windowData.minimized = false;
            windowData.element.classList.remove('minimized');
            this.setActiveWindow(windowId);
            this.updateTaskbarIcon(windowData);
            
            // Traz a janela para frente
            this.bringToFront(windowData.element);
        }
    },
    
    // Define a janela ativa
    setActiveWindow: function(windowId) {
        this.activeWindow = windowId;
        this.updateActiveWindow();
        
        // Atualiza todos os √≠cones da taskbar
        this.windows.forEach(windowData => {
            this.updateTaskbarIcon(windowData);
        });
    },
    
    // Atualiza a classe 'active' em todas as janelas
    updateActiveWindow: function() {
        this.windows.forEach(windowData => {
            if (windowData.id === this.activeWindow) {
                windowData.element.classList.add('active');
                if (windowData.taskbarIcon) {
                    windowData.taskbarIcon.classList.add('active');
                }
            } else {
                windowData.element.classList.remove('active');
                if (windowData.taskbarIcon) {
                    windowData.taskbarIcon.classList.remove('active');
                }
            }
        });
    },
    
    // Cria um √≠cone na taskbar para uma janela
    createTaskbarIcon: function(windowData) {
        const icon = document.createElement('button');
        icon.className = 'taskbar-icon';
        icon.title = windowData.title;
        icon.innerHTML = `<img src="${windowData.icon}" alt="icon"> <span>${windowData.title}</span>`;
        
        icon.onclick = (e) => {
            e.stopPropagation();
            if (windowData.minimized) {
                this.restoreWindow(windowData.id);
            } else {
                if (this.activeWindow === windowData.id) {
                    this.minimizeWindow(windowData.id);
                } else {
                    this.setActiveWindow(windowData.id);
                }
            }
        };
        
        // Duplo clique para restaurar/minimizar
        icon.ondblclick = (e) => {
            e.stopPropagation();
            if (windowData.minimized) {
                this.restoreWindow(windowData.id);
            } else {
                this.minimizeWindow(windowData.id);
            }
        };
        
        taskbarIcons.appendChild(icon);
        windowData.taskbarIcon = icon;
        this.updateTaskbarIcon(windowData);
    },
    
    // Atualiza o √≠cone da taskbar
    updateTaskbarIcon: function(windowData) {
        if (windowData.taskbarIcon) {
            if (windowData.minimized) {
                windowData.taskbarIcon.style.opacity = '0.7';
            } else {
                windowData.taskbarIcon.style.opacity = '1';
            }
        }
    },
    
    // Traz uma janela para frente
    bringToFront: function(windowElement) {
        // Encontra todas as janelas e ajusta o z-index
        const allWindows = document.querySelectorAll('.window');
        let maxZIndex = 100;
        
        allWindows.forEach(win => {
            const zIndex = parseInt(window.getComputedStyle(win).zIndex) || 100;
            if (zIndex > maxZIndex) maxZIndex = zIndex;
        });
        
        windowElement.style.zIndex = maxZIndex + 1;
    },
    
    // Mostra todas as janelas minimizadas
    showAllWindows: function() {
        this.windows.forEach(windowData => {
            if (windowData.minimized) {
                this.restoreWindow(windowData.id);
            }
        });
    },
    
    // Minimiza todas as janelas
    minimizeAllWindows: function() {
        this.windows.forEach(windowData => {
            if (!windowData.minimized) {
                this.minimizeWindow(windowData.id);
            }
        });
    },
    
    // Fecha todas as janelas
    closeAllWindows: function() {
        const windowsToClose = [...this.windows];
        windowsToClose.forEach(windowData => {
            // Registrar fechamento de cada janela
            registerWindowClose(windowData.title, windowData.url);
            windowData.element.remove();
        });
        this.windows = [];
        this.activeWindow = null;
        taskbarIcons.innerHTML = '';
    }
};

// üîí BLOQUEIO DO BOT√ÉO DIREITO
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

// üîí BLOQUEIO DE TECLAS DE ATALHO
document.addEventListener('keydown', function(e) {
    if (e.key === 'F12') e.preventDefault();
    if (e.ctrlKey && e.shiftKey && e.key === 'I') e.preventDefault();
    if (e.ctrlKey && e.shiftKey && e.key === 'J') e.preventDefault();
    if (e.ctrlKey && e.key === 'u') e.preventDefault();
    
    // Atalhos do sistema
    if (e.key === 'Escape') {
        closeAllMenus();
        customizationWindow.style.display = 'none';
    }
    if (e.ctrlKey && e.key === 'm') { // Ctrl+M para minimizar janela ativa
        if (windowManager.activeWindow) {
            windowManager.minimizeWindow(windowManager.activeWindow);
        }
    }
});

// Fun√ß√£o para fechar todos os menus
function closeAllMenus() {
    startMenu.style.display = "none";
    adminMenu.style.display = "none";
    toolsMenu.style.display = "none";
    notificationPopup.style.display = "none";
    userMenu.style.display = "none";
    menuOverlay.style.display = "none";
}

// Fun√ß√£o para mostrar overlay e fechar menus ao clicar fora
function setupMenuClickOutside(menuElement) {
    menuElement.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    menuOverlay.addEventListener('click', function() {
        closeAllMenus();
        customizationWindow.style.display = 'none';
    });
}

// Inicializar fechamento de menus
setupMenuClickOutside(startMenu);
setupMenuClickOutside(adminMenu);
setupMenuClickOutside(toolsMenu);
setupMenuClickOutside(notificationPopup);
setupMenuClickOutside(userMenu);
setupMenuClickOutside(customizationWindow);

// Bot√£o para mostrar todas as janelas
showAllBtn.onclick = () => {
    windowManager.showAllWindows();
};

// Duplo clique na taskbar para minimizar/restaurar todas
taskbarIcons.parentElement.ondblclick = (e) => {
    if (e.target === taskbarIcons.parentElement || e.target === taskbarIcons) {
        const allMinimized = windowManager.windows.every(w => w.minimized);
        if (allMinimized) {
            windowManager.showAllWindows();
        } else {
            windowManager.minimizeAllWindows();
        }
    }
};

// Evento de clique no rel√≥gio para abrir menu do usu√°rio
clockElement.onclick = (e) => {
    e.stopPropagation();
    const isVisible = userMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        userMenu.style.display = "block";
        menuOverlay.style.display = "block";
        userMenu.style.right = "10px";
        userMenu.style.bottom = "40px";
    }
};

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: LOGIN COM GOOGLE (SEMPRE MOSTRAR SELE√á√ÉO DE CONTA)
// -------------------------------------------------------------
loginBtn.addEventListener("click", () => {
    // Configura para sempre mostrar sele√ß√£o de conta
    provider.setCustomParameters({
        prompt: 'select_account'
    });
    signInWithPopup(auth, provider);
});

// üìå L√≥gica de clique do √≠cone de notifica√ß√£o
notificationIcon.onclick = (e) => {
    e.stopPropagation();
    const isVisible = notificationPopup.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        notificationPopup.style.display = "block";
        menuOverlay.style.display = "block";
        notificationPopup.style.right = "60px";
        notificationPopup.style.bottom = "50px";
    }
};

// ‚úÖ L√≥gica de autentica√ß√£o MODIFICADA para registrar logs
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        loginScreen.style.display = "none";
        desktop.style.display = "block";
        updateClock();
        loadDynamicLinks(user.uid);
        
        // Primeiro buscar IP e localiza√ß√£o, depois registrar log
        const ipData = await buscarIpELocalizacao();
        
        // Registrar log no Firebase
        await registerUserLog(user, ipData, "login");
        
        await loadUserCustomization(user.uid, user.displayName, user.email);
        populateUserMenu(user.displayName, user.email);
    } else {
        currentUser = null;
        loginScreen.style.display = "flex";
        desktop.style.display = "none";
        notificationPopup.innerHTML = '';
        notificationIcon.style.color = 'white';
        closeAllMenus();
        windowManager.closeAllWindows();
        
        // Limpar lista de janelas abertas
        openWindows = [];
    }
});

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: CARREGA PERSONALIZA√á√ÉO DO USU√ÅRIO
// -------------------------------------------------------------
async function loadUserCustomization(userId, userName, userEmail) {
    try {
        const docRef = doc(db, USER_CUSTOMIZATION_COLLECTION, userId);
        const docSnap = await getDoc(docRef);

        let customizationData = {
            menuColor: '#1e1e1e',
            wallpaper: 'condedmonddant√®s.png',
            userName: userName,
            userEmail: userEmail
        };

        if (docSnap.exists()) {
            const data = docSnap.data();
            customizationData.menuColor = data.menuColor || '#1e1e1e';
            customizationData.wallpaper = data.wallpaper || 'condedmonddant√®s.png';
            
            // Aplica as personaliza√ß√µes
            applyCustomization(customizationData);
            
            // Preenche os campos na janela de personaliza√ß√£o
            menuColorInput.value = customizationData.menuColor;
            wallpaperInput.value = customizationData.wallpaper !== 'condedmonddant√®s.png' ? customizationData.wallpaper : '';
        } else {
            // Cria um documento padr√£o para o usu√°rio
            await setDoc(docRef, customizationData);
            applyCustomization(customizationData);
        }
        
        return customizationData;
    } catch (error) {
        console.error("Erro ao carregar personaliza√ß√£o:", error);
        return null;
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: APLICA PERSONALIZA√á√ÉO
// -------------------------------------------------------------
function applyCustomization(customizationData) {
    try {
        // Aplica cor do menu
        if (customizationData.menuColor) {
            const menus = document.querySelectorAll('.menu, .admin-popup, .tools-popup, #notificationPopup, #userMenu');
            menus.forEach(menu => {
                menu.style.backgroundColor = customizationData.menuColor;
            });
            
            // Atualiza a pr√©-visualiza√ß√£o de cor
            const menuColorPreview = document.getElementById('menuColorPreview');
            if (menuColorPreview) {
                menuColorPreview.style.backgroundColor = customizationData.menuColor;
            }
        }
        
        // Aplica wallpaper
        if (customizationData.wallpaper) {
            document.body.style.backgroundImage = `url('${customizationData.wallpaper}')`;
        }
    } catch (error) {
        console.error("Erro ao aplicar personaliza√ß√£o:", error);
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: SALVA PERSONALIZA√á√ÉO
// -------------------------------------------------------------
async function saveUserCustomization(userId) {
    try {
        const customizationData = {
            menuColor: menuColorInput.value,
            wallpaper: wallpaperInput.value || 'condedmonddant√®s.png',
            updatedAt: new Date().toISOString()
        };
        
        const docRef = doc(db, USER_CUSTOMIZATION_COLLECTION, userId);
        await setDoc(docRef, customizationData, { merge: true });
        
        // Aplica as mudan√ßas imediatamente
        applyCustomization(customizationData);
        
        alert("Personaliza√ß√£o salva com sucesso!");
        customizationWindow.style.display = 'none';
        
    } catch (error) {
        console.error("Erro ao salvar personaliza√ß√£o:", error);
        alert("Erro ao salvar personaliza√ß√£o. Tente novamente.");
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: REDEFINE PERSONALIZA√á√ÉO
// -------------------------------------------------------------
async function resetUserCustomization(userId) {
    try {
        const defaultCustomization = {
            menuColor: '#1e1e1e',
            wallpaper: 'condedmonddant√®s.png',
            updatedAt: new Date().toISOString()
        };
        
        const docRef = doc(db, USER_CUSTOMIZATION_COLLECTION, userId);
        await setDoc(docRef, defaultCustomization, { merge: true });
        
        // Aplica as configura√ß√µes padr√£o
        applyCustomization(defaultCustomization);
        
        // Atualiza os campos na janela
        menuColorInput.value = defaultCustomization.menuColor;
        wallpaperInput.value = '';
        
        alert("Personaliza√ß√£o redefinida para os padr√µes!");
        
    } catch (error) {
        console.error("Erro ao redefinir personaliza√ß√£o:", error);
        alert("Erro ao redefinir personaliza√ß√£o. Tente novamente.");
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: POPULA MENU DO USU√ÅRIO COM OP√á√ÉO DE TROCAR CONTA
// -------------------------------------------------------------
function populateUserMenu(userName, userEmail) {
    userMenu.innerHTML = '';
    
    // Cabe√ßalho com informa√ß√µes do usu√°rio
    const userHeader = document.createElement('div');
    userHeader.className = 'user-info-header';
    userHeader.innerHTML = `
        <div class="user-name">${userName || 'Usu√°rio'}</div>
        <div class="user-email">${userEmail || ''}</div>
    `;
    userMenu.appendChild(userHeader);
    
    // Separador
    const separator1 = document.createElement('hr');
    separator1.style = 'border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 10px 0;';
    userMenu.appendChild(separator1);
    
    // Op√ß√£o de Personaliza√ß√£o
    const personalizationItem = document.createElement('div');
    personalizationItem.className = 'menu-item';
    personalizationItem.innerHTML = `<img src="iconmagic.png" alt="icon"> Personalizar Sistema`;
    personalizationItem.onclick = () => {
        customizationWindow.style.display = 'block';
        menuOverlay.style.display = 'block';
        closeAllMenus();
    };
    userMenu.appendChild(personalizationItem);
    
    // Separador
    const separator2 = document.createElement('hr');
    separator2.style = 'border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 10px 0;';
    userMenu.appendChild(separator2);
    
    // üîπ NOVA OP√á√ÉO: Trocar de conta
    const switchAccountItem = document.createElement('div');
    switchAccountItem.className = 'menu-item';
    switchAccountItem.innerHTML = `<img src="iconmagic.png" alt="icon"> Trocar de Conta`;
    switchAccountItem.onclick = () => {
        handleSwitchAccount();
        closeAllMenus();
    };
    userMenu.appendChild(switchAccountItem);
    
    // Op√ß√£o de Logoff
    const logoutItem = document.createElement('div');
    logoutItem.className = 'menu-item';
    logoutItem.innerHTML = `<img src="iconmagic.png" alt="icon"> Sair (Logoff)`;
    logoutItem.onclick = handleLogout;
    userMenu.appendChild(logoutItem);
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: TROCAR DE CONTA GOOGLE
// -------------------------------------------------------------
async function handleSwitchAccount() {
    try {
        // Registrar logout antes de trocar
        if (currentUser) {
            const ipData = await getIPData();
            await registerUserLog(currentUser, ipData, "switch_account");
        }
        
        // Primeiro faz logout da conta atual
        await signOut(auth);
        
        // Configura o provedor para sempre pedir sele√ß√£o de conta
        provider.setCustomParameters({
            prompt: 'select_account'
        });
        
        // Faz login novamente, mostrando a tela de sele√ß√£o de conta
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        
        console.log(`Conta alterada para: ${user.email}`);
        
        // Recarrega a personaliza√ß√£o do novo usu√°rio
        await loadUserCustomization(user.uid, user.displayName, user.email);
        populateUserMenu(user.displayName, user.email);
        
    } catch (error) {
        console.error("Erro ao trocar de conta:", error);
        
        // Se o usu√°rio cancelar, volta para a tela de login
        if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
            // Mant√©m na tela de login
            loginScreen.style.display = "flex";
            desktop.style.display = "none";
        } else {
            alert("Erro ao tentar trocar de conta. Tente novamente.");
        }
    }
}

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: CARREGA OS LINKS DO FIRESTORE
// -------------------------------------------------------------
async function loadDynamicLinks(userId) {
    try {
        const SITE_ID = "adminwazzimagiygg";
        const KEY_DOCUMENT_ID = `${SITE_ID}_menu_list`;
        const docRef = doc(db, "keymenulista", KEY_DOCUMENT_ID);
        const docSnap = await getDoc(docRef);

        let allLinksFromDB = [];

        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data[KEY_ARRAY_FIELD] && Array.isArray(data[KEY_ARRAY_FIELD])) {
                allLinksFromDB = data[KEY_ARRAY_FIELD].map(item => ({
                    name: item.titulo,
                    url: item.link_url,
                    iconUrl: item.url_imagem || 'iconmagic.png', 
                    menu_target: item.menu_target || 'outros' 
                }));
            }
        }
        
        const linksParaIniciar = allLinksFromDB.filter(item => item.menu_target === 'menu_iniciar');
        const linksParaAdmin = allLinksFromDB.filter(item => item.menu_target === 'wiki_pedia');
        const linksParaFerramentas = allLinksFromDB.filter(item => item.menu_target === 'ferramentas');

        const staticStartLinks = [
        { name: 'Termos de Servi√ßo', url: 'https://wazzimagiygg.com/Termos%20de%20Servi%C3%A7o.pdf', iconUrl: 'iconmagic.png' },
        { name: 'Pol√≠tica de Privacidade', url: 'https://wazzimagiygg.com/Pol%C3%ADtica%20de%20Privacidade.pdf', iconUrl: 'iconmagic.png' },
        { name: 'Termos de Servi√ßo da WIKI WAZZIMAGIYGG BRASIL', url: 'https://wazzimagiygg.com/html/?uid=42LLRmne0HAgdFtzzgwG', iconUrl: 'iconmagic.png' },
        { name: 'Manual de Pol√≠ticas de Privacidade e Modera√ß√£o', url: 'https://wazzimagiygg.com/html/?uid=9oD5c9P1uWmjI2C3bZSu', iconUrl: 'iconmagic.png' },
        { name: 'Manual de Pol√≠ticas de direito de privacidade', url: 'https://wazzimagiygg.com/html/?uid=F5CmMQDbrTpipTZoqd2x', iconUrl: 'iconmagic.png' },
        { name: 'Direito de privacidade sobre WazzimaGiygg', url: 'https://wazzimagiygg.com/html/?uid=ik1hWPxqHKLjA13MIqVW', iconUrl: 'iconmagic.png' },
        { name: 'Painel Administrativo', url: 'https://wazzimagiygg.com/central/?uid=admin', iconUrl: 'iconmagic.png' }, //h
        { name: 'Logoff (Sair)', action: 'logout', iconUrl: 'iconmagic.png' }¬†
        ];

        const staticAdminLinks = [
        { label: "P√°gina inicial", href: "https://wazzimagiygg.com/admin/recepcao.html" },
        { label: "Adicionar Artigo", href: "https://wazzimagiygg.com/admin/admintools/editordeartigos.html" },
        { label: "Conhe√ßa WazzimaGiygg", href: "https://wazzimagiygg.com/admin/conhecawazzimagiygg.html" },
        { label: "Ferramentas", href: "https://wazzimagiygg.com/admin/ferramentasadministrativas.html" },
        //{ label: "GitHub", href: "https://github.com/" },
        { label: "Check User", href: "https://wazzimagiygg.com/admin/checkuser/" },
        { label: "Criar Menu Fixo", href: "https://wazzimagiygg.com/admin/criarmenufixo/" },
        { label: "Adicionar cidades sancionadas", href: "https://wazzimagiygg.com/admin/cidadessancionadas/" },
        { label: "Chat Admin", href: "https://wazzimagiygg.com/admin/chat/admin/" } //admin/cidadessancionadas/
        ];

        const finalStartLinks = [...linksParaIniciar, ...staticStartLinks];
        const finalAdminLinks = [...linksParaAdmin, ...staticAdminLinks];
        const finalToolLinks = linksParaFerramentas;

        populateMenu(startMenu, finalStartLinks);
        populateMenu(adminMenu, finalAdminLinks);
        populateToolsMenu(finalToolLinks);

    } catch (error) {
        console.error("Erro ao carregar links do Firebase:", error);
        populateMenu(startMenu, [
             { name: 'Fale com a Administra√ß√£o (Erro)', url: 'html/?uid=a13IwrEoc1Jmdi2I3Hve', iconUrl: 'iconmagic.png' },
             { name: 'Logoff (Sair)', action: 'logout', iconUrl: 'iconmagic.png' }
        ]);
        populateMenu(adminMenu, [{ name: "Chat (Erro)", url: "#" }]);
        populateToolsMenu([]);
    }
}

// üÜï FUN√á√ÉO PARA MONTAR MENUS
function populateMenu(menuElement, linksArray) {
    menuElement.innerHTML = ''; 

    linksArray.forEach(item => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `<img src="${item.iconUrl || 'iconmagic.png'}" alt="icon"> ${item.name}`;
        
        div.onclick = () => {
            if (item.action === 'logout') {
                handleLogout(); 
            } else {
                openWindow(item.name, item.url, item.iconUrl);
            }
            closeAllMenus();
        };
        menuElement.appendChild(div);
    });
}

// üÜï FUN√á√ÉO PARA MONTAR MENU DE FERRAMENTAS
function populateToolsMenu(linksArray) {
    toolsMenu.innerHTML = ''; 
    
    const filteredLinks = linksArray.filter(link => 
        !link.url.includes('base44.app') && !link.url.includes('base44.com')
    );
    
    filteredLinks.forEach(link => {
        const a = document.createElement("a");
        a.textContent = link.name;
        a.href = link.url;
        
        a.onclick = (e) => {
            e.preventDefault();
            openWindow(link.name, link.url, link.iconUrl);
            closeAllMenus();
        };
        
        toolsMenu.appendChild(a);
    });
}

// L√≥gica dos bot√µes da taskbar
startBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = startMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        startMenu.style.display = "block";
        menuOverlay.style.display = "block";
        startMenu.style.left = "10px";
        startMenu.style.bottom = "40px";
    }
};

adminBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = adminMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        adminMenu.style.display = "block";
        menuOverlay.style.display = "block";
        adminMenu.style.left = "120px";
        adminMenu.style.bottom = "40px";
    }
};

toolsBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = toolsMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        toolsMenu.style.display = "block";
        menuOverlay.style.display = "block";
        toolsMenu.style.left = "230px";
        toolsMenu.style.bottom = "40px";
    }
};

// -------------------------------------------------------------
// üöÄ FUN√á√ÉO: LOGOUT
// -------------------------------------------------------------
async function handleLogout() {
    try {
        // Registrar logout antes de sair
        if (currentUser) {
            const ipData = await getIPData();
            await registerUserLog(currentUser, ipData, "logout");
        }
        
        await signOut(auth);
        closeAllMenus();
        customizationWindow.style.display = 'none';
    } catch (error) {
        console.error("Erro ao sair:", error);
        alert("Erro ao tentar fazer logoff.");
    }
}

// Fun√ß√£o para atualizar o rel√≥gio 
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
    const dateString = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    clockElement.innerHTML = `<span>${timeString}</span><br><span>${dateString}</span>`;
    setTimeout(updateClock, 1000);
}

// üÜï FUN√á√ÉO PARA ABRIR JANELA (MODIFICADA)
function openWindow(title, url, icon = 'iconmagic.png') {
    const win = document.createElement("div");
    win.className = "window";
    win.innerHTML = `
        <div class="window-header">
            <span>${title}</span>
            <div class="window-controls">
                <button class="minimize" title="Minimizar">‚Äî</button>
                <button class="maximize" title="Maximizar">‚¨ú</button>
                <button class="close" title="Fechar">‚úñ</button>
            </div>
        </div>
        <iframe src="${url}"></iframe>
    `;
    document.body.appendChild(win);

    const header = win.querySelector(".window-header");
    let isDragging = false;
    let offsetX, offsetY;
    let maximized = false;
    let prev = { top: 0, left: 0, width: 0, height: 0 };

    // Adiciona ao gerenciador de janelas
    const windowId = windowManager.addWindow(win, title, icon, url);
    
    // Clique na janela para torn√°-la ativa
    win.addEventListener('click', (e) => {
        e.stopPropagation();
        windowManager.setActiveWindow(windowId);
        windowManager.bringToFront(win);
    });

    // Sistema de arrastar
    header.addEventListener("mousedown", (e) => {
        if (maximized) return;
        isDragging = true;
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        e.stopPropagation();
        windowManager.setActiveWindow(windowId);
        windowManager.bringToFront(win);
    });

    document.addEventListener("mousemove", (e) => {
        if (isDragging && !maximized) {
            win.style.left = e.clientX - offsetX + "px";
            win.style.top = e.clientY - offsetY + "px";
        }
    });

    document.addEventListener("mouseup", () => isDragging = false);

    // Bot√£o fechar
    win.querySelector(".close").onclick = (e) => {
        e.stopPropagation();
        windowManager.removeWindow(windowId);
        win.remove();
    };
    
    // Bot√£o minimizar
    win.querySelector(".minimize").onclick = (e) => {
        e.stopPropagation();
        windowManager.minimizeWindow(windowId);
    };
    
    // Bot√£o maximizar
    win.querySelector(".maximize").onclick = (e) => {
        e.stopPropagation();
        if (!maximized) {
            prev = { top: win.offsetTop, left: win.offsetLeft, width: win.offsetWidth, height: win.offsetHeight };
            win.style.top = "0";
            win.style.left = "0";
            win.style.width = "100%";
            win.style.height = "calc(100% - 40px)";
            maximized = true;
        } else {
            win.style.top = prev.top + "px";
            win.style.left = prev.left + "px";
            win.style.width = prev.width + "px";
            win.style.height = prev.height + "px";
            maximized = false;
        }
        windowManager.bringToFront(win);
    };
}

// üîπ FUN√á√ïES DE IP E LOCALIZA√á√ÉO (MODIFICADAS)
async function getIPData() {
    try {
        const response = await fetch('https://ipinfo.io/json');
        const data = await response.json();
        return data;
    } catch (error) {
        console.error("Erro ao obter dados de IP:", error);
        return {
            ip: 'N/A',
            city: 'Desconhecida',
            region: 'Desconhecido',
            country: 'Desconhecido',
            loc: 'N/A',
            org: 'N/A',
            postal: 'N/A',
            timezone: 'N/A'
        };
    }
}

async function buscarIpELocalizacao() {
    notificationPopup.innerHTML = ''; 
    notificationIcon.style.color = 'white';
    
    try {
        const data = await getIPData();
        
        const ip = data.ip || 'N/A';
        const cidadeDoUsuario = data.city || 'Desconhecida';
        const estadoDoUsuario = data.region || 'Desconhecido';
        const paisDoUsuario = data.country || ''; 
        
        addNotification(`Seu IP P√∫blico: <strong>${ip}</strong>`, 'info');
        addNotification(`Localiza√ß√£o Detectada: ${cidadeDoUsuario}, ${estadoDoUsuario}, ${paisDoUsuario}`, 'info');

        verificarSancao(cidadeDoUsuario, paisDoUsuario);
        
        // Retorna os dados para uso posterior
        return data;
        
    } catch (error) {
        console.error("Erro ao obter IP ou localiza√ß√£o:", error);
        addNotification('Erro: Falha ao obter endere√ßo IP/Localiza√ß√£o.', 'error');
        // Retorna um objeto vazio para n√£o quebrar o c√≥digo
        return {};
    }
}    

function addNotification(message, type = 'info') {
    const div = document.createElement("div");
    div.className = `notification-item ${type === 'error' ? 'sancao-alerta' : ''}`;
    div.innerHTML = message;
    notificationPopup.prepend(div); 
}

async function verificarSancao(cidadeUsuario, paisDoUsuario) {
    try {
        const jsonResponse = await fetch(JSON_URL);
        
        if (!jsonResponse.ok) {
            throw new Error(`Erro HTTP! Status: ${jsonResponse.status}`);
        }
        
        const cidadesSancionadasData = await jsonResponse.json();
        
        const cidadeFormatada = cidadeUsuario.trim().toLowerCase();
        const paisFormatado = paisDoUsuario.trim().toLowerCase();

        const alertaEncontrado = cidadesSancionadasData.cidades_sancionadas.find(item => 
            item.cidade.trim().toLowerCase() === cidadeFormatada || 
            item.cidade.trim().toLowerCase() === paisFormatado      
        );
        
        if (alertaEncontrado) {
            const alertaHTML = `
                üö® Alerta de San√ß√£o! üö®<br>Regi√£o com poss√≠veis usu√°rios sancionados.
                <br>
                (Moderador: <strong>${alertaEncontrado.moderador}</strong>)
            `;
            addNotification(alertaHTML, 'error');
            
            notificationIcon.style.color = '#cc0000';
        }
        
    } catch (error) {
        console.warn("Aviso: Falha ao carregar ou processar o JSON de san√ß√µes. Verifique o arquivo.", error);
    }
}

// Event Listeners para personaliza√ß√£o
saveCustomizationBtn.onclick = () => {
    const user = auth.currentUser;
    if (user) {
        saveUserCustomization(user.uid);
    }
};

resetCustomizationBtn.onclick = () => {
    const user = auth.currentUser;
    if (user) {
        resetUserCustomization(user.uid);
    }
};

closeCustomizationBtn.onclick = () => {
    customizationWindow.style.display = 'none';
    menuOverlay.style.display = 'none';
};

// Inicializar pr√©-visualiza√ß√£o de cor
menuColorInput.addEventListener('input', (e) => {
    const menuColorPreview = document.getElementById('menuColorPreview');
    if (menuColorPreview) {
        menuColorPreview.style.backgroundColor = e.target.value;
    }
});

// Inicializar menu de personaliza√ß√£o com cor padr√£o
window.addEventListener('DOMContentLoaded', () => {
    const menuColorPreview = document.getElementById('menuColorPreview');
    if (menuColorPreview) {
        menuColorPreview.style.backgroundColor = menuColorInput.value;
    }
});
</script>

</body>
</html>
