<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Multi-Abas - Coleção Universal</title>
    <!-- Firebase SDKs COMPATÍVEIS (versão compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #34495e;
        }

        .header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collection-info {
            background: #3498db;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #3498db;
        }

        .auth-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .auth-btn.logout {
            background: #e74c3c;
        }

        .auth-btn.logout:hover {
            background: #c0392b;
        }

        .tabs-container {
            background: #ecf0f1;
            padding: 0 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #bdc3c7;
            min-height: 60px;
        }

        .tabs-list {
            display: flex;
            overflow-x: auto;
            flex: 1;
            padding: 10px 0;
        }

        .tab {
            background: white;
            padding: 12px 25px;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #bdc3c7;
            border-bottom: none;
            white-space: nowrap;
            position: relative;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            background: white;
            border-bottom: 2px solid #3498db;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-close {
            background: none;
            border: none;
            color: #7f8c8d;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .tab-close:hover {
            background: #e74c3c;
            color: white;
        }

        .add-tab-btn {
            background: #2ecc71;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-tab-btn:hover {
            background: #27ae60;
            transform: rotate(90deg);
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            background: #f8f9fa;
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .tool-btn {
            background: white;
            border: 1px solid #ced4da;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .tool-btn.save {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .tool-btn.save:hover {
            background: #2980b9;
        }

        .tool-btn.share {
            background: #9b59b6;
            color: white;
            border-color: #8e44ad;
        }

        .tool-btn.share:hover {
            background: #8e44ad;
        }

        .status-indicator {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
        }

        .status-dot.saving {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .editor-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }

        .editor-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            font-family: 'Courier New', Courier, monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .editor-textarea:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            height: 100%;
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .login-container p {
            margin-bottom: 30px;
            color: #7f8c8d;
            max-width: 500px;
        }

        .footer {
            background: #2c3e50;
            color: #bdc3c7;
            padding: 15px 25px;
            text-align: center;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doc-count {
            background: #34495e;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .collection-stats {
            background: #34495e;
            padding: 5px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .no-tabs-message {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #7f8c8d;
            text-align: center;
            padding: 40px;
        }

        .no-tabs-message i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #bdc3c7;
        }

        .tab-title-input {
            background: transparent;
            border: none;
            outline: none;
            font-weight: inherit;
            font-size: inherit;
            width: 150px;
        }

        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .share-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .share-modal-content h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .share-url {
            display: flex;
            margin: 20px 0;
            gap: 10px;
        }

        .share-url input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .share-url button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .share-modal-close {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                height: 95vh;
                border-radius: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .tabs-container {
                padding: 0 10px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .editor-toolbar {
                flex-wrap: wrap;
            }
            
            .tool-btn span {
                display: none;
            }
            
            .footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .collection-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <div class="header">
            <h1><i class="fas fa-file-alt"></i> Editor Universal</h1>
            <div class="collection-info">
                <i class="fas fa-database"></i>
                <span>Coleção: documentouniversal</span>
            </div>
            <div class="user-info">
                <div id="userDisplay" style="display: none;">
                    <img id="userPhoto" alt="Foto do usuário">
                    <span id="userName"></span>
                </div>
                <button id="authButton" class="auth-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Entrar com Google</span>
                </button>
            </div>
        </div>

        <!-- Container de abas -->
        <div class="tabs-container">
            <div class="tabs-list" id="tabsList">
                <!-- Abas serão adicionadas aqui dinamicamente -->
            </div>
            <button id="addTabBtn" class="add-tab-btn" title="Nova aba">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Container do editor -->
        <div class="editor-container" id="editorContainer">
            <!-- Tela de login -->
            <div class="login-container" id="loginContainer">
                <h2>Editor com Coleção Universal</h2>
                <p>Todos os documentos são salvos em uma única coleção do Firebase chamada <strong>"documentouniversal"</strong>. Cada documento contém o ID do usuário para controle de acesso.</p>
                <button id="loginPromptBtn" class="auth-btn">
                    <i class="fab fa-google"></i>
                    <span>Entrar com Google para começar</span>
                </button>
            </div>

            <!-- Interface do editor (inicialmente oculta) -->
            <div id="editorInterface" style="display: none; height: 100%;">
                <div class="editor-toolbar">
                    <button class="tool-btn" id="boldBtn">
                        <i class="fas fa-bold"></i>
                        <span>Negrito</span>
                    </button>
                    <button class="tool-btn" id="italicBtn">
                        <i class="fas fa-italic"></i>
                        <span>Itálico</span>
                    </button>
                    <button class="tool-btn" id="underlineBtn">
                        <i class="fas fa-underline"></i>
                        <span>Sublinhado</span>
                    </button>
                    <button class="tool-btn share" id="shareBtn">
                        <i class="fas fa-share"></i>
                        <span>Compartilhar</span>
                    </button>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Salvo</span>
                    </div>
                    <button class="tool-btn save" id="saveBtn">
                        <i class="fas fa-save"></i>
                        <span>Salvar agora</span>
                    </button>
                </div>
                
                <div class="editor-content">
                    <textarea class="editor-textarea" id="editorTextarea" 
                              placeholder="Comece a digitar aqui... Seu conteúdo será salvo automaticamente na coleção 'documentouniversal'."></textarea>
                </div>
            </div>

            <!-- Mensagem quando não há abas -->
            <div class="no-tabs-message" id="noTabsMessage" style="display: none;">
                <i class="fas fa-folder-open"></i>
                <h3>Nenhum documento aberto</h3>
                <p>Clique no botão "+" acima para criar seu primeiro documento.</p>
            </div>
        </div>

        <!-- Rodapé -->
        <div class="footer">
            <div>Editor com Coleção Universal</div>
            <div class="collection-stats">
                <i class="fas fa-database"></i>
                <span>documentouniversal: <span id="totalDocs">0</span> docs</span>
            </div>
            <div>Firebase Firestore</div>
        </div>
    </div>

    <!-- Modal de Compartilhamento -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <h3><i class="fas fa-share-alt"></i> Compartilhar Documento</h3>
            <p>Este documento está salvo na coleção <strong>documentouniversal</strong> com o ID:</p>
            <div class="share-url">
                <input type="text" id="shareDocId" readonly>
                <button onclick="copyDocId()">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <p><small>Outros usuários podem acessar este documento usando este ID.</small></p>
            <button class="share-modal-close" id="closeShareModal">Fechar</button>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Nome da coleção universal
        const UNIVERSAL_COLLECTION = "documentouniversal";

        // Estado da aplicação
        let currentUser = null;
        let tabs = [];
        let activeTabId = null;
        let saveTimeout = null;
        let isSaving = false;
        let totalDocumentCount = 0;

        // Elementos DOM
        const authButton = document.getElementById('authButton');
        const loginPromptBtn = document.getElementById('loginPromptBtn');
        const userDisplay = document.getElementById('userDisplay');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');
        const tabsList = document.getElementById('tabsList');
        const addTabBtn = document.getElementById('addTabBtn');
        const loginContainer = document.getElementById('loginContainer');
        const editorInterface = document.getElementById('editorInterface');
        const noTabsMessage = document.getElementById('noTabsMessage');
        const editorTextarea = document.getElementById('editorTextarea');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const saveBtn = document.getElementById('saveBtn');
        const shareBtn = document.getElementById('shareBtn');
        const shareModal = document.getElementById('shareModal');
        const shareDocId = document.getElementById('shareDocId');
        const closeShareModal = document.getElementById('closeShareModal');
        const totalDocs = document.getElementById('totalDocs');

        // Ferramentas de formatação
        document.getElementById('boldBtn').addEventListener('click', () => {
            formatText('bold');
        });
        
        document.getElementById('italicBtn').addEventListener('click', () => {
            formatText('italic');
        });
        
        document.getElementById('underlineBtn').addEventListener('click', () => {
            formatText('underline');
        });

        // Função para formatar texto
        function formatText(command) {
            document.execCommand(command, false, null);
            editorTextarea.focus();
        }

        // Função para copiar ID do documento
        function copyDocId() {
            shareDocId.select();
            document.execCommand('copy');
            alert('ID do documento copiado para a área de transferência!');
        }

        // Contar documentos na coleção universal
        async function countUniversalDocuments() {
            try {
                const snapshot = await db.collection(UNIVERSAL_COLLECTION).get();
                totalDocumentCount = snapshot.size;
                totalDocs.textContent = totalDocumentCount;
            } catch (error) {
                console.error('Erro ao contar documentos:', error);
            }
        }

        // Atualizar status de salvamento
        function updateStatus(saving) {
            isSaving = saving;
            if (saving) {
                statusDot.classList.add('saving');
                statusText.textContent = 'Salvando...';
            } else {
                statusDot.classList.remove('saving');
                statusText.textContent = 'Salvo';
            }
        }

        // SALVAR na coleção documentouniversal
        async function saveTabContent() {
            if (!currentUser || !activeTabId) return;
            
            const tab = tabs.find(t => t.id === activeTabId);
            if (!tab) return;
            
            const content = editorTextarea.value;
            const title = tab.title || 'Sem título';
            
            updateStatus(true);
            
            try {
                // SALVAMENTO NA COLEÇÃO UNIVERSAL
                await db.collection(UNIVERSAL_COLLECTION).doc(activeTabId).set({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    title: title,
                    content: content,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: tab.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                    lastAccess: new Date().toISOString()
                }, { merge: true });
                
                // Atualizar localmente
                tab.content = content;
                tab.title = title;
                tab.updatedAt = new Date().toISOString();
                
                updateStatus(false);
                
                // Atualizar contador de documentos
                await countUniversalDocuments();
                
                console.log(`Documento salvo na coleção "${UNIVERSAL_COLLECTION}":`, activeTabId);
            } catch (error) {
                console.error('Erro ao salvar:', error);
                updateStatus(false);
                statusText.textContent = 'Erro ao salvar';
                setTimeout(() => {
                    if (!isSaving) statusText.textContent = 'Salvo';
                }, 3000);
            }
        }

        // Salvar com debounce
        function debounceSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveTabContent, 2000);
        }

        // Criar nova aba
        function createNewTab(title = 'Nova aba') {
            const tabId = 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const newTab = {
                id: tabId,
                title: title,
                content: '',
                userId: currentUser ? currentUser.uid : null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            tabs.push(newTab);
            renderTabs();
            switchToTab(tabId);
            
            // Salvar no Firebase
            if (currentUser) {
                saveTabContent();
            }
            
            return tabId;
        }

        // Renderizar abas
        function renderTabs() {
            tabsList.innerHTML = '';
            
            tabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.className = `tab ${tab.id === activeTabId ? 'active' : ''}`;
                tabElement.dataset.tabId = tab.id;
                
                tabElement.innerHTML = `
                    <input type="text" class="tab-title-input" value="${tab.title}" 
                           data-tab-id="${tab.id}" maxlength="30">
                    <button class="tab-close" data-tab-id="${tab.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                tabsList.appendChild(tabElement);
                
                // Evento para mudar de aba
                tabElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close') && 
                        !e.target.classList.contains('fa-times') &&
                        !e.target.classList.contains('tab-title-input')) {
                        switchToTab(tab.id);
                    }
                });
                
                // Evento para fechar aba
                const closeBtn = tabElement.querySelector('.tab-close');
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tab.id);
                });
                
                // Evento para editar título
                const titleInput = tabElement.querySelector('.tab-title-input');
                titleInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                titleInput.addEventListener('blur', (e) => {
                    tab.title = e.target.value;
                    if (tab.id === activeTabId) {
                        saveTabContent();
                    }
                });
                
                titleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                });
            });
            
            // Mostrar/ocultar mensagem de nenhuma aba
            if (tabs.length === 0) {
                editorInterface.style.display = 'none';
                noTabsMessage.style.display = 'flex';
            } else {
                noTabsMessage.style.display = 'none';
                editorInterface.style.display = 'block';
            }
        }

        // Mudar para uma aba específica
        function switchToTab(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            activeTabId = tabId;
            editorTextarea.value = tab.content;
            renderTabs();
            
            // Focar no editor
            editorTextarea.focus();
        }

        // Fechar aba
        async function closeTab(tabId) {
            if (tabs.length <= 1) {
                alert('Você precisa ter pelo menos uma aba aberta');
                return;
            }
            
            // Remover do Firebase (coleção universal)
            if (currentUser) {
                try {
                    await db.collection(UNIVERSAL_COLLECTION).doc(tabId).delete();
                    await countUniversalDocuments();
                } catch (error) {
                    console.error('Erro ao excluir do Firebase:', error);
                }
            }
            
            // Remover localmente
            tabs = tabs.filter(t => t.id !== tabId);
            
            // Se fechou a aba ativa, mudar para a primeira aba disponível
            if (tabId === activeTabId) {
                activeTabId = tabs.length > 0 ? tabs[0].id : null;
                if (activeTabId) {
                    switchToTab(activeTabId);
                }
            }
            
            renderTabs();
        }

        // CARREGAR documentos da coleção universal
        async function loadTabsFromFirebase() {
            if (!currentUser) return;
            
            try {
                // Consulta para pegar apenas documentos do usuário atual
                const snapshot = await db.collection(UNIVERSAL_COLLECTION)
                    .where('userId', '==', currentUser.uid)
                    .orderBy('updatedAt', 'desc')
                    .get();
                
                tabs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tabs.push({
                        id: doc.id,
                        title: data.title || 'Sem título',
                        content: data.content || '',
                        userId: data.userId,
                        createdAt: data.createdAt?.toDate().toISOString() || new Date().toISOString(),
                        updatedAt: data.updatedAt?.toDate().toISOString() || new Date().toISOString()
                    });
                });
                
                // Atualizar contador total
                await countUniversalDocuments();
                
                if (tabs.length > 0) {
                    renderTabs();
                    switchToTab(tabs[0].id);
                } else {
                    // Criar primeira aba se não houver nenhuma
                    createNewTab('Meu primeiro documento');
                }
                
                console.log(`Carregados ${tabs.length} documentos da coleção "${UNIVERSAL_COLLECTION}"`);
            } catch (error) {
                console.error('Erro ao carregar documentos:', error);
                // Criar uma aba padrão em caso de erro
                createNewTab('Documento de exemplo');
            }
        }

        // Autenticação com Google
        function setupAuth() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            authButton.addEventListener('click', () => {
                if (currentUser) {
                    // Logout
                    auth.signOut();
                } else {
                    // Login
                    auth.signInWithPopup(provider).catch(error => {
                        console.error('Erro de autenticação:', error);
                        alert('Erro ao fazer login: ' + error.message);
                    });
                }
            });
            
            loginPromptBtn.addEventListener('click', () => {
                auth.signInWithPopup(provider).catch(error => {
                    console.error('Erro de autenticação:', error);
                    alert('Erro ao fazer login: ' + error.message);
                });
            });
            
            // Monitorar estado de autenticação
            auth.onAuthStateChanged(user => {
                currentUser = user;
                
                if (user) {
                    // Usuário logado
                    userPhoto.src = user.photoURL || 'https://via.placeholder.com/40';
                    userName.textContent = user.displayName || 'Usuário';
                    userDisplay.style.display = 'flex';
                    
                    authButton.innerHTML = '<i class="fas fa-sign-out-alt"></i><span>Sair</span>';
                    authButton.classList.add('logout');
                    
                    // Mostrar editor e esconder tela de login
                    loginContainer.style.display = 'none';
                    editorInterface.style.display = 'block';
                    
                    // Carregar documentos da coleção universal
                    loadTabsFromFirebase();
                } else {
                    // Usuário não logado
                    userDisplay.style.display = 'none';
                    
                    authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i><span>Entrar com Google</span>';
                    authButton.classList.remove('logout');
                    
                    // Mostrar tela de login e esconder editor
                    loginContainer.style.display = 'flex';
                    editorInterface.style.display = 'none';
                    noTabsMessage.style.display = 'none';
                    
                    // Limpar abas locais
                    tabs = [];
                    activeTabId = null;
                    renderTabs();
                }
            });
        }

        // Event listeners
        addTabBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert('Por favor, faça login para criar documentos');
                return;
            }
            createNewTab();
        });

        editorTextarea.addEventListener('input', () => {
            // Atualizar conteúdo localmente
            const tab = tabs.find(t => t.id === activeTabId);
            if (tab) {
                tab.content = editorTextarea.value;
                tab.updatedAt = new Date().toISOString();
            }
            
            // Salvar automaticamente após um delay
            debounceSave();
        });

        saveBtn.addEventListener('click', () => {
            saveTabContent();
        });

        shareBtn.addEventListener('click', () => {
            if (!activeTabId) {
                alert('Nenhum documento selecionado para compartilhar');
                return;
            }
            shareDocId.value = activeTabId;
            shareModal.style.display = 'flex';
        });

        closeShareModal.addEventListener('click', () => {
            shareModal.style.display = 'none';
        });

        // Fechar modal ao clicar fora
        window.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });

        // Teclas de atalho
        document.addEventListener('keydown', (e) => {
            // Ctrl+S ou Cmd+S para salvar
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveTabContent();
            }
            
            // Ctrl+T ou Cmd+T para nova aba
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                createNewTab();
            }
            
            // Ctrl+W ou Cmd+W para fechar aba
            if ((e.ctrlKey || e.metaKey) && e.key === 'w') {
                e.preventDefault();
                if (activeTabId) {
                    closeTab(activeTabId);
                }
            }
            
            // Ctrl+H ou Cmd+H para compartilhar
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                if (activeTabId) {
                    shareDocId.value = activeTabId;
                    shareModal.style.display = 'flex';
                }
            }
            
            // Esc para fechar modal
            if (e.key === 'Escape') {
                shareModal.style.display = 'none';
            }
        });

        // Inicializar
        function init() {
            setupAuth();
            
            // Contar documentos na coleção universal
            countUniversalDocuments();
            
            // Atualizar contador a cada 30 segundos
            setInterval(countUniversalDocuments, 30000);
            
            // Criar uma aba de exemplo para demonstração (quando não logado)
            if (!currentUser) {
                setTimeout(() => {
                    if (!currentUser && tabs.length === 0) {
                        // Apenas para demonstração da interface
                        createNewTab('Documento de demonstração');
                        editorTextarea.value = `ESTE DOCUMENTO SERÁ SALVO NA COLEÇÃO "documentouniversal"

Estrutura do documento no Firebase:
- ID: ${activeTabId}
- Coleção: documentouniversal
- Campos:
  • userId: ID do usuário Google
  • userEmail: email do usuário
  • userName: nome do usuário
  • title: título do documento
  • content: conteúdo completo
  • createdAt: data de criação
  • updatedAt: data da última edição

Faça login com Google para salvar seus documentos na coleção universal!`;
                        editorInterface.style.display = 'block';
                        noTabsMessage.style.display = 'none';
                    }
                }, 1000);
            }
        }

        // Iniciar aplicação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
