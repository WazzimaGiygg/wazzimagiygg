<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Quadrado M√≥vel com Transi√ß√£o e Obst√°culos</title>
    <style>
        body {
            margin: 0;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            font-family: Arial, sans-serif;
            overflow: hidden;
            outline: none; 
        }

        /* O cont√™iner que representa o Mapa/Fase */
        #mapa {
            position: relative; 
            border: 4px solid #f39c12;
            background-color: #ecf0f1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 400px; 
            height: 300px;
            transition: width 0.5s, height 0.5s; 
            cursor: pointer;
        }

        /* O elemento que ir√° se mover (o jogador) */
        #quadrado {
            width: 50px;
            height: 50px;
            background-color: #e74c3c; /* Vermelho para o jogador */
            position: absolute;
            border: 2px solid #c0392b;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s; 
            z-index: 10; /* Garante que o jogador fique por cima dos elementos */
        }

        /* Estilo para o painel de informa√ß√µes */
        #painel {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- Estilos para os Elementos do Mapa --- */
        .elemento-mapa {
            position: absolute;
            box-sizing: border-box;
            z-index: 5; /* Garante que os elementos fiquem abaixo do jogador */
        }

        .muro {
            background-color: #34495e; /* Cinza/Azul Escuro */
            border: 1px solid #2c3e50;
        }

        .arvore {
            background-color: #27ae60; /* Verde Floresta */
        }

        .rio {
            background-color: #3498db; /* Azul √Ågua */
        }

        .portal {
            background-color: #f1c40f; /* Amarelo Vibrante para o Port√£o */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px; 
            opacity: 0.8;
            border: 2px solid #e67e22;
        }
        /* Novo elemento que causa dano */
        .fogo {
            background-color: #e74c3c; /* Vermelho/Fogo */
            border: 3px dashed #f39c12; /* Borda de alerta amarela */
            animation: pulse 1s infinite alternate; /* Efeito visual de alerta */
        }
        
        /* Efeito visual para o jogador quando invenc√≠vel (tomando dano) */
        .invencivel {
            opacity: 0.5; /* Fica meio transparente */
            background-color: #3498db !important; /* Mudar cor para feedback */
        }

        @keyframes pulse {
            from { opacity: 0.8; }
            to { opacity: 1.0; }
        }
    </style>
</head>
<body>

    <div id="painel">
        **WASD** para Mover | Mapa Atual: <span id="mapa-nome">A carregar...</span>
    </div>

    <div id="mapa">
        <div id="quadrado"></div>
    </div>

 <script>
        // --- Configura√ß√µes Globais ---
        const VELOCIDADE = 15;
        const HP_MAXIMO = 3; 
        const TEMPO_INVENCIBILIDADE = 1000; // 1 segundo em milissegundos
        
        const quadrado = document.getElementById('quadrado');
        const mapaElement = document.getElementById('mapa');
        const painelElement = document.getElementById('painel'); 
        
        // --- Vari√°veis de Estado do Jogador ---
        let x = 0; 
        let y = 0; 
        let mapaAtual = null; 
        let jogadorHP = HP_MAXIMO; 
        let jogadorUID = gerarUID(); 
        let isInvencivel = false; // Controle de cooldown de dano

        // --- Fun√ß√µes de Utilidade ---

        /**
         * Gera um ID √∫nico de 3 d√≠gitos (ex: 123).
         */
        function gerarUID() {
            return Math.floor(Math.random() * 900) + 100;
        }

        /**
         * Atualiza o painel de informa√ß√µes com os dados do jogador e do mapa.
         */
        function atualizarPainel() {
            let hpDisplay;
            if (jogadorHP > 0) {
                hpDisplay = '‚ù§Ô∏è'.repeat(jogadorHP);
            } else {
                hpDisplay = 'üíÄ GAME OVER üíÄ';
            }

            painelElement.innerHTML = `
                **UID:** ${jogadorUID} | 
                **HP:** ${hpDisplay} | 
                **Mapa Atual:** ${mapaAtual ? mapaAtual.nome : 'A carregar...'}
            `;
            
            // Se o HP for 0, bloqueia o mapa e exibe Game Over
            if (jogadorHP <= 0) {
                quadrado.style.display = 'none'; // Esconde o quadrado
                mapaElement.style.borderColor = '#c0392b'; // Borda vermelha
            } else {
                 quadrado.style.display = 'block';
            }
        }

        /**
         * Aplica um per√≠odo de invencibilidade ap√≥s o dano.
         */
        function aplicarInvencibilidade() {
            isInvencivel = true;
            quadrado.classList.add('invencivel'); // Adiciona o estilo visual

            setTimeout(() => {
                isInvencivel = false;
                quadrado.classList.remove('invencivel'); // Remove o estilo visual
            }, TEMPO_INVENCIBILIDADE);
        }

        /**
         * Checa se o quadrado colidiu com um elemento de dano (fogo)
         * e aplica a penalidade de HP.
         */
        function checarDano() {
            if (!mapaAtual || !mapaAtual.elementos || isInvencivel || jogadorHP <= 0) return;

            const larguraQuadrado = quadrado.clientWidth;
            const alturaQuadrado = quadrado.clientHeight;

            // Elementos que causam dano (Ex: fogo)
            const danos = mapaAtual.elementos.filter(el => el.tipo === 'fogo');

            for (const dano of danos) {
                // Checagem de colis√£o AABB
                const colidiu = (
                    x < dano.x + dano.largura &&
                    x + larguraQuadrado > dano.x &&
                    y < dano.y + dano.altura &&
                    y + alturaQuadrado > dano.y
                );
                
                if (colidiu) {
                    jogadorHP--; // Perde 1 ponto de vida
                    aplicarInvencibilidade();
                    atualizarPainel();
                    
                    if (jogadorHP <= 0) {
                        console.log("Game Over!");
                        atualizarPainel(); 
                    }
                    return; // Sai do loop para aplicar invencibilidade
                }
            }
        }

        // --- Fun√ß√µes de Mapa e Movimento (Permanecem Largamente as Mesmas) ---
        
        function aplicarMovimento() {
            if (!mapaAtual) return;

            const larguraMapa = mapaAtual.largura;
            const alturaMapa = mapaAtual.altura;
            const larguraQuadrado = quadrado.clientWidth;
            const alturaQuadrado = quadrado.clientHeight;

            const maxX = larguraMapa - larguraQuadrado;
            const maxY = alturaMapa - alturaQuadrado;

            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            quadrado.style.left = `${x}px`;
            quadrado.style.top = `${y}px`;
        }

        function renderizarElementos() {
            mapaElement.querySelectorAll('.elemento-mapa').forEach(el => el.remove());

            if (!mapaAtual || !mapaAtual.elementos) return;

            mapaAtual.elementos.forEach((el, index) => {
                const div = document.createElement('div');
                div.className = `elemento-mapa ${el.tipo}`; 
                
                div.style.left = `${el.x}px`;
                div.style.top = `${el.y}px`;
                div.style.width = `${el.largura}px`;
                div.style.height = `${el.altura}px`;

                if (el.tipo === 'portal') {
                    div.innerHTML = 'üö™'; 
                }
                
                mapaElement.appendChild(div);
            });
        }

        function checarColisao(nextX, nextY) {
            if (!mapaAtual || !mapaAtual.elementos) return false;

            const larguraQuadrado = quadrado.clientWidth;
            const alturaQuadrado = quadrado.clientHeight;

            // Obst√°culos que causam colis√£o (bloqueiam o movimento), EXCLUINDO o fogo para permitir que o jogador toque nele
            const obstaculos = mapaAtual.elementos.filter(el => 
                el.tipo === 'muro' || el.tipo === 'arvore' || el.tipo === 'rio'
            );

            for (const obs of obstaculos) {
                if (
                    nextX < obs.x + obs.largura &&
                    nextX + larguraQuadrado > obs.x &&
                    nextY < obs.y + obs.altura &&
                    nextY + alturaQuadrado > obs.y
                ) {
                    return true;
                }
            }
            return false;
        }

        function checarTransicao() {
            if (!mapaAtual || !mapaAtual.gates) return false;

            for (const gate of mapaAtual.gates) {
                const larguraQuadrado = quadrado.clientWidth;
                const alturaQuadrado = quadrado.clientHeight;

                const inGateX = x + larguraQuadrado > gate.x[0] && x < gate.x[1];
                const inGateY = y + alturaQuadrado > gate.y[0] && y < gate.y[1];
                
                if (inGateX && inGateY) {
                    quadrado.style.backgroundColor = '#27ae60'; 
                    
                    setTimeout(() => {
                        carregarMapa(gate.destinoId, gate.destinoX, gate.destinoY);
                    }, 100); 
                    return true;
                }
            }
            quadrado.style.backgroundColor = '#e74c3c'; 
            return false;
        }

        async function carregarMapa(idMapa, newX, newY) {
            if (jogadorHP <= 0) return; // N√£o carrega se o jogo acabou

            const path = `mapa${idMapa}.json`; 
            atualizarPainel();

            try {
                const response = await fetch(path); 
                
                if (!response.ok) {
                    throw new Error(`C√≥digo de status: ${response.status}.`);
                }
                
                const novoMapa = await response.json(); 

                mapaAtual = novoMapa;

                mapaElement.style.width = `${mapaAtual.largura}px`;
                mapaElement.style.height = `${mapaAtual.altura}px`;
                
                renderizarElementos(); 
                
                x = newX !== undefined ? newX : mapaAtual.inicioX;
                y = newY !== undefined ? newY : mapaAtual.inicioY;

                aplicarMovimento();
                quadrado.style.backgroundColor = '#e74c3c'; 
                
                atualizarPainel();
                
            } catch (error) {
                console.error("Erro ao carregar o mapa:", error);
                
                mapaAtual = { nome: "ERRO DE CARREGAMENTO" };
                atualizarPainel();
                
                alert(`Erro de Carregamento. Servidor/Arquivos JSON falharam.`);
            }
        }
        
        // --- L√≥gica de Movimento ---
        document.addEventListener('keydown', (event) => {
            if (!mapaAtual || jogadorHP <= 0) return; // Bloqueia o movimento se o jogo acabou

            let nextX = x;
            let nextY = y;
            let moved = true;
            
            switch (event.key) {
                case 'w': case 'W':
                    nextY -= VELOCIDADE;
                    break;
                case 's': case 'S':
                    nextY += VELOCIDADE;
                    break;
                case 'a': case 'A':
                    nextX -= VELOCIDADE;
                    break;
                case 'd': case 'D':
                    nextX += VELOCIDADE;
                    break;
                default:
                    moved = false;
                    return; 
            }

            if (moved) {
                event.preventDefault(); 
                
                if (!checarColisao(nextX, nextY)) {
                    x = nextX;
                    y = nextY;
                    aplicarMovimento();
                    
                    // CHAMA A CHECAGEM DE DANO AP√ìS O MOVIMENTO
                    checarDano(); 
                    
                    // CHECAGEM DE TRANSI√á√ÉO AP√ìS DANO
                    checarTransicao();
                }
            }
        });

        // Inicia o jogo
        carregarMapa(1);
        atualizarPainel(); 
    </script>
</body>
</html>
