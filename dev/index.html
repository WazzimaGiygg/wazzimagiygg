<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Quadrado M√≥vel com Transi√ß√£o e Obst√°culos</title>
    <style>
        body {
            margin: 0;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            font-family: Arial, sans-serif;
            overflow: hidden;
            outline: none; 
        }

        /* O cont√™iner que representa o Mapa/Fase */
        #mapa {
            position: relative; 
            border: 4px solid #f39c12;
            background-color: #ecf0f1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 400px; 
            height: 300px;
            transition: width 0.5s, height 0.5s; 
            cursor: pointer;
        }

        /* O elemento que ir√° se mover (o jogador) */
        #quadrado {
            width: 50px;
            height: 50px;
            background-color: #e74c3c; /* Vermelho para o jogador */
            position: absolute;
            border: 2px solid #c0392b;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s; 
            z-index: 10; /* Garante que o jogador fique por cima dos elementos */
        }

        /* Estilo para o painel de informa√ß√µes */
        #painel {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* --- Estilos para os Elementos do Mapa --- */
        .elemento-mapa {
            position: absolute;
            box-sizing: border-box;
            z-index: 5; /* Garante que os elementos fiquem abaixo do jogador */
        }

        .muro {
            background-color: #34495e; /* Cinza/Azul Escuro */
            border: 1px solid #2c3e50;
        }

        .arvore {
            background-color: #27ae60; /* Verde Floresta */
        }

        .rio {
            background-color: #3498db; /* Azul √Ågua */
        }

        .portal {
            background-color: #f1c40f; /* Amarelo Vibrante para o Port√£o */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px; 
            opacity: 0.8;
            border: 2px solid #e67e22;
        }
    </style>
</head>
<body>

    <div id="painel">
        **WASD** para Mover | Mapa Atual: <span id="mapa-nome">A carregar...</span>
    </div>

    <div id="mapa">
        <div id="quadrado"></div>
    </div>

    <script>
        // --- Configura√ß√µes Globais ---
        const VELOCIDADE = 15;
        const quadrado = document.getElementById('quadrado');
        const mapaElement = document.getElementById('mapa');
        const mapaNomeElement = document.getElementById('mapa-nome');

        let x = 0; 
        let y = 0; 
        let mapaAtual = null; 

        // --- Fun√ß√µes de Jogo ---

        /**
         * Aplica as coordenadas X e Y ao elemento do quadrado, garantindo que ele
         * n√£o saia dos limites do mapa atual.
         */
        function aplicarMovimento() {
            if (!mapaAtual) return;

            const larguraMapa = mapaAtual.largura;
            const alturaMapa = mapaAtual.altura;
            const larguraQuadrado = quadrado.clientWidth;
            const alturaQuadrado = quadrado.clientHeight;

            const maxX = larguraMapa - larguraQuadrado;
            const maxY = alturaMapa - alturaQuadrado;

            // Aplica os limites: 0 a maxX/maxY
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            quadrado.style.left = `${x}px`;
            quadrado.style.top = `${y}px`;
        }

        /**
         * Renderiza os elementos do mapa (muros, rios, portais) com base no JSON.
         */
        function renderizarElementos() {
            // Limpa quaisquer elementos do mapa anterior
            mapaElement.querySelectorAll('.elemento-mapa').forEach(el => el.remove());

            if (!mapaAtual || !mapaAtual.elementos) return;

            mapaAtual.elementos.forEach((el, index) => {
                const div = document.createElement('div');
                // Adiciona as classes 'elemento-mapa' e o tipo (ex: 'muro')
                div.className = `elemento-mapa ${el.tipo}`; 
                
                div.style.left = `${el.x}px`;
                div.style.top = `${el.y}px`;
                div.style.width = `${el.largura}px`;
                div.style.height = `${el.altura}px`;

                // Adiciona o emoji de portal para feedback visual
                if (el.tipo === 'portal') {
                    div.innerHTML = 'üö™'; 
                }
                
                mapaElement.appendChild(div);
            });
        }

        /**
         * Checa se o quadrado colide com um obst√°culo s√≥lido (muro, √°rvore ou rio).
         * @param {number} nextX - Posi√ß√£o X futura.
         * @param {number} nextY - Posi√ß√£o Y futura.
         * @returns {boolean} - Verdadeiro se houver colis√£o.
         */
        function checarColisao(nextX, nextY) {
            if (!mapaAtual || !mapaAtual.elementos) return false;

            const larguraQuadrado = quadrado.clientWidth;
            const alturaQuadrado = quadrado.clientHeight;

            // Filtra elementos que devem bloquear o movimento (exclui o tipo 'portal' se n√£o for s√≥lido)
            const obstaculos = mapaAtual.elementos.filter(el => 
                el.tipo === 'muro' || el.tipo === 'arvore' || el.tipo === 'rio'
            );

            for (const obs of obstaculos) {
                // Checagem de colis√£o AABB
                if (
                    nextX < obs.x + obs.largura &&
                    nextX + larguraQuadrado > obs.x &&
                    nextY < obs.y + obs.altura &&
                    nextY + alturaQuadrado > obs.y
                ) {
                    return true; // Colis√£o!
                }
            }
            return false;
        }

        /**
         * Checa se a posi√ß√£o atual do jogador est√° em uma √°rea de transi√ß√£o (gate/portal).
         */
        function checarTransicao() {
            if (!mapaAtual || !mapaAtual.gates) return false;

            for (const gate of mapaAtual.gates) {
                const larguraQuadrado = quadrado.clientWidth;
                const alturaQuadrado = quadrado.clientHeight;

                // Checagem de colis√£o (se o jogador est√° na √°rea do port√£o)
                const inGateX = x + larguraQuadrado > gate.x[0] && x < gate.x[1];
                const inGateY = y + alturaQuadrado > gate.y[0] && y < gate.y[1];
                
                if (inGateX && inGateY) {
                    // Feedback visual
                    quadrado.style.backgroundColor = '#27ae60'; 
                    
                    // Transi√ß√£o ap√≥s um pequeno atraso para o feedback visual
                    setTimeout(() => {
                        carregarMapa(gate.destinoId, gate.destinoX, gate.destinoY);
                    }, 100); 
                    return true;
                }
            }
            // Volta √† cor normal se n√£o estiver em um port√£o
            quadrado.style.backgroundColor = '#e74c3c'; 
            return false;
        }

        /**
         * Carrega o mapa a partir de um arquivo JSON.
         */
        async function carregarMapa(idMapa, newX, newY) {
            const path = `mapa${idMapa}.json`; 

            mapaNomeElement.textContent = "A carregar...";

            try {
                const response = await fetch(path); 
                
                if (!response.ok) {
                    throw new Error(`C√≥digo de status: ${response.status}. Verifique se os arquivos JSON existem.`);
                }
                
                const novoMapa = await response.json(); 

                mapaAtual = novoMapa;

                // 1. Aplica as novas propriedades ao cont√™iner #mapa
                mapaElement.style.width = `${mapaAtual.largura}px`;
                mapaElement.style.height = `${mapaAtual.altura}px`;
                
                // 2. RENDERIZA TODOS OS ELEMENTOS
                renderizarElementos(); 
                
                // 3. Define a posi√ß√£o inicial do jogador (posi√ß√£o de entrada ou in√≠cio padr√£o)
                x = newX !== undefined ? newX : mapaAtual.inicioX;
                y = newY !== undefined ? newY : mapaAtual.inicioY;

                // 4. Finaliza a configura√ß√£o
                aplicarMovimento();
                mapaNomeElement.textContent = mapaAtual.nome;
                quadrado.style.backgroundColor = '#e74c3c'; 
                
                console.log(`Mapa ${mapaAtual.nome} carregado.`);

            } catch (error) {
                console.error("Erro ao carregar o mapa:", error);
                mapaNomeElement.textContent = `ERRO! Arquivo '${path}' n√£o encontrado.`;
                alert(`Erro de Carregamento. Certifique-se de que est√° usando um SERVIDOR WEB LOCAL (Ex: Live Server) e que os arquivos JSON existem.`);
            }
        }
        
        // --- L√≥gica de Movimento ---
        document.addEventListener('keydown', (event) => {
            if (!mapaAtual) return; 

            let nextX = x;
            let nextY = y;
            let moved = true;
            
            // Calcula a pr√≥xima posi√ß√£o
            switch (event.key) {
                case 'w': case 'W':
                    nextY -= VELOCIDADE;
                    break;
                case 's': case 'S':
                    nextY += VELOCIDADE;
                    break;
                case 'a': case 'A':
                    nextX -= VELOCIDADE;
                    break;
                case 'd': case 'D':
                    nextX += VELOCIDADE;
                    break;
                default:
                    moved = false;
                    return; 
            }

            if (moved) {
                event.preventDefault(); 
                
                // 1. Checa a colis√£o com OBST√ÅCULOS na pr√≥xima posi√ß√£o
                if (!checarColisao(nextX, nextY)) {
                    // 2. Se n√£o houver colis√£o, atualiza a posi√ß√£o e o CSS
                    x = nextX;
                    y = nextY;
                    aplicarMovimento();
                    
                    // 3. Checa transi√ß√£o (sempre depois de mover, mesmo que n√£o haja colis√£o)
                    checarTransicao();
                }
                // Se houver colis√£o, o jogador n√£o se move.
            }
        });

        // Inicia o jogo
        carregarMapa(1);
    </script>
</body>
</html>
