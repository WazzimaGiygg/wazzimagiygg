<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Dados do Firebase</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
        }
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .tab {
            padding: 10px;
            background: #ddd;
            margin: 5px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        .tab.active {
            background: white;
            border-bottom: 2px solid #4285F4;
        }
        .iframe-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 350px);
        }
        iframe {
            width: 100%;
            border: 1px solid #ccc;
            margin-top: 0;
            border-radius: 4px;
            height: 100%;
        }
        input[type="text"], input[type="password"], button {
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #4285F4;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #357ae8;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .auth-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .auth-status {
            font-weight: bold;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        .authenticated {
            background: #4caf50;
            color: white;
        }
        .not-authenticated {
            background: #ff9800;
            color: white;
        }
        .uid-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            font-size: 12px;
        }
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="contentContainer">
        <h1>Visualizador de Dados do Firebase</h1>
        
        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div class="auth-section" id="authSection">
            <h3>üîê Autentica√ß√£o Obrigat√≥ria</h3>
            <div id="authStatus" class="auth-status"></div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" class="form-control" placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" class="form-control" placeholder="Sua senha">
                </div>
                <div class="auth-buttons">
                    <button class="btn" onclick="login()" style="background: #4285F4; color: white; padding: 10px;">Entrar</button>
                    <button class="btn" onclick="signup()" style="background: #34A853; color: white; padding: 10px;">Cadastrar</button>
                    <button class="btn" onclick="loginAnonymously()" style="background: #666; color: white; padding: 10px;">
                        Acesso An√¥nimo
                    </button>
                </div>
            </div>
            
            <div id="userInfo" style="display: none;">
                <div class="uid-info">
                    <strong>Seu UID:</strong> <span id="userUid"></span>
                </div>
                <p>Logado como: <strong id="userEmail"></strong></p>
                <button class="btn" onclick="logout()" style="background: #EA4335; color: white; padding: 10px;">Sair</button>
            </div>
        </div>
        
        <div class="error" id="errorMessage"></div>
        
        <!-- Campo para inserir o ID do documento do Firebase -->
        <input type="text" id="userId" placeholder="Digite o UID do usu√°rio (seu pr√≥prio UID)" value="" disabled>
        
        <!-- Campo de senha (opcional, dependendo da sua implementa√ß√£o) -->
        <input type="password" id="encryptionPassword" placeholder="Digite a senha (se necess√°rio)" value="">
        
        <button id="importButton" disabled>Carregar Meus Dados</button>
        
        <div class="loading" id="loading">
            <p>Carregando dados do Firebase...</p>
        </div>

        <div class="tabs" id="tabs"></div>
        <div id="iframesContainer"></div>
    </div>

    <!-- Incluir Firebase SDK (ADICIONAR AUTH) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;

        // Observador de autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            updateAuthUI();
            
            if (user) {
                console.log('Usu√°rio autenticado:', user.uid);
                // Preencher automaticamente o campo de UID
                document.getElementById('userId').value = user.uid;
                showError('‚úÖ Autenticado! Voc√™ pode carregar seus dados.', 'success');
            } else {
                console.log('Usu√°rio n√£o autenticado');
                document.getElementById('userId').value = '';
                showError('üîê Fa√ßa login para visualizar seus dados', 'info');
            }
        });

        // Atualizar interface de autentica√ß√£o
        function updateAuthUI() {
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const authStatus = document.getElementById('authStatus');
            const importButton = document.getElementById('importButton');
            const userIdInput = document.getElementById('userId');
            
            if (currentUser) {
                // Usu√°rio logado
                loginForm.style.display = 'none';
                userInfo.style.display = 'block';
                document.getElementById('userEmail').textContent = 
                    currentUser.email || 'Usu√°rio An√¥nimo';
                document.getElementById('userUid').textContent = currentUser.uid;
                authStatus.textContent = '‚úÖ Autenticado';
                authStatus.className = 'auth-status authenticated';
                authStatus.style.display = 'block';
                
                // Habilitar bot√µes
                importButton.disabled = false;
                userIdInput.disabled = false;
                
            } else {
                // Usu√°rio n√£o logado
                loginForm.style.display = 'block';
                userInfo.style.display = 'none';
                authStatus.textContent = '‚ö†Ô∏è N√£o autenticado';
                authStatus.className = 'auth-status not-authenticated';
                authStatus.style.display = 'block';
                
                // Desabilitar bot√µes
                importButton.disabled = true;
                userIdInput.disabled = true;
            }
        }

        // Fun√ß√µes de autentica√ß√£o
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showError('‚úÖ Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no login:', error);
                showError(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Por favor, preencha email e senha.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showError('‚úÖ Cadastro realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showError(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function loginAnonymously() {
            try {
                await auth.signInAnonymously();
                showError('‚úÖ Acesso an√¥nimo ativado', 'success');
            } catch (error) {
                console.error('Erro no acesso an√¥nimo:', error);
                showError(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function logout() {
            try {
                await auth.signOut();
                showError('‚úÖ Logout realizado.', 'info');
                // Limpar abas e iframes
                document.getElementById('tabs').innerHTML = '';
                document.getElementById('iframesContainer').innerHTML = '';
            } catch (error) {
                console.error('Erro no logout:', error);
                showError(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Quando o bot√£o for clicado
        document.getElementById('importButton').onclick = function() {
            importFromFirebase();
        };

        // Tamb√©m permitir Enter no campo de ID
        document.getElementById('userId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                importFromFirebase();
            }
        });

        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            
            // Definir cores baseadas no tipo
            if (type === 'success') {
                errorDiv.style.backgroundColor = '#d4edda';
                errorDiv.style.color = '#155724';
                errorDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'info') {
                errorDiv.style.backgroundColor = '#d1ecf1';
                errorDiv.style.color = '#0c5460';
                errorDiv.style.border = '1px solid #bee5eb';
            } else {
                errorDiv.style.backgroundColor = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.style.border = '1px solid #f5c6cb';
            }
            
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        async function importFromFirebase() {
            // Verificar autentica√ß√£o
            if (!currentUser) {
                showError('‚ùå Voc√™ precisa estar autenticado para carregar dados.', 'error');
                return;
            }
            
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                showError('Por favor, insira o ID do usu√°rio/documento.', 'error');
                return;
            }
            
            // Verificar se o usu√°rio est√° tentando acessar seu pr√≥prio documento
            if (userId !== currentUser.uid) {
                showError('‚ùå Voc√™ s√≥ pode visualizar seu pr√≥prio documento (seu UID).', 'error');
                return;
            }

            // Limpar abas e iframes anteriores
            document.getElementById('tabs').innerHTML = '';
            document.getElementById('iframesContainer').innerHTML = '';
            
            showLoading(true);
            document.getElementById('importButton').disabled = true;

            try {
                // Buscar documento na cole√ß√£o "gespai" pelo ID
                const docRef = db.collection('gespai').doc(userId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showError('Documento n√£o encontrado. Voc√™ ainda n√£o salvou dados.', 'info');
                    showLoading(false);
                    document.getElementById('importButton').disabled = false;
                    return;
                }

                const data = doc.data();
                const password = document.getElementById('encryptionPassword').value;

                // Se voc√™ armazena dados criptografados no Firebase
                if (password) {
                    try {
                        // Processar cada campo que possa estar criptografado
                        const processedData = {};
                        for (const key in data) {
                            if (typeof data[key] === 'string' && data[key].includes('U2FsdGVk')) {
                                // Tentar descriptografar
                                try {
                                    const bytes = CryptoJS.AES.decrypt(data[key], password);
                                    const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                                    processedData[key] = decrypted;
                                } catch (e) {
                                    // Se falhar na descriptografia, usar o valor original
                                    processedData[key] = data[key];
                                    console.log('Falha ao descriptografar campo:', key);
                                }
                            } else {
                                processedData[key] = data[key];
                            }
                        }
                        
                        // Criar abas com os dados processados
                        createTabsFromData(processedData);
                    } catch (e) {
                        showError('Erro ao processar dados criptografados.', 'error');
                        console.error(e);
                    }
                } else {
                    // Se n√£o h√° senha, usar dados diretamente
                    createTabsFromData(data);
                }
                
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                
                if (error.code === 'permission-denied') {
                    showError('‚ùå Permiss√£o negada. Verifique se est√° autenticado e tentando acessar seu pr√≥prio UID.', 'error');
                } else if (error.code === 'unavailable') {
                    showError('‚ùå Firebase indispon√≠vel. Verifique sua conex√£o.', 'error');
                } else {
                    showError(`‚ùå Erro: ${error.message}`, 'error');
                }
            } finally {
                showLoading(false);
                document.getElementById('importButton').disabled = false;
            }
        }

        function createTabsFromData(data) {
            // Verificar se h√° dados para exibir
            if (!data || Object.keys(data).length === 0) {
                showError('Nenhum dado encontrado neste documento.', 'info');
                return;
            }

            // Adicionar abas para cada campo do documento (ignorar metadados)
            let tabCount = 0;
            for (const key in data) {
                if (data.hasOwnProperty(key) && key !== '_metadata') {
                    let content = data[key];
                    
                    // Se o conte√∫do for um objeto/array, converter para string formatada
                    if (typeof content === 'object') {
                        content = JSON.stringify(content, null, 2);
                        content = `<pre style="padding: 20px; white-space: pre-wrap;">${content}</pre>`;
                    } else if (typeof content === 'string') {
                        // Verificar se √© HTML
                        if (content.trim().startsWith('<')) {
                            // J√° √© HTML, usar como est√°
                        } else {
                            // √â texto simples, colocar em um container
                            content = `<div style="padding: 20px;">${content}</div>`;
                        }
                    }
                    
                    addTab(content, key);
                    tabCount++;
                }
            }
            
            if (tabCount > 0) {
                showError(`‚úÖ ${tabCount} p√°gina(s) carregada(s) com sucesso!`, 'success');
            }
        }

        function addTab(htmlContent, tabName) {
            const tabButton = document.createElement('div');
            tabButton.className = 'tab';
            tabButton.innerText = tabName;
            tabButton.onclick = () => setActiveTab(tabName);
            document.getElementById('tabs').appendChild(tabButton);

            const iframeContainer = document.createElement('div');
            iframeContainer.className = 'iframe-container';

            const iframe = document.createElement('iframe');
            iframe.id = tabName;
            iframe.srcdoc = htmlContent;
            iframe.onload = () => adjustIframeHeight(iframe);

            iframeContainer.appendChild(iframe);
            document.getElementById('iframesContainer').appendChild(iframeContainer);

            // Define a primeira tab como ativa
            if (document.querySelectorAll('.tab').length === 1) {
                tabButton.classList.add('active');
                iframe.style.display = 'block';
            } else {
                iframe.style.display = 'none';
            }
        }

        function setActiveTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const iframes = document.querySelectorAll('iframe');

            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            iframes.forEach(iframe => {
                iframe.style.display = 'none';
            });

            const activeIframe = document.getElementById(tabName);
            if (activeIframe) {
                activeIframe.style.display = 'block';
                adjustIframeHeight(activeIframe);
            }

            const activeTab = Array.from(tabs).find(tab => tab.innerText === tabName);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        function adjustIframeHeight(iframe) {
            try {
                const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                const body = iframeDocument.body;
                const html = iframeDocument.documentElement;
                
                if (body && html) {
                    const height = Math.max(
                        body.scrollHeight,
                        body.offsetHeight,
                        html.clientHeight,
                        html.scrollHeight,
                        html.offsetHeight
                    );
                    iframe.style.height = Math.min(height, window.innerHeight - 200) + 'px';
                }
            } catch (e) {
                // Cross-origin error, usar altura padr√£o
                iframe.style.height = '500px';
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI();
            
            // Permitir Enter no campo de senha tamb√©m
            document.getElementById('encryptionPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    importFromFirebase();
                }
            });
        });
    </script>
</body>
</html>
