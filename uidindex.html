<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wiki Not Pedia WZZM</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <style>
        body {
            margin: 0;
            /* SEU PLANO DE FUNDO EST√Å DEFINIDO AQUI: */
            background: url('condedmonddant√®s.png') center/cover no-repeat;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            /* Bloqueia sele√ß√£o de texto para melhor experi√™ncia */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Barra de tarefas */
        .taskbar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background: rgba(20, 20, 20, 0.8);
            display: flex;
            align-items: center;
            /* Adicionado espa√ßo entre elementos na taskbar */
            justify-content: space-between; 
            padding: 0 10px;
            color: white;
            box-sizing: border-box;
        }

        /* Container dos bot√µes Iniciar, Admin e Ferramentas */
        .taskbar-left { /* Alterado para incluir o novo bot√£o */
            display: flex;
            align-items: center;
        }
        
        /* Estilo para o rel√≥gio na direita */
        #clock {
            padding: 0 10px;
            text-align: right;
            line-height: 1.2;
            font-size: 0.85em;
        }

        .start-button {
            background: rgba(40, 40, 40, 0.9);
            border: none;
            color: white;
            padding: 5px 15px;
            margin-right: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .start-button:hover {
            background: rgba(60, 60, 60, 0.9);
        }

        /* MENUS DESLIZANTES - MELHORIAS */
        .menu, .admin-popup, .tools-popup, #notificationPopup {
            position: absolute;
            bottom: 40px;
            left: 10px;
            background: rgba(30, 30, 30, 0.98);
            color: white;
            border-radius: 8px;
            padding: 10px;
            width: 300px;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            /* Deslizante/Scrollable */
            max-height: 60vh; /* Altura m√°xima de 60% da tela */
            overflow-y: auto; /* Scroll vertical quando necess√°rio */
            overflow-x: hidden; /* Evita scroll horizontal */
            
            /* Melhorar a barra de scroll */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(30, 30, 30, 0.5);
            z-index: 1000; /* Garante que os menus fiquem acima de tudo */
        }

        /* Estilizar a barra de scroll para Webkit (Chrome, Safari, Edge) */
        .menu::-webkit-scrollbar,
        .admin-popup::-webkit-scrollbar,
        .tools-popup::-webkit-scrollbar,
        #notificationPopup::-webkit-scrollbar {
            width: 8px;
        }

        .menu::-webkit-scrollbar-track,
        .admin-popup::-webkit-scrollbar-track,
        .tools-popup::-webkit-scrollbar-track,
        #notificationPopup::-webkit-scrollbar-track {
            background: rgba(30, 30, 30, 0.5);
            border-radius: 4px;
        }

        .menu::-webkit-scrollbar-thumb,
        .admin-popup::-webkit-scrollbar-thumb,
        .tools-popup::-webkit-scrollbar-thumb,
        #notificationPopup::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .menu::-webkit-scrollbar-thumb:hover,
        .admin-popup::-webkit-scrollbar-thumb:hover,
        .tools-popup::-webkit-scrollbar-thumb:hover,
        #notificationPopup::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Posicionamento espec√≠fico para cada menu */
        .admin-popup {
            left: 120px; /* Posi√ß√£o do menu Admin */
        }

        .tools-popup {
            left: 230px; /* Posi√ß√£o do menu Ferramentas */
        }

        #notificationPopup {
            left: auto;
            right: 10px; /* Notifica√ß√µes √† direita */
            bottom: 50px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .menu-item img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            flex-shrink: 0; /* Impede que a imagem diminua */
        }

        .window {
            position: absolute;
            top: 60px;
            left: 60px;
            width: 800px;
            height: 500px;
            background: white;
            border: 1px solid #666;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            border-radius: 8px;
            z-index: 100; /* Garante que a janela fique sobre os menus */
            min-width: 300px; /* Tamanho m√≠nimo */
            min-height: 200px;
        }

        .window-header {
            background: #0078d7;
            color: white;
            padding: 6px 10px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .window-controls button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
            padding: 2px 8px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .window-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .window iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Tela de login */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        #login-screen h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        #login-screen p {
            margin-bottom: 30px;
            opacity: 0.8;
        }

        #login-screen button {
            padding: 12px 30px;
            background: #0078d7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }

        #login-screen button:hover {
            background: #005a9e;
            transform: scale(1.05);
        }
        
        /* NOVO: Estilo para o menu de ferramentas para garantir que os links se pare√ßam com itens de menu */
        .tools-popup a {
            display: block;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            text-decoration: none;
            margin-bottom: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tools-popup a:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .taskbar-right {
            display: flex; /* Permite alinhar o √≠cone e o rel√≥gio */
            align-items: center;
        }

        /* Estilo para o √çcone de Notifica√ß√£o */
        #notificationIcon {
            cursor: pointer;
            font-size: 1.2em; /* Tamanho do √≠cone (pode ser um üîî ou outro caractere) */
            margin-right: 15px; /* Espa√ßo entre o √≠cone e o rel√≥gio */
            transition: color 0.2s, transform 0.2s;
            color: white;
            padding: 5px;
            border-radius: 4px;
        }

        #notificationIcon:hover {
            color: #0078d7;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Estilo para as notifica√ß√µes */
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item strong {
            color: #4CAF50; /* Cor verde para destaque, ou vermelha para alerta */
        }

        /* Estilo para a Notifica√ß√£o de San√ß√£o */
        .sancao-alerta {
            background-color: rgba(204, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
            border-left: 4px solid #cc0000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { background-color: rgba(204, 0, 0, 0.2); }
            50% { background-color: rgba(204, 0, 0, 0.3); }
            100% { background-color: rgba(204, 0, 0, 0.2); }
        }

        /* Overlay para fechar menus ao clicar fora */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999;
            display: none;
        }

        /* Responsividade para telas menores */
        @media (max-height: 600px) {
            .menu, .admin-popup, .tools-popup, #notificationPopup {
                max-height: 50vh; /* Menos altura em telas pequenas */
            }
        }

        @media (max-width: 768px) {
            .menu, .admin-popup, .tools-popup, #notificationPopup {
                width: 250px;
                max-height: 50vh;
            }
            
            .start-button {
                padding: 5px 10px;
                font-size: 14px;
                margin-right: 5px;
            }
            
            #clock {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;"> <!-- BLOQUEIO DO BOT√ÉO DIREITO -->

    <div id="login-screen">
        <h2>Bem-vindo(a) ao Wiki Not Pedia WZZM</h2>
        <p>Fa√ßa login para acessar a √°rea de trabalho</p>
        <button id="loginBtn">Entrar com Google</button>
    </div>

    <!-- Overlay para fechar menus ao clicar fora -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <div id="desktop">
        
        <div class="taskbar">
            <div class="taskbar-left">
                <button class="start-button" id="startBtn">Iniciar</button>
                <button class="start-button" id="adminBtn">Wiki Not P√©dia</button>
                <button class="start-button" id="toolsBtn">Ferramentas</button>
            </div>
            
            <div class="taskbar-right"> 
                <span id="notificationIcon">üîî</span>
                <div id="clock"></div>
            </div>
        </div>

        <div class="menu" id="startMenu"></div>
        <div class="admin-popup" id="adminMenu"></div>
        <div class="tools-popup" id="toolsMenu"></div>

        <div id="notificationPopup"></div>
    </div>

   <script type="module">
// üîπ Firebase Auth & Firestore Config
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Chave de API, mantenha a sua real
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// CONSTANTES DO FIRESTORE
const KEY_ARRAY_FIELD = "itens_menu"; // Nome do campo ARRAY dentro do documento

// CONSTANTES DE ELEMENTOS
const notificationIcon = document.getElementById("notificationIcon");
const notificationPopup = document.getElementById("notificationPopup");
const menuOverlay = document.getElementById("menuOverlay");
const JSON_URL = 'cidades_sancionadas.json'; 

const loginScreen = document.getElementById("login-screen");
const loginBtn = document.getElementById("loginBtn");
const desktop = document.getElementById("desktop");
const startMenu = document.getElementById("startMenu");
const adminMenu = document.getElementById("adminMenu");
const toolsMenu = document.getElementById("toolsMenu");
const clockElement = document.getElementById("clock");

// BOTOES DA TASKBAR
const startBtn = document.getElementById("startBtn");
const adminBtn = document.getElementById("adminBtn");
const toolsBtn = document.getElementById("toolsBtn");

// üîí BLOQUEIO DO BOT√ÉO DIREITO
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

// üîí BLOQUEIO DE TECLAS DE ATALHO (F12, Ctrl+Shift+I, etc.)
document.addEventListener('keydown', function(e) {
    // Bloqueia F12
    if (e.key === 'F12') {
        e.preventDefault();
        return false;
    }
    
    // Bloqueia Ctrl+Shift+I (DevTools)
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
        e.preventDefault();
        return false;
    }
    
    // Bloqueia Ctrl+Shift+J (Console)
    if (e.ctrlKey && e.shiftKey && e.key === 'J') {
        e.preventDefault();
        return false;
    }
    
    // Bloqueia Ctrl+U (View Source)
    if (e.ctrlKey && e.key === 'u') {
        e.preventDefault();
        return false;
    }
});

// Fun√ß√£o para fechar todos os menus
function closeAllMenus() {
    startMenu.style.display = "none";
    adminMenu.style.display = "none";
    toolsMenu.style.display = "none";
    notificationPopup.style.display = "none";
    menuOverlay.style.display = "none";
}

// Fun√ß√£o para mostrar overlay e fechar menus ao clicar fora
function setupMenuClickOutside(menuElement) {
    menuElement.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // Fechar menu ao clicar no overlay
    menuOverlay.addEventListener('click', closeAllMenus);
}

// Inicializar fechamento de menus para cada menu
setupMenuClickOutside(startMenu);
setupMenuClickOutside(adminMenu);
setupMenuClickOutside(toolsMenu);
setupMenuClickOutside(notificationPopup);

loginBtn.addEventListener("click", () => {
    signInWithPopup(auth, provider);
});

// üìå L√≥gica de clique do √≠cone, fechando os outros menus.
notificationIcon.onclick = (e) => {
    e.stopPropagation();
    const isVisible = notificationPopup.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        notificationPopup.style.display = "block";
        menuOverlay.style.display = "block";
        
        // Posicionar notifica√ß√µes
        const rect = notificationIcon.getBoundingClientRect();
        notificationPopup.style.left = "auto";
        notificationPopup.style.right = "10px";
        notificationPopup.style.bottom = "50px";
    }
};

// ‚úÖ L√≥gica Alterada: Qualquer usu√°rio logado (user) ter√° acesso
onAuthStateChanged(auth, (user) => {
    if (user) {
        loginScreen.style.display = "none";
        desktop.style.display = "block";
        updateClock();
        
        // üÜï CHAMA A FUN√á√ÉO DE CARREGAMENTO DE LINKS DO FIRESTORE
        loadDynamicLinks(user.uid);
        
        // üìå AJUSTE 2: Chama a fun√ß√£o para buscar IP e verificar san√ß√£o aqui, AP√ìS o login.
        buscarIpELocalizacao();
    } else {
        loginScreen.style.display = "flex";
        desktop.style.display = "none";
        notificationPopup.innerHTML = '';
        notificationIcon.style.color = 'white';
        closeAllMenus();
    }
});

// -------------------------------------------------------------
// üöÄ NOVA FUN√á√ÉO: CARREGA OS LINKS DO FIRESTORE E MONTA O MENU
// -------------------------------------------------------------
async function loadDynamicLinks(userId) {
    try {
        const SITE_ID = "wazzimagiygg"; // Defina o ID do site
        const KEY_DOCUMENT_ID = `${SITE_ID}_menu_list`; // Ex: 'wazzimagiygg_menu_list'
        const docRef = doc(db, "keymenulista", KEY_DOCUMENT_ID);
        const docSnap = await getDoc(docRef);

        let allLinksFromDB = []; // Todos os links din√¢micos do Firebase

        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data[KEY_ARRAY_FIELD] && Array.isArray(data[KEY_ARRAY_FIELD])) {
                // Mapeia os dados do Firebase
                allLinksFromDB = data[KEY_ARRAY_FIELD].map(item => ({
                    name: item.titulo,
                    url: item.link_url,
                    iconUrl: item.url_imagem || 'iconmagic.png', 
                    menu_target: item.menu_target || 'outros' 
                }));
            }
        }
        
        // 1. FILTRAGEM DOS LINKS DIN√ÇMICOS POR CATEGORIA (menu_target)
        const linksParaIniciar = allLinksFromDB.filter(item => item.menu_target === 'menu_iniciar');
        const linksParaAdmin = allLinksFromDB.filter(item => item.menu_target === 'wiki_pedia');
        const linksParaFerramentas = allLinksFromDB.filter(item => item.menu_target === 'ferramentas');

        // 2. LINKS EST√ÅTICOS
        const staticStartLinks = [
            { name: 'Termos de Servi√ßo', url: 'Termos%20de%20Servi%C3%A7o.pdf', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'Pol√≠tica de Privacidade', url: 'Pol%C3%ADtica%20de%20Privacidade.pdf', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'Fale com a Administra√ß√£o', url: 'html/?uid=a13IwrEoc1Jmdi2I3Hve', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' }, 
            { name: 'Gerenciador GESPAI', url: 'https://wazzimagiygg.com/gespai/', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'Logoff (Sair)', action: 'logout', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' }
        ];

        const staticAdminLinks = [
            { name: "Criar um artigo (de ensaio para aprova√ß√£o) ", url: "areadeensaiodeartigos.html", menu_target: 'wiki_pedia' }, 
            { name: 'jsonmulti-tabviewer (Gerador de Criptografia para HTML)', url: 'https://jsonmulti-tabviewer.wazzimagiygg.com/', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' }, 
            { name: 'ciphersafex - Criptografia de Texto', url: 'https://ciphersafex.wazzimagiygg.com', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'quill-sync', url: 'https://quill-sync.wazzimagiygg.com/', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'tabwriter', url: 'https://tabwriter.wazzimagiygg.com/', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' }, 
            { name: 'encryptojson', url: 'https://encryptojson.wazzimagiygg.com/', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: 'file-scramble', url: 'https://file-scrambler.vercel.app', iconUrl: 'iconmagic.png', menu_target: 'menu_iniciar' },
            { name: "Chat (Contato)", url: "html/?uid=a13IwrEoc1Jmdi2I3Hve", menu_target: 'wiki_pedia' } 
        ];

        // 3. MONTAGEM FINAL DAS LISTAS
        const finalStartLinks = [...linksParaIniciar, ...staticStartLinks];
        const finalAdminLinks = [...linksParaAdmin, ...staticAdminLinks];
        const finalToolLinks = linksParaFerramentas; // Links din√¢micos para ferramentas

        // 4. CHAMA AS FUN√á√ïES PARA MONTAR CADA MENU
        populateMenu(startMenu, finalStartLinks); // Usa a fun√ß√£o de item de menu normal
        populateMenu(adminMenu, finalAdminLinks); // Usa a fun√ß√£o de item de menu normal
        populateToolsMenu(finalToolLinks); // Usa a fun√ß√£o espec√≠fica para links <a>

    } catch (error) {
        console.error("Erro ao carregar links do Firebase:", error);
        // Em caso de erro, monta o menu Iniciar apenas com os essenciais para n√£o quebrar
        populateMenu(startMenu, [
             { name: 'Fale com a Administra√ß√£o (Erro)', url: 'html/?uid=a13IwrEoc1Jmdi2I3Hve', iconUrl: 'iconmagic.png' },
             { name: 'Logoff (Sair)', action: 'logout', iconUrl: 'iconmagic.png' }
        ]);
        populateMenu(adminMenu, [{ name: "Chat (Erro)", url: "#" }]);
        populateToolsMenu([]);
    }
}

// -------------------------------------------------------------
// FIM DA FUN√á√ÉO loadDynamicLinks
// -------------------------------------------------------------

// üÜï FUN√á√ÉO UNIFICADA: PARA MONTAR MENUS EM GERAL (Iniciar e Admin)
function populateMenu(menuElement, linksArray) {
    menuElement.innerHTML = ''; 

    linksArray.forEach(item => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `<img src="${item.iconUrl || 'iconmagic.png'}" alt="icon"> ${item.name}`;
        
        div.onclick = () => {
            if (item.action === 'logout') {
                handleLogout(); 
            } else {
                openWindow(item.name, item.url);
            }
            closeAllMenus();
        };
        menuElement.appendChild(div);
    });
}

// -------------------------------------------------------------
// üÜï FUN√á√ÉO √öNICA: PARA MONTAR O MENU DE FERRAMENTAS (usando links <a>)
// -------------------------------------------------------------
function populateToolsMenu(linksArray) {
    toolsMenu.innerHTML = ''; 
    
    // Filtro para remover links que incluem 'base44.app' ou 'base44.com'
    const filteredLinks = linksArray.filter(link => 
        !link.url.includes('base44.app') && !link.url.includes('base44.com')
    );
    
    filteredLinks.forEach(link => {
        const a = document.createElement("a");
        a.textContent = link.name;
        a.href = link.url;
        
        // üö® CORRE√á√ÉO ESSENCIAL: Intercepta o clique para abrir o iframe.
        a.onclick = (e) => {
            e.preventDefault(); // <-- 1. IMPEDE a navega√ß√£o padr√£o do <a>
            openWindow(link.name, link.url); // <-- 2. Chama a fun√ß√£o que cria a janela com iframe
            closeAllMenus(); // <-- 3. Fecha todos os menus
        };
        
        toolsMenu.appendChild(a);
    });
}

// L√≥gica dos bot√µes da taskbar com overlay
startBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = startMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        startMenu.style.display = "block";
        menuOverlay.style.display = "block";
        // Posicionar menu
        const rect = startBtn.getBoundingClientRect();
        startMenu.style.left = "10px";
        startMenu.style.bottom = "40px";
    }
};

adminBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = adminMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        adminMenu.style.display = "block";
        menuOverlay.style.display = "block";
        // Posicionar menu
        const rect = adminBtn.getBoundingClientRect();
        adminMenu.style.left = rect.left + "px";
        adminMenu.style.bottom = "40px";
    }
};

toolsBtn.onclick = (e) => {
    e.stopPropagation();
    const isVisible = toolsMenu.style.display === "block";
    closeAllMenus();
    if (!isVisible) {
        toolsMenu.style.display = "block";
        menuOverlay.style.display = "block";
        // Posicionar menu
        const rect = toolsBtn.getBoundingClientRect();
        toolsMenu.style.left = rect.left + "px";
        toolsMenu.style.bottom = "40px";
    }
};

function handleLogout() {
    signOut(auth).then(() => {
        closeAllMenus();
    }).catch((error) => {
        console.error("Erro ao sair:", error);
        alert("Erro ao tentar fazer logoff.");
    });
}

// Fun√ß√£o para atualizar o rel√≥gio 
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
    const dateString = now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    clockElement.innerHTML = `<span>${timeString}</span><br><span>${dateString}</span>`;
    setTimeout(updateClock, 1000);
}


function openWindow(title, url) {
    const win = document.createElement("div");
    win.className = "window";
    win.innerHTML = `
        <div class="window-header">
            <span>${title}</span>
            <div class="window-controls">
                <button class="minimize">‚Äî</button>
                <button class="maximize">‚¨ú</button>
                <button class="close">‚úñ</button>
            </div>
        </div>
        <iframe src="${url}"></iframe>
    `;
    document.body.appendChild(win);

    const header = win.querySelector(".window-header");
    let isDragging = false;
    let offsetX, offsetY;
    let maximized = false;
    let prev = { top: 0, left: 0, width: 0, height: 0 };

    header.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        e.stopPropagation(); // Previne que o overlay feche a janela
    });

    document.addEventListener("mousemove", (e) => {
        if (isDragging && !maximized) {
            win.style.left = e.clientX - offsetX + "px";
            win.style.top = e.clientY - offsetY + "px";
        }
    });

    document.addEventListener("mouseup", () => isDragging = false);

    win.querySelector(".close").onclick = (e) => {
        e.stopPropagation();
        win.remove();
    };
    
    win.querySelector(".minimize").onclick = (e) => {
        e.stopPropagation();
        win.style.display = "none";
    };
    
    win.querySelector(".maximize").onclick = (e) => {
        e.stopPropagation();
        if (!maximized) {
            prev = { top: win.offsetTop, left: win.offsetLeft, width: win.offsetWidth, height: win.offsetHeight };
            win.style.top = "0";
            win.style.left = "0";
            win.style.width = "100%";
            win.style.height = "calc(100% - 40px)";
            maximized = true;
        } else {
            win.style.top = prev.top + "px";
            win.style.left = prev.left + "px";
            win.style.width = prev.width + "px";
            win.style.height = prev.height + "px";
            maximized = false;
        }
    };
    
    // Impedir que cliques na janela fechem menus
    win.addEventListener('click', (e) => {
        e.stopPropagation();
    });
}

// üîπ 1. Fun√ß√£o principal para buscar IP e Localiza√ß√£o (MANTIDA INTACTA)
async function buscarIpELocalizacao() {
    notificationPopup.innerHTML = ''; 
    notificationIcon.style.color = 'white';
    
    try {
        const response = await fetch('https://ipinfo.io/json');
        const data = await response.json();
        
        const ip = data.ip || 'N/A';
        const cidadeDoUsuario = data.city || 'Desconhecida';
        const paisDoUsuario = data.country || ''; 
        
        addNotification(`Seu IP P√∫blico: <strong>${ip}</strong>`, 'info');
        addNotification(`Localiza√ß√£o Detectada: ${cidadeDoUsuario}, ${paisDoUsuario}`, 'info');

        verificarSancao(cidadeDoUsuario, paisDoUsuario);
        
    } catch (error) {
        console.error("Erro ao obter IP ou localiza√ß√£o:", error);
        addNotification('Erro: Falha ao obter endere√ßo IP/Localiza√ß√£o.', 'error');
    }
}

// üîπ 2. Fun√ß√£o para adicionar uma notifica√ß√£o ao popup (MANTIDA INTACTA)
function addNotification(message, type = 'info') {
    const div = document.createElement("div");
    div.className = `notification-item ${type === 'error' ? 'sancao-alerta' : ''}`;
    div.innerHTML = message;
    
    notificationPopup.prepend(div); 
}

// üîπ 3. Fun√ß√£o para carregar o JSON e verificar san√ß√£o (MANTIDA INTACTA)
async function verificarSancao(cidadeUsuario, paisDoUsuario) {
    try {
        const jsonResponse = await fetch(JSON_URL);
        
        if (!jsonResponse.ok) {
            throw new Error(`Erro HTTP! Status: ${jsonResponse.status}`);
        }
        
        const cidadesSancionadasData = await jsonResponse.json();
        
        const cidadeFormatada = cidadeUsuario.trim().toLowerCase();
        const paisFormatado = paisDoUsuario.trim().toLowerCase();

        const alertaEncontrado = cidadesSancionadasData.cidades_sancionadas.find(item => 
            item.cidade.trim().toLowerCase() === cidadeFormatada || 
            item.cidade.trim().toLowerCase() === paisFormatado      
        );
        
        if (alertaEncontrado) {
            const alertaHTML = `
                üö® Alerta de San√ß√£o! üö®<br>Regi√£o com poss√≠veis usu√°rios sancionados.
                <br>
                (Moderador: <strong>${alertaEncontrado.moderador}</strong>)
            `;
            addNotification(alertaHTML, 'error');
            
            notificationIcon.style.color = '#cc0000';
        }
        
    } catch (error) {
        console.warn("Aviso: Falha ao carregar ou processar o JSON de san√ß√µes. Verifique o arquivo.", error);
    }
}
</script>

</body>
</html>
