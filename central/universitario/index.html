<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Artigos - WZZM Admin</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.indigo-pink.min.css">
    <style>
        :root {
            --primary-color: #3f51b5;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --light-bg: #f5f5f5;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --border-radius: 12px;
        }

        body {
            font-family: 'Roboto', 'Helvetica', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background-color: #fff;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
            font-weight: 500;
            position: relative;
            padding-bottom: 15px;
        }

        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), #9c27b0);
            border-radius: 2px;
        }

        .search-section {
            background: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .mdl-button {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .results-section {
            margin-top: 40px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-count {
            font-size: 16px;
            color: #666;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Vista em Tabela */
        .table-view {
            width: 100%;
            overflow-x: auto;
        }

        .articles-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .articles-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .articles-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .articles-table tr:hover {
            background: #f9f9f9;
        }

        .articles-table tr:last-child td {
            border-bottom: none;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .view-btn-table {
            background: var(--primary-color);
            color: white;
        }

        .edit-btn-table {
            background: #ff9800;
            color: white;
        }

        .delete-btn-table {
            background: var(--error-color);
            color: white;
        }

        .table-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-published {
            background: var(--success-color);
            color: white;
        }

        .status-draft {
            background: #666;
            color: white;
        }

        /* Vista em Cartões */
        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .article-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #eee;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .article-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), #2196f3);
            color: white;
            position: relative;
        }

        .article-title {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-content {
            padding: 20px;
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .article-preview {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-authors {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .authors-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }

        .authors-list {
            font-size: 13px;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn-card {
            background: var(--primary-color);
            color: white;
        }

        .edit-btn-card {
            background: #ff9800;
            color: white;
        }

        .delete-btn-card {
            background: var(--error-color);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            grid-column: 1 / -1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
            gap: 20px;
        }

        .page-info {
            color: #666;
            font-size: 14px;
        }

        .advanced-search-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            cursor: pointer;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 8px;
        }

        .advanced-search-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #f5f7ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .advanced-search-fields.show {
            display: grid;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .debug-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .debug-log {
            color: #495057;
            margin: 2px 0;
        }

        .debug-error {
            color: #dc3545;
            font-weight: bold;
        }

        .debug-success {
            color: #28a745;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .cards-view {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .table-view {
                font-size: 14px;
            }
            
            .articles-table th,
            .articles-table td {
                padding: 10px;
            }
        }

        .citation-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 10px;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="material-icons">search</i>
            Buscar Artigos
        </h1>

        <div class="search-section">
            <h3><i class="material-icons">filter_list</i> Filtros de Busca</h3>
            
            <div class="search-grid">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="search-title">
                    <label class="mdl-textfield__label" for="search-title">Título do artigo</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="search-author">
                    <label class="mdl-textfield__label" for="search-author">Autor ou discente</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <select class="mdl-textfield__input" id="search-status">
                        <option value="">Todos os status</option>
                        <option value="published">Publicados</option>
                        <option value="draft">Rascunhos</option>
                    </select>
                    <label class="mdl-textfield__label" for="search-status">Status</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <select class="mdl-textfield__input" id="search-type">
                        <option value="">Todos os tipos</option>
                        <option value="cientifico">Científico</option>
                        <option value="revisao">Revisão Bibliográfica</option>
                        <option value="noticia">Notícia</option>
                        <option value="editorial">Editorial</option>
                        <option value="opiniao">Opinião</option>
                        <option value="entrevista">Entrevista</option>
                        <option value="tutorial">Tutorial</option>
                        <option value="monografia">Monografia</option>
                        <option value="dissertacao">Dissertação</option>
                        <option value="tese">Tese</option>
                    </select>
                    <label class="mdl-textfield__label" for="search-type">Tipo de artigo</label>
                </div>
            </div>

            <div class="advanced-search-toggle" id="advanced-toggle">
                <i class="material-icons">expand_more</i>
                <span>Busca Avançada</span>
            </div>

            <div class="advanced-search-fields" id="advanced-fields">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="search-content">
                    <label class="mdl-textfield__label" for="search-content">Palavras no conteúdo</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="search-citation">
                    <label class="mdl-textfield__label" for="search-citation">Texto na citação</label>
                </div>

                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <select class="mdl-textfield__input" id="search-language">
                        <option value="">Todos os idiomas</option>
                        <option value="pt-BR">Português (Brasil)</option>
                        <option value="en-US">English (United States)</option>
                        <option value="es-ES">Español (España)</option>
                    </select>
                    <label class="mdl-textfield__label" for="search-language">Idioma</label>
                </div>

                <div class="date-range">
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label date-input">
                        <input class="mdl-textfield__input" type="date" id="search-date-from">
                        <label class="mdl-textfield__label" for="search-date-from">Data inicial</label>
                    </div>
                    <span>até</span>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label date-input">
                        <input class="mdl-textfield__input" type="date" id="search-date-to">
                        <label class="mdl-textfield__label" for="search-date-to">Data final</label>
                    </div>
                </div>
            </div>

            <div class="search-actions">
                <button id="debug-btn" class="mdl-button mdl-js-button mdl-button--raised" style="background: #9c27b0; color: white;">
                    <i class="material-icons">bug_report</i> Diagnóstico
                </button>
                <button id="clear-search" class="mdl-button mdl-js-button mdl-button--raised">
                    <i class="material-icons">clear</i> Limpar
                </button>
                <button id="search-btn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    <i class="material-icons">search</i> Buscar
                </button>
                <button id="new-article-btn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
                    <i class="material-icons">add</i> Novo Artigo
                </button>
            </div>

            <div class="debug-panel" id="debug-panel">
                <div class="debug-header">
                    <strong>Console de Depuração</strong>
                    <button class="debug-toggle" onclick="toggleDebug()">Ocultar</button>
                </div>
                <div id="debug-output"></div>
            </div>
        </div>

        <div class="stats-bar" id="stats-bar">
            <div class="stats-item">
                <i class="material-icons">search</i>
                <span id="search-info">Digite critérios de busca</span>
            </div>
            <div class="stats-item">
                <i class="material-icons">article</i>
                <span id="results-count">0 resultados</span>
            </div>
            <div class="stats-item">
                <i class="material-icons">schedule</i>
                <span id="search-time">Tempo: 0ms</span>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-count" id="detailed-count">
                    Mostrando 0 de 0 artigos
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="table">
                        <i class="material-icons">view_list</i> Tabela
                    </button>
                    <button class="view-btn" data-view="cards">
                        <i class="material-icons">view_module</i> Cartões
                    </button>
                </div>
            </div>

            <div id="table-view" class="table-view">
                <table class="articles-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Autores</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Visualizações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="table-results">
                        <!-- Resultados serão carregados aqui -->
                    </tbody>
                </table>
            </div>

            <div id="cards-view" class="cards-view" style="display: none;">
                <!-- Resultados em cartões serão carregados aqui -->
                <div class="loading" id="loading-cards">
                    <i class="material-icons" style="font-size: 48px; color: #3f51b5;">hourglass_empty</i>
                    <p>Use os filtros acima para buscar artigos</p>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button id="prev-page" class="mdl-button mdl-js-button mdl-button--icon">
                    <i class="material-icons">chevron_left</i>
                </button>
                <span class="page-info" id="page-info">Página 1 de 1</span>
                <button id="next-page" class="mdl-button mdl-js-button mdl-button--icon">
                    <i class="material-icons">chevron_right</i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.min.js"></script>

    <script>
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicializar Firebase
        let app;
        if (!firebase.apps.length) {
            app = firebase.initializeApp(firebaseConfig);
        } else {
            app = firebase.app();
        }
        
        const firestore = firebase.firestore();
        const auth = firebase.auth();

        // --- Estado da aplicação ---
        let currentUser = null;
        let allArticles = [];
        let filteredArticles = [];
        let currentView = 'table';
        let currentPage = 1;
        const articlesPerPage = 10;
        let searchParams = {
            title: '',
            author: '',
            status: '',
            type: '',
            content: '',
            citation: '',
            language: '',
            dateFrom: '',
            dateTo: ''
        };

        // --- Elementos DOM ---
        const elements = {
            // Campos de busca
            searchTitle: document.getElementById('search-title'),
            searchAuthor: document.getElementById('search-author'),
            searchStatus: document.getElementById('search-status'),
            searchType: document.getElementById('search-type'),
            searchContent: document.getElementById('search-content'),
            searchCitation: document.getElementById('search-citation'),
            searchLanguage: document.getElementById('search-language'),
            searchDateFrom: document.getElementById('search-date-from'),
            searchDateTo: document.getElementById('search-date-to'),
            
            // Botões e controles
            advancedToggle: document.getElementById('advanced-toggle'),
            advancedFields: document.getElementById('advanced-fields'),
            clearSearch: document.getElementById('clear-search'),
            searchBtn: document.getElementById('search-btn'),
            newArticleBtn: document.getElementById('new-article-btn'),
            debugBtn: document.getElementById('debug-btn'),
            
            // Views
            tableView: document.getElementById('table-view'),
            cardsView: document.getElementById('cards-view'),
            tableResults: document.getElementById('table-results'),
            cardsResults: document.getElementById('cards-view'),
            
            // Estatísticas
            statsBar: document.getElementById('stats-bar'),
            searchInfo: document.getElementById('search-info'),
            resultsCount: document.getElementById('results-count'),
            detailedCount: document.getElementById('detailed-count'),
            searchTime: document.getElementById('search-time'),
            
            // Paginação
            pagination: document.getElementById('pagination'),
            pageInfo: document.getElementById('page-info'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            
            // View toggle
            viewButtons: document.querySelectorAll('.view-btn'),
            
            // Debug
            debugPanel: document.getElementById('debug-panel'),
            debugOutput: document.getElementById('debug-output')
        };

        // --- Funções de Utilidade ---
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log debug-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            elements.debugOutput.appendChild(logEntry);
            elements.debugOutput.scrollTop = elements.debugOutput.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function toggleDebug() {
            elements.debugPanel.classList.toggle('show');
            const button = elements.debugPanel.querySelector('.debug-toggle');
            button.textContent = elements.debugPanel.classList.contains('show') ? 'Ocultar' : 'Mostrar';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = dateString?.toDate ? dateString.toDate() : new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return 'Data inválida';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = dateString?.toDate ? dateString.toDate() : new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Data inválida';
            }
        }

        function truncateText(text, maxLength = 100) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }

        function stripHTML(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function getArticleTypeLabel(type) {
            const types = {
                'cientifico': 'Científico',
                'revisao': 'Revisão Bibliográfica',
                'noticia': 'Notícia',
                'editorial': 'Editorial',
                'opiniao': 'Opinião',
                'entrevista': 'Entrevista',
                'tutorial': 'Tutorial',
                'monografia': 'Monografia',
                'dissertacao': 'Dissertação',
                'tese': 'Tese'
            };
            return types[type] || type || 'Não especificado';
        }

        function getLanguageLabel(lang) {
            const languages = {
                'pt-BR': 'Português',
                'en-US': 'Inglês',
                'es-ES': 'Espanhol'
            };
            return languages[lang] || lang || 'Não especificado';
        }

        // --- Funções de Busca ---
        function collectSearchParams() {
            return {
                title: elements.searchTitle.value.trim(),
                author: elements.searchAuthor.value.trim(),
                status: elements.searchStatus.value,
                type: elements.searchType.value,
                content: elements.searchContent.value.trim(),
                citation: elements.searchCitation.value.trim(),
                language: elements.searchLanguage.value,
                dateFrom: elements.searchDateFrom.value,
                dateTo: elements.searchDateTo.value
            };
        }

        function articleMatchesSearch(article, params) {
            const data = article.data();
            
            // Verificar se o artigo tem dados básicos
            if (!data) return false;
            
            // Busca por título
            if (params.title && data.title) {
                if (!data.title.toLowerCase().includes(params.title.toLowerCase())) {
                    return false;
                }
            }
            
            // Busca por autor/discente
            if (params.author) {
                const authorQuery = params.author.toLowerCase();
                const authors = data.authors || [];
                const students = data.students || [];
                const allPeople = [...authors, ...students];
                
                if (allPeople.length === 0) return false;
                
                const found = allPeople.some(person => 
                    person && person.toLowerCase().includes(authorQuery));
                if (!found) return false;
            }
            
            // Filtro por status
            if (params.status && data.status !== params.status) {
                return false;
            }
            
            // Filtro por tipo
            if (params.type && data.articleType !== params.type) {
                return false;
            }
            
            // Busca no conteúdo
            if (params.content) {
                const content = stripHTML(data.formattedContent || data.content || '').toLowerCase();
                if (!content.includes(params.content.toLowerCase())) {
                    return false;
                }
            }
            
            // Busca na citação
            if (params.citation && data.citation) {
                if (!data.citation.toLowerCase().includes(params.citation.toLowerCase())) {
                    return false;
                }
            }
            
            // Filtro por idioma
            if (params.language && data.language !== params.language) {
                return false;
            }
            
            // Filtro por data
            if (params.dateFrom || params.dateTo) {
                let articleDate;
                try {
                    articleDate = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || data.timestamp || 0);
                } catch (e) {
                    articleDate = new Date(0);
                }
                
                if (params.dateFrom) {
                    const fromDate = new Date(params.dateFrom);
                    if (articleDate < fromDate) return false;
                }
                
                if (params.dateTo) {
                    const toDate = new Date(params.dateTo);
                    toDate.setHours(23, 59, 59, 999); // Fim do dia
                    if (articleDate > toDate) return false;
                }
            }
            
            return true;
        }

        function performSearch() {
            debugLog('Iniciando busca...');
            const startTime = performance.now();
            searchParams = collectSearchParams();
            
            filteredArticles = allArticles.filter(article => 
                articleMatchesSearch(article, searchParams)
            );
            
            const endTime = performance.now();
            const searchDuration = Math.round(endTime - startTime);
            
            debugLog(`Busca concluída: ${filteredArticles.length} resultados em ${searchDuration}ms`);
            
            // Atualizar estatísticas
            updateSearchStats(searchDuration);
            
            // Resetar para primeira página
            currentPage = 1;
            
            // Renderizar resultados
            renderResults();
            
            // Mostrar/ocultar paginação
            if (filteredArticles.length > articlesPerPage) {
                elements.pagination.style.display = 'flex';
            } else {
                elements.pagination.style.display = 'none';
            }
        }

        function updateSearchStats(duration) {
            const total = allArticles.length;
            const found = filteredArticles.length;
            
            // Criar descrição da busca
            let searchDescription = '';
            const activeFilters = [];
            
            if (searchParams.title) activeFilters.push(`título: "${searchParams.title}"`);
            if (searchParams.author) activeFilters.push(`autor: "${searchParams.author}"`);
            if (searchParams.status) activeFilters.push(`status: ${searchParams.status === 'published' ? 'publicados' : 'rascunhos'}`);
            if (searchParams.type) activeFilters.push(`tipo: ${getArticleTypeLabel(searchParams.type).toLowerCase()}`);
            if (searchParams.content) activeFilters.push(`conteúdo: "${searchParams.content}"`);
            if (searchParams.language) activeFilters.push(`idioma: ${getLanguageLabel(searchParams.language).toLowerCase()}`);
            
            if (activeFilters.length > 0) {
                searchDescription = `Busca por ${activeFilters.join(', ')}`;
            } else {
                searchDescription = 'Todos os artigos';
            }
            
            elements.searchInfo.textContent = searchDescription;
            elements.resultsCount.textContent = `${found} resultado${found !== 1 ? 's' : ''}`;
            elements.detailedCount.textContent = `Mostrando ${Math.min(found, articlesPerPage)} de ${found} artigo${found !== 1 ? 's' : ''}`;
            elements.searchTime.textContent = `Tempo: ${duration}ms`;
        }

        // --- Funções de Renderização ---
        function renderTableRow(article) {
            const data = article.data();
            const articleId = article.id;
            
            const authorsText = data.authors ? truncateText(Array.isArray(data.authors) ? data.authors.join(', ') : data.authors, 60) : 'Não informado';
            const createdDate = formatDate(data.createdAt || data.timestamp || data.date);
            
            return `
                <tr>
                    <td>
                        <strong>${data.title || 'Sem título'}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${truncateText(data.description || data.summary || '', 80)}
                        </div>
                    </td>
                    <td>${authorsText}</td>
                    <td>${getArticleTypeLabel(data.articleType || data.type)}</td>
                    <td>
                        <span class="status-badge ${data.status === 'published' ? 'status-published' : 'status-draft'}">
                            ${data.status === 'published' ? 'PUBLICADO' : 'RASCUNHO'}
                        </span>
                    </td>
                    <td>${createdDate}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <i class="material-icons" style="font-size: 16px;">visibility</i>
                            ${data.views || data.viewCount || 0}
                        </div>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="table-action-btn view-btn-table" onclick="viewArticle('${articleId}')">
                                <i class="material-icons">visibility</i>
                            </button>
                            <button class="table-action-btn edit-btn-table" onclick="editArticle('${articleId}')">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="table-action-btn delete-btn-table" onclick="deleteArticle('${articleId}', '${(data.title || 'este artigo').replace(/'/g, "\\'")}')">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderCard(article) {
            const data = article.data();
            const articleId = article.id;
            
            const previewText = stripHTML(data.formattedContent || data.content || data.body || '');
            const authorsText = data.authors ? (Array.isArray(data.authors) ? data.authors.join(', ') : data.authors) : 'Autor desconhecido';
            
            return `
                <div class="article-card">
                    <div class="article-header">
                        <h3 class="article-title">${data.title || 'Artigo sem título'}</h3>
                        <span class="status-badge ${data.status === 'published' ? 'status-published' : 'status-draft'}">
                            ${data.status === 'published' ? 'PUBLICADO' : 'RASCUNHO'}
                        </span>
                    </div>
                    
                    <div class="article-content">
                        <div class="article-meta">
                            <span class="meta-item">
                                <i class="material-icons">person</i>
                                ${data.userEmail?.split('@')[0] || data.authorName || 'Autor'}
                            </span>
                            <span class="meta-item">
                                <i class="material-icons">calendar_today</i>
                                ${formatDate(data.createdAt || data.date)}
                            </span>
                            <span class="meta-item">
                                <i class="material-icons">visibility</i>
                                ${data.views || data.viewCount || 0}
                            </span>
                        </div>
                        
                        <div class="article-preview">
                            ${truncateText(previewText, 150)}
                        </div>
                        
                        <div class="article-authors">
                            <span class="authors-label">Autores:</span>
                            <div class="authors-list">${truncateText(authorsText, 80)}</div>
                            ${data.students && data.students.length > 0 ? `
                                <span class="authors-label" style="margin-top: 8px;">Discentes:</span>
                                <div class="authors-list">${truncateText(Array.isArray(data.students) ? data.students.join(', ') : data.students, 60)}</div>
                            ` : ''}
                        </div>
                        
                        ${data.citation ? `
                            <div class="citation-badge">
                                <i class="material-icons" style="font-size: 12px;">format_quote</i>
                                Citação disponível
                            </div>
                        ` : ''}
                        
                        <div class="article-actions">
                            <button class="action-btn view-btn-card" onclick="viewArticle('${articleId}')">
                                <i class="material-icons">visibility</i> Ver
                            </button>
                            <button class="action-btn edit-btn-card" onclick="editArticle('${articleId}')">
                                <i class="material-icons">edit</i> Editar
                            </button>
                            <button class="action-btn delete-btn-card" onclick="deleteArticle('${articleId}', '${(data.title || 'este artigo').replace(/'/g, "\\'")}')">
                                <i class="material-icons">delete</i> Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            // Calcular paginação
            const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
            const startIndex = (currentPage - 1) * articlesPerPage;
            const endIndex = startIndex + articlesPerPage;
            const pageArticles = filteredArticles.slice(startIndex, endIndex);
            
            debugLog(`Renderizando página ${currentPage}/${totalPages} com ${pageArticles.length} artigos`);
            
            // Atualizar controles de paginação
            if (totalPages > 1) {
                elements.pagination.style.display = 'flex';
                elements.pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
                elements.prevPage.disabled = currentPage === 1;
                elements.nextPage.disabled = currentPage === totalPages;
            } else {
                elements.pagination.style.display = 'none';
            }
            
            // Renderizar de acordo com a view atual
            if (currentView === 'table') {
                if (pageArticles.length === 0) {
                    elements.tableResults.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                <i class="material-icons" style="font-size: 48px; opacity: 0.3;">search_off</i>
                                <h3>${allArticles.length === 0 ? 'Nenhum artigo cadastrado' : 'Nenhum artigo encontrado'}</h3>
                                <p>${Object.values(searchParams).some(v => v) ? 'Tente alterar seus critérios de busca' : 'Comece usando os filtros acima para buscar artigos'}</p>
                                ${allArticles.length === 0 ? '<p><strong>Dica:</strong> Verifique se a coleção "articlesdoc" existe no Firebase.</p>' : ''}
                            </td>
                        </tr>
                    `;
                } else {
                    elements.tableResults.innerHTML = pageArticles.map(renderTableRow).join('');
                }
            } else {
                if (pageArticles.length === 0) {
                    elements.cardsResults.innerHTML = `
                        <div class="empty-state">
                            <i class="material-icons">search_off</i>
                            <h3>${allArticles.length === 0 ? 'Nenhum artigo cadastrado' : 'Nenhum artigo encontrado'}</h3>
                            <p>${Object.values(searchParams).some(v => v) ? 'Tente alterar seus critérios de busca' : 'Comece usando os filtros acima para buscar artigos'}</p>
                        </div>
                    `;
                } else {
                    elements.cardsResults.innerHTML = pageArticles.map(renderCard).join('');
                }
            }
            
            // Atualizar contador detalhado
            elements.detailedCount.textContent = 
                `Mostrando ${pageArticles.length} de ${filteredArticles.length} artigo${filteredArticles.length !== 1 ? 's' : ''}`;
        }

        function switchView(view) {
            debugLog(`Alternando para view: ${view}`);
            currentView = view;
            
            // Atualizar botões ativos
            elements.viewButtons.forEach(btn => {
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Mostrar/ocultar views
            if (view === 'table') {
                elements.tableView.style.display = 'block';
                elements.cardsView.style.display = 'none';
            } else {
                elements.tableView.style.display = 'none';
                elements.cardsView.style.display = 'grid';
            }
            
            // Renderizar resultados na nova view
            renderResults();
        }

        // --- Funções Firebase ---
        async function loadAllArticles() {
            try {
                debugLog('Iniciando carregamento de artigos...');
                
                // Mostrar loading
                elements.tableResults.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="material-icons" style="font-size: 48px; color: #3f51b5;">hourglass_empty</i>
                            <p>Carregando artigos...</p>
                        </td>
                    </tr>
                `;
                
                // Tentar diferentes abordagens para obter os artigos
                let snapshot;
                try {
                    // Tentar ordenar por createdAt se existir
                    snapshot = await firestore.collection('articlesdoc')
                        .orderBy('createdAt', 'desc')
                        .get();
                    debugLog('Artigos carregados com ordenação por createdAt');
                } catch (orderError) {
                    debugLog(`Não é possível ordenar por createdAt: ${orderError.message}`);
                    // Tentar sem ordenação
                    snapshot = await firestore.collection('articlesdoc').get();
                    debugLog('Artigos carregados sem ordenação');
                }
                
                allArticles = snapshot.docs;
                debugLog(`Total de artigos carregados: ${allArticles.length}`);
                
                // Depurar estrutura dos dados
                if (allArticles.length > 0) {
                    const firstArticle = allArticles[0];
                    debugLog('Primeiro artigo:', 'info');
                    debugLog(`ID: ${firstArticle.id}`, 'info');
                    debugLog('Campos disponíveis:', 'info');
                    const data = firstArticle.data();
                    Object.keys(data).forEach(key => {
                        debugLog(`  - ${key}: ${JSON.stringify(data[key]).substring(0, 50)}...`, 'info');
                    });
                }
                
                // Ordenar localmente por data se possível
                allArticles.sort((a, b) => {
                    const getDate = (doc) => {
                        const data = doc.data();
                        try {
                            const date = data.createdAt?.toDate ? data.createdAt.toDate() : 
                                        data.timestamp?.toDate ? data.timestamp.toDate() :
                                        new Date(data.createdAt || data.timestamp || data.date || 0);
                            return date.getTime();
                        } catch (e) {
                            return 0;
                        }
                    };
                    return getDate(b) - getDate(a);
                });
                
                // Se houver parâmetros na URL, aplicar busca automática
                const urlParams = new URLSearchParams(window.location.search);
                const urlTitle = urlParams.get('title');
                const urlAuthor = urlParams.get('author');
                
                if (urlTitle) {
                    elements.searchTitle.value = urlTitle;
                }
                if (urlAuthor) {
                    elements.searchAuthor.value = urlAuthor;
                }
                
                // Realizar busca inicial
                performSearch();
                
            } catch (error) {
                debugLog(`ERRO ao carregar artigos: ${error.message}`, 'error');
                console.error('Erro detalhado:', error);
                
                elements.tableResults.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">
                            <i class="material-icons" style="font-size: 48px;">error_outline</i>
                            <h3>Erro ao carregar artigos</h3>
                            <p><strong>${error.code || 'Erro'}:</strong> ${error.message}</p>
                            <div style="margin-top: 20px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px;">
                                <strong>Possíveis causas:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    <li>Coleção "articlesdoc" não existe</li>
                                    <li>Regras de segurança do Firestore</li>
                                    <li>Problema de conexão</li>
                                    <li>Erro de autenticação</li>
                                </ul>
                            </div>
                            <button onclick="runDiagnostics()" style="margin-top: 20px; padding: 10px 20px; background: #3f51b5; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Executar Diagnóstico Completo
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        async function runDiagnostics() {
            debugLog('=== INÍCIO DO DIAGNÓSTICO ===', 'success');
            
            // 1. Verificar Firebase
            debugLog('1. Verificando Firebase...', 'info');
            debugLog(`Apps inicializados: ${firebase.apps.length}`, 'info');
            debugLog(`Nome do app: ${firebase.app().name}`, 'info');
            
            // 2. Verificar autenticação
            debugLog('2. Verificando autenticação...', 'info');
            debugLog(`Usuário atual: ${auth.currentUser?.email || 'Não autenticado'}`, 
                    auth.currentUser ? 'success' : 'error');
            
            // 3. Testar conexão com Firestore
            debugLog('3. Testando conexão com Firestore...', 'info');
            try {
                const collections = await firestore.listCollections();
                debugLog(`Coleções disponíveis: ${collections.length}`, 'info');
                collections.forEach(col => {
                    debugLog(`  - ${col.id}`, 'info');
                });
            } catch (error) {
                debugLog(`ERRO ao listar coleções: ${error.message}`, 'error');
            }
            
            // 4. Testar coleção articlesdoc
            debugLog('4. Testando coleção articlesdoc...', 'info');
            try {
                const testQuery = firestore.collection('articlesdoc').limit(5);
                const testSnapshot = await testQuery.get();
                debugLog(`Documentos em articlesdoc: ${testSnapshot.size}`, 
                        testSnapshot.size > 0 ? 'success' : 'warning');
                
                if (testSnapshot.size > 0) {
                    testSnapshot.forEach((doc, index) => {
                        debugLog(`  Documento ${index + 1}: ${doc.id}`, 'info');
                        const data = doc.data();
                        debugLog(`    Título: ${data.title || 'Não definido'}`, 'info');
                        debugLog(`    Autores: ${data.authors ? (Array.isArray(data.authors) ? data.authors.join(', ') : data.authors) : 'Não definido'}`, 'info');
                    });
                }
            } catch (error) {
                debugLog(`ERRO ao acessar articlesdoc: ${error.message}`, 'error');
                debugLog('Certifique-se de que a coleção existe e as regras de segurança permitem leitura.', 'error');
            }
            
            debugLog('=== FIM DO DIAGNÓSTICO ===', 'success');
            
            // Mostrar painel de debug
            elements.debugPanel.classList.add('show');
        }

        async function deleteArticle(articleId, articleTitle) {
            if (!confirm(`Tem certeza que deseja excluir o artigo "${articleTitle}"? Esta ação não pode ser desfeita.`)) {
                return;
            }
            
            try {
                debugLog(`Excluindo artigo: ${articleId}`, 'info');
                await firestore.collection('articlesdoc').doc(articleId).delete();
                showNotification('Artigo excluído com sucesso!', 'success');
                debugLog('Artigo excluído com sucesso', 'success');
                
                // Recarregar artigos
                await loadAllArticles();
                
            } catch (error) {
                debugLog(`ERRO ao excluir artigo: ${error.message}`, 'error');
                showNotification('Erro ao excluir artigo: ' + error.message, 'error');
            }
        }

        function viewArticle(articleId) {
            const article = allArticles.find(a => a.id === articleId);
            if (article) {
                const data = article.data();
                // Usar UID se disponível, senão usar ID
                const uid = data.uid || articleId;
                debugLog(`Abrindo artigo para visualização: ${uid}`, 'info');
                window.open(`view-article.html?uid=${encodeURIComponent(uid)}`, '_blank');
            }
        }

        function editArticle(articleId) {
            const article = allArticles.find(a => a.id === articleId);
            if (article) {
                const data = article.data();
                // Usar UID se disponível, senão usar ID
                const uid = data.uid || articleId;
                debugLog(`Abrindo artigo para edição: ${uid}`, 'info');
                window.open(`edit-article.html?uid=${encodeURIComponent(uid)}`, '_blank');
            }
        }

        function createNewArticle() {
            debugLog('Criando novo artigo', 'info');
            window.open('edit-article.html', '_blank');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function clearSearch() {
            debugLog('Limpando busca', 'info');
            // Limpar todos os campos
            elements.searchTitle.value = '';
            elements.searchAuthor.value = '';
            elements.searchStatus.value = '';
            elements.searchType.value = '';
            elements.searchContent.value = '';
            elements.searchCitation.value = '';
            elements.searchLanguage.value = '';
            elements.searchDateFrom.value = '';
            elements.searchDateTo.value = '';
            
            // Recolher busca avançada
            elements.advancedFields.classList.remove('show');
            elements.advancedToggle.querySelector('i').textContent = 'expand_more';
            
            // Realizar busca vazia
            performSearch();
        }

        // --- Event Listeners e Inicialização ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                debugLog(`Usuário autenticado: ${user.email}`, 'success');
                loadAllArticles();
            } else {
                currentUser = null;
                debugLog('Usuário não autenticado', 'error');
                showNotification('Você precisa fazer login para continuar', 'error');
                setTimeout(() => {
                    window.location.href = './login.html';
                }, 2000);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Página carregada', 'success');
            
            // Inicializar MDL
            if (window.componentHandler) {
                window.componentHandler.upgradeDom();
            }
            
            // Configurar data atual como valor padrão para data final
            const today = new Date().toISOString().split('T')[0];
            elements.searchDateTo.value = today;
            
            // Event Listeners para busca avançada
            elements.advancedToggle.addEventListener('click', () => {
                elements.advancedFields.classList.toggle('show');
                const icon = elements.advancedToggle.querySelector('i');
                icon.textContent = elements.advancedFields.classList.contains('show') 
                    ? 'expand_less' 
                    : 'expand_more';
            });
            
            // Event Listeners para botões de busca
            elements.searchBtn.addEventListener('click', performSearch);
            elements.clearSearch.addEventListener('click', clearSearch);
            elements.newArticleBtn.addEventListener('click', createNewArticle);
            elements.debugBtn.addEventListener('click', runDiagnostics);
            
            // Event Listeners para view toggle
            elements.viewButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchView(btn.dataset.view);
                });
            });
            
            // Event Listeners para paginação
            elements.prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderResults();
                }
            });
            
            elements.nextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderResults();
                }
            });
            
            // Permitir busca com Enter em qualquer campo
            const searchInputs = [
                elements.searchTitle,
                elements.searchAuthor,
                elements.searchContent,
                elements.searchCitation
            ];
            
            searchInputs.forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            });
            
            // Adicionar estilos CSS para animações
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });

        // Funções globais para acesso nos botões
        window.viewArticle = viewArticle;
        window.editArticle = editArticle;
        window.deleteArticle = deleteArticle;
        window.createNewArticle = createNewArticle;
        window.runDiagnostics = runDiagnostics;
        window.toggleDebug = toggleDebug;
        window.debugFirebase = async function() {
            debugLog('Testando conexão Firebase...', 'info');
            try {
                const test = await firestore.collection('articlesdoc').limit(1).get();
                debugLog(`Teste OK! Coleção encontrada com ${test.size} documentos`, 'success');
            } catch (error) {
                debugLog(`ERRO: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>
