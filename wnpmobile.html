<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

    <style>
        /* Estilos base do corpo e do contêiner */
        body {
            font-family: 'Noto Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #202122;
        }
        /* Header e layout (mantidos) */
        .header-logged-in {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #343a40;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .nav-buttons button { margin-right:8px; }
        .main-container { display: none; padding: 2em; gap: 20px; display: grid; grid-template-columns: 350px 1fr; grid-template-areas: "sidebar main-content"; min-height: calc(100vh - 120px); }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; grid-template-areas: "main-content" "sidebar"; } }
        .content-pane { background-color: #ffffff; padding: 2em; border: 1px solid #a2a9b1; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); line-height:1.6; }

        /* Painel de busca: layout otimizado */
        #buscar-artigos-pane .container { max-width: 100%; margin: 0 auto; background-color: #fff; padding: 0; border-radius: 0; box-shadow: none; }
        #buscar-artigos-pane h1 { color: #3f51b5; margin-bottom: 16px; text-align: center; font-size:1.2rem; }
        .search-toolbar {
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            padding: 12px 16px;
            border-bottom:1px solid #e0e0e0;
            background: #fafafa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .search-left { display:flex; gap:8px; align-items:center; flex:1; min-width:260px; }
        .search-right { display:flex; gap:8px; align-items:center; }
        .search-field {
            display:flex;
            align-items:center;
            border:1px solid #dfe1e5;
            border-radius:24px;
            padding:4px 8px;
            background:#fff;
            height:48px;
            flex:1;
            min-width:140px;
        }
        .search-field input[type="text"] {
            border:none; outline:none; padding:8px; font-size:16px; width:100%;
            box-sizing:border-box;
        }
        .select-compact { min-width:130px; padding:8px; border-radius:6px; border:1px solid #ccc; background:#fff; height:40px; }
        .btn-primary { background:#4285f4; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .btn-plain { background:#f5f5f5; color:#333; border:1px solid #ddd; padding:8px 12px; border-radius:6px; cursor:pointer; }

        /* Cards results grid */
        #articles-results {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap:18px;
            margin-top:18px;
            padding: 16px;
        }
        .article-card { background:#fff; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.12); overflow:hidden; display:flex; flex-direction:column; min-height:140px; }
        .article-card .title { background:#3f51b5; color:#fff; padding:12px 14px; font-weight:600; font-size:1rem; }
        .article-card .body { padding:12px 14px; flex:1; color:#333; }
        .article-card .meta { border-top:1px solid #eee; padding:10px 14px; display:flex; justify-content:space-between; align-items:center; font-size:0.9rem; color:#666; }

        .empty-state { text-align:center; padding:40px; color:#777; font-size:1.05em; }
        .error-message { text-align:center; padding:16px; color:#d32f2f; background-color:#ffebee; border:1px solid #d32f2f; border-radius:5px; margin-top:20px; }

        /* Highlighting */
        .hl { background: #fff176; padding:0 2px; border-radius:2px; }

        /* Load more */
        #load-more { margin: 12px auto; display:block; padding:10px 18px; border-radius:6px; border:none; background:#2a6f8b; color:#fff; cursor:pointer; }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .search-toolbar { padding: 8px; }
            .search-right { width: 100%; justify-content:space-between; }
        }
    </style>
</head>
<body>

<!-- (mantive as seções de login e conteúdo principal do arquivo original) -->
<div class="login-container" id="login-section">
    <div class="login-form">
        <h2>Entrar no Painel</h2>
        <p>Use sua conta Google para continuar.</p>
        <button id="google-login-btn" class="google-btn">
            <div class="google-icon"></div>
            Entrar com Google
        </button>
    </div>
</div>

<div id="logged-in-container">
    <div class="header-logged-in" id="header-logged-in">
        <div class="nav-buttons">
            <button id="artigos-btn" class="active">Artigos Recentes</button>
            <button id="criar-artigo-btn">Criar Novo Artigo</button>
            <button id="minhas-contribuicoes-btn">Minhas Contribuições</button>
            <button id="busca-avancada-btn">Busca Avançada</button>
            <button id="buscar-artigos-btn">Buscar Artigos</button>
        </div>
        <div>
            <button id="logout-button">Sair</button>
        </div>
    </div>

    <div class="main-container" id="content-split">
        <div id="artigos-pane" class="content-pane lista-artigos-pane" style="display: block;">
            <h2 id="artigos-title">Artigos Recentes</h2>
            <div id="artigos-list">
                <p style="text-align: center; color: #666;">Carregando...</p>
            </div>
        </div>

        <div id="conteudo-principal">
            <!-- detalhes, editor, histórico e outros painéis (mantidos conforme original) -->
            <div class="detalhes-artigo content-pane" id="detalhes-artigo">
                <p style="text-align: center; color: #888;">Selecione um artigo na lista para ver os detalhes.</p>
            </div>

            <!-- PAINEL DE BUSCA OTIMIZADA (substitui a versão anterior de buscar-artigos-pane) -->
            <div id="buscar-artigos-pane" class="content-pane" style="display: none;">
                <div class="container">
                    <h1>Wiki Zero - Busca de Artigos e Trabalhos</h1>

                    <div class="search-toolbar" id="search-toolbar">
                        <div class="search-left">
                            <div class="search-field" title="Buscar termo">
                                <input id="search-term" type="text" placeholder="Pesquisar título, descrição, resumo..." aria-label="Buscar termo" autocomplete="off" list="suggestions">
                                <datalist id="suggestions"></datalist>
                            </div>

                            <select id="search-type" class="select-compact" title="Campo de busca">
                                <option value="title">Título</option>
                                <option value="description">Descrição Curta</option>
                                <option value="summary">Resumo</option>
                                <option value="abstract">Abstract</option>
                                <option value="introduction">Introdução</option>
                                <option value="methodology">Metodologia</option>
                                <option value="discussion">Discussão</option>
                                <option value="conclusion">Conclusão</option>
                                <option value="sources">Fontes</option>
                                <option value="userId">ID do Usuário</option>
                                <option value="id">ID do Artigo</option>
                                <option value="originalUrl">Url</option>
                            </select>
                        </div>

                        <div class="search-right">
                            <select id="filter-language" class="select-compact" title="Idioma">
                                <option value="">Todos os Idiomas</option>
                                <option value="pt-BR">Português (Brasil)</option>
                                <option value="en-US">English (United States)</option>
                            </select>

                            <select id="filter-article-type" class="select-compact" title="Tipo">
                                <option value="">Todos os Tipos</option>
                                <option value="cientifico">Científico</option>
                                <option value="revisao">Revisão Bibliográfica</option>
                                <option value="noticia">Notícia</option>
                                <option value="editorial">Editorial</option>
                                <option value="opiniao">Opinião</option>
                                <option value="entrevista">Entrevista</option>
                                <option value="tutorial">Tutorial</option>
                            </select>

                            <select id="sort-by" class="select-compact" title="Ordenar">
                                <option value="createdAt_desc">Mais novos</option>
                                <option value="createdAt_asc">Mais antigos</option>
                                <option value="title_asc">Título A→Z</option>
                                <option value="title_desc">Título Z→A</option>
                            </select>

                            <select id="page-size" class="select-compact" title="Resultados por página">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="40">40</option>
                            </select>

                            <button id="main-search-button" class="btn-primary" title="Buscar"><i class="material-icons">search</i></button>
                            <button id="clear-search-button" class="btn-plain" title="Limpar filtros">Limpar</button>
                        </div>
                    </div>

                    <div id="articles-results" aria-live="polite">
                        <p class="empty-state" id="loading-message">Use a barra de pesquisa acima para encontrar artigos.</p>
                    </div>

                    <div style="text-align:center; margin:12px;">
                        <button id="load-more" style="display:none;">Carregar mais</button>
                    </div>

                    <div id="error-display" class="error-message" style="display: none;"></div>
                </div>
            </div>

            <!-- demais painéis (novo-artigo, editor, histórico, página-usuario, etc.) mantidos conforme o arquivo original -->
            <!-- ... (os blocos originais como editor-artigo, historico-artigo, novo-artigo, pagina-usuario, minhas-contribuicoes) ... -->
        </div>
    </div>
</div>

<!-- Scripts Firebase e bibliotecas (mantidas) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configuração do Firebase (mantida) ---
    const firebaseConfig = {
        apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
        authDomain: "wzzm-ce3fc.firebaseapp.com",
        projectId: "wzzm-ce3fc",
        storageBucket: "wzzm-ce3fc.appspot.com",
        messagingSenderId: "249427877153",
        appId: "1:249427877153:web:0e4297294794a5aadeb260",
        measurementId: "G-PLKNZNFCQ8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // Elementos que usaremos
    const buscarArtigosBtn = document.getElementById('buscar-artigos-btn');
    const buscarArtigosPane = document.getElementById('buscar-artigos-pane');
    const articlesResults = document.getElementById('articles-results');
    const loadingMessage = document.getElementById('loading-message');
    const errorDisplay = document.getElementById('error-display');
    const mainSearchButton = document.getElementById('main-search-button');
    const clearSearchButton = document.getElementById('clear-search-button');
    const searchTermInput = document.getElementById('search-term');
    const searchTypeSelect = document.getElementById('search-type');
    const filterLanguage = document.getElementById('filter-language');
    const filterArticleType = document.getElementById('filter-article-type');
    const sortBySelect = document.getElementById('sort-by');
    const pageSizeSelect = document.getElementById('page-size');
    const loadMoreBtn = document.getElementById('load-more');
    const suggestionsDatalist = document.getElementById('suggestions');

    // Estado da busca
    let lastOptions = null;
    let lastDocsSnapshot = null;
    let lastServerQuery = null;
    let isFetching = false;
    let fetchedTitlesCache = []; // para sugestões
    const MAX_CLIENT_FETCH = 500; // limite para buscas client-side (configurável)

    // Função utilitária debounce
    function debounce(fn, wait) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    // Remove elementos filhos seguros
    function clearResults() {
        articlesResults.innerHTML = '';
    }

    // Painel visível
    buscarArtigosBtn.addEventListener('click', () => {
        exibirPainel('buscar-artigos-pane');
        // limpa sugestões e resultados iniciais
        suggestionsDatalist.innerHTML = '';
        clearResults();
        loadingMessage.innerText = 'Use a barra de pesquisa acima para encontrar artigos.';
        loadingMessage.style.display = 'block';
    });

    // Limpar filtros
    clearSearchButton.addEventListener('click', () => {
        searchTermInput.value = '';
        searchTypeSelect.value = 'title';
        filterLanguage.value = '';
        filterArticleType.value = '';
        sortBySelect.value = 'createdAt_desc';
        pageSizeSelect.value = '20';
        suggestionsDatalist.innerHTML = '';
        clearResults();
        loadingMessage.style.display = 'block';
        loadingMessage.innerText = 'Use a barra de pesquisa acima para encontrar artigos.';
        errorDisplay.style.display = 'none';
    });

    // Busca principal (debounced no input + botão)
    const debouncedSearch = debounce(() => {
        triggerSearch({ debounceTriggered: true });
    }, 450);
    searchTermInput.addEventListener('input', (e) => {
        debouncedSearch();
    });

    mainSearchButton.addEventListener('click', () => {
        triggerSearch();
    });

    // Enter para submeter
    searchTermInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            triggerSearch();
        }
    });

    // Carregar mais
    loadMoreBtn.addEventListener('click', () => {
        if (lastOptions) {
            triggerSearch({ loadMore: true });
        }
    });

    // Gera um highlight seguro para o termo encontrado
    function highlight(text, term) {
        if (!term) return DOMPurify.sanitize(text);
        const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(escaped, 'ig');
        return DOMPurify.sanitize(text).replace(re, m => `<span class="hl">${m}</span>`);
    }

    // Renderiza um card de artigo
    function renderArticleCard(doc, term, campo) {
        const data = doc.data();
        const title = data.title || data.titulo || '(Sem título)';
        const description = (data.description || data.descricao || '').slice(0, 380);
        const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : '';
        const type = data.type || data.setor || '';
        const lang = data.language || data.idioma || '';
        const safeTitle = highlight(title, term && campo === 'title' ? term : null);
        const safeDesc = highlight(description, term && campo !== 'title' ? term : null);

        const wrapper = document.createElement('article');
        wrapper.className = 'article-card';
        wrapper.setAttribute('data-id', doc.id);
        wrapper.innerHTML = `
            <div class="title">${safeTitle}</div>
            <div class="body">${safeDesc}</div>
            <div class="meta">
                <div>${DOMPurify.sanitize(type)} ${lang ? '• ' + DOMPurify.sanitize(lang) : ''}</div>
                <div>${DOMPurify.sanitize(createdAt)}</div>
            </div>
        `;
        // clique abre detalhes (comportamento existente)
        wrapper.addEventListener('click', () => {
            // função para mostrar detalhes do artigo; usa id do documento.
            // Reaproveitar sua função existente de abrir detalhe (implemente conforme seu projeto)
            abrirDetalhesArtigo(doc.id);
        });
        return wrapper;
    }

    // Função principal de busca: options: { loadMore, debounceTriggered }
    async function triggerSearch(opts = {}) {
        if (isFetching) return;
        const searchTerm = (searchTermInput.value || '').trim();
        const searchType = (searchTypeSelect.value || 'title');
        const language = filterLanguage.value || '';
        const articleType = filterArticleType.value || '';
        const sortBy = sortBySelect.value || 'createdAt_desc';
        const pageSize = parseInt(pageSizeSelect.value || '20', 10);

        // Se loadMore, mantemos lastOptions e pedimos próxima página quando possível
        let options = { searchTerm, searchType, language, articleType, sortBy, pageSize };

        // If loadMore requested and lastOptions same, we'll attempt pagination (server side where possible).
        if (opts.loadMore && lastOptions && JSON.stringify(lastOptions) === JSON.stringify(options)) {
            await fetchMoreResults();
            return;
        }

        // Reset pagination state
        lastOptions = options;
        lastDocsSnapshot = null;
        lastServerQuery = null;
        loadMoreBtn.style.display = 'none';
        errorDisplay.style.display = 'none';

        // Determine query strategy:
        // - equality fields (id, userId, originalUrl) -> use Firestore where
        // - others text fields -> fallback to fetching recent docs (up to MAX_CLIENT_FETCH) and filtering client-side
        isFetching = true;
        clearResults();
        loadingMessage.style.display = 'block';
        loadingMessage.innerText = 'Carregando resultados...';

        try {
            if (['id','userId','originalUrl'].includes(searchType) && searchTerm !== '') {
                // Consulta direta por igualdade
                let q = db.collection('artigos');
                if (searchType === 'id') {
                    // tentar obter documento por id diretamente
                    const doc = await db.collection('artigos').doc(searchTerm).get();
                    if (doc.exists) {
                        const card = renderArticleCard(doc, searchTerm, 'title');
                        articlesResults.appendChild(card);
                        loadingMessage.style.display = 'none';
                    } else {
                        loadingMessage.innerText = 'Nenhum artigo encontrado com esse ID.';
                    }
                } else {
                    q = q.where(searchType, '==', searchTerm);
                    // aplica filtros adicionais
                    if (language) q = q.where('language', '==', language);
                    if (articleType) q = q.where('type', '==', articleType);
                    // ordenação
                    if (sortBy.startsWith('createdAt')) {
                        const dir = sortBy.endsWith('_asc') ? 'asc' : 'desc';
                        q = q.orderBy('createdAt', dir);
                    }
                    q = q.limit(pageSize);
                    const snap = await q.get();
                    if (snap.empty) {
                        loadingMessage.innerText = 'Nenhum artigo encontrado.';
                    } else {
                        loadingMessage.style.display = 'none';
                        snap.forEach(doc => {
                            const card = renderArticleCard(doc, searchTerm, searchType);
                            articlesResults.appendChild(card);
                        });
                        // preparar paginação com startAfter
                        lastDocsSnapshot = snap.docs.length ? snap.docs[snap.docs.length - 1] : null;
                        if (snap.docs.length === pageSize) loadMoreBtn.style.display = 'inline-block';
                    }
                }
            } else {
                // Textual search: strategy -> query recent docs (server side) then filter client-side
                // Para minimizar leitura, buscamos pageSize * factor (até MAX_CLIENT_FETCH)
                const fetchCount = Math.min(MAX_CLIENT_FETCH, Math.max(pageSize * 10, 100));
                let q = db.collection('artigos');
                // aplicar filtros que são indexáveis
                if (language) q = q.where('language', '==', language);
                if (articleType) q = q.where('type', '==', articleType);
                // ordenar por createdAt (direção do sort)
                if (sortBy.startsWith('createdAt')) {
                    const dir = sortBy.endsWith('_asc') ? 'asc' : 'desc';
                    q = q.orderBy('createdAt', dir);
                } else if (sortBy.startsWith('title')) {
                    // Se quiser ordenar por título, precisamos ordenar por title. Ainda assim faremos fetch client-side.
                    const dir = sortBy.endsWith('_asc') ? 'asc' : 'desc';
                    q = q.orderBy('title', dir);
                } else {
                    q = q.orderBy('createdAt', 'desc');
                }
                q = q.limit(fetchCount);
                const snap = await q.get();

                if (snap.empty) {
                    loadingMessage.innerText = 'Nenhum artigo encontrado.';
                    isFetching = false;
                    return;
                }
                // Filtrar client-side por substring (case-insensitive) no campo selecionado
                const term = searchTerm.toLowerCase();
                const results = [];
                const docs = [];
                snap.forEach(doc => {
                    docs.push(doc);
                    const data = doc.data();
                    let fieldVal = '';
                    // mapeamento para aceitar pt/en/alternativos
                    if (searchType === 'title') fieldVal = data.title || data.titulo || '';
                    else if (searchType === 'description') fieldVal = data.description || data.descricao || '';
                    else if (searchType === 'summary') fieldVal = data.summary || data.resumo || '';
                    else if (searchType === 'abstract') fieldVal = data.abstract || data.resumo || '';
                    else if (searchType === 'introduction') fieldVal = data.introduction || data.introducao || '';
                    else if (searchType === 'methodology') fieldVal = data.methodology || data.metodologia || '';
                    else if (searchType === 'discussion') fieldVal = data.discussion || data.discussoes || '';
                    else if (searchType === 'conclusion') fieldVal = data.conclusion || data.conclusao || '';
                    else if (searchType === 'sources') fieldVal = (data.sources && Array.isArray(data.sources)) ? data.sources.join(' ') : (data.sources || '');
                    else if (searchType === 'originalUrl') fieldVal = data.originalUrl || data.url || '';
                    else fieldVal = JSON.stringify(data);

                    if (!term || (fieldVal && fieldVal.toString().toLowerCase().indexOf(term) !== -1)) {
                        results.push(doc);
                    }
                });

                // Ordenação adicional se for por título e fizemos fetch por createdAt
                if (sortBy.startsWith('title')) {
                    const dirAsc = sortBy.endsWith('_asc');
                    results.sort((a,b) => {
                        const ta = (a.data().title || '').toLowerCase();
                        const tb = (b.data().title || '').toLowerCase();
                        if (ta === tb) return 0;
                        return (ta > tb ? 1 : -1) * (dirAsc ? 1 : -1);
                    });
                }

                // Paginação client-side: mostra os primeiros pageSize; armazena cursor como índice
                results.slice(0, pageSize).forEach(doc => {
                    const card = renderArticleCard(doc, searchTerm, searchType);
                    articlesResults.appendChild(card);
                });

                // atualizar sugestões (últimos títulos)
                fetchedTitlesCache = docs.map(d => d.data().title || d.data().titulo || '').filter(Boolean).slice(0, 60);
                suggestionsDatalist.innerHTML = '';
                fetchedTitlesCache.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    suggestionsDatalist.appendChild(opt);
                });

                // Preparar estado para "load more" client-side
                lastServerQuery = { docs, filteredResults: results, clientIndex: Math.min(pageSize, results.length) };
                if (results.length > pageSize) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }

                loadingMessage.style.display = 'none';
            }
        } catch (err) {
            console.error('Erro na busca:', err);
            errorDisplay.style.display = 'block';
            errorDisplay.innerText = 'Erro ao buscar artigos: ' + (err && err.message ? err.message : String(err));
            loadingMessage.style.display = 'none';
        } finally {
            isFetching = false;
        }
    }

    // Fetch more when server-side available or client-side fallback
    async function fetchMoreResults() {
        if (isFetching) return;
        isFetching = true;
        errorDisplay.style.display = 'none';
        loadMoreBtn.disabled = true;
        loadMoreBtn.innerText = 'Carregando...';

        const options = lastOptions;
        try {
            // If we have lastDocsSnapshot and lastOptions were equality/query-based, use startAfter
            if (lastDocsSnapshot && ['id','userId','originalUrl'].includes(options.searchType) === false) {
                // Attempt server-side pagination using lastDocsSnapshot
                // Rebuild base query similar to initial one
                let q = db.collection('artigos');
                if (options.language) q = q.where('language', '==', options.language);
                if (options.articleType) q = q.where('type', '==', options.articleType);
                if (options.sortBy.startsWith('createdAt')) {
                    const dir = options.sortBy.endsWith('_asc') ? 'asc' : 'desc';
                    q = q.orderBy('createdAt', dir);
                } else if (options.sortBy.startsWith('title')) {
                    const dir = options.sortBy.endsWith('_asc') ? 'asc' : 'desc';
                    q = q.orderBy('title', dir);
                } else {
                    q = q.orderBy('createdAt', 'desc');
                }
                q = q.startAfter(lastDocsSnapshot).limit(options.pageSize);
                const snap = await q.get();
                if (!snap.empty) {
                    snap.forEach(doc => {
                        const card = renderArticleCard(doc, options.searchTerm, options.searchType);
                        articlesResults.appendChild(card);
                    });
                    lastDocsSnapshot = snap.docs[snap.docs.length - 1];
                    if (snap.docs.length < options.pageSize) loadMoreBtn.style.display = 'none';
                    else loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } else if (lastServerQuery && lastServerQuery.filteredResults) {
                // client-side pagination using filteredResults
                const { filteredResults, clientIndex } = lastServerQuery;
                const nextIndex = clientIndex + options.pageSize;
                filteredResults.slice(clientIndex, nextIndex).forEach(doc => {
                    const card = renderArticleCard(doc, options.searchTerm, options.searchType);
                    articlesResults.appendChild(card);
                });
                lastServerQuery.clientIndex = Math.min(nextIndex, filteredResults.length);
                if (lastServerQuery.clientIndex >= filteredResults.length) {
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'inline-block';
                }
            } else {
                // fallback: re-trigger a larger fetch
                await triggerSearch();
            }
        } catch (err) {
            console.error('Erro ao carregar mais:', err);
            errorDisplay.style.display = 'block';
            errorDisplay.innerText = 'Erro ao carregar mais resultados: ' + (err && err.message ? err.message : String(err));
        } finally {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerText = 'Carregar mais';
            isFetching = false;
        }
    }

    // Função que abre detalhes do artigo (placeholder — integre com sua implementação existente)
    function abrirDetalhesArtigo(docId) {
        // Exibe o painel de detalhes e carrega conteúdo do documento
        // Você já possui lógica no arquivo original para exibir detalhes; aqui apenas chamamos essa lógica.
        // Exemplo de comportamento mínimo:
        exibirPainel('detalhes-artigo');
        const detalhesArtigo = document.getElementById('detalhes-artigo');
        detalhesArtigo.innerHTML = '<p style="text-align:center;color:#666">Carregando artigo...</p>';
        db.collection('artigos').doc(docId).get().then(snap => {
            if (!snap.exists) {
                detalhesArtigo.innerHTML = '<p style="text-align:center;color:#666">Artigo não encontrado.</p>';
                return;
            }
            const data = snap.data();
            // Render simples (sanitizar com DOMPurify)
            const title = DOMPurify.sanitize(data.title || data.titulo || '(Sem título)');
            const desc = DOMPurify.sanitize(data.description || data.descricao || data.content || '');
            detalhesArtigo.innerHTML = `
                <h2>${title}</h2>
                <div>${desc}</div>
                <div style="margin-top:10px;color:#777;font-size:0.9em;">
                    ${data.type ? 'Tipo: ' + DOMPurify.sanitize(data.type) + ' • ' : ''}
                    ${data.language ? 'Idioma: ' + DOMPurify.sanitize(data.language) : ''}
                </div>
            `;
        }).catch(err => {
            console.error('Erro ao carregar artigo:', err);
            detalhesArtigo.innerHTML = '<p style="text-align:center;color:#d32f2f">Erro ao carregar artigo.</p>';
        });
    }

    // Exibir painel helper (copiado do seu arquivo original)
    function exibirPainel(painelId) {
        document.querySelectorAll('#conteudo-principal > .content-pane').forEach(pane => pane.style.display = 'none');
        const painel = document.getElementById(painelId);
        if (painel) painel.style.display = 'block';
        document.querySelectorAll('.nav-buttons button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(painelId.replace('-pane', '-btn')) || document.getElementById('artigos-btn');
        if (activeBtn) activeBtn.classList.add('active');
    }

    // (Opcional) carregar alguns títulos iniciais para sugestões / cache
    async function preloadTitles() {
        try {
            const snap = await db.collection('artigos').orderBy('createdAt', 'desc').limit(60).get();
            const titles = [];
            snap.forEach(d => {
                const t = d.data().title || d.data().titulo;
                if (t) titles.push(t);
            });
            titles.slice(0,30).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                suggestionsDatalist.appendChild(opt);
            });
            fetchedTitlesCache = titles;
        } catch (err) {
            
            console.warn('Não foi possível pré-carregar títulos:', err);
        }
    }
    preloadTitles();

    // Optionally sign-in logic and auth.onAuthStateChanged are present in original file; ensure they remain.
    // Para não duplicar código, presumo que sua lógica de auth do arquivo original permanece intacta.
});
</script>

</body>
</html>