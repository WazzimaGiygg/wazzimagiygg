<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - WZZM</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <!-- Flatpickr CSS para filtros de data -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* Estilos base do corpo e do contêiner */
        body {
            font-family: 'Noto Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #202122;
        }

        /* Estilos do formulário de login */
        .login-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f8f9fa;
        }
        .login-form {
            background-color: #ffffff;
            padding: 40px;
            border: 1px solid #a2a9b1;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 350px;
            text-align: center;
        }
        .login-form h2 {
            color: #333;
            margin-bottom: 25px;
        }
        .login-form p {
            color: #54595d;
            margin-bottom: 25px;
        }
        .google-btn {
            background-color: #4285F4;
            color: white;
            padding: 12px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .google-btn:hover {
            background-color: #357ae8;
        }
        .google-icon {
            margin-right: 10px;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png') no-repeat center;
            background-size: contain;
            width: 24px;
            height: 24px;
        }

        /* Estilos da barra de cabeçalho e do corpo principal */
        .header-logged-in {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #343a40;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-logged-in .nav-buttons button {
            background-color: #54595d;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .header-logged-in .nav-buttons button.active {
            background-color: #2a6f8b;
        }

        /* Novo estilo para o layout de duas colunas */
        .main-container {
            display: none;
            flex-grow: 1;
            flex-wrap: wrap;
            padding: 2em;
            gap: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-areas: "sidebar main-content";
            min-height: calc(100vh - 120px);
        }
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-areas: "main-content" "sidebar";
            }
        }

        #artigos-pane {
            grid-area: sidebar;
        }
        #conteudo-principal {
            grid-area: main-content;
        }

        /* Estilos do painel de conteúdo */
        .content-pane {
            background-color: #ffffff;
            padding: 2em;
            border: 1px solid #a2a9b1;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            line-height: 1.6;
        }

        /* Estilos da lista de artigos */
        .lista-artigos-pane {
            height: 100%;
            overflow-y: auto;
        }
        .lista-artigos-pane h2 {
            font-size: 1.5em;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .artigo-item {
            padding: 1em;
            border-bottom: 1px solid #eaecf0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .artigo-item:hover, .artigo-item.ativo {
            background-color: #eaf3ff;
        }
        .artigo-item h3 {
            margin: 0 0 5px 0;
            color: #0645ad;
            font-size: 1.1em;
        }
        .artigo-item p {
            font-size: 0.9em;
            color: #54595d;
            margin: 0;
        }

        /* Estilos dos outros painéis */
        #detalhes-artigo, #editor-artigo, #historico-artigo, #novo-artigo, #pagina-usuario, 
        #busca-avancada-pane, #minhas-contribuicoes, #buscar-artigos-pane {
           width: 100%;
           height: 100%;
           max-height: calc(100vh - 200px);
           overflow-y: auto;
        }
        
        /* Estilos aprimorados para busca avançada */
        #busca-avancada-pane .search-form {
            padding: 1em;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        #busca-avancada-pane .search-form label {
            display: block;
            font-weight: normal;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        #busca-avancada-pane .search-form input, 
        #busca-avancada-pane .search-form select,
        #busca-avancada-pane .search-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* Filtros de data lado a lado */
        .date-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .date-filters > div {
            flex: 1;
        }

        /* Estilos aprimorados para o editor de artigos */
        .editor-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .editor-status {
            font-size: 0.9em;
            color: #666;
            padding: 5px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .editor-status.saving {
            color: #2196F3;
            background-color: #E3F2FD;
        }
        
        .editor-status.saved {
            color: #4CAF50;
            background-color: #E8F5E9;
        }
        
        .editor-main {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }
        
        /* Contêiner para o editor Quill */
        #editor-quill {
            height: 400px;
            min-height: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Preview em tempo real */
        .editor-preview {
            flex: 1;
            min-height: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        
        .editor-preview h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .preview-content {
            line-height: 1.6;
        }
        
        .preview-content img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
        
        .editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .draft-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Upload de imagens */
        .image-upload-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .image-upload-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .image-upload-btn:hover {
            background-color: #357ae8;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Estilos para tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .tag {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .tag-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .tag-input input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Estilos para resultados de busca avançada */
        .search-result-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            transition: box-shadow 0.3s;
        }
        
        .search-result-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .search-result-title {
            font-size: 1.2em;
            color: #1976d2;
            margin: 0;
            text-decoration: none;
        }
        
        .search-result-title:hover {
            text-decoration: underline;
        }
        
        .search-result-meta {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .search-result-summary {
            color: #444;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .search-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .search-result-tag {
            background-color: #f0f0f0;
            color: #555;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        .search-highlight {
            background-color: #fff9c4;
            padding: 2px;
            border-radius: 2px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .pagination button {
            padding: 5px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: #f5f5f5;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 0.9em;
            color: #666;
        }

        /* Estilos do Quill editor toolbar */
        .ql-toolbar.ql-snow {
            border: 1px solid #ccc;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        
        .ql-container.ql-snow {
            border: 1px solid #ccc;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            height: 300px;
        }

        /* Responsividade para o editor */
        @media (max-width: 768px) {
            .editor-main {
                flex-direction: column;
            }
            
            #editor-quill, .editor-preview {
                min-height: 250px;
            }
            
            .date-filters {
                flex-direction: column;
            }
        }

        /* Estilos existentes mantidos */
        #artigo-iframe {
            width: 100%;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Estilos de impressão */
        @media print {
            body > *:not(.detalhes-artigo) {
                display: none !important;
            }
            .detalhes-artigo {
                width: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }
            .botoes-artigo-imprimivel {
                display: none !important;
            }
        }
        
        /* Estilos da Página de Busca existentes mantidos */
        #buscar-artigos-pane .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: #fff;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
        }
        #buscar-artigos-pane h1 {
            color: #3f51b5;
            margin-bottom: 25px;
            text-align: center;
        }
        
        /* Estilos para a nova busca avançada */
        .advanced-search-filters {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .filter-group input,
        .filter-group select,
        .filter-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filter-group input:focus,
        .filter-group select:focus,
        .filter-group textarea:focus {
            outline: none;
            border-color: #4285F4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        .search-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .search-results-container {
            margin-top: 20px;
        }
        
        .results-stats {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* Flatpickr custom styles */
        .flatpickr-input {
            background-color: white;
            cursor: pointer;
        }
        
        /* Loader para busca */
        .search-loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .search-loader.active {
            display: block;
        }
        
        .loader-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285F4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- Estrutura HTML existente mantida -->
<div class="login-container" id="login-section">
    <div class="login-form">
        <h2>Entrar no Painel</h2>
        <p>Use sua conta Google para continuar.</p>
        <button id="google-login-btn" class="google-btn">
            <div class="google-icon"></div>
            Entrar com Google
        </button>
    </div>
</div>

<div id="logged-in-container">
    <div class="header-logged-in" id="header-logged-in">
        <div class="nav-buttons">
            <button id="artigos-btn" class="active">Artigos Recentes</button>
            <button id="criar-artigo-btn">Criar Novo Artigo</button>
            <button id="minhas-contribuicoes-btn">Minhas Contribuições</button>
            <button id="busca-avancada-btn">Busca Avançada</button>
            <button id="buscar-artigos-btn">Buscar Artigos</button>
        </div>
        <div>
            <button id="logout-button">Sair</button>
        </div>
    </div>

    <div class="main-container" id="content-split">
        <div id="artigos-pane" class="content-pane lista-artigos-pane" style="display: block;">
            <h2 id="artigos-title">Artigos Recentes</h2>
            <div id="artigos-list">
                <p style="text-align: center; color: #666;">Carregando...</p>
            </div>
        </div>

        <div id="conteudo-principal">
            <!-- Painel de Detalhes do Artigo (mantido) -->
            <div class="detalhes-artigo content-pane" id="detalhes-artigo">
                <p style="text-align: center; color: #888;">Selecione um artigo na lista para ver os detalhes.</p>
            </div>

            <!-- Busca Avançada Aprimorada -->
            <div id="busca-avancada-pane" class="content-pane" style="display: none;">
                <h2>Busca Avançada</h2>
                <div class="advanced-search-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca-titulo">Título:</label>
                            <input type="text" id="busca-titulo" placeholder="Digite palavras do título">
                        </div>
                        <div class="filter-group">
                            <label for="busca-descricao">Descrição/Conteúdo:</label>
                            <input type="text" id="busca-descricao" placeholder="Buscar no conteúdo">
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca-autor">Autor:</label>
                            <input type="text" id="busca-autor" placeholder="Nome ou email do autor">
                        </div>
                        <div class="filter-group">
                            <label for="busca-tags">Tags (separadas por vírgula):</label>
                            <input type="text" id="busca-tags" placeholder="ex: tecnologia, ciência, história">
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca-categoria">Categoria:</label>
                            <select id="busca-categoria">
                                <option value="">Todas as categorias</option>
                                <option value="Ultimas Noticias">Últimas Notícias</option>
                                <option value="Arte">Arte</option>
                                <option value="Biografias">Biografias</option>
                                <option value="Ciência">Ciência</option>
                                <option value="Filosofia">Filosofia</option>
                                <option value="Geografia">Geografia</option>
                                <option value="História">História</option>
                                <option value="Matemática">Matemática</option>
                                <option value="Sociedade">Sociedade</option>
                                <option value="Tecnologia">Tecnologia</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="busca-idioma">Idioma:</label>
                            <select id="busca-idioma">
                                <option value="">Todos os idiomas</option>
                                <option value="Português">Português</option>
                                <option value="Inglês">Inglês</option>
                                <option value="Espanhol">Espanhol</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="date-filters">
                            <div class="filter-group">
                                <label for="data-inicio">Data de criação (início):</label>
                                <input type="text" id="data-inicio" class="flatpickr-input" placeholder="Selecione uma data">
                            </div>
                            <div class="filter-group">
                                <label for="data-fim">Data de criação (fim):</label>
                                <input type="text" id="data-fim" class="flatpickr-input" placeholder="Selecione uma data">
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca-uid">UID do Documento:</label>
                            <input type="text" id="busca-uid" placeholder="uid/?uid=">
                        </div>
                        <div class="filter-group">
                            <label for="ordenar-por">Ordenar por:</label>
                            <select id="ordenar-por">
                                <option value="ultimaEdicao">Data da última edição</option>
                                <option value="dataCriacao">Data de criação</option>
                                <option value="titulo">Título (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="search-actions">
                        <button id="buscar-avancada-submit" style="padding: 10px 20px; background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Buscar Artigos
                        </button>
                        <button id="limpar-busca-avancada" type="button" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Limpar Filtros
                        </button>
                    </div>
                </div>
                
                <div class="search-loader" id="busca-loader">
                    <div class="loader-spinner"></div>
                    <p>Buscando artigos...</p>
                </div>
                
                <div class="search-results-container" id="busca-resultados">
                    <div class="results-stats" id="resultados-stats"></div>
                    <div id="lista-resultados-busca"></div>
                    <div class="pagination" id="busca-paginacao"></div>
                </div>
            </div>

            <!-- Editor de Artigos Aprimorado -->
            <div id="editor-artigo" class="content-pane" style="display: none;">
                <div class="editor-container">
                    <div class="editor-header">
                        <h2>Editar Artigo</h2>
                        <div class="editor-status" id="editor-status">Pronto</div>
                    </div>
                    
                    <div class="editor-main">
                        <div class="form-group">
                            <label for="edit-titulo">Título *</label>
                            <input type="text" id="edit-titulo" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Tags (opcional)</label>
                            <div class="tag-input">
                                <input type="text" id="edit-tag-input" placeholder="Digite uma tag e pressione Enter">
                                <button type="button" id="add-tag-btn" style="padding: 5px 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Adicionar</button>
                            </div>
                            <div class="tags-container" id="edit-tags-container"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descrição (Editor WYSIWYG)</label>
                            <div id="editor-quill"></div>
                        </div>
                        
                        <div class="image-upload-container">
                            <button type="button" id="upload-image-btn" class="image-upload-btn">
                                <i class="material-icons">image</i> Upload de Imagem
                            </button>
                            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                            <div class="image-preview" id="image-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Preview em Tempo Real</label>
                            <div class="editor-preview">
                                <h3>Preview do Artigo</h3>
                                <div class="preview-content" id="preview-content"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-sumario">Resumo da Edição (para o Histórico) *</label>
                            <input type="text" id="edit-sumario" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div class="editor-actions">
                        <div class="draft-controls">
                            <button type="button" id="salvar-rascunho" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Salvar Rascunho
                            </button>
                            <span id="draft-info" style="font-size: 0.9em; color: #666;"></span>
                        </div>
                        <div>
                            <button type="submit" id="salvar-edicao" style="padding: 10px 20px; background-color: #2a6f8b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Salvar Edição
                            </button>
                            <button type="button" id="cancelar-edicao" style="padding: 10px 20px; background-color: #a2a9b1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histórico do Artigo (mantido) -->
            <div id="historico-artigo" class="content-pane" style="display: none;">
                <h2 style="border-bottom: 1px solid #a2a9b1; padding-bottom: 0.5em;">Histórico de Edições</h2>
                <div id="lista-historico">
                    <p style="text-align: center; color: #666;">Carregando histórico...</p>
                </div>
                <button type="button" id="voltar-detalhes" style="margin-top: 1em; padding: 10px 20px; background-color: #a2a9b1; color: white; border: none; cursor: pointer;">Voltar</button>
            </div>

            <!-- Novo Artigo com Editor Aprimorado -->
            <div id="novo-artigo" class="content-pane" style="display: none;">
                <div class="editor-container">
                    <h2>Criar Novo Artigo</h2>
                    
                    <div class="editor-main">
                        <div class="form-group">
                            <label for="new-titulo">Título *</label>
                            <input type="text" id="new-titulo" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="new-setor">Setor / Categoria *</label>
                                <select id="new-setor" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Ultimas Noticias">Últimas Notícias</option>
                                    <option value="Arte">Arte</option>
                                    <option value="Biografias">Biografias</option>
                                    <option value="Ciência">Ciência</option>
                                    <option value="Filosofia">Filosofia</option>
                                    <option value="Geografia">Geografia</option>
                                    <option value="História">História</option>
                                    <option value="Matemática">Matemática</option>
                                    <option value="Sociedade">Sociedade</option>
                                    <option value="Tecnologia">Tecnologia</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="new-armario">Idioma *</label>
                                <select id="new-armario" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="">Selecione um idioma</option>
                                    <option value="Português">Português</option>
                                    <option value="Inglês">Inglês</option>
                                    <option value="Espanhol">Espanhol</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Tags (opcional)</label>
                            <div class="tag-input">
                                <input type="text" id="new-tag-input" placeholder="Digite uma tag e pressione Enter">
                                <button type="button" id="add-new-tag-btn" style="padding: 5px 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Adicionar</button>
                            </div>
                            <div class="tags-container" id="new-tags-container"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descrição (Editor WYSIWYG) *</label>
                            <div id="new-editor-quill"></div>
                        </div>
                        
                        <div class="image-upload-container">
                            <button type="button" id="new-upload-image-btn" class="image-upload-btn">
                                <i class="material-icons">image</i> Upload de Imagem
                            </button>
                            <input type="file" id="new-image-upload-input" accept="image/*" style="display: none;">
                            <div class="image-preview" id="new-image-preview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Preview em Tempo Real</label>
                            <div class="editor-preview">
                                <h3>Preview do Artigo</h3>
                                <div class="preview-content" id="new-preview-content"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="editor-actions">
                        <div class="draft-controls">
                            <button type="button" id="salvar-novo-rascunho" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Salvar Rascunho
                            </button>
                            <span id="new-draft-info" style="font-size: 0.9em; color: #666;"></span>
                        </div>
                        <div>
                            <button type="submit" id="criar-artigo-submit" style="padding: 10px 20px; background-color: #2a9d8f; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Criar Artigo
                            </button>
                            <button type="button" id="cancelar-novo-artigo" style="padding: 10px 20px; background-color: #a2a9b1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outros painéis mantidos -->
            <!-- ... (código existente para outros painéis) ... -->

        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<!-- Flatpickr JS para filtros de data -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicialize o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // Elementos da interface
        const loginSection = document.getElementById('login-section');
        const loggedInHeader = document.getElementById('header-logged-in');
        const mainContainer = document.getElementById('content-split');
        const logoutButton = document.getElementById('logout-button');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const artigosBtn = document.getElementById('artigos-btn');
        const criarArtigoBtn = document.getElementById('criar-artigo-btn');
        const minhasContribuicoesBtn = document.getElementById('minhas-contribuicoes-btn');
        const buscaAvancadaBtn = document.getElementById('busca-avancada-btn');
        const buscarArtigosBtn = document.getElementById('buscar-artigos-btn');
        
        // Variáveis para editores
        let quillEditor = null;
        let quillNewEditor = null;
        let currentDraftId = null;
        let autoSaveInterval = null;
        let currentImages = [];
        let newArticleImages = [];
        
        // Inicializar Flatpickr para filtros de data
        flatpickr.localize(flatpickr.l10ns.pt);
        const dateOptions = {
            dateFormat: "d/m/Y",
            locale: "pt"
        };
        
        flatpickr("#data-inicio", dateOptions);
        flatpickr("#data-fim", dateOptions);

        // --- Inicializar Editor Quill ---
        function initializeQuillEditor() {
            if (!quillEditor && document.getElementById('editor-quill')) {
                quillEditor = new Quill('#editor-quill', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'font': [] }],
                            [{ 'align': [] }],
                            ['link', 'image', 'video'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Digite o conteúdo do artigo aqui...'
                });
                
                // Atualizar preview em tempo real
                quillEditor.on('text-change', function() {
                    updatePreview();
                });
            }
            
            if (!quillNewEditor && document.getElementById('new-editor-quill')) {
                quillNewEditor = new Quill('#new-editor-quill', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'font': [] }],
                            [{ 'align': [] }],
                            ['link', 'image', 'video'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Digite o conteúdo do artigo aqui...'
                });
                
                // Atualizar preview em tempo real
                quillNewEditor.on('text-change', function() {
                    updateNewPreview();
                });
            }
        }

        // --- Funções de Preview ---
        function updatePreview() {
            if (quillEditor) {
                const content = quillEditor.root.innerHTML;
                document.getElementById('preview-content').innerHTML = DOMPurify.sanitize(content);
            }
        }
        
        function updateNewPreview() {
            if (quillNewEditor) {
                const content = quillNewEditor.root.innerHTML;
                document.getElementById('new-preview-content').innerHTML = DOMPurify.sanitize(content);
            }
        }

        // --- Upload de Imagens ---
        function setupImageUpload(uploadBtnId, inputId, previewId, imagesArray) {
            const uploadBtn = document.getElementById(uploadBtnId);
            const fileInput = document.getElementById(inputId);
            const previewContainer = document.getElementById(previewId);
            
            if (!uploadBtn || !fileInput || !previewContainer) return;
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    await uploadImage(file, previewContainer, imagesArray);
                }
                fileInput.value = '';
            });
        }
        
        async function uploadImage(file, previewContainer, imagesArray) {
            const user = auth.currentUser;
            if (!user) {
                alert('Você precisa estar logado para fazer upload de imagens.');
                return;
            }
            
            // Verificar se é uma imagem
            if (!file.type.match('image.*')) {
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }
            
            // Verificar tamanho (limite de 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('A imagem é muito grande. Por favor, selecione uma imagem menor que 5MB.');
                return;
            }
            
            try {
                // Criar nome único para a imagem
                const timestamp = Date.now();
                const fileName = `article_images/${user.uid}_${timestamp}_${file.name}`;
                
                // Upload para Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(fileName);
                const snapshot = await imageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                // Adicionar à lista de imagens
                const imageData = {
                    url: downloadURL,
                    name: file.name,
                    path: fileName
                };
                imagesArray.push(imageData);
                
                // Adicionar preview
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${downloadURL}" alt="${file.name}">
                    <button class="remove-image" onclick="removeImage(this, '${downloadURL}', ${imagesArray === currentImages ? 'currentImages' : 'newArticleImages'})">×</button>
                `;
                previewContainer.appendChild(previewItem);
                
                // Inserir imagem no editor ativo
                const quill = quillEditor || quillNewEditor;
                if (quill) {
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', downloadURL);
                }
                
            } catch (error) {
                console.error('Erro no upload da imagem:', error);
                alert('Erro ao fazer upload da imagem. Tente novamente.');
            }
        }
        
        // Função para remover imagem (exposta globalmente para o onclick)
        window.removeImage = function(button, url, imagesArray) {
            const previewItem = button.parentElement;
            previewItem.remove();
            
            // Remover da array
            const index = imagesArray.findIndex(img => img.url === url);
            if (index > -1) {
                imagesArray.splice(index, 1);
            }
        };

        // --- Gerenciamento de Tags ---
        function setupTagManagement(inputId, addBtnId, containerId) {
            const tagInput = document.getElementById(inputId);
            const addBtn = document.getElementById(addBtnId);
            const container = document.getElementById(containerId);
            
            if (!tagInput || !addBtn || !container) return;
            
            let tags = [];
            
            function addTag(tagText) {
                const trimmedTag = tagText.trim();
                if (trimmedTag && !tags.includes(trimmedTag)) {
                    tags.push(trimmedTag);
                    renderTags();
                    tagInput.value = '';
                }
            }
            
            function removeTag(tagToRemove) {
                tags = tags.filter(tag => tag !== tagToRemove);
                renderTags();
            }
            
            function renderTags() {
                container.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="tag-remove" onclick="this.parentElement.remove(); removeTag('${tag}')">×</span>
                    `;
                    container.appendChild(tagElement);
                });
            }
            
            addBtn.addEventListener('click', () => {
                addTag(tagInput.value);
            });
            
            tagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(tagInput.value);
                }
            });
            
            // Expor funções para uso externo
            return {
                getTags: () => [...tags],
                setTags: (newTags) => {
                    tags = Array.isArray(newTags) ? newTags : [];
                    renderTags();
                },
                clearTags: () => {
                    tags = [];
                    renderTags();
                }
            };
        }
        
        // Inicializar gerenciamento de tags
        const editTagsManager = setupTagManagement('edit-tag-input', 'add-tag-btn', 'edit-tags-container');
        const newTagsManager = setupTagManagement('new-tag-input', 'add-new-tag-btn', 'new-tags-container');

        // --- Sistema de Rascunhos ---
        function startAutoSave(articleId, isNew = false) {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            autoSaveInterval = setInterval(async () => {
                await saveDraft(articleId, isNew);
            }, 30000); // Salvar a cada 30 segundos
            
            // Salvar imediatamente
            saveDraft(articleId, isNew);
        }
        
        async function saveDraft(articleId, isNew = false) {
            const user = auth.currentUser;
            if (!user) return;
            
            const editor = isNew ? quillNewEditor : quillEditor;
            const titleInput = isNew ? document.getElementById('new-titulo') : document.getElementById('edit-titulo');
            const tagsManager = isNew ? newTagsManager : editTagsManager;
            const draftInfo = isNew ? document.getElementById('new-draft-info') : document.getElementById('draft-info');
            const statusElement = document.getElementById('editor-status');
            
            if (!editor || !titleInput) return;
            
            const draftData = {
                title: titleInput.value,
                content: editor.root.innerHTML,
                tags: tagsManager.getTags(),
                images: isNew ? newArticleImages : currentImages,
                lastSaved: firebase.firestore.FieldValue.serverTimestamp(),
                userId: user.uid,
                isNewArticle: isNew
            };
            
            try {
                if (statusElement) {
                    statusElement.textContent = 'Salvando...';
                    statusElement.className = 'editor-status saving';
                }
                
                if (currentDraftId) {
                    // Atualizar rascunho existente
                    await db.collection('drafts').doc(currentDraftId).update(draftData);
                } else {
                    // Criar novo rascunho
                    const docRef = await db.collection('drafts').add({
                        ...draftData,
                        articleId: articleId || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    currentDraftId = docRef.id;
                }
                
                if (statusElement) {
                    statusElement.textContent = 'Salvo';
                    statusElement.className = 'editor-status saved';
                    
                    // Resetar status após 2 segundos
                    setTimeout(() => {
                        if (statusElement.textContent === 'Salvo') {
                            statusElement.textContent = 'Pronto';
                            statusElement.className = 'editor-status';
                        }
                    }, 2000);
                }
                
                if (draftInfo) {
                    const now = new Date();
                    draftInfo.textContent = `Rascunho salvo: ${now.toLocaleTimeString()}`;
                }
                
            } catch (error) {
                console.error('Erro ao salvar rascunho:', error);
                if (statusElement) {
                    statusElement.textContent = 'Erro ao salvar';
                    statusElement.className = 'editor-status';
                }
            }
        }
        
        function loadDraft(draftId) {
            db.collection('drafts').doc(draftId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    if (data.isNewArticle) {
                        // Carregar para novo artigo
                        if (data.title) document.getElementById('new-titulo').value = data.title;
                        if (data.content && quillNewEditor) {
                            quillNewEditor.root.innerHTML = data.content;
                            updateNewPreview();
                        }
                        if (data.tags) newTagsManager.setTags(data.tags);
                        newArticleImages = data.images || [];
                        
                        // Atualizar preview de imagens
                        const previewContainer = document.getElementById('new-image-preview');
                        previewContainer.innerHTML = '';
                        newArticleImages.forEach(image => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'image-preview-item';
                            previewItem.innerHTML = `
                                <img src="${image.url}" alt="${image.name}">
                                <button class="remove-image" onclick="removeImage(this, '${image.url}', newArticleImages)">×</button>
                            `;
                            previewContainer.appendChild(previewItem);
                        });
                        
                    } else {
                        // Carregar para edição existente
                        if (data.title) document.getElementById('edit-titulo').value = data.title;
                        if (data.content && quillEditor) {
                            quillEditor.root.innerHTML = data.content;
                            updatePreview();
                        }
                        if (data.tags) editTagsManager.setTags(data.tags);
                        currentImages = data.images || [];
                        
                        // Atualizar preview de imagens
                        const previewContainer = document.getElementById('image-preview');
                        previewContainer.innerHTML = '';
                        currentImages.forEach(image => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'image-preview-item';
                            previewItem.innerHTML = `
                                <img src="${image.url}" alt="${image.name}">
                                <button class="remove-image" onclick="removeImage(this, '${image.url}', currentImages)">×</button>
                            `;
                            previewContainer.appendChild(previewItem);
                        });
                    }
                    
                    currentDraftId = draftId;
                    document.getElementById('draft-info').textContent = `Rascunho carregado: ${doc.data().lastSaved?.toDate().toLocaleString() || 'Agora'}`;
                }
            });
        }
        
        function clearAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            currentDraftId = null;
        }

        // --- Busca Avançada Aprimorada ---
        function setupAdvancedSearch() {
            const searchBtn = document.getElementById('buscar-avancada-submit');
            const clearBtn = document.getElementById('limpar-busca-avancada');
            const resultsContainer = document.getElementById('lista-resultados-busca');
            const statsContainer = document.getElementById('resultados-stats');
            const paginationContainer = document.getElementById('busca-paginacao');
            const loader = document.getElementById('busca-loader');
            
            let currentPage = 1;
            const pageSize = 10;
            let totalResults = 0;
            let lastQuery = null;
            
            async function performSearch(page = 1) {
                currentPage = page;
                
                // Coletar critérios de busca
                const criteria = {
                    titulo: document.getElementById('busca-titulo').value,
                    descricao: document.getElementById('busca-descricao').value,
                    autor: document.getElementById('busca-autor').value,
                    tags: document.getElementById('busca-tags').value,
                    categoria: document.getElementById('busca-categoria').value,
                    idioma: document.getElementById('busca-idioma').value,
                    dataInicio: document.getElementById('data-inicio').value,
                    dataFim: document.getElementById('data-fim').value,
                    uid: document.getElementById('busca-uid').value,
                    ordenarPor: document.getElementById('ordenar-por').value
                };
                
                // Mostrar loader
                loader.classList.add('active');
                resultsContainer.innerHTML = '';
                statsContainer.innerHTML = '';
                paginationContainer.innerHTML = '';
                
                try {
                    let query = db.collection('materiadeensaio');
                    
                    // Aplicar filtros
                    if (criteria.uid) {
                        query = query.where(firebase.firestore.FieldPath.documentId(), '==', criteria.uid);
                    } else {
                        // Filtro por título (case insensitive)
                        if (criteria.titulo) {
                            const tituloLower = criteria.titulo.toLowerCase();
                            query = query.where('tituloLowerCase', '>=', tituloLower)
                                         .where('tituloLowerCase', '<=', tituloLower + '\uf8ff');
                        }
                        
                        // Filtro por categoria
                        if (criteria.categoria) {
                            query = query.where('setor', '==', criteria.categoria);
                        }
                        
                        // Filtro por idioma
                        if (criteria.idioma) {
                            query = query.where('armario', '==', criteria.idioma);
                        }
                        
                        // Filtro por autor
                        if (criteria.autor) {
                            query = query.where('criadorEmail', '==', criteria.autor);
                        }
                        
                        // Filtro por data
                        if (criteria.dataInicio) {
                            const startDate = new Date(criteria.dataInicio.split('/').reverse().join('-'));
                            query = query.where('dataCriacao', '>=', startDate);
                        }
                        
                        if (criteria.dataFim) {
                            const endDate = new Date(criteria.dataFim.split('/').reverse().join('-'));
                            endDate.setHours(23, 59, 59, 999);
                            query = query.where('dataCriacao', '<=', endDate);
                        }
                    }
                    
                    // Ordenação
                    const orderField = criteria.ordenarPor || 'ultimaEdicao';
                    query = query.orderBy(orderField, 'desc');
                    
                    // Paginação
                    const offset = (page - 1) * pageSize;
                    const snapshot = await query.limit(pageSize + 1).get(); // +1 para saber se tem mais páginas
                    
                    // Processar resultados
                    const results = [];
                    let hasMore = false;
                    let count = 0;
                    
                    snapshot.forEach((doc, index) => {
                        if (index < pageSize) {
                            const data = doc.data();
                            
                            // Verificar critérios de texto adicionais
                            let matchesText = true;
                            if (criteria.descricao && !criteria.uid) {
                                const descricao = data.descricao || '';
                                matchesText = descricao.toLowerCase().includes(criteria.descricao.toLowerCase());
                            }
                            
                            if (matchesText) {
                                results.push({
                                    id: doc.id,
                                    ...data
                                });
                            }
                        } else {
                            hasMore = true;
                        }
                        count++;
                    });
                    
                    totalResults = count;
                    
                    // Atualizar estatísticas
                    statsContainer.innerHTML = `
                        Encontrados ${results.length} artigo(s)${totalResults > results.length ? ' (página atual)' : ''}
                    `;
                    
                    // Renderizar resultados
                    if (results.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="empty-state">
                                <p>Nenhum artigo encontrado com os critérios especificados.</p>
                                <p>Tente ajustar os filtros de busca.</p>
                            </div>
                        `;
                    } else {
                        resultsContainer.innerHTML = '';
                        results.forEach(article => {
                            const resultElement = createSearchResultElement(article, criteria);
                            resultsContainer.appendChild(resultElement);
                        });
                        
                        // Adicionar paginação
                        renderPagination(hasMore, page);
                    }
                    
                    lastQuery = { criteria, page };
                    
                } catch (error) {
                    console.error('Erro na busca:', error);
                    resultsContainer.innerHTML = `
                        <div class="error-message">
                            <p>Erro ao realizar a busca: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    loader.classList.remove('active');
                }
            }
            
            function createSearchResultElement(article, criteria) {
                const element = document.createElement('div');
                element.className = 'search-result-item';
                
                // Extrair trecho relevante do conteúdo
                let excerpt = '';
                if (article.descricao) {
                    excerpt = article.descricao.substring(0, 200);
                    if (article.descricao.length > 200) {
                        excerpt += '...';
                    }
                }
                
                // Destacar termos de busca no trecho
                if (criteria.descricao) {
                    const regex = new RegExp(`(${criteria.descricao})`, 'gi');
                    excerpt = excerpt.replace(regex, '<span class="search-highlight">$1</span>');
                }
                
                const tags = article.tags || [];
                
                element.innerHTML = `
                    <div class="search-result-header">
                        <h3 class="search-result-title">
                            <a href="#" class="view-article-link" data-id="${article.id}">
                                ${article.titulo || 'Sem título'}
                            </a>
                        </h3>
                        <span class="search-result-meta">
                            ${article.ultimaEdicao ? new Date(article.ultimaEdicao.seconds * 1000).toLocaleDateString() : ''}
                        </span>
                    </div>
                    <div class="search-result-meta">
                        <strong>Autor:</strong> ${article.criadorEmail || 'Desconhecido'} |
                        <strong>Categoria:</strong> ${article.setor || 'Não especificada'} |
                        <strong>Idioma:</strong> ${article.armario || 'Não especificado'}
                    </div>
                    <div class="search-result-summary">
                        ${excerpt}
                    </div>
                    ${tags.length > 0 ? `
                        <div class="search-result-tags">
                            ${tags.map(tag => `<span class="search-result-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div style="margin-top: 10px;">
                        <button class="mdl-button mdl-button--colored view-article-btn" data-id="${article.id}">
                            Visualizar Artigo
                        </button>
                        <button class="mdl-button edit-article-btn" data-id="${article.id}" style="margin-left: 10px;">
                            Editar
                        </button>
                    </div>
                `;
                
                return element;
            }
            
            function renderPagination(hasMore, currentPage) {
                paginationContainer.innerHTML = '';
                
                if (currentPage > 1 || hasMore) {
                    const pagination = document.createElement('div');
                    pagination.className = 'pagination';
                    
                    if (currentPage > 1) {
                        const prevBtn = document.createElement('button');
                        prevBtn.textContent = 'Anterior';
                        prevBtn.addEventListener('click', () => performSearch(currentPage - 1));
                        pagination.appendChild(prevBtn);
                    }
                    
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'pagination-info';
                    pageInfo.textContent = `Página ${currentPage}`;
                    pagination.appendChild(pageInfo);
                    
                    if (hasMore) {
                        const nextBtn = document.createElement('button');
                        nextBtn.textContent = 'Próxima';
                        nextBtn.addEventListener('click', () => performSearch(currentPage + 1));
                        pagination.appendChild(nextBtn);
                    }
                    
                    paginationContainer.appendChild(pagination);
                }
            }
            
            // Event listeners
            searchBtn.addEventListener('click', () => performSearch(1));
            
            clearBtn.addEventListener('click', () => {
                document.getElementById('busca-titulo').value = '';
                document.getElementById('busca-descricao').value = '';
                document.getElementById('busca-autor').value = '';
                document.getElementById('busca-tags').value = '';
                document.getElementById('busca-categoria').value = '';
                document.getElementById('busca-idioma').value = '';
                document.getElementById('data-inicio').value = '';
                document.getElementById('data-fim').value = '';
                document.getElementById('busca-uid').value = '';
                document.getElementById('ordenar-por').value = 'ultimaEdicao';
                
                document.getElementById('lista-resultados-busca').innerHTML = '';
                document.getElementById('resultados-stats').innerHTML = '';
                document.getElementById('busca-paginacao').innerHTML = '';
            });
            
            // Permitir busca com Enter
            document.querySelectorAll('#busca-avancada-pane input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch(1);
                    }
                });
            });
            
            // Delegar eventos para botões de visualização/edição
            document.getElementById('busca-avancada-pane').addEventListener('click', (e) => {
                if (e.target.classList.contains('view-article-link') || 
                    e.target.classList.contains('view-article-btn')) {
                    e.preventDefault();
                    const articleId = e.target.dataset.id;
                    if (articleId) {
                        // Carregar e mostrar o artigo
                        db.collection('materiadeensaio').doc(articleId).get().then(doc => {
                            if (doc.exists) {
                                carregarDetalhesArtigo(doc.id, doc.data());
                                exibirPainel('detalhes-artigo');
                            }
                        });
                    }
                }
                
                if (e.target.classList.contains('edit-article-btn')) {
                    const articleId = e.target.dataset.id;
                    if (articleId) {
                        // Abrir editor do artigo
                        db.collection('materiadeensaio').doc(articleId).get().then(doc => {
                            if (doc.exists) {
                                abrirEditor(doc.id, doc.data());
                            }
                        });
                    }
                }
            });
            
            return { performSearch };
        }
        
        // Inicializar busca avançada
        const advancedSearch = setupAdvancedSearch();

        // --- Funções de Edição Aprimoradas ---
        function abrirEditor(id, materia) {
            exibirPainel('editor-artigo');
            
            // Inicializar editor se necessário
            initializeQuillEditor();
            
            // Preencher campos
            document.getElementById('edit-titulo').value = materia.titulo || '';
            
            if (quillEditor && materia.descricao) {
                quillEditor.root.innerHTML = materia.descricao;
                updatePreview();
            }
            
            // Carregar tags
            if (materia.tags && Array.isArray(materia.tags)) {
                editTagsManager.setTags(materia.tags);
            } else {
                editTagsManager.clearTags();
            }
            
            // Carregar imagens
            currentImages = materia.images || [];
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            currentImages.forEach(image => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${image.url}" alt="${image.name}">
                    <button class="remove-image" onclick="removeImage(this, '${image.url}', currentImages)">×</button>
                `;
                previewContainer.appendChild(previewItem);
            });
            
            // Configurar upload de imagens
            setupImageUpload('upload-image-btn', 'image-upload-input', 'image-preview', currentImages);
            
            // Salvar dados para referência
            editorArtigo.dataset.docId = id;
            editorArtigo.dataset.tituloOriginal = materia.titulo;
            editorArtigo.dataset.descricaoOriginal = materia.descricao;
            
            // Verificar se há rascunhos salvos
            const user = auth.currentUser;
            if (user) {
                db.collection('drafts')
                    .where('userId', '==', user.uid)
                    .where('articleId', '==', id)
                    .orderBy('lastSaved', 'desc')
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const draft = snapshot.docs[0];
                            const shouldLoad = confirm(`Encontramos um rascunho salvo em ${draft.data().lastSaved.toDate().toLocaleString()}. Deseja carregá-lo?`);
                            if (shouldLoad) {
                                loadDraft(draft.id);
                            }
                        }
                    });
            }
            
            // Iniciar salvamento automático
            startAutoSave(id, false);
        }

        // Salvar edição do artigo
        document.getElementById('salvar-edicao').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const docId = editorArtigo.dataset.docId;
            if (!docId) return;
            
            const user = auth.currentUser;
            if (!user) {
                alert('Você precisa estar logado para editar artigos.');
                return;
            }
            
            const titulo = document.getElementById('edit-titulo').value;
            const sumario = document.getElementById('edit-sumario').value;
            const tags = editTagsManager.getTags();
            
            if (!titulo || !sumario) {
                alert('Por favor, preencha o título e o resumo da edição.');
                return;
            }
            
            if (!quillEditor) {
                alert('Editor não inicializado.');
                return;
            }
            
            const descricao = quillEditor.root.innerHTML;
            
            try {
                // 1. Atualizar o artigo
                await db.collection('materiadeensaio').doc(docId).update({
                    titulo,
                    descricao,
                    tags,
                    images: currentImages,
                    ultimaEdicao: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. Salvar histórico
                await db.collection('historico').add({
                    docId,
                    editorId: user.uid,
                    editorEmail: user.email,
                    dataEdicao: firebase.firestore.FieldValue.serverTimestamp(),
                    sumario,
                    tituloAnterior: editorArtigo.dataset.tituloOriginal,
                    descricaoAnterior: editorArtigo.dataset.descricaoOriginal
                });
                
                // 3. Limpar rascunho
                if (currentDraftId) {
                    await db.collection('drafts').doc(currentDraftId).delete();
                    currentDraftId = null;
                }
                
                // 4. Parar salvamento automático
                clearAutoSave();
                
                alert('Artigo editado e histórico salvo com sucesso!');
                
                // 5. Atualizar visualização
                const doc = await db.collection('materiadeensaio').doc(docId).get();
                if (doc.exists) {
                    carregarDetalhesArtigo(doc.id, doc.data());
                }
                
            } catch (error) {
                console.error("Erro ao salvar edição:", error);
                alert("Erro ao salvar edição: " + error.message);
            }
        });

        // Salvar rascunho manualmente
        document.getElementById('salvar-rascunho').addEventListener('click', () => {
            const docId = editorArtigo.dataset.docId;
            if (docId) {
                saveDraft(docId, false);
            }
        });

        // --- Novo Artigo Aprimorado ---
        criarArtigoBtn.addEventListener('click', () => {
            exibirPainel('novo-artigo');
            
            // Inicializar editor
            initializeQuillEditor();
            
            // Limpar campos
            document.getElementById('new-titulo').value = '';
            document.getElementById('new-setor').value = '';
            document.getElementById('new-armario').value = '';
            if (quillNewEditor) {
                quillNewEditor.root.innerHTML = '';
                updateNewPreview();
            }
            newTagsManager.clearTags();
            newArticleImages = [];
            document.getElementById('new-image-preview').innerHTML = '';
            
            // Configurar upload de imagens
            setupImageUpload('new-upload-image-btn', 'new-image-upload-input', 'new-image-preview', newArticleImages);
            
            // Verificar rascunhos de novo artigo
            const user = auth.currentUser;
            if (user) {
                db.collection('drafts')
                    .where('userId', '==', user.uid)
                    .where('isNewArticle', '==', true)
                    .orderBy('lastSaved', 'desc')
                    .limit(1)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const draft = snapshot.docs[0];
                            const shouldLoad = confirm(`Encontramos um rascunho de novo artigo salvo em ${draft.data().lastSaved.toDate().toLocaleString()}. Deseja carregá-lo?`);
                            if (shouldLoad) {
                                loadDraft(draft.id);
                            }
                        }
                    });
            }
            
            // Iniciar salvamento automático
            startAutoSave(null, true);
        });

        // Criar novo artigo
        document.getElementById('criar-artigo-submit').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                alert('Você precisa estar logado para criar artigos.');
                return;
            }
            
            const titulo = document.getElementById('new-titulo').value;
            const setor = document.getElementById('new-setor').value;
            const armario = document.getElementById('new-armario').value;
            const tags = newTagsManager.getTags();
            
            if (!titulo || !setor || !armario) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (!quillNewEditor) {
                alert('Editor não inicializado.');
                return;
            }
            
            const descricao = quillNewEditor.root.innerHTML;
            
            try {
                // Criar artigo
                const docRef = await db.collection('materiadeensaio').add({
                    titulo,
                    setor,
                    armario,
                    descricao,
                    tags,
                    images: newArticleImages,
                    criadorId: user.uid,
                    criadorEmail: user.email,
                    dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaEdicao: firebase.firestore.FieldValue.serverTimestamp(),
                    fontes: [],
                    // Campo para busca case-insensitive
                    tituloLowerCase: titulo.toLowerCase()
                });
                
                // Limpar rascunho
                if (currentDraftId) {
                    await db.collection('drafts').doc(currentDraftId).delete();
                    currentDraftId = null;
                }
                
                // Parar salvamento automático
                clearAutoSave();
                
                alert('Artigo criado com sucesso! ID: ' + docRef.id);
                
                // Resetar formulário
                document.getElementById('new-titulo').value = '';
                document.getElementById('new-setor').value = '';
                document.getElementById('new-armario').value = '';
                if (quillNewEditor) {
                    quillNewEditor.root.innerHTML = '';
                    updateNewPreview();
                }
                newTagsManager.clearTags();
                newArticleImages = [];
                document.getElementById('new-image-preview').innerHTML = '';
                
                // Voltar para detalhes e carregar o novo artigo
                exibirPainel('detalhes-artigo');
                buscarArtigos();
                
                // Carregar o artigo recém-criado
                const doc = await docRef.get();
                if (doc.exists) {
                    carregarDetalhesArtigo(doc.id, doc.data());
                }
                
            } catch (error) {
                console.error("Erro ao criar artigo:", error);
                alert("Erro ao criar artigo: " + error.message);
            }
        });

        // Salvar rascunho do novo artigo
        document.getElementById('salvar-novo-rascunho').addEventListener('click', () => {
            saveDraft(null, true);
        });

        // --- Autenticação e Outras Funções (mantidas do código original) ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("Usuário logado:", user.email);
                const userDoc = await db.collection('users').doc(user.uid).get();
                let currentUserRole = 'user';
                if (userDoc.exists && userDoc.data().role) {
                    currentUserRole = userDoc.data().role;
                }
                loginSection.style.display = 'none';
                loggedInHeader.style.display = 'flex';
                mainContainer.style.display = 'grid';
                exibirPainel('detalhes-artigo');
                buscarArtigos();
            } else {
                console.log("Nenhum usuário logado.");
                loginSection.style.display = 'flex';
                loggedInHeader.style.display = 'none';
                mainContainer.style.display = 'none';
            }
        });

        googleLoginBtn.addEventListener('click', async () => {
            try {
                await auth.signInWithPopup(googleProvider);
            } catch (error) {
                console.error("Erro no login com Google:", error);
                alert("Erro no login com Google: " + error.message);
            }
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // Função exibirPainel e outras funções do código original
        function exibirPainel(painelId) {
            document.querySelectorAll('#conteudo-principal > .content-pane').forEach(pane => {
                pane.style.display = 'none';
            });
            const painel = document.getElementById(painelId);
            if (painel) {
                painel.style.display = 'block';
            }
            
            document.querySelectorAll('.nav-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.getElementById(painelId.replace('-pane', '-btn')) || document.getElementById('artigos-btn');
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Event listeners para navegação
        artigosBtn.addEventListener('click', () => {
            exibirPainel('detalhes-artigo');
            buscarArtigos();
        });

        minhasContribuicoesBtn.addEventListener('click', () => {
            exibirPainel('minhas-contribuicoes');
            carregarMinhasContribuicoes();
        });

        buscaAvancadaBtn.addEventListener('click', () => {
            exibirPainel('busca-avancada-pane');
            // Inicializar buscador se necessário
            if (typeof advancedSearch !== 'undefined') {
                advancedSearch.performSearch(1);
            }
        });

        // Cancelar ações
        document.getElementById('cancelar-edicao').addEventListener('click', async () => {
            const docId = editorArtigo.dataset.docId;
            if (!docId) return;
            
            // Parar salvamento automático
            clearAutoSave();
            
            try {
                const doc = await db.collection('materiadeensaio').doc(docId).get();
                if (doc.exists) {
                    carregarDetalhesArtigo(doc.id, doc.data());
                } else {
                    exibirPainel('detalhes-artigo');
                    buscarArtigos();
                }
            } catch (error) {
                console.error("Erro ao carregar artigo:", error);
                alert("Erro ao carregar artigo: " + error.message);
            }
        });

        document.getElementById('cancelar-novo-artigo').addEventListener('click', () => {
            // Parar salvamento automático
            clearAutoSave();
            
            // Limpar rascunho se existir
            if (currentDraftId) {
                if (confirm('Deseja excluir o rascunho não salvo?')) {
                    db.collection('drafts').doc(currentDraftId).delete();
                }
                currentDraftId = null;
            }
            
            exibirPainel('detalhes-artigo');
            buscarArtigos();
        });

        // --- Inicialização ao Carregar a Página ---
        // Inicializar editores quando o DOM estiver pronto
        initializeQuillEditor();
        
        // Configurar upload de imagens para editores
        setupImageUpload('upload-image-btn', 'image-upload-input', 'image-preview', currentImages);
        setupImageUpload('new-upload-image-btn', 'new-image-upload-input', 'new-image-preview', newArticleImages);
        
        // Outras inicializações do código original...
        // ... (restante do código original)

    });
</script>

</body>
</html>
