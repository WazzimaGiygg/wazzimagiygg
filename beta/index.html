<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Sess√£o com Firebase</title>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
    </style>
</head>
<body>

    <div id="log">Aguardando inicializa√ß√£o do Firebase e da sess√£o...</div>

    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics-compat.js"></script>

    <script>
        // --- Configura√ß√£o do Firebase (Fornecida na requisi√ß√£o) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Chave de exemplo
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        firebase.analytics();

        const logElement = document.getElementById('log');
        const COLLECTION_NAME = "securityuid_sessions"; // Nome da cole√ß√£o

        // Fun√ß√£o para simular a exclus√£o de um documento
        function deleteSessionDocument(docId) {
            // A exclus√£o real no Firestore n√£o √© recomendada a partir de um cliente sem
            // regras de seguran√ßa estritas, mas demonstramos o conceito:
            firestore.collection(COLLECTION_NAME).doc(docId).delete()
            .then(() => {
                logElement.innerHTML += `<br><b>üóëÔ∏è Documento de sess√£o anterior (ID: ${docId}) DELETADO com sucesso.</b>`;
            })
            .catch((error) => {
                logElement.innerHTML += `<br>‚ö†Ô∏è Erro ao tentar deletar o documento anterior (ID: ${docId}): ${error.message}`;
            });
        }

        async function initializeSession() {
            // 1. Verificar se existe um ID de sess√£o anterior no sessionStorage
            const previousSessionId = sessionStorage.getItem('currentSessionDocId');

            if (previousSessionId) {
                // 2. Se houver um ID anterior, simulamos a exclus√£o (ou desativa√ß√£o)
                logElement.innerHTML = `Sess√£o anterior encontrada no storage: <b>${previousSessionId}</b>. Tentando apagar...`;
                deleteSessionDocument(previousSessionId);
            }

            // 3. Criar um novo documento de sess√£o (o Firestore gera o ID automaticamente)
            try {
                // Dados para o novo documento. IP √© OMITIDO por quest√µes de seguran√ßa/privacidade.
                const user = auth.currentUser;
                const newSessionData = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    // ID do usu√°rio autenticado, se houver
                    userId: user ? user.uid : 'USUARIO_NAO_AUTENTICADO',
                    // A URL da p√°gina atual, incluindo o par√¢metro ?uid=
                    pageUrl: window.location.href,
                    // Validade de 5 minutos (para ser verificado no lado do servidor/regras)
                    expiresAt: Date.now() + (5 * 60 * 1000)
                    // Endere√ßo IP DEVE ser coletado e processado em um SERVIDOR BACKEND SE NECESS√ÅRIO.
                };

                const newDocRef = await firestore.collection(COLLECTION_NAME).add(newSessionData);
                const newDocId = newDocRef.id;

                // 4. Armazenar o novo ID na mem√≥ria tempor√°ria do navegador
                sessionStorage.setItem('currentSessionDocId', newDocId);

                // 5. Redirecionar/Atualizar o URL com o novo ID (simulando o ?uid=)
                const newUrl = window.location.origin + window.location.pathname + `?uid=${newDocId}`;
                window.history.pushState({ path: newUrl }, '', newUrl); // Altera o URL sem recarregar

                logElement.innerHTML += `<br>‚úÖ Nova sess√£o criada com sucesso!`;
                logElement.innerHTML += `<br><b>ID do Documento (UID):</b> ${newDocId}`;
                logElement.innerHTML += `<br><b>UID armazenado no sessionStorage.</b>`;
                logElement.innerHTML += `<br>URL atualizada para: ${newUrl}`;


            } catch (error) {
                logElement.innerHTML = `<br>‚ùå Erro ao criar a nova sess√£o no Firestore: ${error.message}`;
            }
        }

        // Inicia o processo de sess√£o ao carregar a p√°gina
        initializeSession();
    </script>
</body>
</html>
